<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Requests - Production System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Holiday Requests</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="user-guide.html" class="btn btn-secondary btn-sm">Help</a>
            <a href="timesheet.html" class="btn btn-secondary btn-sm">Timesheet</a>
            <a href="tasks.html" class="btn btn-secondary btn-sm">Tasks</a>
            <a href="reminders.html" class="btn btn-secondary btn-sm">Reminders</a>
            <a href="dashboard.html" class="btn btn-secondary btn-sm manager-only">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- My Entitlement -->
        <div class="card">
            <div class="card-header">
                <h2>My Holiday Entitlement</h2>
            </div>
            <div id="entitlementInfo">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Request Holiday -->
        <div class="card">
            <div class="card-header">
                <h2>Request Holiday</h2>
            </div>
            <form id="requestForm" onsubmit="submitRequest(event)">
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="requestStartDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" id="requestEndDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Day Type:</label>
                    <select id="requestDayType" class="form-input" required onchange="updateRequestSummary()">
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                    </select>
                </div>
                <div class="form-group">
                    <div id="requestSummary" style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;">
                        <p><strong>Days requested:</strong> <span id="daysRequested">0</span> days</p>
                        <p id="entitlementCheck" style="margin: 5px 0;"></p>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Submit Request</button>
                </div>
            </form>
        </div>
        
        <!-- My Requests -->
        <div class="card">
            <div class="card-header">
                <h2>My Holiday Requests</h2>
                <button onclick="loadMyRequests()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="myRequestsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let allEntitlements = []; // Store all entitlements for all years
        let currentEntitlement = null; // Current entitlement for selected year
        const currentYear = new Date().getFullYear();
        
        async function init() {
            await checkAuth();
            initNavbar();
            await loadAllEntitlements();
            await loadMyRequests();
            
            // Add date change listeners
            document.getElementById('requestStartDate').addEventListener('change', updateRequestSummary);
            document.getElementById('requestEndDate').addEventListener('change', updateRequestSummary);
            
            // Set minimum date to today (but allow future years)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('requestStartDate').min = today;
            document.getElementById('requestEndDate').min = today;
        }
        
        async function loadAllEntitlements() {
            try {
                // Get current user info first
                const meResponse = await apiCall('/me');
                console.log('Current user:', meResponse);
                const currentUserId = meResponse?.user?.id ? parseInt(meResponse.user.id) : null;
                
                const response = await apiCall('/holidays/entitlements');
                console.log('Entitlements API response:', response);
                if (response.success && response.entitlements) {
                    // Filter to only show entitlements for the current user
                    // Even if admin can see all entitlements, they should only see their own for booking
                    if (currentUserId !== null) {
                        allEntitlements = response.entitlements.filter(e => parseInt(e.user_id) === currentUserId);
                        console.log('Filtered entitlements for current user (ID:', currentUserId, '):', allEntitlements);
                    } else {
                        allEntitlements = [];
                        console.warn('Could not determine current user ID');
                    }
                    // Display current year's entitlement by default
                    updateEntitlementForYear(currentYear);
                } else {
                    console.warn('No entitlements in response or response not successful:', response);
                    allEntitlements = [];
                    updateEntitlementForYear(currentYear);
                }
            } catch (error) {
                console.error('Error loading entitlements:', error);
                allEntitlements = [];
                updateEntitlementForYear(currentYear);
            }
        }
        
        function updateEntitlementForYear(year) {
            console.log('Looking for entitlement for year:', year, 'Available entitlements:', allEntitlements);
            const entitlement = allEntitlements.find(e => {
                const eYear = parseInt(e.year);
                const match = eYear === year;
                console.log(`Comparing entitlement year ${eYear} (type: ${typeof eYear}) with ${year} (type: ${typeof year}): ${match}`);
                return match;
            });
            currentEntitlement = entitlement || null;
            console.log('Found entitlement for year', year, ':', entitlement);
            displayEntitlement(entitlement, year);
        }
        
        function displayEntitlement(entitlement, year) {
            if (!entitlement) {
                document.getElementById('entitlementInfo').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Year ${year}:</strong> No entitlement set for this year. Please contact admin to set up your holiday entitlement.
                    </div>
                `;
                return;
            }
            
            const daysUsed = parseFloat(entitlement.days_used || 0);
            const totalDays = parseFloat(entitlement.total_days || 0);
            const daysRemaining = entitlement.days_remaining !== undefined 
                ? parseFloat(entitlement.days_remaining) 
                : (totalDays - daysUsed);
            
            document.getElementById('entitlementInfo').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="font-size: 18px;">Holiday Entitlement for ${year}</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">
                    <div>
                        <strong>Total Entitlement:</strong><br>
                        <span style="font-size: 24px; color: #007bff;">${totalDays} days</span>
                    </div>
                    <div>
                        <strong>Days Used:</strong><br>
                        <span style="font-size: 24px; color: #ff9800;">${daysUsed.toFixed(1)} days</span>
                    </div>
                    <div>
                        <strong>Days Remaining:</strong><br>
                        <span style="font-size: 24px; color: ${daysRemaining < 0 ? '#dc3545' : (daysRemaining < 5 ? '#ff9800' : '#28a745')};">
                            ${daysRemaining >= 0 ? '' : '-'}${Math.abs(daysRemaining).toFixed(1)} days
                        </span>
                        ${daysRemaining < 0 ? '<br><small style="color: #dc3545;">(Negative due to shutdown periods)</small>' : ''}
                        ${daysUsed > totalDays ? '<br><small style="color: #dc3545;">(Includes shutdown periods)</small>' : ''}
                    </div>
                </div>
            `;
        }
        
        function calculateWorkingDays(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            let count = 0;
            const current = new Date(start);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }
        
        function updateRequestSummary() {
            const startDate = document.getElementById('requestStartDate').value;
            const endDate = document.getElementById('requestEndDate').value;
            const dayType = document.getElementById('requestDayType').value;
            
            if (!startDate || !endDate) {
                document.getElementById('daysRequested').textContent = '0';
                document.getElementById('entitlementCheck').textContent = '';
                // Show current year's entitlement when no dates selected
                updateEntitlementForYear(currentYear);
                return;
            }
            
            // For half day, start and end dates must be the same
            if (dayType === 'half' && startDate !== endDate) {
                document.getElementById('daysRequested').textContent = '0';
                document.getElementById('entitlementCheck').innerHTML = '<span style="color: red;">For half day, start date and end date must be the same</span>';
                document.getElementById('submitBtn').disabled = true;
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                document.getElementById('daysRequested').textContent = '0';
                document.getElementById('entitlementCheck').innerHTML = '<span style="color: red;">End date must be after start date</span>';
                document.getElementById('submitBtn').disabled = true;
                return;
            }
            
            // Get the year from the start date
            const requestYear = new Date(startDate).getFullYear();
            
            // Update entitlement display for the selected year
            updateEntitlementForYear(requestYear);
            
            // Get entitlement for the request year
            const entitlement = allEntitlements.find(e => {
                const eYear = parseInt(e.year);
                return eYear === requestYear;
            });
            
            let weekdays = calculateWorkingDays(startDate, endDate);
            
            // For half day, it's 0.5 days
            if (dayType === 'half') {
                if (weekdays === 0) {
                    document.getElementById('daysRequested').textContent = '0';
                    document.getElementById('entitlementCheck').innerHTML = '<span style="color: red;">Half day must be on a weekday</span>';
                    document.getElementById('submitBtn').disabled = true;
                    return;
                }
                weekdays = 0.5;
            }
            
            document.getElementById('daysRequested').textContent = weekdays.toFixed(1);
            
            if (entitlement) {
                const daysRemaining = entitlement.days_remaining !== undefined 
                    ? parseFloat(entitlement.days_remaining) 
                    : (parseFloat(entitlement.total_days || 0) - parseFloat(entitlement.days_used || 0));
                
                const afterRequest = daysRemaining - weekdays;
                // Allow negative balances (shutdown periods can cause this)
                if (afterRequest < 0) {
                    document.getElementById('entitlementCheck').innerHTML = 
                        `<span style="color: orange;">After this request, you will have <strong>${afterRequest.toFixed(1)} days</strong> remaining for ${requestYear} (negative due to shutdown periods).</span>`;
                    document.getElementById('submitBtn').disabled = false;
                } else {
                    document.getElementById('entitlementCheck').innerHTML = 
                        `<span style="color: green;">After this request, you will have ${afterRequest.toFixed(1)} days remaining for ${requestYear}.</span>`;
                    document.getElementById('submitBtn').disabled = false;
                }
            } else {
                document.getElementById('entitlementCheck').innerHTML = `<span style="color: red; font-weight: bold;">No holiday entitlement set for ${requestYear}. Please contact admin to set up your entitlement before requesting holidays.</span>`;
                document.getElementById('submitBtn').disabled = true;
            }
        }
        
        async function submitRequest(event) {
            event.preventDefault();
            const startDate = document.getElementById('requestStartDate').value;
            const endDate = document.getElementById('requestEndDate').value;
            const dayType = document.getElementById('requestDayType').value;
            
            if (!startDate || !endDate || !dayType) {
                alert('Please fill in all required fields');
                return;
            }
            
            // For half day, start and end dates must be the same
            if (dayType === 'half' && startDate !== endDate) {
                alert('For half day, start date and end date must be the same');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const weekdays = calculateWorkingDays(startDate, endDate);
            if (weekdays === 0) {
                alert('Please select a date range that includes at least one weekday');
                return;
            }
            
            // For half day, validate it's a weekday
            if (dayType === 'half' && weekdays === 0) {
                alert('Half day must be on a weekday');
                return;
            }
            
            // Get the year from the start date and check entitlement for that year
            const requestYear = new Date(startDate).getFullYear();
            console.log('Submitting request for year:', requestYear);
            console.log('Available entitlements:', allEntitlements);
            const entitlement = allEntitlements.find(e => {
                const eYear = parseInt(e.year);
                return eYear === requestYear;
            });
            console.log('Found entitlement for submission:', entitlement);
            
            // Check if entitlement exists for the selected year
            if (!entitlement) {
                alert(`You do not have a holiday entitlement set for ${requestYear}. Please contact your administrator to set up your holiday entitlement before requesting holidays.`);
                return;
            }
            
            try {
                const response = await apiCall('/holidays/requests', {
                    method: 'POST',
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        day_type: dayType
                    })
                });
                
                console.log('Holiday request response:', response);
                
                if (response.success) {
                    console.log('Request created:', response.request);
                    console.log('Request status:', response.request?.status);
                    
                    if (response.request?.status !== 'pending') {
                        console.warn('WARNING: Request was not created with status "pending"');
                    }
                    
                    alert('Holiday request submitted successfully. Status: ' + (response.request?.status || 'unknown'));
                    document.getElementById('requestForm').reset();
                    document.getElementById('requestDayType').value = 'full'; // Reset to full day
                    document.getElementById('daysRequested').textContent = '0';
                    document.getElementById('entitlementCheck').textContent = '';
                    await loadMyRequests();
                    await loadAllEntitlements(); // Refresh entitlements in case they were updated
                } else {
                    alert('Error submitting request: ' + (response.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error submitting holiday request:', error);
                alert('Error submitting request: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function loadMyRequests() {
            try {
                // Get current user info first
                const meResponse = await apiCall('/me');
                const currentUserId = meResponse?.user?.id ? parseInt(meResponse.user.id) : null;
                
                const response = await apiCall('/holidays/requests');
                if (response.success) {
                    // Filter to only show current user's requests (even if admin can see all)
                    let myRequests = response.requests;
                    if (currentUserId !== null) {
                        myRequests = response.requests.filter(req => parseInt(req.user_id) === currentUserId);
                        console.log('Filtered requests: showing', myRequests.length, 'out of', response.requests.length, 'for user', currentUserId);
                    }
                    displayMyRequests(myRequests);
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('myRequestsList').innerHTML = '<div class="error">Error loading requests</div>';
            }
        }
        
        function displayMyRequests(requests) {
            const container = document.getElementById('myRequestsList');
            
            if (requests.length === 0) {
                container.innerHTML = '<div class="info">No holiday requests yet</div>';
                return;
            }
            
            // Sort by start date (most recent first)
            requests.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
            
            let html = '<div class="table-wrapper"><table class="data-table"><thead><tr><th style="width: 110px;">Start Date</th><th style="width: 110px;">End Date</th><th style="width: 100px;">Days</th><th style="width: 100px;">Status</th><th style="width: 110px;">Requested</th><th style="width: 110px;">Reviewed</th><th style="min-width: 150px;">Actions</th></tr></thead><tbody>';
            
            requests.forEach(req => {
                const startDate = new Date(req.start_date).toLocaleDateString();
                const endDate = new Date(req.end_date).toLocaleDateString();
                const requestedAt = req.requested_at ? new Date(req.requested_at).toLocaleDateString() : '-';
                const reviewedAt = req.reviewed_at ? new Date(req.reviewed_at).toLocaleDateString() : '-';
                
                let statusClass = 'info';
                if (req.status === 'approved') statusClass = 'success';
                else if (req.status === 'rejected') statusClass = 'danger';
                else if (req.status === 'pending') statusClass = 'warning';
                
                // Show rejection reason on the same line for rejected requests
                const rejectionReason = req.status === 'rejected' && req.review_notes 
                    ? `<div style="margin-top: 4px; font-size: 0.85em; color: #dc3545; font-style: italic;">Reason: ${req.review_notes}</div>`
                    : '';
                
                html += `<tr>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${parseFloat(req.days_requested).toFixed(1)}</strong> weekdays</td>
                    <td>
                        <span class="badge badge-${statusClass}">${req.status.toUpperCase()}</span>
                        ${rejectionReason}
                    </td>
                    <td>${requestedAt}</td>
                    <td>${reviewedAt}</td>
                    <td>
                        ${req.status === 'pending' ? `<button onclick="cancelRequest(${req.id})" class="btn btn-sm btn-danger">Cancel</button>` : ''}
                        ${req.review_notes && req.status !== 'rejected' ? `<button onclick="viewNotes(${req.id}, '${req.review_notes.replace(/'/g, "\\'")}')" class="btn btn-sm btn-secondary">View Notes</button>` : ''}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function cancelRequest(requestId) {
            if (!confirm('Cancel this holiday request?')) return;
            
            try {
                const response = await apiCall(`/holidays/requests/${requestId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        action: 'cancel'
                    })
                });
                
                if (response.success) {
                    await loadMyRequests();
                    await loadAllEntitlements();
                    alert('Request cancelled');
                }
            } catch (error) {
                alert('Error cancelling request: ' + (error.message || 'Unknown error'));
            }
        }
        
        function viewNotes(requestId, notes) {
            alert(`Review Notes:\n\n${notes}`);
        }
        
        init();
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            </div>
            <div class="footer-info">
                <p>&copy; <script>document.write(new Date().getFullYear())</script> Production System. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>

