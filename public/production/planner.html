<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Planner - Production System</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .build-rate-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
        }
        .build-rate-indicator.green {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        .build-rate-indicator.yellow {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        .build-rate-indicator.red {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        .week-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .planner-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        .summary-card p {
            margin: 0;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        .planner-days-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .planner-day-column {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
        }
        .planner-day-column.saturday {
            background: #e3f2fd;
            border-color: #90caf9;
        }
        .planner-day-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
            text-align: center;
        }
        .planner-day-column.saturday .planner-day-header {
            border-bottom-color: #90caf9;
            color: #1976d2;
        }
        .planner-item-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: move;
            position: relative;
        }
        .planner-item-card.multi-day-start {
            border-left: 4px solid #28a745;
        }
        .planner-item-card.multi-day-middle {
            border-left: 4px solid #ffc107;
            background: #fff9e6;
        }
        .planner-item-card.multi-day-end {
            border-right: 4px solid #28a745;
        }
        .planner-item-card.single-day {
            border-left: 4px solid #667eea;
        }
        .planner-item-card.job {
            border-color: #9c27b0;
            border-left: 4px solid #9c27b0;
        }
        .planner-item-card.component {
            border-color: #2196f3;
            border-left: 4px solid #2196f3;
        }
        .planner-item-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .planner-item-details {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .planner-item-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .planner-item-actions button {
            font-size: 11px;
            padding: 4px 8px;
        }
        .day-hours-summary {
            font-size: 12px;
            color: #6c757d;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }
        .unassigned-items {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Production Planner</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <a href="panels.html" class="btn btn-secondary btn-sm">Built Items</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="week-selector">
            <label><strong>Select Week:</strong></label>
            <input type="date" id="weekStartDate" class="form-input" onchange="loadPlanner()">
            <button onclick="createNewWeek()" class="btn btn-primary">New Week</button>
            <button onclick="loadPlanner()" class="btn btn-secondary">Refresh</button>
        </div>
        
        <div id="plannerContent">
            <div class="loading">Select a week to view planner</div>
        </div>
    </div>
    
    <!-- Planner Modal -->
    <div id="plannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="plannerModalTitle">Weekly Planner</h3>
                <button class="modal-close" onclick="hideModal('plannerModal')">&times;</button>
            </div>
            <form id="plannerForm">
                <input type="hidden" id="plannerId">
                <div class="form-group">
                    <label class="form-label">Week Start Date *</label>
                    <input type="date" id="plannerWeekStart" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Staff Available</label>
                    <input type="number" id="plannerStaff" class="form-input" value="1" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Hours Available</label>
                    <input type="number" step="0.5" id="plannerHours" class="form-input" value="40" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="plannerNotes" class="form-input" rows="3"></textarea>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('plannerModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Item Modal -->
    <div id="addPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Item to Planner</h3>
                <button class="modal-close" onclick="hideModal('addPanelModal')">&times;</button>
            </div>
            <form id="addPanelForm" novalidate>
                <div class="form-group">
                    <label class="form-label">Item Type *</label>
                    <select id="itemTypeSelect" class="form-select" required onchange="updateItemSelect()">
                        <option value="">Select item type...</option>
                        <option value="component">Component</option>
                        <option value="built_item">Built Item</option>
                        <option value="job">Job</option>
                    </select>
                </div>
                <div class="form-group" id="itemSelectGroup">
                    <label class="form-label" id="itemSelectLabel">Item *</label>
                    <select id="panelSelect" class="form-select" required>
                        <option value="">Select item type first...</option>
                    </select>
                </div>
                <div class="form-group" id="jobNameGroup" style="display: none;">
                    <label class="form-label">Job Name *</label>
                    <input type="text" id="jobNameInput" class="form-input" placeholder="e.g., Workshop Tidy, Showsite Clean">
                </div>
                <div class="form-group">
                    <label class="form-label" id="quantityLabel">Quantity to Build *</label>
                    <input type="number" step="0.01" id="panelQuantity" class="form-input" required min="0.01">
                    <small style="color: #6c757d;" id="quantityHelp">Quantity of items to build</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="panelPriority" class="form-select">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('addPanelModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Low Stock Panel Selector Modal -->
    <div id="lowStockModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Add Low Stock Built Items</h3>
                <button class="modal-close" onclick="hideModal('lowStockModal')">&times;</button>
            </div>
            <div id="lowStockList">
                <div class="loading">Loading...</div>
            </div>
            <div class="text-right" style="margin-top: 20px;">
                <button type="button" onclick="hideModal('lowStockModal')" class="btn btn-secondary">Cancel</button>
                <button onclick="addSelectedLowStockPanels()" class="btn btn-primary">Add Selected</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let currentPlannerId = null;
        let allPanels = [];
        let allComponents = [];
        let lowStockPanels = [];
        let lowStockComponents = [];
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            
            // Set default week to current week (Monday)
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
            const monday = new Date(today.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            document.getElementById('weekStartDate').value = monday.toISOString().split('T')[0];
            
            await Promise.all([loadAllPanels(), loadAllComponents()]);
            loadPlanner();
        }
        
        async function loadAllPanels() {
            try {
                const data = await apiCall('/panels');
                allPanels = data.panels;
            } catch (error) {
                console.error('Error loading panels:', error);
            }
        }
        
        async function loadAllComponents() {
            try {
                const data = await apiCall('/components');
                allComponents = data.components;
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }
        
        function updateItemSelect() {
            const itemType = document.getElementById('itemTypeSelect').value;
            const select = document.getElementById('panelSelect');
            const label = document.getElementById('itemSelectLabel');
            const itemSelectGroup = document.getElementById('itemSelectGroup');
            const jobNameGroup = document.getElementById('jobNameGroup');
            const quantityLabel = document.getElementById('quantityLabel');
            const quantityHelp = document.getElementById('quantityHelp');
            
            if (itemType === 'job') {
                // Show job name input, hide item select
                itemSelectGroup.style.display = 'none';
                jobNameGroup.style.display = 'block';
                quantityLabel.textContent = 'Hours Required *';
                quantityHelp.textContent = 'Number of hours this job will take';
                select.required = false;
                document.getElementById('jobNameInput').required = true;
            } else {
                // Show item select, hide job name input
                itemSelectGroup.style.display = 'block';
                jobNameGroup.style.display = 'none';
                quantityLabel.textContent = 'Quantity to Build *';
                quantityHelp.textContent = 'Quantity of items to build';
                select.required = true;
                document.getElementById('jobNameInput').required = false;
                
                select.innerHTML = '<option value="">Select item...</option>';
                
                if (itemType === 'component') {
                    label.textContent = 'Component *';
                    allComponents.forEach(comp => {
                        const option = document.createElement('option');
                        option.value = comp.id;
                        option.textContent = `${comp.name} (${parseFloat(comp.labour_hours || 0).toFixed(2)} hrs each)`;
                        select.appendChild(option);
                    });
                } else if (itemType === 'built_item') {
                    label.textContent = 'Built Item *';
                    allPanels.forEach(panel => {
                        const option = document.createElement('option');
                        option.value = panel.id;
                        option.textContent = `${panel.name} (${parseFloat(panel.labour_hours || 0).toFixed(2)} hrs each)`;
                        select.appendChild(option);
                    });
                }
            }
        }
        
        async function loadPlanner() {
            const weekStart = document.getElementById('weekStartDate').value;
            if (!weekStart) {
                document.getElementById('plannerContent').innerHTML = '<p>Please select a week</p>';
                return;
            }
            
            try {
                // Try to get existing planner for this week
                const planners = await apiCall(`/planner?start_date=${weekStart}&end_date=${weekStart}`);
                let planner = planners.planners.find(p => {
                    // Handle both date formats (with or without time)
                    const plannerDate = p.week_start_date.split('T')[0];
                    return plannerDate === weekStart;
                });
                
                if (!planner) {
                    // Create new planner for this week
                    try {
                        const result = await apiCall('/planner', {
                            method: 'POST',
                            body: JSON.stringify({
                                week_start_date: weekStart,
                                staff_available: 1,
                                hours_available: 40
                            })
                        });
                        planner = result.planner;
                    } catch (createError) {
                        // If creation fails (e.g., duplicate), try to fetch again
                        const plannersRetry = await apiCall(`/planner?start_date=${weekStart}&end_date=${weekStart}`);
                        planner = plannersRetry.planners.find(p => {
                            const plannerDate = p.week_start_date.split('T')[0];
                            return plannerDate === weekStart;
                        });
                        if (!planner) {
                            throw createError;
                        }
                    }
                }
                
                currentPlannerId = planner.id;
                await displayPlanner(planner.id);
            } catch (error) {
                console.error('Error loading planner:', error);
                showAlert('Error loading planner: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function displayPlanner(plannerId) {
            try {
                const data = await apiCall(`/planner/${plannerId}`);
                const planner = data.planner;
                const items = data.items || [];
                const buildRate = data.build_rate || {
                    hours_available: parseFloat(planner.hours_available || 0),
                    hours_required: 0,
                    hours_shortfall: 0,
                    hours_excess: parseFloat(planner.hours_available || 0),
                    build_rate_percent: 100,
                    is_feasible: true,
                    indicator: 'green',
                    emoji: 'üòä'
                };
                
                const weekStart = new Date(planner.week_start_date);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                let content = `
                    <div class="card">
                        <div class="card-header">
                            <h2>Week: ${formatDate(weekStart)} - ${formatDate(weekEnd)}</h2>
                            <div>
                                <button onclick="editPlanner(${planner.id})" class="btn btn-secondary btn-sm">Edit Capacity</button>
                                <button onclick="showAddPanelModal()" class="btn btn-primary btn-sm">Add Item</button>
                                <button onclick="showLowStockModal()" class="btn btn-success btn-sm">Add Low Stock</button>
                            </div>
                        </div>
                        
                        <div class="planner-summary">
                            <div class="summary-card">
                                <h4>Staff Available</h4>
                                <p>${planner.staff_available || 1}</p>
                            </div>
                            <div class="summary-card">
                                <h4>Hours Available</h4>
                                <p>${buildRate.hours_available.toFixed(1)}</p>
                            </div>
                            <div class="summary-card">
                                <h4>Hours Required</h4>
                                <p>${buildRate.hours_required.toFixed(1)}</p>
                            </div>
                            <div class="summary-card">
                                <h4>Build Rate</h4>
                                <p>${buildRate.build_rate_percent.toFixed(1)}%</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <div class="build-rate-indicator ${buildRate.indicator}">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold;">${buildRate.build_rate_percent.toFixed(1)}%</div>
                                    <div style="font-size: 14px; font-weight: normal;">
                                        ${buildRate.hours_required > buildRate.hours_available 
                                            ? `${buildRate.hours_shortfall.toFixed(1)} hours short` 
                                            : `${buildRate.hours_excess.toFixed(1)} hours spare`}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${buildRate.hours_required > buildRate.hours_available ? `
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> Scheduled production exceeds available hours by ${buildRate.hours_shortfall.toFixed(1)} hours.
                                Consider reducing quantities, adding staff, or extending the timeline.
                            </div>
                        ` : ''}
                        
                        <h3>Production Schedule</h3>
                        
                        ${items.length === 0 ? '<p>No items scheduled for this week</p>' : `
                            <div class="planner-days-grid">
                                ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map((dayName, dayIndex) => {
                                    const dayItems = items.filter(item => {
                                        const startDay = item.start_day !== null && item.start_day !== undefined ? parseInt(item.start_day) : null;
                                        const endDay = item.end_day !== null && item.end_day !== undefined ? parseInt(item.end_day) : null;
                                        
                                        // If no day assignment, don't show in any column (will show in unassigned)
                                        if (startDay === null && endDay === null) return false;
                                        
                                        // Show item if it spans this day
                                        return dayIndex >= startDay && dayIndex <= (endDay !== null ? endDay : startDay);
                                    });
                                    
                                    const dayHours = dayItems.reduce((total, item) => {
                                        const hoursPerUnit = parseFloat(item.labour_hours || 0);
                                        const qty = parseFloat(item.quantity_to_build || 0);
                                        if (item.item_type === 'job') {
                                            return total + qty; // For jobs, quantity_to_build is hours
                                        }
                                        // Distribute hours across days for multi-day items
                                        const startDay = item.start_day !== null ? parseInt(item.start_day) : 0;
                                        const endDay = item.end_day !== null ? parseInt(item.end_day) : startDay;
                                        const daySpan = (endDay - startDay) + 1;
                                        return total + (hoursPerUnit * qty / daySpan);
                                    }, 0);
                                    
                                    return `
                                        <div class="planner-day-column ${dayIndex === 5 ? 'saturday' : ''}">
                                            <div class="planner-day-header">
                                                ${dayName}
                                                <div class="day-hours-summary">${dayHours.toFixed(1)} hrs</div>
                                            </div>
                                            ${dayItems.length === 0 ? '<p style="color: #6c757d; font-size: 12px; text-align: center; margin-top: 20px;">No items</p>' : ''}
                                            ${dayItems.map(item => {
                                                const hoursPerUnit = parseFloat(item.labour_hours || 0);
                                                const qtyPlanned = parseFloat(item.quantity_to_build || 0);
                                                const qtyBuilt = parseFloat(item.quantity_built || 0);
                                                const hoursUsed = parseFloat(item.hours_used || 0);
                                                const startDay = item.start_day !== null ? parseInt(item.start_day) : null;
                                                const endDay = item.end_day !== null ? parseInt(item.end_day) : null;
                                                const isMultiDay = startDay !== null && endDay !== null && startDay !== endDay;
                                                const isStart = dayIndex === startDay;
                                                const isEnd = dayIndex === endDay;
                                                const isMiddle = isMultiDay && !isStart && !isEnd;
                                                
                                                let cardClass = 'planner-item-card';
                                                if (item.item_type === 'job') cardClass += ' job';
                                                else if (item.item_type === 'component') cardClass += ' component';
                                                
                                                if (isMultiDay) {
                                                    if (isStart) cardClass += ' multi-day-start';
                                                    else if (isEnd) cardClass += ' multi-day-end';
                                                    else if (isMiddle) cardClass += ' multi-day-middle';
                                                } else {
                                                    cardClass += ' single-day';
                                                }
                                                
                                                return `
                                                    <div class="${cardClass}" data-item-id="${item.id}">
                                                        <div class="planner-item-name">
                                                            ${item.item_name || 'Unknown'}
                                                            <span class="badge badge-info" style="font-size: 10px; margin-left: 5px;">
                                                                ${item.item_type === 'component' ? 'C' : item.item_type === 'job' ? 'J' : 'BI'}
                                                            </span>
                                                        </div>
                                                        ${item.item_type !== 'job' ? `
                                                            <div class="planner-item-details">Qty: ${qtyPlanned.toFixed(1)}</div>
                                                            <div class="planner-item-details">Built: ${qtyBuilt.toFixed(1)}</div>
                                                        ` : ''}
                                                        <div class="planner-item-details">Hours: ${hoursPerUnit.toFixed(1)}${item.item_type === 'job' ? '' : '/unit'}</div>
                                                        <div class="planner-item-details">
                                                            Priority: <span class="badge badge-${item.priority === 'high' ? 'danger' : item.priority === 'medium' ? 'warning' : 'info'}" style="font-size: 10px;">${item.priority}</span>
                                                            Status: <span class="badge badge-info" style="font-size: 10px;">${item.status}</span>
                                                        </div>
                                                        ${isMultiDay ? `
                                                            <div class="planner-item-details" style="font-size: 10px; color: #28a745; font-weight: bold;">
                                                                ${isStart ? '‚Üí' : isEnd ? '‚Üê' : '‚Üî'} ${dayIndex === startDay ? 'Start' : dayIndex === endDay ? 'End' : 'Day ' + (dayIndex - startDay + 1)}
                                                            </div>
                                                        ` : ''}
                                                        <div class="planner-item-actions">
                                                            <button onclick="editPlannerItem(${item.id})" class="btn btn-secondary btn-sm">Edit</button>
                                                            ${qtyBuilt > 0 && item.item_type !== 'job' ? `
                                                                <button onclick="addToStock('${item.item_type || 'built_item'}', ${item.item_id_for_movement || item.item_id || item.panel_id}, ${qtyBuilt}, ${item.id}, ${item.hours_used || 0})" class="btn btn-success btn-sm" title="Add to stock">Stock</button>
                                                            ` : ''}
                                                            <button onclick="deletePlannerItem(${item.id})" class="btn btn-danger btn-sm">Remove</button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${items.filter(item => item.start_day === null && item.end_day === null).length > 0 ? `
                                <div class="unassigned-items">
                                    <h4>Unassigned Items</h4>
                                    <p style="font-size: 12px; color: #856404; margin-bottom: 10px;">These items need to be assigned to specific days. Click Edit to assign them.</p>
                                    ${items.filter(item => item.start_day === null && item.end_day === null).map(item => {
                                        const hoursPerUnit = parseFloat(item.labour_hours || 0);
                                        const qtyPlanned = parseFloat(item.quantity_to_build || 0);
                                        return `
                                            <div class="planner-item-card" style="display: inline-block; margin: 5px; min-width: 200px;">
                                                <div class="planner-item-name">${item.item_name || 'Unknown'}</div>
                                                <div class="planner-item-details">Qty: ${qtyPlanned.toFixed(1)} | Hours: ${hoursPerUnit.toFixed(1)}</div>
                                                <div class="planner-item-actions">
                                                    <button onclick="editPlannerItem(${item.id})" class="btn btn-secondary btn-sm">Assign Days</button>
                                                    <button onclick="deletePlannerItem(${item.id})" class="btn btn-danger btn-sm">Remove</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        `}
                        
                        <div style="margin-top: 30px;">
                            <button onclick="showEfficiencyReport(${planner.id})" class="btn btn-primary">View Weekly Report</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('plannerContent').innerHTML = content;
            } catch (error) {
                console.error('Error displaying planner:', error);
                showAlert('Error displaying planner', 'error');
            }
        }
        
        async function createNewWeek() {
            const weekStart = document.getElementById('weekStartDate').value;
            if (!weekStart) {
                showAlert('Please select a week first', 'error');
                return;
            }
            
            try {
                // Check if planner already exists for this week
                const planners = await apiCall(`/planner?start_date=${weekStart}&end_date=${weekStart}`);
                const existingPlanner = planners.planners.find(p => {
                    const plannerDate = p.week_start_date.split('T')[0];
                    return plannerDate === weekStart;
                });
                
                if (existingPlanner) {
                    // Load existing planner for editing
                    await editPlanner(existingPlanner.id);
                    return;
                }
                
                // No existing planner, create new one
                document.getElementById('plannerModalTitle').textContent = 'New Weekly Planner';
                document.getElementById('plannerForm').reset();
                document.getElementById('plannerId').value = '';
                document.getElementById('plannerWeekStart').value = weekStart;
                document.getElementById('plannerStaff').value = 1;
                document.getElementById('plannerHours').value = 40;
                document.getElementById('plannerNotes').value = '';
                showModal('plannerModal');
            } catch (error) {
                console.error('Error checking for existing planner:', error);
                // If check fails, still allow creating new planner
                document.getElementById('plannerModalTitle').textContent = 'New Weekly Planner';
                document.getElementById('plannerForm').reset();
                document.getElementById('plannerId').value = '';
                document.getElementById('plannerWeekStart').value = weekStart;
                document.getElementById('plannerStaff').value = 1;
                document.getElementById('plannerHours').value = 40;
                document.getElementById('plannerNotes').value = '';
                showModal('plannerModal');
            }
        }
        
        async function editPlanner(id) {
            try {
                const data = await apiCall(`/planner/${id}`);
                const planner = data.planner;
                
                document.getElementById('plannerModalTitle').textContent = 'Edit Weekly Planner';
                document.getElementById('plannerId').value = planner.id;
                document.getElementById('plannerWeekStart').value = planner.week_start_date;
                document.getElementById('plannerStaff').value = planner.staff_available;
                document.getElementById('plannerHours').value = planner.hours_available;
                document.getElementById('plannerNotes').value = planner.notes || '';
                showModal('plannerModal');
            } catch (error) {
                showAlert('Error loading planner', 'error');
            }
        }
        
        async function showAddPanelModal() {
            document.getElementById('addPanelForm').reset();
            document.getElementById('itemTypeSelect').value = '';
            document.getElementById('panelSelect').innerHTML = '<option value="">Select item type first...</option>';
            document.getElementById('itemSelectLabel').textContent = 'Item *';
            document.getElementById('itemSelectGroup').style.display = 'block';
            document.getElementById('jobNameGroup').style.display = 'none';
            document.getElementById('quantityLabel').textContent = 'Quantity to Build *';
            document.getElementById('quantityHelp').textContent = 'Quantity of items to build';
            document.getElementById('panelSelect').required = true;
            document.getElementById('jobNameInput').required = false;
            
            // Reload data if empty
            if (allComponents.length === 0) {
                await loadAllComponents();
            }
            if (allPanels.length === 0) {
                await loadAllPanels();
            }
            
            showModal('addPanelModal');
        }
        
        async function showLowStockModal() {
            try {
                const [panelsData, componentsData] = await Promise.all([
                    apiCall('/planner/low-stock-panels'),
                    apiCall('/planner/low-stock-components')
                ]);
                lowStockPanels = panelsData.panels || [];
                lowStockComponents = componentsData.components || [];
                
                const allLowStock = [...lowStockPanels, ...lowStockComponents];
                
                if (allLowStock.length === 0) {
                    document.getElementById('lowStockList').innerHTML = '<p>No items are currently low on stock</p>';
                } else {
                    document.getElementById('lowStockList').innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllLowStock" onchange="toggleAllLowStock()"></th>
                                    <th>Type</th>
                                    <th>Item</th>
                                    <th>Current</th>
                                    <th>Min Stock</th>
                                    <th>Shortfall</th>
                                    <th>Suggested Qty</th>
                                    <th>Hours/Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allLowStock.map(item => `
                                    <tr>
                                        <td><input type="checkbox" class="low-stock-checkbox" 
                                            data-item-type="${item.item_type || 'built_item'}" 
                                            data-item-id="${item.id}" 
                                            data-suggested="${item.suggested_quantity}" 
                                            data-hours="${item.labour_hours || 0}"></td>
                                        <td><span class="badge badge-info">${item.item_type === 'component' ? 'Component' : 'Built Item'}</span></td>
                                        <td><strong>${item.name}</strong></td>
                                        <td>${item.current_quantity.toFixed(2)}</td>
                                        <td>${item.min_stock.toFixed(2)}</td>
                                        <td>${item.shortfall.toFixed(2)}</td>
                                        <td>${item.suggested_quantity}</td>
                                        <td>${parseFloat(item.labour_hours || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                showModal('lowStockModal');
            } catch (error) {
                showAlert('Error loading low stock items', 'error');
            }
        }
        
        function toggleAllLowStock() {
            const selectAll = document.getElementById('selectAllLowStock');
            const checkboxes = document.querySelectorAll('.low-stock-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }
        
        async function addSelectedLowStockPanels() {
            const selected = document.querySelectorAll('.low-stock-checkbox:checked');
            if (selected.length === 0) {
                showAlert('Please select at least one item', 'error');
                return;
            }
            
            try {
                for (const checkbox of selected) {
                    await apiCall(`/planner/${currentPlannerId}/items`, {
                        method: 'POST',
                        body: JSON.stringify({
                            item_type: checkbox.dataset.itemType || 'built_item',
                            item_id: parseInt(checkbox.dataset.itemId),
                            quantity_to_build: parseFloat(checkbox.dataset.suggested),
                            priority: 'high'
                        })
                    });
                }
                showAlert('Items added to planner');
                hideModal('lowStockModal');
                loadPlanner();
            } catch (error) {
                showAlert('Error adding items', 'error');
            }
        }
        
        async function editPlannerItem(id) {
            const data = await apiCall(`/planner/${currentPlannerId}`);
            const item = data.items.find(i => i.id === id);
            if (!item) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Planner Item: ${item.item_name || item.panel_name || 'Unknown'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <form id="editItemForm">
                        <div class="form-group">
                            <label class="form-label">Quantity to Build</label>
                            <input type="number" step="0.01" id="editQtyBuild" class="form-input" value="${item.quantity_to_build}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity Built</label>
                            <input type="number" step="0.01" id="editQtyBuilt" class="form-input" value="${item.quantity_built || 0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hours Used</label>
                            <input type="number" step="0.01" id="editHoursUsed" class="form-input" value="${item.hours_used || 0}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select id="editPriority" class="form-select">
                                <option value="high" ${item.priority === 'high' ? 'selected' : ''}>High</option>
                                <option value="medium" ${item.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                <option value="low" ${item.priority === 'low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="editStatus" class="form-select">
                                <option value="planned" ${item.status === 'planned' ? 'selected' : ''}>Planned</option>
                                <option value="in_progress" ${item.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${item.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Day</label>
                            <select id="editStartDay" class="form-select">
                                <option value="">Not assigned</option>
                                <option value="0" ${item.start_day === 0 ? 'selected' : ''}>Monday</option>
                                <option value="1" ${item.start_day === 1 ? 'selected' : ''}>Tuesday</option>
                                <option value="2" ${item.start_day === 2 ? 'selected' : ''}>Wednesday</option>
                                <option value="3" ${item.start_day === 3 ? 'selected' : ''}>Thursday</option>
                                <option value="4" ${item.start_day === 4 ? 'selected' : ''}>Friday</option>
                                <option value="5" ${item.start_day === 5 ? 'selected' : ''}>Saturday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Day</label>
                            <select id="editEndDay" class="form-select">
                                <option value="">Not assigned</option>
                                <option value="0" ${item.end_day === 0 ? 'selected' : ''}>Monday</option>
                                <option value="1" ${item.end_day === 1 ? 'selected' : ''}>Tuesday</option>
                                <option value="2" ${item.end_day === 2 ? 'selected' : ''}>Wednesday</option>
                                <option value="3" ${item.end_day === 3 ? 'selected' : ''}>Thursday</option>
                                <option value="4" ${item.end_day === 4 ? 'selected' : ''}>Friday</option>
                                <option value="5" ${item.end_day === 5 ? 'selected' : ''}>Saturday</option>
                            </select>
                            <small style="color: #6c757d;">Leave empty or same as start day for single day. Set end day to span multiple days.</small>
                        </div>
                        <div class="text-right">
                            <button type="button" onclick="this.closest('.modal').remove()" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('editItemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const startDay = document.getElementById('editStartDay').value;
                    const endDay = document.getElementById('editEndDay').value;
                    
                    // If start day is set but end day is not, set end day to start day (single day)
                    const finalStartDay = startDay !== '' ? parseInt(startDay) : null;
                    const finalEndDay = endDay !== '' ? parseInt(endDay) : (finalStartDay !== null ? finalStartDay : null);
                    
                    await apiCall(`/planner/items/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            quantity_to_build: parseFloat(document.getElementById('editQtyBuild').value),
                            quantity_built: parseFloat(document.getElementById('editQtyBuilt').value),
                            hours_used: parseFloat(document.getElementById('editHoursUsed').value),
                            priority: document.getElementById('editPriority').value,
                            status: document.getElementById('editStatus').value,
                            start_day: finalStartDay,
                            end_day: finalEndDay
                        })
                    });
                    showAlert('Item updated');
                    modal.remove();
                    loadPlanner();
                } catch (error) {
                    showAlert('Error updating item: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        async function showEfficiencyReport(plannerId) {
            try {
                const data = await apiCall(`/planner/${plannerId}`);
                const efficiency = await apiCall(`/planner/${plannerId}/efficiency`);
                const buildRate = await apiCall(`/planner/${plannerId}/build-rate`);
                const planner = data.planner;
                const items = data.items || [];
                
                const weekStart = new Date(planner.week_start_date);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // Calculate status and priority breakdowns
                const statusCounts = { planned: 0, in_progress: 0, completed: 0 };
                const priorityCounts = { high: 0, medium: 0, low: 0 };
                const builtItemCount = items.filter(item => item.item_type === 'built_item' || !item.item_type).length;
                const componentCount = items.filter(item => item.item_type === 'component').length;
                const jobCount = items.filter(item => item.item_type === 'job').length;
                
                items.forEach(item => {
                    if (item.status) statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                    if (item.priority) priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
                });
                
                const completionRate = efficiency.efficiency.panels_planned > 0 
                    ? (efficiency.efficiency.panels_built / efficiency.efficiency.panels_planned) * 100 
                    : 0;
                
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.style.maxWidth = '1000px';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Weekly Production Report</h3>
                            <div>
                                <button onclick="generatePDFReport(${plannerId})" class="btn btn-primary btn-sm" style="margin-right: 10px;">
                                    üì• Download PDF
                                </button>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <h4 style="margin-bottom: 20px; color: #2c3e50;">Week: ${formatDate(weekStart)} - ${formatDate(weekEnd)}</h4>
                            
                            <div style="margin-bottom: 30px;">
                                <h5 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">Key Metrics</h5>
                                <div class="planner-summary">
                                    <div class="summary-card">
                                        <h4>Hours Available</h4>
                                        <p>${formatHours(efficiency.efficiency.hours_available)}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Hours Planned</h4>
                                        <p>${formatHours(efficiency.efficiency.hours_planned)}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Hours Used</h4>
                                        <p>${formatHours(efficiency.efficiency.hours_used)}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Hours Spare</h4>
                                        <p style="color: ${buildRate.build_rate.hours_excess > 0 ? '#28a745' : '#dc3545'}">
                                            ${formatHours(buildRate.build_rate.hours_excess)}
                                        </p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Built Items Planned</h4>
                                        <p>${efficiency.efficiency.panels_planned.toFixed(1)}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Built Items Built</h4>
                                        <p>${efficiency.efficiency.panels_built.toFixed(1)}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Components Planned</h4>
                                        <p>${componentCount}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Components Built</h4>
                                        <p>${items.filter(item => item.item_type === 'component' && item.status === 'completed').length}</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Completion Rate</h4>
                                        <p>${completionRate.toFixed(1)}%</p>
                                    </div>
                                    <div class="summary-card">
                                        <h4>Staff Available</h4>
                                        <p>${planner.staff_available || 1}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h5 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">Performance Indicators</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div style="text-align: center;">
                                        <div class="build-rate-indicator ${buildRate.build_rate.indicator}">
                                            <div>
                                                <div style="font-size: 20px; font-weight: bold;">Build Rate: ${buildRate.build_rate.build_rate_percent.toFixed(1)}%</div>
                                                <div style="font-size: 12px; font-weight: normal; margin-top: 8px;">
                                                    ${buildRate.build_rate.hours_shortfall > 0 
                                                        ? `${formatHours(buildRate.build_rate.hours_shortfall)} short` 
                                                        : `${formatHours(buildRate.build_rate.hours_excess)} spare`}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div class="build-rate-indicator ${efficiency.efficiency.indicator}">
                                            <div>
                                                <div style="font-size: 20px; font-weight: bold;">Efficiency: ${efficiency.efficiency.overall_efficiency.toFixed(1)}%</div>
                                                <div style="font-size: 12px; font-weight: normal; margin-top: 8px;">
                                                    Hours: ${efficiency.efficiency.hours_efficiency.toFixed(1)}% | 
                                                    Built Items: ${efficiency.efficiency.panels_efficiency.toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <h5 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">Breakdowns</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h6 style="margin-bottom: 10px; color: #495057;">Item Type Breakdown</h6>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <div style="margin-bottom: 8px;"><strong>Built Items:</strong> ${builtItemCount}</div>
                                            <div style="margin-bottom: 8px;"><strong>Components:</strong> ${componentCount}</div>
                                            <div><strong>Jobs:</strong> ${jobCount}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6 style="margin-bottom: 10px; color: #495057;">Status Breakdown</h6>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <div style="margin-bottom: 8px;"><strong>Planned:</strong> ${statusCounts.planned || 0} items</div>
                                            <div style="margin-bottom: 8px;"><strong>In Progress:</strong> ${statusCounts.in_progress || 0} items</div>
                                            <div><strong>Completed:</strong> ${statusCounts.completed || 0} items</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h6 style="margin-bottom: 10px; color: #495057;">Priority Breakdown</h6>
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <div style="margin-bottom: 8px;"><strong>High:</strong> ${priorityCounts.high || 0} items</div>
                                            <div style="margin-bottom: 8px;"><strong>Medium:</strong> ${priorityCounts.medium || 0} items</div>
                                            <div><strong>Low:</strong> ${priorityCounts.low || 0} items</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${planner.notes ? `
                                <div style="margin-bottom: 30px;">
                                    <h5 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">Notes</h5>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        ${escapeHtml(planner.notes)}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div>
                                <h5 style="color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 5px;">Production Details</h5>
                                ${items.length === 0 ? '<p>No items in this week\'s planner</p>' : `
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Item Name</th>
                                                <th>Type</th>
                                                <th>Planned</th>
                                                <th>Built</th>
                                                <th>Hours Used</th>
                                                <th>Priority</th>
                                                <th>Status</th>
                                                <th>Efficiency</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map(item => {
                                                const qtyPlanned = parseFloat(item.quantity_to_build || 0);
                                                const qtyBuilt = parseFloat(item.quantity_built || 0);
                                                const hoursUsed = parseFloat(item.hours_used || 0);
                                                const hoursPerUnit = parseFloat(item.labour_hours || 0);
                                                const expectedHours = hoursPerUnit * qtyBuilt;
                                                const itemEfficiency = expectedHours > 0 ? (expectedHours / hoursUsed) * 100 : 0;
                                                const itemIndicator = itemEfficiency >= 95 ? 'green' : (itemEfficiency >= 80 ? 'yellow' : 'red');
                                                
                                                // Determine item type label
                                                let itemTypeLabel = 'Built Item';
                                                if (item.item_type === 'component') {
                                                    itemTypeLabel = 'Component';
                                                } else if (item.item_type === 'job') {
                                                    itemTypeLabel = 'Job';
                                                }
                                                
                                                // Get item name
                                                const itemName = item.item_name || item.panel_name || item.job_name || 'Unknown';
                                                
                                                return `
                                                    <tr>
                                                        <td><strong>${itemName}</strong></td>
                                                        <td><span class="badge badge-info">${itemTypeLabel}</span></td>
                                                        <td>${qtyPlanned.toFixed(2)}</td>
                                                        <td>${qtyBuilt.toFixed(2)}</td>
                                                        <td>${formatHours(hoursUsed)}</td>
                                                        <td><span class="badge badge-${item.priority === 'high' ? 'danger' : item.priority === 'medium' ? 'warning' : 'info'}">${item.priority || 'N/A'}</span></td>
                                                        <td><span class="badge badge-info">${item.status || 'N/A'}</span></td>
                                                        <td>
                                                            <span class="badge badge-${itemIndicator === 'green' ? 'success' : itemIndicator === 'yellow' ? 'warning' : 'danger'}">
                                                                ${itemEfficiency.toFixed(1)}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading efficiency report:', error);
                showAlert('Error loading efficiency report: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function generatePDFReport(plannerId) {
            try {
                // Fetch all required data
                const data = await apiCall(`/planner/${plannerId}`);
                const efficiency = await apiCall(`/planner/${plannerId}/efficiency`);
                const buildRate = await apiCall(`/planner/${plannerId}/build-rate`);
                const planner = data.planner;
                const items = data.items || [];
                
                const weekStart = new Date(planner.week_start_date);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // Calculate breakdowns
                const statusCounts = { planned: 0, in_progress: 0, completed: 0 };
                const priorityCounts = { high: 0, medium: 0, low: 0 };
                items.forEach(item => {
                    if (item.status) statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                    if (item.priority) priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
                });
                
                // Calculate item counts by type
                const builtItemCount = items.filter(item => item.item_type === 'built_item' || !item.item_type).length;
                const componentCount = items.filter(item => item.item_type === 'component').length;
                const jobCount = items.filter(item => item.item_type === 'job').length;
                
                const completionRate = efficiency.efficiency.panels_planned > 0 
                    ? (efficiency.efficiency.panels_built / efficiency.efficiency.panels_planned) * 100 
                    : 0;
                
                // Initialize PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Header
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('Weekly Production Report', 105, yPos, { align: 'center' });
                yPos += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Week: ${formatDate(weekStart)} - ${formatDate(weekEnd)}`, 105, yPos, { align: 'center' });
                yPos += 15;
                
                // Key Metrics Section
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Key Metrics', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const metrics = [
                    ['Hours Available', formatHours(efficiency.efficiency.hours_available)],
                    ['Hours Planned', formatHours(efficiency.efficiency.hours_planned)],
                    ['Hours Used', formatHours(efficiency.efficiency.hours_used)],
                    ['Hours Spare', formatHours(buildRate.build_rate.hours_excess)],
                    ['Built Items Planned', efficiency.efficiency.panels_planned.toFixed(1)],
                    ['Built Items Built', efficiency.efficiency.panels_built.toFixed(1)],
                    ['Components Planned', componentCount.toString()],
                    ['Components Built', items.filter(item => item.item_type === 'component' && item.status === 'completed').length.toString()],
                    ['Completion Rate', completionRate.toFixed(1) + '%'],
                    ['Staff Available', (planner.staff_available || 1).toString()]
                ];
                
                let xPos = 14;
                metrics.forEach((metric, index) => {
                    if (index % 2 === 0 && index > 0) {
                        xPos = 14;
                        yPos += 7;
                    }
                    doc.setFont(undefined, 'bold');
                    doc.text(metric[0] + ':', xPos, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.text(metric[1], xPos + 55, yPos);
                    if (index % 2 === 0) {
                        xPos = 105;
                    }
                });
                yPos += 15;
                
                // Performance Indicators
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Performance Indicators', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Build Rate: ${buildRate.build_rate.build_rate_percent.toFixed(1)}%`, 14, yPos);
                doc.text(buildRate.build_rate.hours_shortfall > 0 
                    ? `Hours Short: ${formatHours(buildRate.build_rate.hours_shortfall)}` 
                    : `Hours Spare: ${formatHours(buildRate.build_rate.hours_excess)}`, 14, yPos + 5);
                yPos += 10;
                
                doc.text(`Overall Efficiency: ${efficiency.efficiency.overall_efficiency.toFixed(1)}%`, 14, yPos);
                doc.text(`Hours Efficiency: ${efficiency.efficiency.hours_efficiency.toFixed(1)}%`, 14, yPos + 5);
                doc.text(`Built Items Efficiency: ${efficiency.efficiency.panels_efficiency.toFixed(1)}%`, 14, yPos + 10);
                yPos += 18;
                
                // Breakdowns
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Breakdowns', 14, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Item Type Breakdown:', 14, yPos);
                doc.text(`  Built Items: ${builtItemCount}`, 20, yPos + 5);
                doc.text(`  Components: ${componentCount}`, 20, yPos + 10);
                doc.text(`  Jobs: ${jobCount}`, 20, yPos + 15);
                yPos += 25;
                
                doc.text('Status Breakdown:', 14, yPos);
                doc.text(`  Planned: ${statusCounts.planned || 0} items`, 20, yPos + 5);
                doc.text(`  In Progress: ${statusCounts.in_progress || 0} items`, 20, yPos + 10);
                doc.text(`  Completed: ${statusCounts.completed || 0} items`, 20, yPos + 15);
                yPos += 25;
                
                doc.text('Priority Breakdown:', 14, yPos);
                doc.text(`  High: ${priorityCounts.high || 0} items`, 20, yPos + 5);
                doc.text(`  Medium: ${priorityCounts.medium || 0} items`, 20, yPos + 10);
                doc.text(`  Low: ${priorityCounts.low || 0} items`, 20, yPos + 15);
                yPos += 20;
                
                // Notes
                if (planner.notes) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Notes', 14, yPos);
                    yPos += 8;
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const notesLines = doc.splitTextToSize(planner.notes, 180);
                    doc.text(notesLines, 14, yPos);
                    yPos += notesLines.length * 5 + 5;
                }
                
                // Production Details Table
                if (items.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Production Details', 14, yPos);
                    yPos += 5;
                    
                    const tableData = items.map(item => {
                        const qtyPlanned = parseFloat(item.quantity_to_build || 0);
                        const qtyBuilt = parseFloat(item.quantity_built || 0);
                        const hoursUsed = parseFloat(item.hours_used || 0);
                        const hoursPerUnit = parseFloat(item.labour_hours || 0);
                        const expectedHours = hoursPerUnit * qtyBuilt;
                        const itemEfficiency = expectedHours > 0 ? (expectedHours / hoursUsed) * 100 : 0;
                        
                        // Determine item type label
                        let itemTypeLabel = 'Built Item';
                        if (item.item_type === 'component') {
                            itemTypeLabel = 'Component';
                        } else if (item.item_type === 'job') {
                            itemTypeLabel = 'Job';
                        }
                        
                        // Get item name - use item_name if available, otherwise panel_name, otherwise job_name
                        const itemName = item.item_name || item.panel_name || item.job_name || 'N/A';
                        
                        return [
                            itemName,
                            itemTypeLabel,
                            qtyPlanned.toFixed(2),
                            qtyBuilt.toFixed(2),
                            formatHours(hoursUsed),
                            item.priority || 'N/A',
                            item.status || 'N/A',
                            itemEfficiency.toFixed(1) + '%'
                        ];
                    });
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Item Name', 'Type', 'Planned', 'Built', 'Hours Used', 'Priority', 'Status', 'Efficiency']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: { fillColor: [102, 126, 234], textColor: 255, fontStyle: 'bold' },
                        styles: { fontSize: 9 },
                        margin: { left: 14, right: 14 },
                        columnStyles: {
                            4: { cellWidth: 35 } // Hours Used column wider for hours/mins format
                        }
                    });
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'italic');
                    doc.text(
                        `Generated: ${new Date().toLocaleString()} - Page ${i} of ${pageCount}`,
                        105,
                        doc.internal.pageSize.height - 10,
                        { align: 'center' }
                    );
                }
                
                // Save PDF
                const fileName = `Weekly_Report_${weekStart.toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showAlert('PDF report generated successfully', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showAlert('Error generating PDF: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function deletePlannerItem(id) {
            if (!confirm('Remove this panel from the planner?')) return;
            
            try {
                await apiCall(`/planner/items/${id}`, { method: 'DELETE' });
                showAlert('Panel removed');
                loadPlanner();
            } catch (error) {
                showAlert('Error removing panel', 'error');
            }
        }
        
        document.getElementById('plannerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('plannerId').value;
            const weekStart = document.getElementById('plannerWeekStart').value;
            
            if (!weekStart) {
                showAlert('Week start date is required', 'error');
                return;
            }
            
            const data = {
                week_start_date: weekStart,
                staff_available: parseInt(document.getElementById('plannerStaff').value) || 1,
                hours_available: parseFloat(document.getElementById('plannerHours').value) || 40,
                notes: document.getElementById('plannerNotes').value || ''
            };
            
            try {
                if (id) {
                    // Editing existing planner
                    await apiCall(`/planner/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    // Creating new planner - check if one already exists first
                    try {
                        const planners = await apiCall(`/planner?start_date=${weekStart}&end_date=${weekStart}`);
                        const existingPlanner = planners.planners.find(p => {
                            const plannerDate = p.week_start_date.split('T')[0];
                            return plannerDate === weekStart;
                        });
                        
                        if (existingPlanner) {
                            // Update existing planner instead
                            await apiCall(`/planner/${existingPlanner.id}`, {
                                method: 'PUT',
                                body: JSON.stringify(data)
                            });
                        } else {
                            // Create new planner
                            await apiCall('/planner', {
                                method: 'POST',
                                body: JSON.stringify(data)
                            });
                        }
                    } catch (createError) {
                        // If creation fails with duplicate error, try to update existing
                        if (createError.message && createError.message.includes('already exists')) {
                            const planners = await apiCall(`/planner?start_date=${weekStart}&end_date=${weekStart}`);
                            const existingPlanner = planners.planners.find(p => {
                                const plannerDate = p.week_start_date.split('T')[0];
                                return plannerDate === weekStart;
                            });
                            if (existingPlanner) {
                                await apiCall(`/planner/${existingPlanner.id}`, {
                                    method: 'PUT',
                                    body: JSON.stringify(data)
                                });
                            } else {
                                throw createError;
                            }
                        } else {
                            throw createError;
                        }
                    }
                }
                showAlert('Planner saved');
                hideModal('plannerModal');
                loadPlanner();
            } catch (error) {
                const errorMsg = error.message || 'Failed to save planner';
                showAlert(errorMsg, 'error');
                console.error('Planner save error:', error);
            }
        });
        
        document.getElementById('addPanelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentPlannerId) {
                showAlert('Please select a week first', 'error');
                return;
            }
            
            try {
                const itemType = document.getElementById('itemTypeSelect').value;
                
                if (!itemType) {
                    showAlert('Please select item type', 'error');
                    return;
                }
                
                const quantityInput = document.getElementById('panelQuantity');
                const quantity = parseFloat(quantityInput.value);
                if (!quantity || quantity <= 0) {
                    showAlert('Please enter a valid quantity greater than 0', 'error');
                    return;
                }
                
                let requestBody = {
                    item_type: itemType,
                    quantity_to_build: quantity,
                    priority: document.getElementById('panelPriority').value
                };
                
                if (itemType === 'job') {
                    const jobName = document.getElementById('jobNameInput').value.trim();
                    if (!jobName) {
                        showAlert('Please enter a job name', 'error');
                        return;
                    }
                    requestBody.job_name = jobName;
                } else {
                    const panelSelect = document.getElementById('panelSelect');
                    const itemId = parseInt(panelSelect.value);
                    if (!itemId || isNaN(itemId)) {
                        const itemTypeName = itemType === 'component' ? 'component' : 'built item';
                        showAlert(`Please select a ${itemTypeName}`, 'error');
                        return;
                    }
                    requestBody.item_id = itemId;
                    
                    // Verify the selected item exists in our loaded data
                    if (itemType === 'component') {
                        const component = allComponents.find(c => c.id === itemId);
                        if (!component) {
                            showAlert('Selected component not found. Please refresh and try again.', 'error');
                            return;
                        }
                    } else if (itemType === 'built_item') {
                        const panel = allPanels.find(p => p.id === itemId);
                        if (!panel) {
                            showAlert('Selected built item not found. Please refresh and try again.', 'error');
                            return;
                        }
                    }
                }
                
                console.log('Submitting planner item:', requestBody);
                const result = await apiCall(`/planner/${currentPlannerId}/items`, {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });
                console.log('Planner item added successfully:', result);
                showAlert('Item added to planner');
                hideModal('addPanelModal');
                loadPlanner();
            } catch (error) {
                console.error('Error adding planner item:', error);
                const errorMessage = error.message || 'Failed to add item to planner. Please check the console for details.';
                showAlert(errorMessage, 'error');
            }
        });
        
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        // Format hours as hours and minutes (e.g., "5hrs 30mins")
        function formatHours(hours) {
            if (!hours || isNaN(hours) || hours === 0) {
                return '0hrs 0mins';
            }
            const hoursFloat = parseFloat(hours);
            const wholeHours = Math.floor(hoursFloat);
            const minutes = Math.round((hoursFloat - wholeHours) * 60);
            
            if (wholeHours === 0) {
                return `${minutes}mins`;
            } else if (minutes === 0) {
                return `${wholeHours}hrs`;
            } else {
                return `${wholeHours}hrs ${minutes}mins`;
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function addToStock(itemType, itemId, quantity, plannerItemId, hoursUsed) {
            const itemTypeName = itemType === 'component' ? 'component' : 'built item';
            if (!confirm(`Add ${quantity.toFixed(2)} units to ${itemTypeName} stock, mark as completed, and remove from planner?\n\nHours used (${hoursUsed.toFixed(2)}) will be deducted from available hours.`)) {
                return;
            }
            
            try {
                // First, get the planner item to get planner_id
                const plannerData = await apiCall(`/planner/${currentPlannerId}`);
                const item = plannerData.items.find(i => i.id === plannerItemId);
                if (!item) {
                    throw new Error('Planner item not found');
                }
                
                // Mark the planner item as completed
                await apiCall(`/planner/items/${plannerItemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        quantity_to_build: parseFloat(item.quantity_to_build || 0),
                        quantity_built: parseFloat(item.quantity_built || 0),
                        hours_used: parseFloat(hoursUsed || 0),
                        priority: item.priority,
                        status: 'completed'
                    })
                });
                
                // Get current planner to calculate new hours_available
                const planner = plannerData.planner;
                const currentHoursAvailable = parseFloat(planner.hours_available || 0);
                const hoursToDeduct = parseFloat(hoursUsed || 0);
                const newHoursAvailable = Math.max(0, currentHoursAvailable - hoursToDeduct);
                
                // Update planner hours_available
                await apiCall(`/planner/${currentPlannerId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        staff_available: parseInt(planner.staff_available || 1),
                        hours_available: newHoursAvailable,
                        notes: planner.notes || ''
                    })
                });
                
                // Record movement to add to stock (component or built item)
                if (itemType === 'component') {
                    await apiCall(`/components/${itemId}/movement`, {
                        method: 'POST',
                        body: JSON.stringify({
                            movement_type: 'build',
                            quantity: quantity,
                            reference: `Planner Item #${plannerItemId}`
                        })
                    });
                } else {
                    await apiCall(`/panels/${itemId}/movement`, {
                        method: 'POST',
                        body: JSON.stringify({
                            movement_type: 'build',
                            quantity: quantity,
                            reference: `Planner Item #${plannerItemId}`
                        })
                    });
                }
                
                // Remove the planner item after successfully adding to stock
                await apiCall(`/planner/items/${plannerItemId}`, { method: 'DELETE' });
                
                showAlert(`Added ${quantity.toFixed(2)} units to ${itemTypeName} stock, marked as completed, and deducted ${hoursToDeduct.toFixed(2)} hours from available hours`, 'success');
                // Reload planner to refresh data
                loadPlanner();
            } catch (error) {
                console.error('Error adding to stock:', error);
                showAlert('Error adding to stock: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        init();
    </script>
</body>
</html>

