<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Check Reminders - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Stock Check Reminders</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Reminders</h2>
                <button onclick="showAddReminderModal()" class="btn btn-primary admin-only">Add Reminder</button>
            </div>
            <div id="remindersList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Reminder Modal -->
    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reminderModalTitle">Add Reminder</h3>
                <button class="modal-close" onclick="hideModal('reminderModal')">&times;</button>
            </div>
            <form id="reminderForm">
                <input type="hidden" id="reminderId">
                <div class="form-group">
                    <label class="form-label">Reminder Type *</label>
                    <select id="reminderType" class="form-select" required onchange="updateReminderTypeFields()">
                        <option value="stock_check">Stock Item Reminder</option>
                        <option value="text">Text Reminder</option>
                    </select>
                </div>
                <div class="form-group" id="reminderStockItemGroup">
                    <label class="form-label">Stock Item *</label>
                    <select id="reminderStockItem" class="form-select">
                        <option value="">Select stock item</option>
                    </select>
                </div>
                <div class="form-group" id="reminderTextGroup" style="display: none;">
                    <label class="form-label">Reminder Text *</label>
                    <textarea id="reminderText" class="form-input" rows="3" placeholder="Enter reminder text..."></textarea>
                </div>
                <div class="form-group" id="reminderFrequencyGroup">
                    <label class="form-label">Check Frequency (Days) *</label>
                    <input type="number" id="reminderFrequency" class="form-input" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Checked Date</label>
                    <input type="date" id="reminderLastChecked" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Next Check Date</label>
                    <input type="date" id="reminderNextCheck" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Assign To *</label>
                    <select id="reminderAssignTo" class="form-select" required onchange="updateAssignmentFields()">
                        <option value="myself">Myself</option>
                        <option value="user" id="assignToUserOption" style="display: none;">Specific User</option>
                        <option value="role" id="assignToRoleOption" style="display: none;">By Role</option>
                        <option value="all" id="assignToAllOption" style="display: none;">All Users</option>
                    </select>
                </div>
                <div class="form-group" id="reminderUserGroup" style="display: none;">
                    <label class="form-label">User</label>
                    <select id="reminderUserId" class="form-select">
                        <option value="">Select user</option>
                    </select>
                </div>
                <div class="form-group" id="reminderRoleGroup" style="display: none;">
                    <label class="form-label">Role</label>
                    <select id="reminderTargetRole" class="form-select">
                        <option value="">Select role</option>
                        <option value="staff">Staff</option>
                        <option value="office">Office</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reminderActive" checked> Active
                    </label>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('reminderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let stockItems = [];
        
        let allUsers = [];
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await loadStockItems();
            await loadUsers();
            loadReminders();
            updateAssignmentOptions();
        }
        
        async function loadUsers() {
            try {
                const data = await apiCall('/users');
                allUsers = data.users || [];
                
                // Populate user dropdown
                const userSelect = document.getElementById('reminderUserId');
                userSelect.innerHTML = '<option value="">Select user</option>';
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        function updateAssignmentOptions() {
            if (!currentUser) return;
            
            const assignToSelect = document.getElementById('reminderAssignTo');
            const assignToUserOption = document.getElementById('assignToUserOption');
            const assignToRoleOption = document.getElementById('assignToRoleOption');
            const assignToAllOption = document.getElementById('assignToAllOption');
            
            if (currentUser.role === 'admin') {
                assignToUserOption.style.display = 'block';
                assignToRoleOption.style.display = 'block';
                assignToAllOption.style.display = 'block';
            } else {
                // Non-admins can only assign to themselves
                assignToSelect.value = 'myself';
                assignToSelect.disabled = true;
            }
        }
        
        function updateAssignmentFields() {
            const assignTo = document.getElementById('reminderAssignTo').value;
            const userGroup = document.getElementById('reminderUserGroup');
            const roleGroup = document.getElementById('reminderRoleGroup');
            
            userGroup.style.display = assignTo === 'user' ? 'block' : 'none';
            roleGroup.style.display = assignTo === 'role' ? 'block' : 'none';
            
            if (assignTo !== 'user') {
                document.getElementById('reminderUserId').value = '';
            }
            if (assignTo !== 'role') {
                document.getElementById('reminderTargetRole').value = '';
            }
        }
        
        function updateReminderTypeFields() {
            const reminderType = document.getElementById('reminderType').value;
            const stockItemGroup = document.getElementById('reminderStockItemGroup');
            const reminderTextGroup = document.getElementById('reminderTextGroup');
            const frequencyGroup = document.getElementById('reminderFrequencyGroup');
            const stockItemSelect = document.getElementById('reminderStockItem');
            const reminderText = document.getElementById('reminderText');
            const frequency = document.getElementById('reminderFrequency');
            
            if (reminderType === 'stock_check') {
                stockItemGroup.style.display = 'block';
                reminderTextGroup.style.display = 'none';
                frequencyGroup.style.display = 'block';
                stockItemSelect.required = true;
                reminderText.required = false;
                frequency.required = true;
            } else {
                stockItemGroup.style.display = 'none';
                reminderTextGroup.style.display = 'block';
                frequencyGroup.style.display = 'none';
                stockItemSelect.required = false;
                reminderText.required = true;
                frequency.required = false;
            }
        }
        
        async function loadStockItems() {
            try {
                const data = await apiCall('/stock');
                stockItems = data.items;
                
                const select = document.getElementById('reminderStockItem');
                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading stock items:', error);
            }
        }
        
        async function loadReminders() {
            try {
                const data = await apiCall('/reminders');
                const remindersList = document.getElementById('remindersList');
                
                if (data.reminders.length === 0) {
                    remindersList.innerHTML = '<p>No reminders found</p>';
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                remindersList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Reminder</th>
                                <th>Frequency</th>
                                <th>Last Checked</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.reminders.map(reminder => {
                                const isOverdue = reminder.next_check_date && reminder.next_check_date < today;
                                const isActive = reminder.is_active === true || reminder.is_active === 1;
                                const reminderType = reminder.reminder_type || 'stock_check';
                                
                                // Determine assignment display
                                let assignmentText = '';
                                if (reminder.assigned_user_name) {
                                    assignmentText = `User: ${reminder.assigned_user_name}`;
                                } else if (reminder.target_role) {
                                    assignmentText = `Role: ${reminder.target_role}`;
                                } else if (!reminder.user_id && !reminder.target_role) {
                                    assignmentText = 'All Users';
                                } else {
                                    assignmentText = 'Myself';
                                }
                                
                                const canEdit = currentUser.role === 'admin' || reminder.created_by_user_id === currentUser.id;
                                
                                // Display reminder content
                                let reminderContent = '';
                                if (reminderType === 'text') {
                                    reminderContent = `<strong>üìù ${reminder.reminder_text || 'Text Reminder'}</strong><br><small style="color: #666;">${assignmentText}</small>`;
                                } else {
                                    reminderContent = `<strong>${reminder.stock_item_name || 'Stock Item'}</strong><br><small style="color: #666;">${assignmentText}</small>`;
                                }
                                
                                return `
                                    <tr>
                                        <td>
                                            ${reminderContent}
                                        </td>
                                        <td>${reminderType === 'text' ? 'One-time' : `Every ${reminder.check_frequency_days || 0} days`}</td>
                                        <td>${formatDate(reminder.last_checked_date)}</td>
                                        <td>${formatDate(reminder.next_check_date)}</td>
                                        <td>
                                            ${isOverdue && isActive ? '<span class="badge badge-danger">Overdue</span>' : ''}
                                            ${!isActive ? '<span class="badge badge-warning">Inactive</span>' : '<span class="badge badge-success">Active</span>'}
                                        </td>
                                        <td>
                                            <button onclick="markChecked(${reminder.id})" class="btn btn-success btn-sm">Mark Checked</button>
                                            ${canEdit ? `
                                                <button onclick="editReminder(${reminder.id})" class="btn btn-secondary btn-sm">Edit</button>
                                                <button onclick="deleteReminder(${reminder.id})" class="btn btn-danger btn-sm">Delete</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('remindersList').innerHTML = '<p>Error loading reminders</p>';
            }
        }
        
        function showAddReminderModal() {
            document.getElementById('reminderModalTitle').textContent = 'Add Reminder';
            document.getElementById('reminderForm').reset();
            document.getElementById('reminderId').value = '';
            document.getElementById('reminderActive').checked = true;
            document.getElementById('reminderType').value = 'stock_check';
            document.getElementById('reminderAssignTo').value = currentUser.role === 'admin' ? 'myself' : 'myself';
            updateReminderTypeFields();
            updateAssignmentFields();
            showModal('reminderModal');
        }
        
        async function editReminder(id) {
            try {
                const data = await apiCall('/reminders');
                const reminder = data.reminders.find(r => r.id === id);
                if (!reminder) return;
                
                document.getElementById('reminderModalTitle').textContent = 'Edit Reminder';
                document.getElementById('reminderId').value = reminder.id;
                document.getElementById('reminderType').value = reminder.reminder_type || 'stock_check';
                updateReminderTypeFields();
                
                if (reminder.reminder_type === 'text') {
                    document.getElementById('reminderText').value = reminder.reminder_text || '';
                } else {
                    document.getElementById('reminderStockItem').value = reminder.stock_item_id || '';
                    document.getElementById('reminderFrequency').value = reminder.check_frequency_days || '';
                }
                
                document.getElementById('reminderLastChecked').value = reminder.last_checked_date || '';
                document.getElementById('reminderNextCheck').value = reminder.next_check_date || '';
                document.getElementById('reminderActive').checked = reminder.is_active === true || reminder.is_active === 1;
                
                // Set assignment fields
                if (reminder.user_id) {
                    document.getElementById('reminderAssignTo').value = 'user';
                    document.getElementById('reminderUserId').value = reminder.user_id;
                } else if (reminder.target_role) {
                    document.getElementById('reminderAssignTo').value = 'role';
                    document.getElementById('reminderTargetRole').value = reminder.target_role;
                } else if (!reminder.user_id && !reminder.target_role) {
                    document.getElementById('reminderAssignTo').value = 'all';
                } else {
                    document.getElementById('reminderAssignTo').value = 'myself';
                }
                updateAssignmentFields();
                
                showModal('reminderModal');
            } catch (error) {
                showAlert('Error loading reminder', 'error');
            }
        }
        
        async function markChecked(id) {
            try {
                await apiCall(`/reminders/${id}/check`, { method: 'POST' });
                showAlert('Reminder marked as checked');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function deleteReminder(id) {
            if (!confirm('Delete this reminder?')) return;
            try {
                await apiCall(`/reminders/${id}`, { method: 'DELETE' });
                showAlert('Reminder deleted');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        document.getElementById('reminderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('reminderId').value;
            const frequency = parseInt(document.getElementById('reminderFrequency').value);
            const lastChecked = document.getElementById('reminderLastChecked').value;
            let nextCheck = document.getElementById('reminderNextCheck').value;
            
            // Calculate next check date if not provided
            if (!nextCheck && lastChecked) {
                const nextDate = new Date(lastChecked);
                nextDate.setDate(nextDate.getDate() + frequency);
                nextCheck = nextDate.toISOString().split('T')[0];
            } else if (!nextCheck) {
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + frequency);
                nextCheck = nextDate.toISOString().split('T')[0];
            }
            
            const assignTo = document.getElementById('reminderAssignTo').value;
            const userId = document.getElementById('reminderUserId').value;
            const targetRole = document.getElementById('reminderTargetRole').value;
            const reminderType = document.getElementById('reminderType').value;
            const reminderText = document.getElementById('reminderText').value;
            
            const data = {
                reminder_type: reminderType,
                stock_item_id: reminderType === 'stock_check' ? document.getElementById('reminderStockItem').value : null,
                check_frequency_days: reminderType === 'stock_check' ? frequency : null,
                reminder_text: reminderType === 'text' ? reminderText : null,
                last_checked_date: lastChecked || null,
                next_check_date: nextCheck,
                is_active: document.getElementById('reminderActive').checked,
                assign_to: assignTo,
                user_id: assignTo === 'user' ? userId : null,
                target_role: assignTo === 'role' ? targetRole : null
            };
            
            try {
                if (id) {
                    await apiCall(`/reminders/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Reminder updated');
                } else {
                    await apiCall('/reminders', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Reminder created');
                }
                hideModal('reminderModal');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        init();
    </script>
</body>
</html>

