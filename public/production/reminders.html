<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Check Reminders - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Stock Check Reminders</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Reminders</h2>
                <button onclick="showAddReminderModal()" class="btn btn-primary admin-only">Add Reminder</button>
            </div>
            <div id="remindersList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Reminder Modal -->
    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reminderModalTitle">Add Reminder</h3>
                <button class="modal-close" onclick="hideModal('reminderModal')">&times;</button>
            </div>
            <form id="reminderForm">
                <input type="hidden" id="reminderId">
                <div class="form-group">
                    <label class="form-label">Stock Item *</label>
                    <select id="reminderStockItem" class="form-select" required>
                        <option value="">Select stock item</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Check Frequency (Days) *</label>
                    <input type="number" id="reminderFrequency" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Checked Date</label>
                    <input type="date" id="reminderLastChecked" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Next Check Date</label>
                    <input type="date" id="reminderNextCheck" class="form-input">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reminderActive" checked> Active
                    </label>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('reminderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let stockItems = [];
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await loadStockItems();
            loadReminders();
        }
        
        async function loadStockItems() {
            try {
                const data = await apiCall('/stock');
                stockItems = data.items;
                
                const select = document.getElementById('reminderStockItem');
                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading stock items:', error);
            }
        }
        
        async function loadReminders() {
            try {
                const data = await apiCall('/reminders');
                const remindersList = document.getElementById('remindersList');
                
                if (data.reminders.length === 0) {
                    remindersList.innerHTML = '<p>No reminders found</p>';
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                remindersList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Stock Item</th>
                                <th>Frequency</th>
                                <th>Last Checked</th>
                                <th>Next Check</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.reminders.map(reminder => {
                                const isOverdue = reminder.next_check_date && reminder.next_check_date < today;
                                const isActive = reminder.is_active === true || reminder.is_active === 1;
                                return `
                                    <tr>
                                        <td><strong>${reminder.stock_item_name}</strong></td>
                                        <td>Every ${reminder.check_frequency_days} days</td>
                                        <td>${formatDate(reminder.last_checked_date)}</td>
                                        <td>${formatDate(reminder.next_check_date)}</td>
                                        <td>
                                            ${isOverdue && isActive ? '<span class="badge badge-danger">Overdue</span>' : ''}
                                            ${!isActive ? '<span class="badge badge-warning">Inactive</span>' : '<span class="badge badge-success">Active</span>'}
                                        </td>
                                        <td>
                                            <button onclick="markChecked(${reminder.id})" class="btn btn-success btn-sm">Mark Checked</button>
                                            ${currentUser.role === 'admin' ? `
                                                <button onclick="editReminder(${reminder.id})" class="btn btn-secondary btn-sm">Edit</button>
                                                <button onclick="deleteReminder(${reminder.id})" class="btn btn-danger btn-sm">Delete</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('remindersList').innerHTML = '<p>Error loading reminders</p>';
            }
        }
        
        function showAddReminderModal() {
            document.getElementById('reminderModalTitle').textContent = 'Add Reminder';
            document.getElementById('reminderForm').reset();
            document.getElementById('reminderId').value = '';
            document.getElementById('reminderActive').checked = true;
            showModal('reminderModal');
        }
        
        async function editReminder(id) {
            try {
                const data = await apiCall('/reminders');
                const reminder = data.reminders.find(r => r.id === id);
                if (!reminder) return;
                
                document.getElementById('reminderModalTitle').textContent = 'Edit Reminder';
                document.getElementById('reminderId').value = reminder.id;
                document.getElementById('reminderStockItem').value = reminder.stock_item_id;
                document.getElementById('reminderFrequency').value = reminder.check_frequency_days;
                document.getElementById('reminderLastChecked').value = reminder.last_checked_date || '';
                document.getElementById('reminderNextCheck').value = reminder.next_check_date || '';
                document.getElementById('reminderActive').checked = reminder.is_active === true || reminder.is_active === 1;
                showModal('reminderModal');
            } catch (error) {
                showAlert('Error loading reminder', 'error');
            }
        }
        
        async function markChecked(id) {
            try {
                await apiCall(`/reminders/${id}/check`, { method: 'POST' });
                showAlert('Reminder marked as checked');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function deleteReminder(id) {
            if (!confirm('Delete this reminder?')) return;
            try {
                await apiCall(`/reminders/${id}`, { method: 'DELETE' });
                showAlert('Reminder deleted');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        document.getElementById('reminderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('reminderId').value;
            const frequency = parseInt(document.getElementById('reminderFrequency').value);
            const lastChecked = document.getElementById('reminderLastChecked').value;
            let nextCheck = document.getElementById('reminderNextCheck').value;
            
            // Calculate next check date if not provided
            if (!nextCheck && lastChecked) {
                const nextDate = new Date(lastChecked);
                nextDate.setDate(nextDate.getDate() + frequency);
                nextCheck = nextDate.toISOString().split('T')[0];
            } else if (!nextCheck) {
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + frequency);
                nextCheck = nextDate.toISOString().split('T')[0];
            }
            
            const data = {
                stock_item_id: document.getElementById('reminderStockItem').value,
                check_frequency_days: frequency,
                last_checked_date: lastChecked || null,
                next_check_date: nextCheck,
                is_active: document.getElementById('reminderActive').checked
            };
            
            try {
                if (id) {
                    await apiCall(`/reminders/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Reminder updated');
                } else {
                    await apiCall('/reminders', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Reminder created');
                }
                hideModal('reminderModal');
                loadReminders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        init();
    </script>
</body>
</html>

