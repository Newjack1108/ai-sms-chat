<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Works Orders - Production System</title>
    <link rel="stylesheet" href="common.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .requirements-section h4 {
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .requirements-section h4:first-child {
            margin-top: 0;
        }
        .load-sheet-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .load-sheet-print-area {
            padding: 20px;
            background: white;
            color: black;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        .load-sheet-print-area h3 {
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .load-sheet-print-area table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .load-sheet-print-area table th,
        .load-sheet-print-area table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .load-sheet-print-area table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .load-sheet-print-area h4 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: black;
        }
        .load-sheet-print-area h5 {
            margin-top: 15px;
            margin-bottom: 8px;
            color: black;
        }
        .load-sheet-print-area p {
            color: black;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Works Orders</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Quotes</h2>
                <button onclick="showAddQuoteModal()" class="btn btn-primary">Create Quote</button>
            </div>
            <div id="quotesList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Works Orders</h2>
                <button onclick="showAddOrderModal()" class="btn btn-primary">Add Works Order</button>
            </div>
            <div id="ordersList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Material Requirements Calculator</h2>
            </div>
            <div id="calculatorContent">
                <div class="form-group">
                    <label class="form-label">Select Works Orders to Calculate</label>
                    <div id="ordersCheckboxes"></div>
                </div>
                <button onclick="calculateRequirements()" class="btn btn-primary">Calculate Requirements</button>
                <div id="requirementsResult" class="mt-20"></div>
            </div>
        </div>
    </div>
    
    <!-- Quote Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Quote</h3>
                <button class="modal-close" onclick="hideModal('quoteModal')">&times;</button>
            </div>
            <form id="quoteForm">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="quoteProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="quoteQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Quote Date</label>
                    <input type="date" id="quoteDate" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('quoteModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Quote</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Works Order</h3>
                <button class="modal-close" onclick="hideModal('orderModal')">&times;</button>
            </div>
            <form id="orderForm">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="orderProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="orderQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Order Date</label>
                    <input type="date" id="orderDate" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('orderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Works Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Works Order</h3>
                <button class="modal-close" onclick="hideModal('editOrderModal')">&times;</button>
            </div>
            <form id="editOrderForm">
                <input type="hidden" id="editOrderId">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="editOrderProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="editOrderQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Order Date</label>
                    <input type="date" id="editOrderDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select id="editOrderStatus" class="form-select" required>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('editOrderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Works Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manage Spares Modal -->
    <div id="sparesModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 id="sparesModalTitle">Manage Spares</h3>
                <button class="modal-close" onclick="hideModal('sparesModal')">&times;</button>
            </div>
            <div id="sparesContent">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Update Status Modal -->
    <div id="updateStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Works Order Status</h3>
                <button class="modal-close" onclick="hideModal('updateStatusModal')">&times;</button>
            </div>
            <form id="updateStatusForm">
                <input type="hidden" id="updateStatusOrderId">
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select id="updateStatusSelect" class="form-select" required>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('updateStatusModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let products = [];
        let orders = [];
        let quotes = [];
        let components = [];
        let panels = [];
        let stockItems = [];
        let currentOrderId = null;
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await Promise.all([loadProducts(), loadComponents(), loadPanels(), loadStockItems()]);
            loadQuotes();
            loadOrders();
        }
        
        async function loadComponents() {
            try {
                const data = await apiCall('/components');
                components = data.components || [];
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }
        
        async function loadPanels() {
            try {
                const data = await apiCall('/panels');
                panels = data.panels || [];
            } catch (error) {
                console.error('Error loading panels:', error);
            }
        }
        
        async function loadStockItems() {
            try {
                const data = await apiCall('/stock');
                stockItems = data.items || [];
            } catch (error) {
                console.error('Error loading stock items:', error);
            }
        }
        
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                products = data.products.filter(p => p.status === 'active');
                
                // Populate order product select
                const orderSelect = document.getElementById('orderProduct');
                orderSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    orderSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
                
                // Populate quote product select
                const quoteSelect = document.getElementById('quoteProduct');
                quoteSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    quoteSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        async function loadQuotes() {
            try {
                const data = await apiCall('/quotes');
                quotes = data.quotes;
                const quotesList = document.getElementById('quotesList');
                
                if (quotes.length === 0) {
                    quotesList.innerHTML = '<p>No quotes found</p>';
                    return;
                }
                
                quotesList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Quote Date</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotes.map(quote => `
                                <tr>
                                    <td><strong>${quote.product_name || 'Unknown'}</strong></td>
                                    <td>${quote.quantity}</td>
                                    <td>${formatDate(quote.order_date)}</td>
                                    <td>${quote.created_by_name || '-'}</td>
                                    <td>
                                        <button onclick="convertQuoteToOrder(${quote.id})" class="btn btn-success btn-sm">Convert to Order</button>
                                        <button onclick="viewQuoteRequirements(${quote.id})" class="btn btn-primary btn-sm">View Requirements</button>
                                        <button onclick="deleteQuote(${quote.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('quotesList').innerHTML = '<p>Error loading quotes</p>';
            }
        }
        
        async function loadOrders() {
            try {
                const data = await apiCall('/orders');
                orders = data.orders;
                const ordersList = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    ordersList.innerHTML = '<p>No works orders found</p>';
                    updateOrdersCheckboxes();
                    return;
                }
                
                ordersList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Order Date</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td><strong>${order.product_name || 'Unknown'}</strong></td>
                                    <td>${order.quantity}</td>
                                    <td><span class="badge badge-info">${order.status}</span></td>
                                    <td>${formatDate(order.order_date)}</td>
                                    <td>${order.created_by_name || '-'}</td>
                                    <td>
                                        <button onclick="viewOrderRequirements(${order.id})" class="btn btn-primary btn-sm">View Requirements</button>
                                        <button onclick="viewLoadSheet(${order.id})" class="btn btn-success btn-sm">Load Sheet</button>
                                        <button onclick="manageSpares(${order.id})" class="btn btn-warning btn-sm">Manage Spares</button>
                                        <button onclick="showUpdateStatusModal(${order.id}, '${order.status}')" class="btn btn-secondary btn-sm">Update Status</button>
                                        <button onclick="showEditOrderModal(${order.id})" class="btn btn-info btn-sm">Edit</button>
                                        <button onclick="deleteOrder(${order.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                updateOrdersCheckboxes();
            } catch (error) {
                document.getElementById('ordersList').innerHTML = '<p>Error loading works orders</p>';
            }
        }
        
        function updateOrdersCheckboxes() {
            const checkboxesDiv = document.getElementById('ordersCheckboxes');
            if (orders.length === 0) {
                checkboxesDiv.innerHTML = '<p>No works orders available</p>';
                return;
            }
            
            checkboxesDiv.innerHTML = orders.map(order => `
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" value="${order.id}" style="margin-right: 8px;">
                    ${order.product_name} - Qty: ${order.quantity} (${order.status})
                </label>
            `).join('');
        }
        
        function showAddQuoteModal() {
            document.getElementById('quoteForm').reset();
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
            showModal('quoteModal');
        }
        
        function showAddOrderModal() {
            document.getElementById('orderForm').reset();
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            showModal('orderModal');
        }
        
        async function convertQuoteToOrder(quoteId) {
            if (!confirm('Are you sure you want to convert this quote to an order?')) {
                return;
            }
            
            try {
                await apiCall(`/quotes/${quoteId}/convert-to-order`, {
                    method: 'POST'
                });
                showAlert('Quote converted to order successfully');
                loadQuotes();
                loadOrders();
            } catch (error) {
                showAlert('Error converting quote to order: ' + error.message, 'error');
            }
        }
        
        async function viewQuoteRequirements(quoteId) {
            try {
                const result = await apiCall(`/orders/${quoteId}/requirements`, {
                    method: 'POST'
                });
                
                const requirements = result.requirements;
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Quote Requirements</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div>
                            <h4>Built Items Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Built Item</th>
                                        <th>Total Quantity</th>
                                        <th>Type</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                        <th>Total Cost (GBP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.panels_required.length === 0 ? '<tr><td colspan="6">No built items required</td></tr>' : requirements.panels_required.map(p => {
                                        const available = parseFloat(p.available || 0);
                                        const required = parseFloat(p.total_quantity || 0);
                                        const shortfall = Math.max(0, required - available);
                                        const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                        return `
                                            <tr>
                                                <td><strong>${p.panel_name}</strong></td>
                                                <td>${required.toFixed(2)}</td>
                                                <td>${p.type || 'Built Item'}</td>
                                                <td>${available.toFixed(2)}</td>
                                                <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                                <td>${formatCurrency(p.cost_gbp || 0)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            <h4>Components Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Total Quantity</th>
                                        <th>Type</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                        <th>Total Cost (GBP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.components_required && requirements.components_required.length > 0 ? requirements.components_required.map(c => {
                                        const available = parseFloat(c.available || 0);
                                        const required = parseFloat(c.total_quantity || 0);
                                        const shortfall = Math.max(0, required - available);
                                        const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                        return `
                                            <tr>
                                                <td><strong>${c.component_name}</strong></td>
                                                <td>${required.toFixed(2)}</td>
                                                <td>${c.type || 'Component'}</td>
                                                <td>${available.toFixed(2)}</td>
                                                <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                                <td>${formatCurrency(c.cost_gbp || 0)}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="6">No components required</td></tr>'}
                                </tbody>
                            </table>
                            
                            ${requirements.labour_hours_required > 0 ? `
                            <h4>Labour Requirements</h4>
                            <div class="alert alert-info">
                                <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                            </div>
                            ` : ''}
                            
                            <h4>Raw Materials Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.raw_materials_required.map(m => {
                                        const shortfall = Math.max(0, parseFloat(m.total_quantity) - parseFloat(m.available || 0));
                                        return `
                                            <tr>
                                                <td>${m.name}</td>
                                                <td>${parseFloat(m.total_quantity).toFixed(2)}</td>
                                                <td>${m.unit}</td>
                                                <td>${parseFloat(m.available || 0).toFixed(2)}</td>
                                                <td><span class="badge ${shortfall > 0 ? 'badge-danger' : 'badge-success'}">${shortfall.toFixed(2)}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                showAlert('Error loading requirements', 'error');
            }
        }
        
        async function deleteQuote(quoteId) {
            if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/orders/${quoteId}`, {
                    method: 'DELETE'
                });
                showAlert('Quote deleted successfully');
                loadQuotes();
            } catch (error) {
                showAlert('Error deleting quote: ' + error.message, 'error');
            }
        }
        
        async function calculateRequirements() {
            const selected = Array.from(document.querySelectorAll('#ordersCheckboxes input:checked')).map(cb => parseInt(cb.value));
            if (selected.length === 0) {
                showAlert('Please select at least one order', 'error');
                return;
            }
            
            try {
                const selectedOrders = orders.filter(o => selected.includes(o.id));
                const ordersData = selectedOrders.map(o => ({
                    product_id: o.product_id,
                    quantity: o.quantity
                }));
                
                const result = await apiCall('/requirements/calculate', {
                    method: 'POST',
                    body: JSON.stringify({ orders: ordersData })
                });
                
                const requirements = result.requirements;
                const resultDiv = document.getElementById('requirementsResult');
                
                let totalCost = 0;
                requirements.raw_materials_required.forEach(m => totalCost += parseFloat(m.cost_gbp || 0));
                
                resultDiv.innerHTML = `
                    <h3>Material Requirements Summary</h3>
                    <div class="alert alert-info">
                        <strong>Total Estimated Cost:</strong> ${formatCurrency(requirements.total_cost_gbp || totalCost)}
                    </div>
                    <div class="requirements-section">
                    <h4>Built Items Required</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Built Item</th>
                                <th>Total Quantity</th>
                                <th>Type</th>
                                <th>Available</th>
                                <th>Shortfall</th>
                                <th>Total Cost (GBP)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requirements.panels_required.length === 0 ? '<tr><td colspan="6">No built items required</td></tr>' : requirements.panels_required.map(p => {
                                const available = parseFloat(p.available || 0);
                                const required = parseFloat(p.total_quantity || 0);
                                const shortfall = Math.max(0, required - available);
                                const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                return `
                                    <tr>
                                        <td><strong>${p.panel_name}</strong></td>
                                        <td>${required.toFixed(2)}</td>
                                        <td>${p.type || 'Built Item'}</td>
                                        <td>${available.toFixed(2)}</td>
                                        <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                        <td>${formatCurrency(p.cost_gbp || 0)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <h4>Components Required</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Total Quantity</th>
                                <th>Type</th>
                                <th>Available</th>
                                <th>Shortfall</th>
                                <th>Total Cost (GBP)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requirements.components_required && requirements.components_required.length > 0 ? requirements.components_required.map(c => {
                                const available = parseFloat(c.available || 0);
                                const required = parseFloat(c.total_quantity || 0);
                                const shortfall = Math.max(0, required - available);
                                const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                return `
                                    <tr>
                                        <td><strong>${c.component_name}</strong></td>
                                        <td>${required.toFixed(2)}</td>
                                        <td>${c.type || 'Component'}</td>
                                        <td>${available.toFixed(2)}</td>
                                        <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                        <td>${formatCurrency(c.cost_gbp || 0)}</td>
                                    </tr>
                                `;
                            }).join('') : '<tr><td colspan="6">No components required</td></tr>'}
                        </tbody>
                    </table>
                    
                    ${requirements.labour_hours_required > 0 ? `
                    <h4>Labour Requirements</h4>
                    <div class="alert alert-info">
                        <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                    </div>
                    ` : ''}
                    
                    <h4>Raw Materials Required</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Total Quantity</th>
                                <th>Unit</th>
                                <th>Available</th>
                                <th>Shortfall</th>
                                <th>Cost (GBP)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requirements.raw_materials_required.map(m => {
                                const available = parseFloat(m.available || 0);
                                const required = parseFloat(m.total_quantity || 0);
                                const shortfall = Math.max(0, required - available);
                                const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                return `
                                    <tr>
                                        <td><strong>${m.name}</strong></td>
                                        <td>${required.toFixed(2)}</td>
                                        <td>${m.unit}</td>
                                        <td>${available.toFixed(2)}</td>
                                        <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                        <td>${formatCurrency(m.cost_gbp || 0)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                `;
            } catch (error) {
                showAlert('Error calculating requirements: ' + error.message, 'error');
            }
        }
        
        function saveLoadSheetCheckboxes(orderId) {
            const checkboxes = document.querySelectorAll(`#loadSheetModal .load-sheet-checkbox`);
            const states = {};
            checkboxes.forEach(cb => {
                states[cb.id] = cb.checked;
            });
            localStorage.setItem(`loadSheet_${orderId}_checkboxes`, JSON.stringify(states));
        }
        
        function loadLoadSheetCheckboxes(orderId) {
            try {
                const saved = localStorage.getItem(`loadSheet_${orderId}_checkboxes`);
                if (saved) {
                    const states = JSON.parse(saved);
                    Object.keys(states).forEach(id => {
                        const checkbox = document.getElementById(id);
                        if (checkbox) {
                            checkbox.checked = states[id];
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading checkbox states:', error);
            }
        }
        
        async function viewLoadSheet(orderId) {
            try {
                const result = await apiCall(`/orders/${orderId}/load-sheet`);
                const loadSheet = result.load_sheet;
                
                // Load saved checkbox states
                const savedStates = {};
                try {
                    const saved = localStorage.getItem(`loadSheet_${orderId}_checkboxes`);
                    if (saved) {
                        Object.assign(savedStates, JSON.parse(saved));
                    }
                } catch (error) {
                    console.error('Error loading saved checkbox states:', error);
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.id = 'loadSheetModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3>Load Sheet - ${loadSheet.product_name} (Qty: ${loadSheet.quantity})</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 15px; border-bottom: 1px solid #dee2e6;">
                            <button onclick="printLoadSheetPDF(${orderId})" class="btn btn-primary">Print PDF</button>
                        </div>
                        <div class="requirements-section" id="loadSheetContent">
                            ${loadSheet.components.length > 0 ? `
                            <h4>Components Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Component</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        ${loadSheet.components.some(c => c.spares && c.spares.length > 0) ? '<th>Spares</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loadSheet.components.map((c, idx) => {
                                        const spareRows = c.spares && c.spares.length > 0 ? c.spares.map((spare, sIdx) => {
                                            const loaded = parseFloat(spare.quantity_loaded || 0);
                                            const used = parseFloat(spare.quantity_used || 0);
                                            const returned = parseFloat(spare.quantity_returned || 0);
                                            const checkboxId = `spare-comp-${idx}-${sIdx}`;
                                            const isChecked = savedStates[checkboxId] || false;
                                            return `
                                                <tr style="background: #fff3cd;">
                                                    <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                    <td><em>Spare: ${c.name}</em></td>
                                                    <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                    <td>${c.unit}</td>
                                                    ${loadSheet.components.some(comp => comp.spares && comp.spares.length > 0) ? '<td></td>' : ''}
                                                </tr>
                                            `;
                                        }).join('') : '';
                                        const checkboxId = `comp-${idx}`;
                                        const isChecked = savedStates[checkboxId] || false;
                                        return `
                                            <tr>
                                                <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                <td><strong>${c.name}</strong></td>
                                                <td>${parseFloat(c.quantity).toFixed(2)}</td>
                                                <td>${c.unit}</td>
                                                ${loadSheet.components.some(comp => comp.spares && comp.spares.length > 0) ? '<td></td>' : ''}
                                            </tr>
                                            ${spareRows}
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            
                            ${loadSheet.built_items.length > 0 ? `
                            <h4>Built Items Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Built Item</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        ${loadSheet.built_items.some(bi => bi.spares && bi.spares.length > 0) ? '<th>Spares</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loadSheet.built_items.map((bi, idx) => {
                                        const spareRows = bi.spares && bi.spares.length > 0 ? bi.spares.map((spare, sIdx) => {
                                            const loaded = parseFloat(spare.quantity_loaded || 0);
                                            const used = parseFloat(spare.quantity_used || 0);
                                            const returned = parseFloat(spare.quantity_returned || 0);
                                            const checkboxId = `spare-built-${idx}-${sIdx}`;
                                            const isChecked = savedStates[checkboxId] || false;
                                            return `
                                                <tr style="background: #fff3cd;">
                                                    <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                    <td><em>Spare: ${bi.name}</em></td>
                                                    <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                    <td>${bi.unit}</td>
                                                    ${loadSheet.built_items.some(item => item.spares && item.spares.length > 0) ? '<td></td>' : ''}
                                                </tr>
                                            `;
                                        }).join('') : '';
                                        const checkboxId = `built-${idx}`;
                                        const isChecked = savedStates[checkboxId] || false;
                                        return `
                                            <tr>
                                                <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                <td><strong>${bi.name}</strong></td>
                                                <td>${parseFloat(bi.quantity).toFixed(2)}</td>
                                                <td>${bi.unit}</td>
                                                ${loadSheet.built_items.some(item => item.spares && item.spares.length > 0) ? '<td></td>' : ''}
                                            </tr>
                                            ${spareRows}
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            
                            ${loadSheet.raw_materials.length > 0 ? `
                            <h4>Raw Materials Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Material</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        ${loadSheet.raw_materials.some(rm => rm.location) ? '<th>Location</th>' : ''}
                                        ${loadSheet.raw_materials.some(rm => rm.spares && rm.spares.length > 0) ? '<th>Spares</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loadSheet.raw_materials.map((rm, idx) => {
                                        const spareRows = rm.spares && rm.spares.length > 0 ? rm.spares.map((spare, sIdx) => {
                                            const loaded = parseFloat(spare.quantity_loaded || 0);
                                            const used = parseFloat(spare.quantity_used || 0);
                                            const returned = parseFloat(spare.quantity_returned || 0);
                                            const checkboxId = `spare-raw-${idx}-${sIdx}`;
                                            const isChecked = savedStates[checkboxId] || false;
                                            return `
                                                <tr style="background: #fff3cd;">
                                                    <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                    <td><em>Spare: ${rm.name}</em></td>
                                                    <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                    <td>${rm.unit}</td>
                                                    ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                                    ${loadSheet.raw_materials.some(mat => mat.spares && mat.spares.length > 0) ? '<td></td>' : ''}
                                                </tr>
                                            `;
                                        }).join('') : '';
                                        const checkboxId = `raw-${idx}`;
                                        const isChecked = savedStates[checkboxId] || false;
                                        return `
                                            <tr>
                                                <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                <td><strong>${rm.name}</strong></td>
                                                <td>${parseFloat(rm.quantity).toFixed(2)}</td>
                                                <td>${rm.unit}</td>
                                                ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                                ${loadSheet.raw_materials.some(mat => mat.spares && mat.spares.length > 0) ? '<td></td>' : ''}
                                            </tr>
                                            ${spareRows}
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : '<p>No raw materials required</p>'}
                            
                            ${loadSheet.standalone_spares && (
                                loadSheet.standalone_spares.components.length > 0 ||
                                loadSheet.standalone_spares.built_items.length > 0 ||
                                loadSheet.standalone_spares.raw_materials.length > 0
                            ) ? `
                            <h4>Standalone Spares (Not in Main Requirements)</h4>
                            ${loadSheet.standalone_spares.components.length > 0 ? `
                            <h5>Components</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Component</th>
                                        <th>Spare Quantity</th>
                                        <th>Unit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loadSheet.standalone_spares.components.map((c, idx) => {
                                        const spare = c.spares[0];
                                        const loaded = parseFloat(spare.quantity_loaded || 0);
                                        const used = parseFloat(spare.quantity_used || 0);
                                        const returned = parseFloat(spare.quantity_returned || 0);
                                        const checkboxId = `standalone-comp-${idx}`;
                                        const isChecked = savedStates[checkboxId] || false;
                                        return `
                                            <tr style="background: #fff3cd;">
                                                <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                <td><strong>${c.name}</strong></td>
                                                <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                <td>${c.unit}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            ${loadSheet.standalone_spares.built_items.length > 0 ? `
                            <h5>Built Items</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Built Item</th>
                                        <th>Spare Quantity</th>
                                        <th>Unit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${loadSheet.standalone_spares.built_items.map((bi, idx) => {
                                        const spare = bi.spares[0];
                                        const loaded = parseFloat(spare.quantity_loaded || 0);
                                        const used = parseFloat(spare.quantity_used || 0);
                                        const returned = parseFloat(spare.quantity_returned || 0);
                                        const checkboxId = `standalone-built-${idx}`;
                                        const isChecked = savedStates[checkboxId] || false;
                                        return `
                                            <tr style="background: #fff3cd;">
                                                <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                                <td><strong>${bi.name}</strong></td>
                                                <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                <td>${bi.unit}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            ${loadSheet.standalone_spares.raw_materials.length > 0 ? `
                            <h5>Raw Materials</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">✓</th>
                                        <th>Material</th>
                                        <th>Spare Quantity</th>
                                        <th>Unit</th>
                                        ${loadSheet.standalone_spares.raw_materials.some(rm => rm.location) ? '<th>Location</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                ${loadSheet.standalone_spares.raw_materials.map((rm, idx) => {
                                    const spare = rm.spares[0];
                                    const loaded = parseFloat(spare.quantity_loaded || 0);
                                    const used = parseFloat(spare.quantity_used || 0);
                                    const returned = parseFloat(spare.quantity_returned || 0);
                                    const checkboxId = `standalone-raw-${idx}`;
                                    const isChecked = savedStates[checkboxId] || false;
                                    return `
                                        <tr style="background: #fff3cd;">
                                            <td><input type="checkbox" class="load-sheet-checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''}></td>
                                            <td><strong>${rm.name}</strong></td>
                                            <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                            <td>${rm.unit}</td>
                                            ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                        </tr>
                                    `;
                                }).join('')}
                                </tbody>
                            </table>
                            ` : ''}
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add event listeners to save checkbox states when changed
                setTimeout(() => {
                    const checkboxes = modal.querySelectorAll('.load-sheet-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            saveLoadSheetCheckboxes(orderId);
                        });
                    });
                }, 100);
            } catch (error) {
                showAlert('Error loading load sheet: ' + error.message, 'error');
            }
        }
        
        async function printLoadSheetPDF(orderId) {
            try {
                const result = await apiCall(`/orders/${orderId}/load-sheet`);
                const loadSheet = result.load_sheet;
                
                // PDF always uses blank checkboxes (for fresh picking)
                // Don't use saved checkbox states for PDF
                
                // Create print-friendly HTML
                const printHTML = `
                    <div class="load-sheet-print-area">
                        <h3>Load Sheet - ${loadSheet.product_name} (Quantity: ${loadSheet.quantity})</h3>
                        <p><strong>Order ID:</strong> ${orderId} | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                        
                        ${loadSheet.components.length > 0 ? `
                        <h4>Components Required</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Component</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.components.map((c, idx) => {
                                    const mainRow = `
                                        <tr>
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${c.name}</strong></td>
                                            <td>${parseFloat(c.quantity).toFixed(2)}</td>
                                            <td>${c.unit}</td>
                                        </tr>
                                    `;
                                    const spareRows = c.spares && c.spares.length > 0 ? c.spares.map((spare, sIdx) => {
                                        const loaded = parseFloat(spare.quantity_loaded || 0);
                                        const used = parseFloat(spare.quantity_used || 0);
                                        const returned = parseFloat(spare.quantity_returned || 0);
                                        return `
                                            <tr style="background: #fff3cd;">
                                                <td style="text-align: center; font-size: 18px;">☐</td>
                                                <td><em>Spare: ${c.name}</em></td>
                                                <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                <td>${c.unit}</td>
                                            </tr>
                                        `;
                                    }).join('') : '';
                                    return mainRow + spareRows;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        
                        ${loadSheet.built_items.length > 0 ? `
                        <h4>Built Items Required</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Built Item</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.built_items.map((bi, idx) => {
                                    const mainRow = `
                                        <tr>
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${bi.name}</strong></td>
                                            <td>${parseFloat(bi.quantity).toFixed(2)}</td>
                                            <td>${bi.unit}</td>
                                        </tr>
                                    `;
                                    const spareRows = bi.spares && bi.spares.length > 0 ? bi.spares.map((spare, sIdx) => {
                                        const loaded = parseFloat(spare.quantity_loaded || 0);
                                        const used = parseFloat(spare.quantity_used || 0);
                                        const returned = parseFloat(spare.quantity_returned || 0);
                                        return `
                                            <tr style="background: #fff3cd;">
                                                <td style="text-align: center; font-size: 18px;">☐</td>
                                                <td><em>Spare: ${bi.name}</em></td>
                                                <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                <td>${bi.unit}</td>
                                            </tr>
                                        `;
                                    }).join('') : '';
                                    return mainRow + spareRows;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        
                        ${loadSheet.raw_materials.length > 0 ? `
                        <h4>Raw Materials Required</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Material</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    ${loadSheet.raw_materials.some(rm => rm.location) ? '<th>Location</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.raw_materials.map((rm, idx) => {
                                    const mainRow = `
                                        <tr>
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${rm.name}</strong></td>
                                            <td>${parseFloat(rm.quantity).toFixed(2)}</td>
                                            <td>${rm.unit}</td>
                                            ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                        </tr>
                                    `;
                                    const spareRows = rm.spares && rm.spares.length > 0 ? rm.spares.map((spare, sIdx) => {
                                        const loaded = parseFloat(spare.quantity_loaded || 0);
                                        const used = parseFloat(spare.quantity_used || 0);
                                        const returned = parseFloat(spare.quantity_returned || 0);
                                        return `
                                            <tr style="background: #fff3cd;">
                                                <td style="text-align: center; font-size: 18px;">☐</td>
                                                <td><em>Spare: ${rm.name}</em></td>
                                                <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                                <td>${rm.unit}</td>
                                                ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                            </tr>
                                        `;
                                    }).join('') : '';
                                    return mainRow + spareRows;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        
                        ${loadSheet.standalone_spares && (
                            loadSheet.standalone_spares.components.length > 0 ||
                            loadSheet.standalone_spares.built_items.length > 0 ||
                            loadSheet.standalone_spares.raw_materials.length > 0
                        ) ? `
                        <h4>Standalone Spares (Not in Main Requirements)</h4>
                        ${loadSheet.standalone_spares.components.length > 0 ? `
                        <h5>Components</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Component</th>
                                    <th>Spare Quantity</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.standalone_spares.components.map((c, idx) => {
                                    const spare = c.spares[0];
                                    const loaded = parseFloat(spare.quantity_loaded || 0);
                                    const used = parseFloat(spare.quantity_used || 0);
                                    const returned = parseFloat(spare.quantity_returned || 0);
                                    return `
                                        <tr style="background: #fff3cd;">
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${c.name}</strong></td>
                                            <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                            <td>${c.unit}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        ${loadSheet.standalone_spares.built_items.length > 0 ? `
                        <h5>Built Items</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Built Item</th>
                                    <th>Spare Quantity</th>
                                    <th>Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.standalone_spares.built_items.map((bi, idx) => {
                                    const spare = bi.spares[0];
                                    const loaded = parseFloat(spare.quantity_loaded || 0);
                                    const used = parseFloat(spare.quantity_used || 0);
                                    const returned = parseFloat(spare.quantity_returned || 0);
                                    return `
                                        <tr style="background: #fff3cd;">
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${bi.name}</strong></td>
                                            <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                            <td>${bi.unit}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        ${loadSheet.standalone_spares.raw_materials.length > 0 ? `
                        <h5>Raw Materials</h5>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30px;">✓</th>
                                    <th>Material</th>
                                    <th>Spare Quantity</th>
                                    <th>Unit</th>
                                    ${loadSheet.standalone_spares.raw_materials.some(rm => rm.location) ? '<th>Location</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${loadSheet.standalone_spares.raw_materials.map((rm, idx) => {
                                    const spare = rm.spares[0];
                                    const loaded = parseFloat(spare.quantity_loaded || 0);
                                    const used = parseFloat(spare.quantity_used || 0);
                                    const returned = parseFloat(spare.quantity_returned || 0);
                                    return `
                                        <tr style="background: #fff3cd;">
                                            <td style="text-align: center; font-size: 18px;">☐</td>
                                            <td><strong>${rm.name}</strong></td>
                                            <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)} (L:${loaded.toFixed(2)} U:${used.toFixed(2)} R:${returned.toFixed(2)})</td>
                                            <td>${rm.unit}</td>
                                            ${rm.location ? `<td>${rm.location || '-'}</td>` : ''}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        ` : ''}
                    </div>
                `;
                
                // Create temporary element for PDF generation
                const printDiv = document.createElement('div');
                printDiv.innerHTML = printHTML;
                printDiv.className = 'load-sheet-print-area';
                printDiv.style.position = 'fixed';
                printDiv.style.top = '0';
                printDiv.style.left = '0';
                printDiv.style.width = '210mm'; // A4 width
                printDiv.style.padding = '20px';
                printDiv.style.backgroundColor = 'white';
                printDiv.style.zIndex = '9999';
                printDiv.style.visibility = 'hidden';
                printDiv.style.opacity = '0';
                document.body.appendChild(printDiv);
                
                // Wait for element to render
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Make it visible for html2canvas
                printDiv.style.visibility = 'visible';
                printDiv.style.opacity = '1';
                
                // Wait a bit more for rendering
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Generate PDF
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `LoadSheet_Order_${orderId}_${loadSheet.product_name.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: printDiv.scrollWidth,
                        windowHeight: printDiv.scrollHeight
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                await html2pdf().set(opt).from(printDiv).save();
                
                // Clean up
                document.body.removeChild(printDiv);
                
                showAlert('PDF generated successfully');
            } catch (error) {
                console.error('PDF generation error:', error);
                showAlert('Error generating PDF: ' + error.message, 'error');
            }
        }
        
        async function manageSpares(orderId) {
            currentOrderId = orderId;
            try {
                const order = orders.find(o => o.id === orderId);
                const sparesData = await apiCall(`/orders/${orderId}/spares`);
                const spares = sparesData.spares || [];
                
                document.getElementById('sparesModalTitle').textContent = `Manage Spares - Order #${orderId} (${order?.product_name || 'Unknown'})`;
                
                const sparesContent = document.getElementById('sparesContent');
                sparesContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <button onclick="showAddSpareForm()" class="btn btn-primary">Add Spare</button>
                    </div>
                    <div id="sparesList">
                        ${spares.length === 0 ? '<p>No spares added yet</p>' : `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item Type</th>
                                    <th>Item Name</th>
                                    <th>Needed</th>
                                    <th>Loaded</th>
                                    <th>Used</th>
                                    <th>Returned</th>
                                    <th>Remaining</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${spares.map(spare => {
                                    const loaded = parseFloat(spare.quantity_loaded || 0);
                                    const used = parseFloat(spare.quantity_used || 0);
                                    const returned = parseFloat(spare.quantity_returned || 0);
                                    const remaining = loaded - used - returned;
                                    return `
                                        <tr>
                                            <td><span class="badge badge-info">${spare.item_type === 'component' ? 'Component' : spare.item_type === 'built_item' ? 'Built Item' : 'Raw Material'}</span></td>
                                            <td><strong>${spare.item_name || 'Unknown'}</strong></td>
                                            <td>${parseFloat(spare.quantity_needed || 0).toFixed(2)}</td>
                                            <td>${loaded.toFixed(2)}</td>
                                            <td>${used.toFixed(2)}</td>
                                            <td>${returned.toFixed(2)}</td>
                                            <td><span class="badge ${remaining > 0 ? 'badge-warning' : 'badge-success'}">${remaining.toFixed(2)}</span></td>
                                            <td>
                                                <button onclick="updateSpareStatus(${spare.id}, 'loaded')" class="btn btn-sm btn-secondary">Mark Loaded</button>
                                                <button onclick="updateSpareStatus(${spare.id}, 'used')" class="btn btn-sm btn-warning">Mark Used</button>
                                                ${remaining > 0 ? `<button onclick="returnSpareToStock(${spare.id})" class="btn btn-sm btn-success">Return to Stock</button>` : ''}
                                                <button onclick="deleteSpare(${spare.id})" class="btn btn-sm btn-danger">Delete</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                    <div id="addSpareForm" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Add Spare</h4>
                        <form id="spareForm">
                            <div class="form-group">
                                <label class="form-label">Item Type *</label>
                                <select id="spareItemType" class="form-select" required onchange="updateSpareItemOptions()">
                                    <option value="">Select type</option>
                                    <option value="component">Component</option>
                                    <option value="built_item">Built Item</option>
                                    <option value="raw_material">Raw Material</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Item *</label>
                                <select id="spareItemId" class="form-select" required>
                                    <option value="">Select item</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quantity Needed *</label>
                                <input type="number" step="0.01" id="spareQuantity" class="form-input" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea id="spareNotes" class="form-textarea"></textarea>
                            </div>
                            <div class="text-right">
                                <button type="button" onclick="hideAddSpareForm()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add Spare</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.getElementById('spareForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        await apiCall(`/orders/${orderId}/spares`, {
                            method: 'POST',
                            body: JSON.stringify({
                                item_type: document.getElementById('spareItemType').value,
                                item_id: document.getElementById('spareItemId').value,
                                quantity_needed: document.getElementById('spareQuantity').value,
                                notes: document.getElementById('spareNotes').value || null
                            })
                        });
                        showAlert('Spare added successfully');
                        manageSpares(orderId);
                    } catch (error) {
                        showAlert(error.message || 'Failed to add spare', 'error');
                    }
                });
                
                showModal('sparesModal');
            } catch (error) {
                showAlert('Error loading spares: ' + error.message, 'error');
            }
        }
        
        function showAddSpareForm() {
            document.getElementById('addSpareForm').style.display = 'block';
            document.getElementById('spareForm').reset();
            document.getElementById('spareItemId').innerHTML = '<option value="">Select item</option>';
        }
        
        function hideAddSpareForm() {
            document.getElementById('addSpareForm').style.display = 'none';
        }
        
        function updateSpareItemOptions() {
            const type = document.getElementById('spareItemType').value;
            const select = document.getElementById('spareItemId');
            select.innerHTML = '<option value="">Select item</option>';
            
            if (type === 'component') {
                components.forEach(comp => {
                    select.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
                });
            } else if (type === 'built_item') {
                panels.forEach(panel => {
                    select.innerHTML += `<option value="${panel.id}">${panel.name}</option>`;
                });
            } else if (type === 'raw_material') {
                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name} (${item.unit})</option>`;
                });
            }
        }
        
        async function updateSpareStatus(spareId, status) {
            try {
                const spare = await apiCall(`/orders/${currentOrderId}/spares`).then(r => r.spares.find(s => s.id === spareId));
                if (!spare) {
                    showAlert('Spare not found', 'error');
                    return;
                }
                
                let quantity = 0;
                let promptText = '';
                
                if (status === 'loaded') {
                    promptText = `Enter quantity loaded (max: ${parseFloat(spare.quantity_needed || 0).toFixed(2)}):`;
                    quantity = parseFloat(prompt(promptText) || '0');
                    if (quantity <= 0 || quantity > parseFloat(spare.quantity_needed)) {
                        showAlert('Invalid quantity', 'error');
                        return;
                    }
                    await apiCall(`/orders/${currentOrderId}/spares/${spareId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ quantity_loaded: quantity })
                    });
                } else if (status === 'used') {
                    const loaded = parseFloat(spare.quantity_loaded || 0);
                    const alreadyUsed = parseFloat(spare.quantity_used || 0);
                    const available = loaded - alreadyUsed;
                    promptText = `Enter quantity used (max: ${available.toFixed(2)}):`;
                    quantity = parseFloat(prompt(promptText) || '0');
                    if (quantity <= 0 || quantity > available) {
                        showAlert('Invalid quantity', 'error');
                        return;
                    }
                    await apiCall(`/orders/${currentOrderId}/spares/${spareId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ quantity_used: alreadyUsed + quantity })
                    });
                }
                
                showAlert('Spare status updated successfully');
                manageSpares(currentOrderId);
            } catch (error) {
                showAlert(error.message || 'Failed to update spare status', 'error');
            }
        }
        
        async function returnSpareToStock(spareId) {
            try {
                const spare = await apiCall(`/orders/${currentOrderId}/spares`).then(r => r.spares.find(s => s.id === spareId));
                if (!spare) {
                    showAlert('Spare not found', 'error');
                    return;
                }
                
                const loaded = parseFloat(spare.quantity_loaded || 0);
                const used = parseFloat(spare.quantity_used || 0);
                const returned = parseFloat(spare.quantity_returned || 0);
                const available = loaded - used - returned;
                
                if (available <= 0) {
                    showAlert('No spares available to return', 'error');
                    return;
                }
                
                const quantity = parseFloat(prompt(`Enter quantity to return to stock (max: ${available.toFixed(2)}):`) || '0');
                if (quantity <= 0 || quantity > available) {
                    showAlert('Invalid quantity', 'error');
                    return;
                }
                
                if (!confirm(`Return ${quantity.toFixed(2)} to stock? This will update stock levels automatically.`)) {
                    return;
                }
                
                await apiCall(`/orders/${currentOrderId}/spares/${spareId}/return`, {
                    method: 'POST',
                    body: JSON.stringify({ quantity })
                });
                
                showAlert('Spare returned to stock successfully');
                manageSpares(currentOrderId);
            } catch (error) {
                showAlert(error.message || 'Failed to return spare to stock', 'error');
            }
        }
        
        async function deleteSpare(spareId) {
            if (!confirm('Are you sure you want to delete this spare?')) return;
            
            try {
                await apiCall(`/orders/${currentOrderId}/spares/${spareId}`, { method: 'DELETE' });
                showAlert('Spare deleted successfully');
                manageSpares(currentOrderId);
            } catch (error) {
                showAlert(error.message || 'Failed to delete spare', 'error');
            }
        }
        
        async function viewOrderRequirements(orderId) {
            try {
                const result = await apiCall(`/orders/${orderId}/requirements`, {
                    method: 'POST'
                });
                
                const requirements = result.requirements;
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Order Requirements</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="requirements-section">
                            <h4>Built Items Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Built Item</th>
                                        <th>Total Quantity</th>
                                        <th>Type</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                        <th>Total Cost (GBP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.panels_required.length === 0 ? '<tr><td colspan="6">No built items required</td></tr>' : requirements.panels_required.map(p => {
                                        const available = parseFloat(p.available || 0);
                                        const required = parseFloat(p.total_quantity || 0);
                                        const shortfall = Math.max(0, required - available);
                                        const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                        return `
                                            <tr>
                                                <td><strong>${p.panel_name}</strong></td>
                                                <td>${required.toFixed(2)}</td>
                                                <td>${p.type || 'Built Item'}</td>
                                                <td>${available.toFixed(2)}</td>
                                                <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                                <td>${formatCurrency(p.cost_gbp || 0)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            <h4>Components Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Total Quantity</th>
                                        <th>Type</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                        <th>Total Cost (GBP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.components_required && requirements.components_required.length > 0 ? requirements.components_required.map(c => {
                                        const available = parseFloat(c.available || 0);
                                        const required = parseFloat(c.total_quantity || 0);
                                        const shortfall = Math.max(0, required - available);
                                        const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                        return `
                                            <tr>
                                                <td><strong>${c.component_name}</strong></td>
                                                <td>${required.toFixed(2)}</td>
                                                <td>${c.type || 'Component'}</td>
                                                <td>${available.toFixed(2)}</td>
                                                <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                                <td>${formatCurrency(c.cost_gbp || 0)}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="6">No components required</td></tr>'}
                                </tbody>
                            </table>
                            
                            ${requirements.labour_hours_required > 0 ? `
                            <h4>Labour Requirements</h4>
                            <div class="alert alert-info">
                                <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                            </div>
                            ` : ''}
                            
                            <h4>Raw Materials Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.raw_materials_required.map(m => {
                                        const shortfall = Math.max(0, parseFloat(m.total_quantity) - parseFloat(m.available || 0));
                                        return `
                                            <tr>
                                                <td>${m.name}</td>
                                                <td>${parseFloat(m.total_quantity).toFixed(2)}</td>
                                                <td>${m.unit}</td>
                                                <td>${parseFloat(m.available || 0).toFixed(2)}</td>
                                                <td><span class="badge ${shortfall > 0 ? 'badge-danger' : 'badge-success'}">${shortfall.toFixed(2)}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                showAlert('Error loading requirements', 'error');
            }
        }
        
        function showUpdateStatusModal(orderId, currentStatus) {
            document.getElementById('updateStatusOrderId').value = orderId;
            document.getElementById('updateStatusSelect').value = currentStatus;
            showModal('updateStatusModal');
        }
        
        async function updateOrderStatus(orderId, status) {
            try {
                await apiCall(`/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                showAlert('Order status updated');
                hideModal('updateStatusModal');
                loadOrders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function showEditOrderModal(orderId) {
            try {
                const data = await apiCall(`/orders/${orderId}`);
                const order = data.order;
                
                // Populate product dropdown in edit modal
                const editProductSelect = document.getElementById('editOrderProduct');
                editProductSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    editProductSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
                
                document.getElementById('editOrderId').value = order.id;
                document.getElementById('editOrderProduct').value = order.product_id;
                document.getElementById('editOrderQty').value = order.quantity;
                document.getElementById('editOrderDate').value = order.order_date ? order.order_date.split('T')[0] : '';
                document.getElementById('editOrderStatus').value = order.status;
                
                showModal('editOrderModal');
            } catch (error) {
                showAlert('Error loading order: ' + error.message, 'error');
            }
        }
        
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/orders/${orderId}`, {
                    method: 'DELETE'
                });
                showAlert('Order deleted successfully');
                loadOrders();
            } catch (error) {
                showAlert('Error deleting order: ' + error.message, 'error');
            }
        }
        
        document.getElementById('quoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await apiCall('/quotes', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: document.getElementById('quoteProduct').value,
                        quantity: document.getElementById('quoteQty').value,
                        order_date: document.getElementById('quoteDate').value
                    })
                });
                showAlert('Quote created');
                hideModal('quoteModal');
                loadQuotes();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await apiCall('/orders', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: document.getElementById('orderProduct').value,
                        quantity: document.getElementById('orderQty').value,
                        order_date: document.getElementById('orderDate').value
                    })
                });
                showAlert('Order created');
                hideModal('orderModal');
                loadOrders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        document.getElementById('updateStatusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderId = parseInt(document.getElementById('updateStatusOrderId').value);
            const status = document.getElementById('updateStatusSelect').value;
            await updateOrderStatus(orderId, status);
        });
        
        document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const orderId = parseInt(document.getElementById('editOrderId').value);
                await apiCall(`/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        product_id: document.getElementById('editOrderProduct').value,
                        quantity: document.getElementById('editOrderQty').value,
                        order_date: document.getElementById('editOrderDate').value,
                        status: document.getElementById('editOrderStatus').value
                    })
                });
                showAlert('Order updated successfully');
                hideModal('editOrderModal');
                loadOrders();
            } catch (error) {
                showAlert('Error updating order: ' + error.message, 'error');
            }
        });
        
        init();
    </script>
</body>
</html>

