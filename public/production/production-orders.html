<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Works Orders - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Works Orders</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Quotes</h2>
                <button onclick="showAddQuoteModal()" class="btn btn-primary">Create Quote</button>
            </div>
            <div id="quotesList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Works Orders</h2>
                <button onclick="showAddOrderModal()" class="btn btn-primary">Add Works Order</button>
            </div>
            <div id="ordersList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Material Requirements Calculator</h2>
            </div>
            <div id="calculatorContent">
                <div class="form-group">
                    <label class="form-label">Select Works Orders to Calculate</label>
                    <div id="ordersCheckboxes"></div>
                </div>
                <button onclick="calculateRequirements()" class="btn btn-primary">Calculate Requirements</button>
                <div id="requirementsResult" class="mt-20"></div>
            </div>
        </div>
    </div>
    
    <!-- Quote Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Quote</h3>
                <button class="modal-close" onclick="hideModal('quoteModal')">&times;</button>
            </div>
            <form id="quoteForm">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="quoteProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="quoteQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Quote Date</label>
                    <input type="date" id="quoteDate" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('quoteModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Quote</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Works Order</h3>
                <button class="modal-close" onclick="hideModal('orderModal')">&times;</button>
            </div>
            <form id="orderForm">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="orderProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="orderQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Order Date</label>
                    <input type="date" id="orderDate" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('orderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Works Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Works Order</h3>
                <button class="modal-close" onclick="hideModal('editOrderModal')">&times;</button>
            </div>
            <form id="editOrderForm">
                <input type="hidden" id="editOrderId">
                <div class="form-group">
                    <label class="form-label">Product *</label>
                    <select id="editOrderProduct" class="form-select" required>
                        <option value="">Select product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" id="editOrderQty" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Order Date</label>
                    <input type="date" id="editOrderDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select id="editOrderStatus" class="form-select" required>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('editOrderModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Works Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Update Status Modal -->
    <div id="updateStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Works Order Status</h3>
                <button class="modal-close" onclick="hideModal('updateStatusModal')">&times;</button>
            </div>
            <form id="updateStatusForm">
                <input type="hidden" id="updateStatusOrderId">
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select id="updateStatusSelect" class="form-select" required>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('updateStatusModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let products = [];
        let orders = [];
        let quotes = [];
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await loadProducts();
            loadQuotes();
            loadOrders();
        }
        
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                products = data.products.filter(p => p.status === 'active');
                
                // Populate order product select
                const orderSelect = document.getElementById('orderProduct');
                orderSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    orderSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
                
                // Populate quote product select
                const quoteSelect = document.getElementById('quoteProduct');
                quoteSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    quoteSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        async function loadQuotes() {
            try {
                const data = await apiCall('/quotes');
                quotes = data.quotes;
                const quotesList = document.getElementById('quotesList');
                
                if (quotes.length === 0) {
                    quotesList.innerHTML = '<p>No quotes found</p>';
                    return;
                }
                
                quotesList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Quote Date</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotes.map(quote => `
                                <tr>
                                    <td><strong>${quote.product_name || 'Unknown'}</strong></td>
                                    <td>${quote.quantity}</td>
                                    <td>${formatDate(quote.order_date)}</td>
                                    <td>${quote.created_by_name || '-'}</td>
                                    <td>
                                        <button onclick="convertQuoteToOrder(${quote.id})" class="btn btn-success btn-sm">Convert to Order</button>
                                        <button onclick="viewQuoteRequirements(${quote.id})" class="btn btn-primary btn-sm">View Requirements</button>
                                        <button onclick="deleteQuote(${quote.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('quotesList').innerHTML = '<p>Error loading quotes</p>';
            }
        }
        
        async function loadOrders() {
            try {
                const data = await apiCall('/orders');
                orders = data.orders;
                const ordersList = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    ordersList.innerHTML = '<p>No works orders found</p>';
                    updateOrdersCheckboxes();
                    return;
                }
                
                ordersList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Order Date</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td><strong>${order.product_name || 'Unknown'}</strong></td>
                                    <td>${order.quantity}</td>
                                    <td><span class="badge badge-info">${order.status}</span></td>
                                    <td>${formatDate(order.order_date)}</td>
                                    <td>${order.created_by_name || '-'}</td>
                                    <td>
                                        <button onclick="viewOrderRequirements(${order.id})" class="btn btn-primary btn-sm">View Requirements</button>
                                        <button onclick="showUpdateStatusModal(${order.id}, '${order.status}')" class="btn btn-secondary btn-sm">Update Status</button>
                                        <button onclick="showEditOrderModal(${order.id})" class="btn btn-info btn-sm">Edit</button>
                                        <button onclick="deleteOrder(${order.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                updateOrdersCheckboxes();
            } catch (error) {
                document.getElementById('ordersList').innerHTML = '<p>Error loading works orders</p>';
            }
        }
        
        function updateOrdersCheckboxes() {
            const checkboxesDiv = document.getElementById('ordersCheckboxes');
            if (orders.length === 0) {
                checkboxesDiv.innerHTML = '<p>No works orders available</p>';
                return;
            }
            
            checkboxesDiv.innerHTML = orders.map(order => `
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" value="${order.id}" style="margin-right: 8px;">
                    ${order.product_name} - Qty: ${order.quantity} (${order.status})
                </label>
            `).join('');
        }
        
        function showAddQuoteModal() {
            document.getElementById('quoteForm').reset();
            document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
            showModal('quoteModal');
        }
        
        function showAddOrderModal() {
            document.getElementById('orderForm').reset();
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            showModal('orderModal');
        }
        
        async function convertQuoteToOrder(quoteId) {
            if (!confirm('Are you sure you want to convert this quote to an order?')) {
                return;
            }
            
            try {
                await apiCall(`/quotes/${quoteId}/convert-to-order`, {
                    method: 'POST'
                });
                showAlert('Quote converted to order successfully');
                loadQuotes();
                loadOrders();
            } catch (error) {
                showAlert('Error converting quote to order: ' + error.message, 'error');
            }
        }
        
        async function viewQuoteRequirements(quoteId) {
            try {
                const result = await apiCall(`/orders/${quoteId}/requirements`, {
                    method: 'POST'
                });
                
                const requirements = result.requirements;
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Quote Requirements</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div>
                            <h4>Built Items Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Built Item</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.panels_required.map(p => `
                                        <tr>
                                            <td>${p.panel_name}</td>
                                            <td>${p.total_quantity.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            ${requirements.labour_hours_required > 0 ? `
                            <h4>Labour Requirements</h4>
                            <div class="alert alert-info">
                                <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                            </div>
                            ` : ''}
                            
                            <h4>Raw Materials Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.raw_materials_required.map(m => {
                                        const shortfall = Math.max(0, parseFloat(m.total_quantity) - parseFloat(m.available || 0));
                                        return `
                                            <tr>
                                                <td>${m.name}</td>
                                                <td>${parseFloat(m.total_quantity).toFixed(2)}</td>
                                                <td>${m.unit}</td>
                                                <td>${parseFloat(m.available || 0).toFixed(2)}</td>
                                                <td><span class="badge ${shortfall > 0 ? 'badge-danger' : 'badge-success'}">${shortfall.toFixed(2)}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                showAlert('Error loading requirements', 'error');
            }
        }
        
        async function deleteQuote(quoteId) {
            if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/orders/${quoteId}`, {
                    method: 'DELETE'
                });
                showAlert('Quote deleted successfully');
                loadQuotes();
            } catch (error) {
                showAlert('Error deleting quote: ' + error.message, 'error');
            }
        }
        
        async function calculateRequirements() {
            const selected = Array.from(document.querySelectorAll('#ordersCheckboxes input:checked')).map(cb => parseInt(cb.value));
            if (selected.length === 0) {
                showAlert('Please select at least one order', 'error');
                return;
            }
            
            try {
                const selectedOrders = orders.filter(o => selected.includes(o.id));
                const ordersData = selectedOrders.map(o => ({
                    product_id: o.product_id,
                    quantity: o.quantity
                }));
                
                const result = await apiCall('/requirements/calculate', {
                    method: 'POST',
                    body: JSON.stringify({ orders: ordersData })
                });
                
                const requirements = result.requirements;
                const resultDiv = document.getElementById('requirementsResult');
                
                let totalCost = 0;
                requirements.raw_materials_required.forEach(m => totalCost += parseFloat(m.cost_gbp || 0));
                
                resultDiv.innerHTML = `
                    <h3>Material Requirements Summary</h3>
                    <div class="alert alert-info">
                        <strong>Total Estimated Cost:</strong> ${formatCurrency(requirements.total_cost_gbp || totalCost)}
                    </div>
                    
                    <h4>Built Items Required</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Built Item</th>
                                <th>Total Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requirements.panels_required.length === 0 ? '<tr><td colspan="2">No built items required</td></tr>' : requirements.panels_required.map(p => `
                                <tr>
                                    <td>${p.panel_name}</td>
                                    <td>${p.total_quantity.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    ${requirements.labour_hours_required > 0 ? `
                    <h4>Labour Requirements</h4>
                    <div class="alert alert-info">
                        <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                    </div>
                    ` : ''}
                    
                    <h4>Raw Materials Required</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Total Quantity</th>
                                <th>Unit</th>
                                <th>Available</th>
                                <th>Shortfall</th>
                                <th>Cost (GBP)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requirements.raw_materials_required.map(m => {
                                const available = parseFloat(m.available || 0);
                                const required = parseFloat(m.total_quantity || 0);
                                const shortfall = Math.max(0, required - available);
                                const statusClass = shortfall > 0 ? 'badge-danger' : 'badge-success';
                                return `
                                    <tr>
                                        <td><strong>${m.name}</strong></td>
                                        <td>${required.toFixed(2)}</td>
                                        <td>${m.unit}</td>
                                        <td>${available.toFixed(2)}</td>
                                        <td><span class="badge ${statusClass}">${shortfall.toFixed(2)}</span></td>
                                        <td>${formatCurrency(m.cost_gbp || 0)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                showAlert('Error calculating requirements: ' + error.message, 'error');
            }
        }
        
        async function viewOrderRequirements(orderId) {
            try {
                const result = await apiCall(`/orders/${orderId}/requirements`, {
                    method: 'POST'
                });
                
                const requirements = result.requirements;
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Order Requirements</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div>
                            <h4>Built Items Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Built Item</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.panels_required.map(p => `
                                        <tr>
                                            <td>${p.panel_name}</td>
                                            <td>${p.total_quantity.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            ${requirements.labour_hours_required > 0 ? `
                            <h4>Labour Requirements</h4>
                            <div class="alert alert-info">
                                <strong>Total Labour Hours Required:</strong> ${parseFloat(requirements.labour_hours_required || 0).toFixed(2)} hours
                            </div>
                            ` : ''}
                            
                            <h4>Raw Materials Required</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Available</th>
                                        <th>Shortfall</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${requirements.raw_materials_required.map(m => {
                                        const shortfall = Math.max(0, parseFloat(m.total_quantity) - parseFloat(m.available || 0));
                                        return `
                                            <tr>
                                                <td>${m.name}</td>
                                                <td>${parseFloat(m.total_quantity).toFixed(2)}</td>
                                                <td>${m.unit}</td>
                                                <td>${parseFloat(m.available || 0).toFixed(2)}</td>
                                                <td><span class="badge ${shortfall > 0 ? 'badge-danger' : 'badge-success'}">${shortfall.toFixed(2)}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                showAlert('Error loading requirements', 'error');
            }
        }
        
        function showUpdateStatusModal(orderId, currentStatus) {
            document.getElementById('updateStatusOrderId').value = orderId;
            document.getElementById('updateStatusSelect').value = currentStatus;
            showModal('updateStatusModal');
        }
        
        async function updateOrderStatus(orderId, status) {
            try {
                await apiCall(`/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                showAlert('Order status updated');
                hideModal('updateStatusModal');
                loadOrders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function showEditOrderModal(orderId) {
            try {
                const data = await apiCall(`/orders/${orderId}`);
                const order = data.order;
                
                // Populate product dropdown in edit modal
                const editProductSelect = document.getElementById('editOrderProduct');
                editProductSelect.innerHTML = '<option value="">Select product</option>';
                products.forEach(product => {
                    editProductSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
                });
                
                document.getElementById('editOrderId').value = order.id;
                document.getElementById('editOrderProduct').value = order.product_id;
                document.getElementById('editOrderQty').value = order.quantity;
                document.getElementById('editOrderDate').value = order.order_date ? order.order_date.split('T')[0] : '';
                document.getElementById('editOrderStatus').value = order.status;
                
                showModal('editOrderModal');
            } catch (error) {
                showAlert('Error loading order: ' + error.message, 'error');
            }
        }
        
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/orders/${orderId}`, {
                    method: 'DELETE'
                });
                showAlert('Order deleted successfully');
                loadOrders();
            } catch (error) {
                showAlert('Error deleting order: ' + error.message, 'error');
            }
        }
        
        document.getElementById('quoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await apiCall('/quotes', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: document.getElementById('quoteProduct').value,
                        quantity: document.getElementById('quoteQty').value,
                        order_date: document.getElementById('quoteDate').value
                    })
                });
                showAlert('Quote created');
                hideModal('quoteModal');
                loadQuotes();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await apiCall('/orders', {
                    method: 'POST',
                    body: JSON.stringify({
                        product_id: document.getElementById('orderProduct').value,
                        quantity: document.getElementById('orderQty').value,
                        order_date: document.getElementById('orderDate').value
                    })
                });
                showAlert('Order created');
                hideModal('orderModal');
                loadOrders();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        document.getElementById('updateStatusForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const orderId = parseInt(document.getElementById('updateStatusOrderId').value);
            const status = document.getElementById('updateStatusSelect').value;
            await updateOrderStatus(orderId, status);
        });
        
        document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const orderId = parseInt(document.getElementById('editOrderId').value);
                await apiCall(`/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        product_id: document.getElementById('editOrderProduct').value,
                        quantity: document.getElementById('editOrderQty').value,
                        order_date: document.getElementById('editOrderDate').value,
                        status: document.getElementById('editOrderStatus').value
                    })
                });
                showAlert('Order updated successfully');
                hideModal('editOrderModal');
                loadOrders();
            } catch (error) {
                showAlert('Error updating order: ' + error.message, 'error');
            }
        });
        
        init();
    </script>
</body>
</html>

