<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Clock Admin - Production System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="common.css">
    <style>
        .nfc-section { margin-bottom: 32px; }
        .nfc-section h3 { margin-bottom: 12px; color: #4CBB17; }
        .nfc-table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        .nfc-table th, .nfc-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .nfc-table th { background: #f5f5f5; }
        .token-box { background: #1a1a2e; color: #eee; padding: 12px; border-radius: 8px; margin-top: 12px; word-break: break-all; font-family: monospace; }
        .token-box button { margin-left: 8px; }
        .form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 12px; }
        .form-row label { display: flex; flex-direction: column; gap: 4px; }
        .form-row input, .form-row select { padding: 8px 12px; min-width: 160px; }
        .kiosk-link { margin-top: 16px; font-size: 14px; }
        .kiosk-link a { color: #4CBB17; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
            <h1>NFC Clock Admin</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="timesheet-admin.html" class="btn btn-secondary btn-sm">Timesheet Admin</a>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>NFC Clock Setup</h2>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 20px; color: #666;">
                    Register NFC cards to staff and set up tablet readers. Staff tap their card on the tablet to clock in and out.
                    <a href="clock-kiosk.html" target="_blank">Open kiosk page</a> (use <code>?reader_id=xxx</code> for each tablet).
                </p>

                <div class="nfc-section">
                    <h3>NFC Cards (staff badges)</h3>
                    <div class="form-row">
                        <label>
                            Staff
                            <select id="cardUserSelect">
                                <option value="">-- Select user --</option>
                            </select>
                        </label>
                        <label>
                            Card UID
                            <input type="text" id="cardUidInput" placeholder="Tap card or type UID">
                        </label>
                        <label>
                            Label (optional)
                            <input type="text" id="cardLabelInput" placeholder="e.g. John's card">
                        </label>
                        <button type="button" class="btn btn-primary" id="scanCardBtn" style="display: none;">Scan card</button>
                        <button type="button" class="btn btn-primary" id="addCardBtn">Add card</button>
                    </div>
                    <div id="cardsList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <div class="nfc-section">
                    <h3>NFC Readers (tablets)</h3>
                    <div class="form-row">
                        <label>
                            Reader ID
                            <input type="text" id="readerIdInput" placeholder="e.g. reception-1">
                        </label>
                        <label>
                            Job / Site
                            <select id="readerJobSelect">
                                <option value="">-- Select job --</option>
                            </select>
                        </label>
                        <label>
                            Name (optional)
                            <input type="text" id="readerNameInput" placeholder="e.g. Reception tablet">
                        </label>
                        <button type="button" class="btn btn-primary" id="addReaderBtn">Add reader</button>
                    </div>
                    <div id="newReaderToken" class="token-box" style="display: none;">
                        <strong>Reader token (save this â€“ shown once):</strong>
                        <span id="newReaderTokenValue"></span>
                        <button type="button" class="btn btn-secondary btn-sm" id="copyTokenBtn">Copy</button>
                        <p style="margin: 8px 0 0 0; font-size: 12px;">Enter this token on the tablet kiosk page when prompted.</p>
                    </div>
                    <div id="readersList">
                        <div class="loading">Loading...</div>
                    </div>
                    <div class="kiosk-link">
                        Kiosk URL: <a href="clock-kiosk.html" target="_blank">clock-kiosk.html</a>?reader_id=<span id="readerIdExample">reception-1</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        document.getElementById('userInfo').textContent = 'Loading...';
        apiCall('/me').then(function (data) {
            if (data && data.user) {
                document.getElementById('userInfo').textContent = data.user.username || '';
            }
        }).catch(function () {
            document.getElementById('userInfo').textContent = '';
        });

        function logout() {
            window.location.href = 'login.html';
        }

        function loadUsers() {
            return apiCall('/clock/nfc/users').then(function (r) {
                if (!r || !r.success) return;
                var sel = document.getElementById('cardUserSelect');
                sel.innerHTML = '<option value="">-- Select user --</option>';
                (r.users || []).forEach(function (u) {
                    var opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = u.username;
                    sel.appendChild(opt);
                });
            });
        }

        function loadJobs() {
            return apiCall('/timesheet/jobs?all=true').then(function (r) {
                if (!r || !r.jobs) return;
                var sel = document.getElementById('readerJobSelect');
                sel.innerHTML = '<option value="">-- Select job --</option>';
                r.jobs.forEach(function (j) {
                    var opt = document.createElement('option');
                    opt.value = j.id;
                    opt.textContent = j.name;
                    sel.appendChild(opt);
                });
            });
        }

        function loadCards() {
            return apiCall('/clock/nfc/cards').then(function (r) {
                var el = document.getElementById('cardsList');
                if (!r || !r.success) {
                    el.innerHTML = '<p class="error">Failed to load cards</p>';
                    return;
                }
                var cards = r.cards || [];
                if (cards.length === 0) {
                    el.innerHTML = '<p>No cards registered. Add one above.</p>';
                    return;
                }
                el.innerHTML = '<table class="nfc-table"><thead><tr><th>User</th><th>Card UID</th><th>Label</th><th></th></tr></thead><tbody>' +
                    cards.map(function (c) {
                        return '<tr><td>' + (c.username || '-') + '</td><td><code>' + (c.card_uid || '') + '</code></td><td>' + (c.label || '') + '</td><td><button type="button" class="btn btn-danger btn-sm" data-id="' + c.id + '" onclick="deleteCard(' + c.id + ')">Remove</button></td></tr>';
                    }).join('') + '</tbody></table>';
            });
        }

        function loadReaders() {
            return apiCall('/clock/nfc/readers').then(function (r) {
                var el = document.getElementById('readersList');
                if (!r || !r.success) {
                    el.innerHTML = '<p class="error">Failed to load readers</p>';
                    return;
                }
                var readers = r.readers || [];
                if (readers.length === 0) {
                    el.innerHTML = '<p>No readers registered. Add one above.</p>';
                    return;
                }
                el.innerHTML = '<table class="nfc-table"><thead><tr><th>Reader ID</th><th>Job</th><th>Name</th><th></th></tr></thead><tbody>' +
                    readers.map(function (r) {
                        return '<tr><td><code>' + (r.reader_id || '') + '</code></td><td>' + (r.job_name || '-') + '</td><td>' + (r.name || '') + '</td><td><button type="button" class="btn btn-danger btn-sm" onclick="deleteReader(' + r.id + ')">Remove</button></td></tr>';
                    }).join('') + '</tbody></table>';
            });
        }

        function deleteCard(id) {
            if (!confirm('Remove this card?')) return;
            apiCall('/clock/nfc/cards/' + id, { method: 'DELETE' }).then(function (r) {
                if (r && r.success) loadCards();
                else alert(r && r.error ? r.error : 'Failed to delete');
            }).catch(function (e) {
                alert(e.message || 'Failed to delete');
            });
        }

        function deleteReader(id) {
            if (!confirm('Remove this reader? The tablet will need a new token if you add it again.')) return;
            apiCall('/clock/nfc/readers/' + id, { method: 'DELETE' }).then(function (r) {
                if (r && r.success) {
                    document.getElementById('newReaderToken').style.display = 'none';
                    loadReaders();
                } else {
                    alert(r && r.error ? r.error : 'Failed to delete');
                }
            }).catch(function (e) {
                alert(e.message || 'Failed to delete');
            });
        }

        document.getElementById('addCardBtn').addEventListener('click', function () {
            var userId = document.getElementById('cardUserSelect').value;
            var uid = document.getElementById('cardUidInput').value.trim();
            var label = document.getElementById('cardLabelInput').value.trim() || null;
            if (!userId || !uid) {
                alert('Select a user and enter or scan the card UID.');
                return;
            }
            apiCall('/clock/nfc/cards', {
                method: 'POST',
                body: JSON.stringify({ user_id: userId, card_uid: uid, label: label })
            }).then(function (r) {
                if (r && r.success) {
                    document.getElementById('cardUidInput').value = '';
                    document.getElementById('cardLabelInput').value = '';
                    loadCards();
                } else {
                    alert(r && r.error ? r.error : 'Failed to add card');
                }
            }).catch(function (e) {
                alert(e.message || 'Failed to add card');
            });
        });

        document.getElementById('addReaderBtn').addEventListener('click', function () {
            var readerId = document.getElementById('readerIdInput').value.trim();
            var jobId = document.getElementById('readerJobSelect').value;
            var name = document.getElementById('readerNameInput').value.trim() || null;
            if (!readerId || !jobId) {
                alert('Enter reader ID and select a job.');
                return;
            }
            apiCall('/clock/nfc/readers', {
                method: 'POST',
                body: JSON.stringify({ reader_id: readerId, job_id: jobId, name: name })
            }).then(function (r) {
                if (r && r.success && r.reader) {
                    document.getElementById('newReaderTokenValue').textContent = r.reader.reader_token || '';
                    document.getElementById('newReaderToken').style.display = 'block';
                    document.getElementById('readerIdExample').textContent = readerId;
                    document.getElementById('readerIdInput').value = '';
                    document.getElementById('readerNameInput').value = '';
                    loadReaders();
                } else {
                    alert(r && r.error ? r.error : 'Failed to add reader');
                }
            }).catch(function (e) {
                alert(e.message || 'Failed to add reader');
            });
        });

        document.getElementById('copyTokenBtn').addEventListener('click', function () {
            var val = document.getElementById('newReaderTokenValue').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(val).then(function () {
                    alert('Token copied to clipboard.');
                }).catch(function () {
                    fallbackCopy(val);
                });
            } else {
                fallbackCopy(val);
            }
        });
        function fallbackCopy(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                alert('Token copied.');
            } catch (e) {
                alert('Copy failed. Please copy the token manually.');
            }
            document.body.removeChild(ta);
        }

        if ('NDEFReader' in window) {
            var scanBtn = document.getElementById('scanCardBtn');
            scanBtn.style.display = 'inline-block';
            scanBtn.addEventListener('click', function () {
                var nfc = new NDEFReader();
                nfc.scan().then(function () {
                    alert('Hold the NFC card to the device...');
                    nfc.addEventListener('reading', function (event) {
                        var serial = event.serialNumber || '';
                        if (serial) {
                            document.getElementById('cardUidInput').value = serial;
                        }
                    });
                }).catch(function (err) {
                    alert('NFC error: ' + (err.message || 'Could not start scan'));
                });
            });
        }

        Promise.all([loadUsers(), loadJobs(), loadCards(), loadReaders()]).catch(function () {
            console.error('Initial load failed');
        });
    </script>
</body>
</html>
