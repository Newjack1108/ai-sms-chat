<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finished Products - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Finished Products</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Products</h2>
                <button onclick="showAddProductModal()" class="btn btn-primary admin-only">Add Product</button>
            </div>
            <div id="productsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add Product</h3>
                <button class="modal-close" onclick="hideModal('productModal')">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Product Type</label>
                    <input type="text" id="productType" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Cost (GBP)</label>
                    <input type="number" step="0.01" id="productCost" class="form-input" value="0" readonly style="background: #f8f9fa;">
                    <small style="color: #6c757d;">Calculated automatically from Raw Materials + Components + Built Items</small>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('productModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Components Modal -->
    <div id="componentsModal" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 id="componentsModalTitle">Product Components</h3>
                <button class="modal-close" onclick="hideModal('componentsModal')">&times;</button>
            </div>
            <div id="componentsContent">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let panels = [];
        let stockItems = [];
        let components = [];
        let currentProductId = null;
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await Promise.all([loadPanels(), loadStockItems(), loadComponents()]);
            loadProducts();
        }
        
        async function loadPanels() {
            try {
                const data = await apiCall('/panels');
                panels = data.panels;
            } catch (error) {
                console.error('Error loading panels:', error);
            }
        }
        
        async function loadStockItems() {
            try {
                const data = await apiCall('/stock');
                stockItems = data.items;
            } catch (error) {
                console.error('Error loading stock items:', error);
            }
        }
        
        async function loadComponents() {
            try {
                const data = await apiCall('/components');
                components = data.components;
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }
        
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                const productsList = document.getElementById('productsList');
                
                if (data.products.length === 0) {
                    productsList.innerHTML = '<p>No products found</p>';
                    return;
                }
                
                // Calculate costs for all products
                const productsWithCosts = await Promise.all(data.products.map(async (product) => {
                    try {
                        const costData = await apiCall(`/products/${product.id}/cost`);
                        return { ...product, calculated_cost: costData.cost };
                    } catch (error) {
                        console.error(`Error calculating cost for product ${product.id}:`, error);
                        return { ...product, calculated_cost: product.cost_gbp || 0 };
                    }
                }));
                
                productsList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Cost (Auto)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsWithCosts.map(product => {
                                const truncatedDesc = product.description 
                                    ? product.description.split(' ').slice(0, 10).join(' ') + (product.description.split(' ').length > 10 ? '...' : '')
                                    : '-';
                                return `
                                <tr>
                                    <td><strong>${product.name}</strong></td>
                                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${product.description || ''}">${truncatedDesc}</td>
                                    <td>${product.product_type || '-'}</td>
                                    <td><span class="badge badge-info">${product.status}</span></td>
                                    <td>${formatCurrency(product.calculated_cost)}</td>
                                    <td>
                                        <button onclick="viewComponents(${product.id})" class="btn btn-primary btn-sm">View Components</button>
                                        ${currentUser.role === 'admin' ? `
                                            <button onclick="editProduct(${product.id})" class="btn btn-secondary btn-sm">Edit</button>
                                            <button onclick="duplicateProduct(${product.id})" class="btn btn-info btn-sm">Duplicate</button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('productsList').innerHTML = '<p>Error loading products</p>';
            }
        }
        
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            showModal('productModal');
        }
        
        async function editProduct(id) {
            try {
                const data = await apiCall('/products');
                const product = data.products.find(p => p.id === id);
                if (!product) return;
                
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productType').value = product.product_type || '';
                // Load calculated cost
                const costData = await apiCall(`/products/${product.id}/cost`);
                document.getElementById('productCost').value = costData.cost.toFixed(2);
                showModal('productModal');
            } catch (error) {
                showAlert('Error loading product', 'error');
            }
        }
        
        async function viewComponents(productId) {
            currentProductId = productId;
            try {
                const componentsData = await apiCall(`/products/${productId}/components`);
                
                document.getElementById('componentsModalTitle').textContent = 'Product Components';
                document.getElementById('componentsContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        ${currentUser.role === 'admin' ? `
                            <button onclick="showAddComponent()" class="btn btn-primary">Add Component</button>
                        ` : ''}
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Component</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                ${currentUser.role === 'admin' ? '<th>Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${componentsData.components.length === 0 ? '<tr><td colspan="5">No components</td></tr>' : componentsData.components.map(comp => `
                                <tr>
                                    <td><span class="badge badge-info">${comp.component_type === 'raw_material' ? 'Raw Material' : comp.component_type === 'component' ? 'Component' : 'Built Item'}</span></td>
                                    <td>${comp.component_name || 'Unknown'}</td>
                                    <td>${comp.quantity_required}</td>
                                    <td>${comp.unit}</td>
                                    ${currentUser.role === 'admin' ? `
                                        <td>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="editComponent(${comp.id})" class="btn btn-secondary btn-sm">Edit</button>
                                                <button onclick="deleteComponent(${comp.id})" class="btn btn-danger btn-sm">Delete</button>
                                            </div>
                                        </td>
                                    ` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                showModal('componentsModal');
            } catch (error) {
                showAlert('Error loading components', 'error');
            }
        }
        
        let editingComponentId = null;
        
        function showAddComponent(componentId = null) {
            editingComponentId = componentId;
            const componentsContent = document.getElementById('componentsContent');
            const isEditing = componentId !== null;
            
            componentsContent.innerHTML = `
                <h4>${isEditing ? 'Edit Component' : 'Add Component'}</h4>
                <form id="componentForm">
                    <input type="hidden" id="compEditId" value="${componentId || ''}">
                    <div class="form-group">
                        <label class="form-label">Component Type *</label>
                        <select id="compType" class="form-select" required onchange="updateComponentOptions()" ${isEditing ? 'disabled' : ''}>
                            <option value="">Select type</option>
                            <option value="raw_material">Raw Material</option>
                            <option value="component">Component</option>
                            <option value="built_item">Built Item</option>
                        </select>
                        ${isEditing ? '<small style="color: #6c757d;">Component type cannot be changed when editing</small>' : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Component *</label>
                        <select id="compId" class="form-select" required ${isEditing ? 'disabled' : ''}>
                            <option value="">Select component</option>
                        </select>
                        ${isEditing ? '<small style="color: #6c757d;">Component cannot be changed when editing</small>' : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity Required *</label>
                        <input type="number" step="0.01" id="compQty" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit *</label>
                        <input type="text" id="compUnit" class="form-input" required>
                    </div>
                    <div class="text-right">
                        <button type="button" onclick="viewComponents(${currentProductId})" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">${isEditing ? 'Update' : 'Add'}</button>
                    </div>
                </form>
            `;
            
            // If editing, load the component data
            if (isEditing) {
                loadComponentForEdit(componentId);
            }
            
            document.getElementById('componentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    if (isEditing) {
                        await apiCall(`/products/${currentProductId}/components/${componentId}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                quantity_required: document.getElementById('compQty').value,
                                unit: document.getElementById('compUnit').value
                            })
                        });
                        showAlert('Component updated');
                    } else {
                        await apiCall(`/products/${currentProductId}/components`, {
                            method: 'POST',
                            body: JSON.stringify({
                                component_type: document.getElementById('compType').value,
                                component_id: document.getElementById('compId').value,
                                quantity_required: document.getElementById('compQty').value,
                                unit: document.getElementById('compUnit').value
                            })
                        });
                        showAlert('Component added');
                    }
                    viewComponents(currentProductId);
                    // Refresh products list to show updated cost
                    loadProducts();
                } catch (error) {
                    showAlert(error.message, 'error');
                }
            });
        }
        
        async function loadComponentForEdit(componentId) {
            try {
                const componentsData = await apiCall(`/products/${currentProductId}/components`);
                const component = componentsData.components.find(c => c.id === componentId);
                if (!component) {
                    showAlert('Component not found', 'error');
                    viewComponents(currentProductId);
                    return;
                }
                
                // Set the form values
                const typeSelect = document.getElementById('compType');
                const compSelect = document.getElementById('compId');
                
                typeSelect.value = component.component_type;
                
                // Populate component options based on type (even though disabled)
                compSelect.innerHTML = '<option value="">Select component</option>';
                if (component.component_type === 'raw_material') {
                    stockItems.forEach(item => {
                        compSelect.innerHTML += `<option value="${item.id}">${item.name} (${item.unit})</option>`;
                    });
                } else if (component.component_type === 'component') {
                    components.forEach(comp => {
                        compSelect.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
                    });
                } else if (component.component_type === 'built_item') {
                    panels.forEach(panel => {
                        compSelect.innerHTML += `<option value="${panel.id}">${panel.name}</option>`;
                    });
                }
                
                // Set the selected component and other values
                compSelect.value = component.component_id;
                document.getElementById('compQty').value = component.quantity_required;
                document.getElementById('compUnit').value = component.unit;
            } catch (error) {
                showAlert('Error loading component', 'error');
                viewComponents(currentProductId);
            }
        }
        
        async function editComponent(componentId) {
            showAddComponent(componentId);
        }
        
        function updateComponentOptions() {
            const type = document.getElementById('compType').value;
            const select = document.getElementById('compId');
            select.innerHTML = '<option value="">Select component</option>';
            
            if (type === 'raw_material') {
                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name} (${item.unit})</option>`;
                });
            } else if (type === 'component') {
                components.forEach(comp => {
                    select.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
                });
            } else if (type === 'built_item') {
                panels.forEach(panel => {
                    select.innerHTML += `<option value="${panel.id}">${panel.name}</option>`;
                });
            }
        }
        
        async function deleteComponent(compId) {
            if (!confirm('Delete this component?')) return;
            try {
                await apiCall(`/products/${currentProductId}/components/${compId}`, { method: 'DELETE' });
                showAlert('Component deleted');
                viewComponents(currentProductId);
                // Refresh products list to show updated cost
                loadProducts();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function duplicateProduct(productId) {
            if (!confirm('Duplicate this product? This will create a copy with all components.')) return;
            try {
                const result = await apiCall(`/products/${productId}/duplicate`, {
                    method: 'POST'
                });
                showAlert('Product duplicated successfully');
                loadProducts();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                product_type: document.getElementById('productType').value,
                status: 'active'
            };
            
            try {
                if (id) {
                    await apiCall(`/products/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Product updated');
                } else {
                    await apiCall('/products', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Product created');
                }
                hideModal('productModal');
                loadProducts();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        init();
    </script>
</body>
</html>

