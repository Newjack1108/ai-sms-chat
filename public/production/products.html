<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finished Products - Production System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Finished Products</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Products</h2>
                <button onclick="showAddProductModal()" class="btn btn-primary admin-only">Add Product</button>
            </div>
            <div class="tabs" style="margin-bottom: 0;">
                <button class="tab-btn active" onclick="filterProducts('all')" id="tab-all">All Products</button>
                <button class="tab-btn" onclick="filterProducts('Standard Product')" id="tab-standard">Standard Product</button>
                <button class="tab-btn" onclick="filterProducts('Customer Product')" id="tab-customer">Customer Product</button>
                <button class="tab-btn" onclick="filterProducts('Bespoke Build')" id="tab-bespoke">Bespoke Build</button>
                <button class="tab-btn" onclick="filterProducts('Other')" id="tab-other">Other</button>
            </div>
            <div id="productsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Add Product</h3>
                <button class="modal-close" onclick="hideModal('productModal')">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Product Type</label>
                    <input type="text" id="productType" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="productCategory" class="form-select" required>
                        <option value="Standard Product">Standard Product</option>
                        <option value="Customer Product">Customer Product</option>
                        <option value="Bespoke Build">Bespoke Build</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cost (GBP)</label>
                    <input type="number" step="0.01" id="productCost" class="form-input" value="0" readonly style="background: #f8f9fa;">
                    <small style="color: #6c757d;">Calculated automatically from Raw Materials + Components + Built Items + Load Time Labour</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Load Time (hours)</label>
                    <input type="number" step="0.01" min="0" id="productLoadTime" class="form-input" value="0">
                    <small style="color: #6c757d;">Load time labour cost will be added to product cost</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Install Time (hours)</label>
                    <input type="number" step="0.01" min="0" id="productInstallTime" class="form-input" value="0">
                    <small style="color: #6c757d;">For reference only - shown on load sheets</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Travel Time (hours)</label>
                    <input type="number" step="0.01" min="0" id="productTravelTime" class="form-input" value="0">
                    <small style="color: #6c757d;">For reference only - shown on load sheets</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Number of Boxes</label>
                    <input type="number" min="0" id="productNumberOfBoxes" class="form-input" value="1">
                    <small style="color: #6c757d;">Boxes per product for inventory / shipping</small>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('productModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Components Modal -->
    <div id="componentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="componentsModalTitle">Product Components</h3>
                <button class="modal-close" onclick="hideModal('componentsModal')">&times;</button>
            </div>
            <div id="componentsContent">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let panels = [];
        let stockItems = [];
        let components = [];
        let currentProductId = null;
        let selectedCategory = 'all';
        let allProducts = [];
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            await Promise.all([loadPanels(), loadStockItems(), loadComponents()]);
            loadProducts();
        }
        
        async function loadPanels() {
            try {
                const data = await apiCall('/panels');
                panels = data.panels;
            } catch (error) {
                console.error('Error loading panels:', error);
            }
        }
        
        async function loadStockItems() {
            try {
                const data = await apiCall('/stock');
                stockItems = data.items;
            } catch (error) {
                console.error('Error loading stock items:', error);
            }
        }
        
        async function loadComponents() {
            try {
                const data = await apiCall('/components');
                components = data.components;
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }
        
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                const productsList = document.getElementById('productsList');
                
                if (data.products.length === 0) {
                    productsList.innerHTML = '<p>No products found</p>';
                    allProducts = [];
                    return;
                }
                
                // Calculate costs for all products
                const productsWithCosts = await Promise.all(data.products.map(async (product) => {
                    try {
                        const costData = await apiCall(`/products/${product.id}/cost`);
                        return { ...product, calculated_cost: costData.cost };
                    } catch (error) {
                        console.error(`Error calculating cost for product ${product.id}:`, error);
                        return { ...product, calculated_cost: product.cost_gbp || 0 };
                    }
                }));
                
                // Store all products
                allProducts = productsWithCosts;
                
                // Filter products based on selected category
                displayProducts();
            } catch (error) {
                document.getElementById('productsList').innerHTML = '<p>Error loading products</p>';
                allProducts = [];
            }
        }
        
        function displayProducts() {
            const productsList = document.getElementById('productsList');
            
            // Filter products by category
            let filteredProducts = allProducts;
            if (selectedCategory !== 'all') {
                filteredProducts = allProducts.filter(product => product.category === selectedCategory);
            }
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p>No products found in this category</p>';
                return;
            }
            
            productsList.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Cost (Auto)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredProducts.map(product => `
                            <tr>
                                <td><strong>${product.name}</strong></td>
                                <td><span class="badge badge-secondary">${product.category || 'Other'}</span></td>
                                <td>${product.product_type || '-'}</td>
                                <td><span class="badge badge-info">${product.status}</span></td>
                                <td>${formatCurrency(product.calculated_cost)}</td>
                                <td>
                                    <button onclick="viewComponents(${product.id})" class="btn btn-primary btn-sm">View Components</button>
                                    ${(currentUser && (currentUser.role === 'admin' || currentUser.role === 'office')) ? `
                                        <button onclick="pushToSales(${product.id})" class="btn btn-success btn-sm" title="Push to Sales App">Push to Sales</button>
                                        <button onclick="editProduct(${product.id})" class="btn btn-secondary btn-sm">Edit</button>
                                        <button onclick="duplicateProduct(${product.id})" class="btn btn-info btn-sm" style="margin-left: 5px;">Duplicate</button>
                                        <button onclick="deleteProduct(${product.id})" class="btn btn-danger btn-sm" style="margin-left: 5px;">Delete</button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function filterProducts(category) {
            selectedCategory = category;
            
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (category === 'all') {
                document.getElementById('tab-all').classList.add('active');
            } else if (category === 'Standard Product') {
                document.getElementById('tab-standard').classList.add('active');
            } else if (category === 'Customer Product') {
                document.getElementById('tab-customer').classList.add('active');
            } else if (category === 'Bespoke Build') {
                document.getElementById('tab-bespoke').classList.add('active');
            } else if (category === 'Other') {
                document.getElementById('tab-other').classList.add('active');
            }
            
            // Display filtered products
            displayProducts();
        }
        
        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            showModal('productModal');
        }
        
        async function editProduct(id) {
            try {
                const data = await apiCall('/products');
                const product = data.products.find(p => p.id === id);
                if (!product) return;
                
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productType').value = product.product_type || '';
                document.getElementById('productCategory').value = product.category || 'Other';
                document.getElementById('productLoadTime').value = product.estimated_load_time || 0;
                document.getElementById('productInstallTime').value = product.estimated_install_time || 0;
                document.getElementById('productTravelTime').value = product.estimated_travel_time || 0;
                document.getElementById('productNumberOfBoxes').value = product.number_of_boxes ?? 1;
                // Load calculated cost
                const costData = await apiCall(`/products/${product.id}/cost`);
                document.getElementById('productCost').value = costData.cost.toFixed(2);
                showModal('productModal');
            } catch (error) {
                showAlert('Error loading product', 'error');
            }
        }
        
        async function viewComponents(productId) {
            currentProductId = productId;
            try {
                const [componentsData, costData] = await Promise.all([
                    apiCall(`/products/${productId}/components`),
                    apiCall(`/products/${productId}/cost`)
                ]);
                const totalCost = (costData && typeof costData.cost === 'number') ? costData.cost : 0;
                // Keep main list in sync so Cost (Auto) is correct when modal is open or after close
                const productIndex = allProducts.findIndex(p => p.id === productId);
                if (productIndex >= 0) {
                    allProducts[productIndex].calculated_cost = totalCost;
                    displayProducts();
                }

                // Get product name from allProducts array or fetch from API
                let productName = null;
                const product = allProducts.find(p => p.id === productId);
                if (product) {
                    productName = product.name;
                } else {
                    // Fallback: fetch product from API if not in array
                    try {
                        const productData = await apiCall(`/products/${productId}`);
                        productName = productData.product ? productData.product.name : `Product #${productId}`;
                    } catch (error) {
                        productName = `Product #${productId}`;
                    }
                }

                document.getElementById('componentsModalTitle').textContent = 'Product Components';
                document.getElementById('componentsContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: #333;">${productName || 'Product Components'}</h4>
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
                            <div>
                                <strong>Total product cost:</strong>
                                <span id="componentsModalTotalCost" style="font-size: 1.1em; margin-left: 8px;">${formatCurrency(totalCost)}</span>
                            </div>
                            <button type="button" onclick="refreshComponentsModalTotal()" class="btn btn-secondary btn-sm">Refresh total</button>
                        </div>
                        ${currentUser.role === 'admin' ? `
                            <button onclick="showAddComponent()" class="btn btn-primary">Add Component</button>
                        ` : ''}
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Component</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                ${currentUser.role === 'admin' ? '<th>Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${componentsData.components.length === 0 ? '<tr><td colspan="5">No components</td></tr>' : componentsData.components.map(comp => `
                                <tr id="comp-row-${comp.id}">
                                    <td><span class="badge badge-info">${comp.component_type === 'raw_material' ? 'Raw Material' : comp.component_type === 'component' ? 'Component' : 'Built Item'}</span></td>
                                    <td>${comp.component_name || 'Unknown'}</td>
                                    <td>
                                        ${currentUser.role === 'admin' ? `
                                            <input type="number" step="0.01" 
                                                id="qty-${comp.id}" 
                                                class="form-input" 
                                                value="${comp.quantity_required}" 
                                                style="width: 100px; display: inline-block;"
                                                data-comp-id="${comp.id}"
                                                data-component-type="${comp.component_type}"
                                                data-component-id="${comp.component_id}"
                                                data-unit="${comp.unit}"
                                                data-original-value="${comp.quantity_required}"
                                                onchange="showSaveButton(${comp.id})"
                                                oninput="showSaveButton(${comp.id})">
                                        ` : comp.quantity_required}
                                    </td>
                                    <td>${comp.unit}</td>
                                    ${currentUser.role === 'admin' ? `
                                        <td>
                                            <span id="save-buttons-${comp.id}" style="display: none;">
                                                <button onclick="saveComponentQuantity(${comp.id})" class="btn btn-primary btn-sm" style="margin-right: 5px;">Save</button>
                                                <button onclick="cancelQuantityEdit(${comp.id})" class="btn btn-secondary btn-sm" style="margin-right: 5px;">Cancel</button>
                                            </span>
                                            <button onclick="deleteComponent(${comp.id})" class="btn btn-danger btn-sm">Delete</button>
                                        </td>
                                    ` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                showModal('componentsModal');
            } catch (error) {
                showAlert('Error loading components', 'error');
            }
        }
        
        function showAddComponent() {
            const componentsContent = document.getElementById('componentsContent');
            componentsContent.innerHTML = `
                <h4>Add Component</h4>
                <form id="componentForm">
                    <div class="form-group">
                        <label class="form-label">Component Type *</label>
                        <select id="compType" class="form-select" required onchange="updateComponentOptions()">
                            <option value="">Select type</option>
                            <option value="raw_material">Raw Material</option>
                            <option value="component">Component</option>
                            <option value="built_item">Built Item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Component *</label>
                        <select id="compId" class="form-select" required>
                            <option value="">Select component</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity Required *</label>
                        <input type="number" step="0.01" id="compQty" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit *</label>
                        <input type="text" id="compUnit" class="form-input" required>
                    </div>
                    <div class="text-right">
                        <button type="button" onclick="viewComponents(${currentProductId})" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
            `;
            
            document.getElementById('componentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await apiCall(`/products/${currentProductId}/components`, {
                        method: 'POST',
                        body: JSON.stringify({
                            component_type: document.getElementById('compType').value,
                            component_id: document.getElementById('compId').value,
                            quantity_required: document.getElementById('compQty').value,
                            unit: document.getElementById('compUnit').value
                        })
                    });
                    showAlert('Component added');
                    viewComponents(currentProductId);
                } catch (error) {
                    showAlert(error.message, 'error');
                }
            });
        }
        
        function updateComponentOptions() {
            const type = document.getElementById('compType').value;
            const select = document.getElementById('compId');
            select.innerHTML = '<option value="">Select component</option>';
            
            if (type === 'raw_material') {
                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name} (${item.unit})</option>`;
                });
            } else if (type === 'component') {
                components.forEach(comp => {
                    select.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
                });
            } else if (type === 'built_item') {
                panels.forEach(panel => {
                    select.innerHTML += `<option value="${panel.id}">${panel.name}</option>`;
                });
            }
        }
        
        async function refreshComponentsModalTotal() {
            if (!currentProductId) return;
            const el = document.getElementById('componentsModalTotalCost');
            if (!el) return;
            try {
                el.textContent = '…';
                const costData = await apiCall(`/products/${currentProductId}/cost`);
                const cost = (costData && typeof costData.cost === 'number') ? costData.cost : 0;
                el.textContent = formatCurrency(cost);
            } catch (error) {
                el.textContent = '—';
                showAlert(error.message || 'Failed to refresh total', 'error');
            }
        }

        function showSaveButton(compId) {
            const qtyInput = document.getElementById(`qty-${compId}`);
            const saveButtons = document.getElementById(`save-buttons-${compId}`);
            
            if (!qtyInput || !saveButtons) return;
            
            const originalValue = parseFloat(qtyInput.dataset.originalValue);
            const currentValue = parseFloat(qtyInput.value);
            
            // Show save buttons if value has changed
            if (!isNaN(currentValue) && currentValue !== originalValue) {
                saveButtons.style.display = 'inline';
            } else {
                saveButtons.style.display = 'none';
            }
        }
        
        async function saveComponentQuantity(compId) {
            const qtyInput = document.getElementById(`qty-${compId}`);
            if (!qtyInput) return;
            
            const componentType = qtyInput.dataset.componentType;
            const componentId = qtyInput.dataset.componentId;
            const unit = qtyInput.dataset.unit;
            
            if (!compId || !componentType || !componentId || !unit) {
                showAlert('Missing component data', 'error');
                return;
            }
            
            const newQuantity = parseFloat(qtyInput.value);
            if (isNaN(newQuantity) || newQuantity < 0) {
                showAlert('Invalid quantity', 'error');
                cancelQuantityEdit(compId); // Reset to original value
                return;
            }
            
            // Show loading state
            const saveButtons = document.getElementById(`save-buttons-${compId}`);
            if (saveButtons) {
                saveButtons.style.display = 'none';
            }
            qtyInput.disabled = true;
            
            try {
                await apiCall(`/products/${currentProductId}/components/${compId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        component_type: componentType,
                        component_id: parseInt(componentId),
                        quantity_required: newQuantity,
                        unit: unit
                    })
                });
                showAlert('Quantity updated');
                viewComponents(currentProductId);
            } catch (error) {
                showAlert(error.message || 'Failed to update quantity', 'error');
                qtyInput.disabled = false;
                showSaveButton(compId); // Show buttons again on error
            }
        }
        
        function cancelQuantityEdit(compId) {
            const qtyInput = document.getElementById(`qty-${compId}`);
            const saveButtons = document.getElementById(`save-buttons-${compId}`);
            
            if (!qtyInput) return;
            
            // Reset to original value
            const originalValue = qtyInput.dataset.originalValue;
            qtyInput.value = originalValue;
            
            // Hide save buttons
            if (saveButtons) {
                saveButtons.style.display = 'none';
            }
        }
        
        async function deleteComponent(compId) {
            if (!confirm('Delete this component?')) return;
            try {
                await apiCall(`/products/${currentProductId}/components/${compId}`, { method: 'DELETE' });
                showAlert('Component deleted');
                viewComponents(currentProductId);
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }
        
        async function duplicateProduct(id) {
            if (!confirm('Duplicate this product? This will create a copy with all its components.')) return;
            try {
                await apiCall(`/products/${id}/duplicate`, { method: 'POST' });
                showAlert('Product duplicated successfully');
                loadProducts();
            } catch (error) {
                showAlert(error.message || 'Failed to duplicate product', 'error');
            }
        }

        async function pushToSales(id) {
            try {
                await apiCall(`/products/${id}/push-to-sales`, { method: 'POST' });
                showAlert('Product pushed to sales app');
            } catch (error) {
                showAlert(error.message || 'Failed to push to sales app', 'error');
            }
        }

        async function deleteProduct(id) {
            const product = allProducts.find(p => p.id === id);
            const name = product ? product.name : `#${id}`;
            if (!confirm(`Delete product "${name}"? This will remove the product and all its components. This cannot be undone.`)) return;
            try {
                await apiCall(`/products/${id}`, { method: 'DELETE' });
                showAlert('Product deleted');
                loadProducts();
            } catch (error) {
                showAlert(error.message || 'Failed to delete product', 'error');
            }
        }
        
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                product_type: document.getElementById('productType').value,
                category: document.getElementById('productCategory').value,
                status: 'active',
                estimated_load_time: parseFloat(document.getElementById('productLoadTime').value) || 0,
                estimated_install_time: parseFloat(document.getElementById('productInstallTime').value) || 0,
                estimated_travel_time: parseFloat(document.getElementById('productTravelTime').value) || 0,
                number_of_boxes: Math.max(0, parseInt(document.getElementById('productNumberOfBoxes').value, 10) || 1)
            };
            
            try {
                if (id) {
                    await apiCall(`/products/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Product updated');
                } else {
                    await apiCall('/products', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Product created');
                }
                hideModal('productModal');
                loadProducts();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        init();
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            </div>
            <div class="footer-info">
                <p>&copy; <script>document.write(new Date().getFullYear())</script> Production System. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>

