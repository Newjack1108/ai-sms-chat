<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock ON/OFF</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .timesheet-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .notice-board {
            margin-bottom: 30px;
        }
        
        .notice-item {
            background: white;
            border-left: 4px solid #4CBB17;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .notice-item.urgent {
            border-left-color: #e74c3c;
            background: #fee;
        }
        
        .notice-item.high {
            border-left-color: #f39c12;
            background: #fff8e1;
        }
        
        .notice-item.normal {
            border-left-color: #4CBB17;
        }
        
        .notice-item.low {
            border-left-color: #808080;
        }
        
        .notice-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .notice-message {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .notice-meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        .clock-status {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .clock-status.clocked-in {
            background: linear-gradient(135deg, #4CBB17 0%, #3A9B12 100%);
            color: white;
        }
        
        .clock-status-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .clock-details {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .clock-controls {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .job-select-group {
            margin-bottom: 25px;
        }
        
        .clock-button {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .clock-button.clock-in {
            background: linear-gradient(135deg, #4CBB17 0%, #3A9B12 100%);
            color: white;
        }
        
        .clock-button.clock-in:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 187, 23, 0.4);
        }
        
        .clock-button.clock-out {
            background: linear-gradient(135deg, #808080 0%, #606060 100%);
            color: white;
        }
        
        .clock-button.clock-out:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(128, 128, 128, 0.4);
        }
        
        .clock-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .location-status {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        .location-status.error {
            color: #e74c3c;
        }
        
        .location-status.success {
            color: #27ae60;
        }
        
        .weekly-timesheet {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .week-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #808080;
        }
        
        .week-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .week-header h2 {
            color: #4CBB17;
            margin: 0;
            font-size: 18px;
        }
        
        .week-navigation {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .week-navigation button {
            padding: 6px 10px;
            border: 1px solid #808080;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            color: #4CBB17;
            font-weight: 600;
            font-size: 12px;
            min-width: 40px;
        }
        
        .week-navigation button:hover {
            background: #f5f5f5;
            border-color: #4CBB17;
        }
        
        .week-range-display {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            padding: 5px 0;
        }
        
        @media (max-width: 768px) {
            .week-header {
                padding: 12px;
            }
            
            .week-header h2 {
                font-size: 16px;
            }
            
            .week-navigation {
                gap: 6px;
            }
            
            .week-navigation button {
                padding: 5px 8px;
                font-size: 11px;
                min-width: 35px;
            }
            
            .week-range-display {
                font-size: 13px;
            }
        }
        
        .day-entry {
            border: 1px solid #808080;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f5f5f5;
        }
        
        .day-entry.has-hours {
            background: white;
            border-color: #4CBB17;
        }
        
        .day-entry.has-clock-times {
            background: white;
            border-color: #808080;
            border-left: 4px solid #4CBB17;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .day-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .day-date {
            font-size: 14px;
            color: #666;
        }
        
        .day-hours {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .hour-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .hour-item.regular { border-left: 3px solid #4CBB17; }
        .hour-item.overtime { border-left: 3px solid #3A9B12; }
        .hour-item.weekend { border-left: 3px solid #808080; }
        .hour-item.overnight { border-left: 3px solid #606060; }
        
        .hour-label {
            font-weight: 600;
            color: #555;
        }
        
        .hour-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .day-notes {
            margin-top: 10px;
        }
        
        .day-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .overnight-checkbox {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .edit-times-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #4CBB17;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-times-btn:hover {
            background: #3A9B12;
        }
        
        .amendment-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .amendment-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .amendment-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .amendment-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .weekly-summary {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #4CBB17 0%, #3A9B12 100%);
            color: white;
            border-radius: 8px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .summary-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.3);
            font-weight: 700;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Clock ON/OFF</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm manager-only">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="timesheet-container">
            <!-- Notice Board -->
            <div class="card notice-board">
                <div class="card-header">
                    <h2>Notices & Reminders</h2>
                </div>
                <div id="noticesList">
                    <div class="loading">Loading notices...</div>
                </div>
            </div>
            
            <!-- Clock Status -->
            <div class="clock-status" id="clockStatus">
                <div class="clock-status-text">Loading...</div>
                <div class="clock-details" id="clockDetails"></div>
            </div>
            
            <!-- Clock Controls -->
            <div class="clock-controls">
                <div class="job-select-group" id="jobSelectGroup" style="display: none;">
                    <label class="form-label">Select Job/Site *</label>
                    <select id="jobSelect" class="form-select" required>
                        <option value="">Loading jobs...</option>
                    </select>
                </div>
                
                <button id="clockInBtn" class="clock-button clock-in" onclick="handleClockIn()" style="display: none;">
                    Clock In
                </button>
                
                <button id="clockOutBtn" class="clock-button clock-out" onclick="handleClockOut()" style="display: none;">
                    Clock Out
                </button>
                
                <div class="location-status" id="locationStatus"></div>
            </div>
            
            <!-- Weekly Timesheet -->
            <div class="weekly-timesheet">
                <div class="week-header">
                    <div class="week-header-top">
                        <h2>Weekly Timesheet</h2>
                        <div class="week-navigation">
                            <button onclick="previousWeek()" title="Previous week">←</button>
                            <button onclick="nextWeek()" title="Next week">→</button>
                        </div>
                    </div>
                    <div class="week-range-display" id="weekRange"></div>
                </div>
                <div id="weeklyTimesheetContent">
                    <div class="loading">Loading timesheet...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Amendment Modal -->
    <div id="amendmentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Edit Clock Times</h3>
                <span class="close" onclick="closeAmendmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="amendmentForm">
                    <input type="hidden" id="amendmentEntryId">
                    <div class="form-group">
                        <label>Original Clock In:</label>
                        <div id="originalClockIn" style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Original Clock Out:</label>
                        <div id="originalClockOut" style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="amendedClockIn">New Clock In Time *</label>
                        <input type="datetime-local" id="amendedClockIn" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="amendedClockOut">New Clock Out Time *</label>
                        <input type="datetime-local" id="amendedClockOut" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="amendmentReason">Reason for Amendment *</label>
                        <textarea id="amendmentReason" class="form-control" rows="3" required placeholder="Please explain why you need to change these times..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAmendmentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        console.log('=== TIMESHEET PAGE SCRIPT LOADING ===');
        let currentUser = null;
        let currentStatus = null;
        let jobs = [];
        let currentLocation = null;
        let locationError = false;
        
        async function init() {
            console.log('=== INIT FUNCTION CALLED ===');
            console.log('Checking auth...');
            currentUser = await checkAuth();
            console.log('Auth check complete, user:', currentUser ? currentUser.username : 'null');
            if (!currentUser) {
                console.log('No current user, returning from init');
                return;
            }
            console.log('Initializing navbar...');
            initNavbar();
            
            // Hide dashboard link for staff
            if (currentUser.role === 'staff') {
                const dashboardLink = document.querySelector('a[href="dashboard.html"]');
                if (dashboardLink) {
                    dashboardLink.style.display = 'none';
                }
            }
            
            // Request location permission
            requestLocation();
            
            // Load initial data
            try {
                await Promise.all([
                    loadNotices(),
                    loadJobs(),
                    loadClockStatus()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Error loading some data. Please refresh the page.', 'error');
            }
            
            // Load weekly timesheet (don't block on error)
            console.log('=== ABOUT TO LOAD WEEKLY TIMESHEET ===');
            console.log('Checking if weeklyTimesheetContent exists:', !!document.getElementById('weeklyTimesheetContent'));
            setTimeout(() => {
                console.log('=== INSIDE setTimeout, CALLING loadWeeklyTimesheet ===');
                loadWeeklyTimesheet().catch(error => {
                    console.error('Error loading weekly timesheet in init:', error);
                    console.error('Error stack:', error.stack);
                    const content = document.getElementById('weeklyTimesheetContent');
                    if (content) {
                        content.innerHTML = `<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading weekly timesheet. Please refresh the page.<br><small>${escapeHtml(error.message || 'Unknown error')}</small></p>`;
                    } else {
                        console.error('weeklyTimesheetContent element not found for error display');
                    }
                });
            }, 100); // Small delay to ensure DOM is ready
        }
        
        function requestLocation() {
            if (!navigator.geolocation) {
                locationError = true;
                updateLocationStatus('Geolocation not supported by your browser', 'error');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    updateLocationStatus('Location ready', 'success');
                },
                (error) => {
                    locationError = true;
                    let message = 'Location access denied';
                    if (error.code === error.PERMISSION_DENIED) {
                        message = 'Please enable location access to clock in/out';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        message = 'Location unavailable';
                    } else if (error.code === error.TIMEOUT) {
                        message = 'Location request timeout';
                    }
                    updateLocationStatus(message, 'error');
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }
        
        function updateLocationStatus(message, type) {
            const statusEl = document.getElementById('locationStatus');
            statusEl.textContent = message;
            statusEl.className = `location-status ${type}`;
        }
        
        async function loadNotices() {
            try {
                const data = await apiCall('/timesheet/notices');
                const notices = data.notices || [];
                const noticesList = document.getElementById('noticesList');
                
                if (notices.length === 0) {
                    noticesList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No notices at this time</p>';
                    return;
                }
                
                noticesList.innerHTML = notices.map(notice => {
                    const priorityClass = notice.priority || 'normal';
                    const expiresText = notice.expires_at ? `Expires: ${formatDate(notice.expires_at)}` : '';
                    return `
                        <div class="notice-item ${priorityClass}">
                            <div class="notice-title">${escapeHtml(notice.title)}</div>
                            <div class="notice-message">${escapeHtml(notice.message)}</div>
                            <div class="notice-meta">${expiresText}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                document.getElementById('noticesList').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading notices</p>';
            }
        }
        
        async function loadJobs() {
            try {
                const data = await apiCall('/timesheet/jobs');
                jobs = data.jobs || [];
                const jobSelect = document.getElementById('jobSelect');
                
                jobSelect.innerHTML = '<option value="">Select job/site</option>';
                jobs.forEach(job => {
                    jobSelect.innerHTML += `<option value="${job.id}">${job.name}${job.description ? ' - ' + job.description : ''}</option>`;
                });
            } catch (error) {
                showAlert('Error loading jobs', 'error');
            }
        }
        
        async function loadClockStatus() {
            try {
                const data = await apiCall('/clock/status');
                currentStatus = data.status;
                updateUI();
            } catch (error) {
                showAlert('Error loading clock status', 'error');
            }
        }
        
        function updateUI() {
            const clockStatus = document.getElementById('clockStatus');
            const clockDetails = document.getElementById('clockDetails');
            const jobSelectGroup = document.getElementById('jobSelectGroup');
            const clockInBtn = document.getElementById('clockInBtn');
            const clockOutBtn = document.getElementById('clockOutBtn');
            
            if (currentStatus) {
                // Clocked in
                clockStatus.className = 'clock-status clocked-in';
                clockStatus.querySelector('.clock-status-text').textContent = 'You are clocked in';
                const clockInTime = new Date(currentStatus.clock_in_time);
                clockDetails.innerHTML = `
                    <div>Job: ${escapeHtml(currentStatus.job_name || 'Unknown')}</div>
                    <div>Clocked in: ${formatDateTime(clockInTime)}</div>
                `;
                
                jobSelectGroup.style.display = 'none';
                clockInBtn.style.display = 'none';
                clockOutBtn.style.display = 'block';
            } else {
                // Not clocked in
                clockStatus.className = 'clock-status';
                clockStatus.querySelector('.clock-status-text').textContent = 'You are not clocked in';
                clockDetails.textContent = 'Select a job/site and clock in to start';
                
                jobSelectGroup.style.display = 'block';
                clockInBtn.style.display = 'block';
                clockOutBtn.style.display = 'none';
            }
        }
        
        async function handleClockIn() {
            const jobId = document.getElementById('jobSelect').value;
            if (!jobId) {
                showAlert('Please select a job/site', 'error');
                return;
            }
            
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            const clockInBtn = document.getElementById('clockInBtn');
            clockInBtn.disabled = true;
            clockInBtn.textContent = 'Clocking in...';
            
            try {
                await apiCall('/clock/clock-in', {
                    method: 'POST',
                    body: JSON.stringify({
                        job_id: jobId,
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked in successfully');
                await loadClockStatus();
            } catch (error) {
                showAlert(error.message || 'Failed to clock in', 'error');
            } finally {
                clockInBtn.disabled = false;
                clockInBtn.textContent = 'Clock In';
            }
        }
        
        async function handleClockOut() {
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            const clockOutBtn = document.getElementById('clockOutBtn');
            clockOutBtn.disabled = true;
            clockOutBtn.textContent = 'Clocking out...';
            
            try {
                await apiCall('/clock/clock-out', {
                    method: 'POST',
                    body: JSON.stringify({
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked out successfully');
                await loadClockStatus();
                await loadWeeklyTimesheet(currentWeekStart || getCurrentWeekStart());
            } catch (error) {
                showAlert(error.message || 'Failed to clock out', 'error');
            } finally {
                clockOutBtn.disabled = false;
                clockOutBtn.textContent = 'Clock Out';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Weekly timesheet functions
        let currentWeekStart = null;
        
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            monday.setHours(0, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }
        
        function getWeekDates(weekStart) {
            const start = new Date(weekStart);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function getDayName(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }
        
        async function loadWeeklyTimesheet(weekStart = null) {
            if (!weekStart) {
                weekStart = getCurrentWeekStart();
            }
            currentWeekStart = weekStart;
            
            const content = document.getElementById('weeklyTimesheetContent');
            if (!content) {
                console.error('weeklyTimesheetContent element not found');
                return;
            }
            
            // Show loading state
            content.innerHTML = '<div class="loading">Loading weekly timesheet...</div>';
            
            try {
                console.log('Loading weekly timesheet for week:', weekStart);
                console.log('API endpoint:', `/clock/weekly/${weekStart}`);
                const data = await apiCall(`/clock/weekly/${weekStart}`);
                console.log('Weekly timesheet data received:', data);
                console.log('Data type:', typeof data);
                console.log('Data keys:', data ? Object.keys(data) : 'null/undefined');
                
                if (!data) {
                    throw new Error('No data received from API');
                }
                
                if (!data.success) {
                    throw new Error(data?.error || 'API returned success: false');
                }
                
                const weeklyTimesheet = data.weeklyTimesheet;
                const dailyEntries = data.dailyEntries || [];
                const timesheetEntries = data.timesheetEntries || [];
                
                console.log('Weekly timesheet:', weeklyTimesheet);
                console.log('Daily entries count:', dailyEntries.length);
                console.log('Timesheet entries count:', timesheetEntries.length);
                
                // Create a map of daily entries by date
                const entriesMap = {};
                dailyEntries.forEach(entry => {
                    entriesMap[entry.entry_date] = entry;
                });
                
                // Also map timesheet entries by date (for entries that don't have daily entries)
                timesheetEntries.forEach(te => {
                    const clockInDate = new Date(te.clock_in_time);
                    const dateStr = clockInDate.toISOString().split('T')[0];
                    
                    // Only add if there's no daily entry for this date, or if daily entry doesn't have times
                    if (!entriesMap[dateStr] || !entriesMap[dateStr].clock_in_time) {
                        if (!entriesMap[dateStr]) {
                            entriesMap[dateStr] = {
                                entry_date: dateStr,
                                timesheet_entry_id: te.id,
                                clock_in_time: te.clock_in_time,
                                clock_out_time: te.clock_out_time,
                                regular_hours: te.regular_hours || 0,
                                overtime_hours: te.overtime_hours || 0,
                                weekend_hours: te.weekend_hours || 0,
                                overnight_hours: te.overnight_hours || 0,
                                total_hours: te.total_hours || 0
                            };
                        } else {
                            // Merge timesheet entry data into daily entry
                            entriesMap[dateStr].timesheet_entry_id = te.id;
                            entriesMap[dateStr].clock_in_time = entriesMap[dateStr].clock_in_time || te.clock_in_time;
                            entriesMap[dateStr].clock_out_time = entriesMap[dateStr].clock_out_time || te.clock_out_time;
                            if (!entriesMap[dateStr].regular_hours && te.regular_hours) {
                                entriesMap[dateStr].regular_hours = te.regular_hours;
                            }
                            if (!entriesMap[dateStr].overtime_hours && te.overtime_hours) {
                                entriesMap[dateStr].overtime_hours = te.overtime_hours;
                            }
                            if (!entriesMap[dateStr].weekend_hours && te.weekend_hours) {
                                entriesMap[dateStr].weekend_hours = te.weekend_hours;
                            }
                            if (!entriesMap[dateStr].overnight_hours && te.overnight_hours) {
                                entriesMap[dateStr].overnight_hours = te.overnight_hours;
                            }
                            if (!entriesMap[dateStr].total_hours && te.total_hours) {
                                entriesMap[dateStr].total_hours = te.total_hours;
                            }
                        }
                    }
                });
                
                // Display week range
                const weekDates = getWeekDates(weekStart);
                const startDate = new Date(weekDates[0]);
                const endDate = new Date(weekDates[6]);
                const weekRangeEl = document.getElementById('weekRange');
                if (weekRangeEl) {
                    weekRangeEl.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
                } else {
                    console.warn('weekRange element not found');
                }
                
                // Display daily entries
                const content = document.getElementById('weeklyTimesheetContent');
                if (!content) {
                    console.error('weeklyTimesheetContent not found after API call');
                    return;
                }
                let html = '';
                let totalRegular = 0, totalOvertime = 0, totalWeekend = 0, totalOvernight = 0, totalHours = 0;
                
                weekDates.forEach(dateStr => {
                    const entry = entriesMap[dateStr] || null;
                    const dayName = getDayName(dateStr);
                    const date = new Date(dateStr);
                    const isCurrentWeek = weekStart === getCurrentWeekStart();
                    
                    let clockInTime = '';
                    let clockOutTime = '';
                    let regularHours = 0, overtimeHours = 0, weekendHours = 0, overnightHours = 0, dayTotal = 0;
                    let amendmentStatus = '';
                    
                    if (entry) {
                        if (entry.clock_in_time) {
                            clockInTime = formatDateTime(new Date(entry.clock_in_time));
                        }
                        if (entry.clock_out_time) {
                            clockOutTime = formatDateTime(new Date(entry.clock_out_time));
                        }
                        // Convert to numbers to ensure they're numeric
                        regularHours = parseFloat(entry.regular_hours) || 0;
                        overtimeHours = parseFloat(entry.overtime_hours) || 0;
                        weekendHours = parseFloat(entry.weekend_hours) || 0;
                        overnightHours = parseFloat(entry.overnight_hours) || 0;
                        dayTotal = parseFloat(entry.total_hours) || 0;
                        
                        totalRegular += regularHours;
                        totalOvertime += overtimeHours;
                        totalWeekend += weekendHours;
                        totalOvernight += overnightHours;
                        totalHours += dayTotal;
                    }
                    
                    const hasHours = dayTotal > 0;
                    const hasEntry = entry !== null;
                    const hasClockTimes = entry && (entry.clock_in_time || entry.clock_out_time);
                    
                    // Check if amendment is allowed (current week or one week back)
                    let canAmend = false;
                    if (hasClockTimes && entry.timesheet_entry_id) {
                        const today = new Date();
                        const oneWeekAgo = new Date(today);
                        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                        oneWeekAgo.setHours(0, 0, 0, 0);
                        const entryDate = new Date(dateStr);
                        entryDate.setHours(0, 0, 0, 0);
                        canAmend = entryDate >= oneWeekAgo;
                    }
                    
                    html += `
                        <div class="day-entry ${hasHours ? 'has-hours' : (hasClockTimes ? 'has-clock-times' : '')}">
                            <div class="day-header">
                                <div>
                                    <span class="day-name">${dayName}</span>
                                    <span class="day-date">${formatDate(date)}</span>
                                </div>
                                ${canAmend ? `
                                    <button class="edit-times-btn" onclick="showAmendmentModal(${entry.timesheet_entry_id}, '${entry.clock_in_time || ''}', '${entry.clock_out_time || ''}')">
                                        Edit Times
                                    </button>
                                ` : hasClockTimes && entry.timesheet_entry_id ? `
                                    <span style="font-size: 11px; color: #999; font-style: italic;">Too old to amend</span>
                                ` : ''}
                            </div>
                            ${hasClockTimes ? `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #4CBB17;">
                                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">Clock Times:</div>
                                    <div style="font-size: 14px; color: #555;">
                                        ${clockInTime ? `<strong>Clock In:</strong> ${clockInTime}` : '<span style="color: #999;">No clock in recorded</span>'}
                                        ${clockOutTime ? `<br><strong>Clock Out:</strong> ${clockOutTime}` : clockInTime ? '<br><span style="color: #999;">No clock out recorded</span>' : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${hasHours ? `
                                <div class="day-hours">
                                    ${regularHours > 0 ? `
                                        <div class="hour-item regular">
                                            <div class="hour-label">Regular</div>
                                            <div class="hour-value">${regularHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${overtimeHours > 0 ? `
                                        <div class="hour-item overtime">
                                            <div class="hour-label">Overtime (1.25x)</div>
                                            <div class="hour-value">${overtimeHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${weekendHours > 0 ? `
                                        <div class="hour-item weekend">
                                            <div class="hour-label">Weekend (1.5x)</div>
                                            <div class="hour-value">${weekendHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${overnightHours > 0 ? `
                                        <div class="hour-item overnight">
                                            <div class="hour-label">Overnight (1.25x)</div>
                                            <div class="hour-value">${overnightHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${isCurrentWeek ? `
                                <div class="day-notes">
                                    <textarea 
                                        id="notes-${dateStr}" 
                                        placeholder="What did you do today?"
                                        onblur="saveDailyNotes('${dateStr}', this.value)"
                                    >${entry ? (entry.daily_notes || '') : ''}</textarea>
                                </div>
                                <div class="overnight-checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="overnight-${dateStr}" 
                                        ${entry && entry.overnight_away ? 'checked' : ''}
                                        onchange="saveOvernightAway('${dateStr}', this.checked)"
                                    >
                                    <label for="overnight-${dateStr}">Overnight away from home</label>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Add weekly summary (ensure totals are numbers)
                const finalRegular = parseFloat(totalRegular) || 0;
                const finalOvertime = parseFloat(totalOvertime) || 0;
                const finalWeekend = parseFloat(totalWeekend) || 0;
                const finalOvernight = parseFloat(totalOvernight) || 0;
                const finalTotal = parseFloat(totalHours) || 0;
                
                html += `
                    <div class="weekly-summary">
                        <div class="summary-row">
                            <span>Regular Hours:</span>
                            <span>${finalRegular.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Overtime Hours (1.25x):</span>
                            <span>${finalOvertime.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Weekend Hours (1.5x):</span>
                            <span>${finalWeekend.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Overnight Hours (1.25x):</span>
                            <span>${finalOvernight.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total Hours:</span>
                            <span>${finalTotal.toFixed(2)}h</span>
                        </div>
                    </div>
                `;
                
                console.log('Generated HTML length:', html.length);
                console.log('Setting innerHTML on content element');
                content.innerHTML = html;
                console.log('innerHTML set successfully');
                
                // Verify it was set
                if (content.innerHTML.length === 0) {
                    console.error('WARNING: innerHTML is empty after setting!');
                } else {
                    console.log('innerHTML set successfully, length:', content.innerHTML.length);
                }
            } catch (error) {
                console.error('Error loading weekly timesheet:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                const errorMsg = error.message || 'Failed to load weekly timesheet';
                const content = document.getElementById('weeklyTimesheetContent');
                if (content) {
                    content.innerHTML = 
                        `<p style="text-align: center; color: #e74c3c; padding: 20px;">
                            Error loading weekly timesheet: ${escapeHtml(errorMsg)}
                            <br><small>Check browser console for details</small>
                        </p>`;
                }
            }
        }
        
        function previousWeek() {
            if (!currentWeekStart) return;
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() - 7);
            loadWeeklyTimesheet(date.toISOString().split('T')[0]);
        }
        
        function nextWeek() {
            if (!currentWeekStart) return;
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + 7);
            loadWeeklyTimesheet(date.toISOString().split('T')[0]);
        }
        
        async function saveDailyNotes(date, notes) {
            if (!currentWeekStart) return;
            try {
                await apiCall(`/clock/weekly/${currentWeekStart}/day/${date}`, {
                    method: 'PUT',
                    body: JSON.stringify({ daily_notes: notes })
                });
            } catch (error) {
                showAlert('Failed to save notes', 'error');
            }
        }
        
        async function saveOvernightAway(date, overnightAway) {
            if (!currentWeekStart) return;
            try {
                await apiCall(`/clock/weekly/${currentWeekStart}/day/${date}`, {
                    method: 'PUT',
                    body: JSON.stringify({ overnight_away: overnightAway })
                });
                // Reload to update hours
                await loadWeeklyTimesheet(currentWeekStart);
            } catch (error) {
                showAlert('Failed to save overnight away status', 'error');
            }
        }
        
        // Time amendment functions
        function showAmendmentModal(entryId, clockInTime, clockOutTime) {
            // Check if amendment is allowed (current week or one week back)
            const clockInDate = clockInTime ? new Date(clockInTime) : new Date();
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            oneWeekAgo.setHours(0, 0, 0, 0);
            const entryDate = new Date(clockInDate);
            entryDate.setHours(0, 0, 0, 0);
            
            if (entryDate < oneWeekAgo) {
                showAlert('Amendments are only allowed for the current week and one week back. Payroll is processed by Wednesday the week after completion.', 'error');
                return;
            }
            
            document.getElementById('amendmentEntryId').value = entryId;
            document.getElementById('originalClockIn').textContent = clockInTime ? formatDateTime(new Date(clockInTime)) : 'Not set';
            document.getElementById('originalClockOut').textContent = clockOutTime ? formatDateTime(new Date(clockOutTime)) : 'Not set';
            
            // Set default values to current times
            if (clockInTime) {
                const clockIn = new Date(clockInTime);
                const localDateTime = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('amendedClockIn').value = localDateTime;
            }
            if (clockOutTime) {
                const clockOut = new Date(clockOutTime);
                const localDateTime = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('amendedClockOut').value = localDateTime;
            }
            
            document.getElementById('amendmentModal').style.display = 'block';
        }
        
        function closeAmendmentModal() {
            document.getElementById('amendmentModal').style.display = 'none';
            document.getElementById('amendmentForm').reset();
        }
        
        document.getElementById('amendmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const entryId = parseInt(document.getElementById('amendmentEntryId').value);
            const amendedClockIn = document.getElementById('amendedClockIn').value;
            const amendedClockOut = document.getElementById('amendedClockOut').value;
            const reason = document.getElementById('amendmentReason').value;
            
            // Convert local datetime to ISO string
            const clockInISO = new Date(amendedClockIn).toISOString();
            const clockOutISO = new Date(amendedClockOut).toISOString();
            
            try {
                await apiCall('/clock/amendments', {
                    method: 'POST',
                    body: JSON.stringify({
                        entry_id: entryId,
                        amended_clock_in_time: clockInISO,
                        amended_clock_out_time: clockOutISO,
                        reason: reason
                    })
                });
                showAlert('Amendment request submitted. Waiting for approval.');
                closeAmendmentModal();
                await loadWeeklyTimesheet(currentWeekStart);
            } catch (error) {
                showAlert(error.message || 'Failed to submit amendment request', 'error');
            }
        });
        
        // Call init when DOM is ready
        console.log('=== SCRIPT LOADED, CALLING INIT ===');
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('=== DOMContentLoaded EVENT, CALLING INIT ===');
                init();
            });
        } else {
            console.log('=== DOM ALREADY READY, CALLING INIT IMMEDIATELY ===');
            init();
        }
    </script>
</body>
</html>

