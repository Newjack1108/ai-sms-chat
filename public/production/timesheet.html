<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock ON/OFF</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .timesheet-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .notice-board {
            margin-bottom: 30px;
        }
        
        .notice-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .notice-item.urgent {
            border-left-color: #e74c3c;
            background: #fee;
        }
        
        .notice-item.high {
            border-left-color: #f39c12;
            background: #fff8e1;
        }
        
        .notice-item.normal {
            border-left-color: #3498db;
        }
        
        .notice-item.low {
            border-left-color: #95a5a6;
        }
        
        .notice-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .notice-message {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .notice-meta {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        .clock-status {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .clock-status.clocked-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .clock-status-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .clock-details {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .clock-controls {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .job-select-group {
            margin-bottom: 25px;
        }
        
        .clock-button {
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .clock-button.clock-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .clock-button.clock-in:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .clock-button.clock-out {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .clock-button.clock-out:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }
        
        .clock-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .location-status {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        .location-status.error {
            color: #e74c3c;
        }
        
        .location-status.success {
            color: #27ae60;
        }
        
        .weekly-timesheet {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .week-navigation {
            display: flex;
            gap: 10px;
        }
        
        .week-navigation button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .week-navigation button:hover {
            background: #f5f5f5;
        }
        
        .day-entry {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .day-entry.has-hours {
            background: white;
            border-color: #667eea;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .day-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .day-date {
            font-size: 14px;
            color: #666;
        }
        
        .day-hours {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .hour-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .hour-item.regular { border-left: 3px solid #3498db; }
        .hour-item.overtime { border-left: 3px solid #f39c12; }
        .hour-item.weekend { border-left: 3px solid #9b59b6; }
        .hour-item.overnight { border-left: 3px solid #e74c3c; }
        
        .hour-label {
            font-weight: 600;
            color: #555;
        }
        
        .hour-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .day-notes {
            margin-top: 10px;
        }
        
        .day-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .overnight-checkbox {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .edit-times-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-times-btn:hover {
            background: #5568d3;
        }
        
        .amendment-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .amendment-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .amendment-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .amendment-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .weekly-summary {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .summary-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid rgba(255,255,255,0.3);
            font-weight: 700;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Clock ON/OFF</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm manager-only">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="timesheet-container">
            <!-- Notice Board -->
            <div class="card notice-board">
                <div class="card-header">
                    <h2>Notices & Reminders</h2>
                </div>
                <div id="noticesList">
                    <div class="loading">Loading notices...</div>
                </div>
            </div>
            
            <!-- Clock Status -->
            <div class="clock-status" id="clockStatus">
                <div class="clock-status-text">Loading...</div>
                <div class="clock-details" id="clockDetails"></div>
            </div>
            
            <!-- Clock Controls -->
            <div class="clock-controls">
                <div class="job-select-group" id="jobSelectGroup" style="display: none;">
                    <label class="form-label">Select Job/Site *</label>
                    <select id="jobSelect" class="form-select" required>
                        <option value="">Loading jobs...</option>
                    </select>
                </div>
                
                <button id="clockInBtn" class="clock-button clock-in" onclick="handleClockIn()" style="display: none;">
                    Clock In
                </button>
                
                <button id="clockOutBtn" class="clock-button clock-out" onclick="handleClockOut()" style="display: none;">
                    Clock Out
                </button>
                
                <div class="location-status" id="locationStatus"></div>
            </div>
            
            <!-- Weekly Timesheet -->
            <div class="weekly-timesheet">
                <div class="week-header">
                    <h2>Weekly Timesheet</h2>
                    <div class="week-navigation">
                        <button onclick="previousWeek()">← Previous</button>
                        <span id="weekRange" style="font-weight: 600; padding: 0 15px;"></span>
                        <button onclick="nextWeek()">Next →</button>
                    </div>
                </div>
                <div id="weeklyTimesheetContent">
                    <div class="loading">Loading timesheet...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Amendment Modal -->
    <div id="amendmentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Edit Clock Times</h3>
                <span class="close" onclick="closeAmendmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="amendmentForm">
                    <input type="hidden" id="amendmentEntryId">
                    <div class="form-group">
                        <label>Original Clock In:</label>
                        <div id="originalClockIn" style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Original Clock Out:</label>
                        <div id="originalClockOut" style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="amendedClockIn">New Clock In Time *</label>
                        <input type="datetime-local" id="amendedClockIn" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="amendedClockOut">New Clock Out Time *</label>
                        <input type="datetime-local" id="amendedClockOut" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="amendmentReason">Reason for Amendment *</label>
                        <textarea id="amendmentReason" class="form-control" rows="3" required placeholder="Please explain why you need to change these times..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAmendmentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let currentStatus = null;
        let jobs = [];
        let currentLocation = null;
        let locationError = false;
        
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            
            // Hide dashboard link for staff
            if (currentUser.role === 'staff') {
                const dashboardLink = document.querySelector('a[href="dashboard.html"]');
                if (dashboardLink) {
                    dashboardLink.style.display = 'none';
                }
            }
            
            // Request location permission
            requestLocation();
            
            // Load initial data
            await Promise.all([
                loadNotices(),
                loadJobs(),
                loadClockStatus()
            ]);
            
            // Load weekly timesheet
            await loadWeeklyTimesheet();
        }
        
        function requestLocation() {
            if (!navigator.geolocation) {
                locationError = true;
                updateLocationStatus('Geolocation not supported by your browser', 'error');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    updateLocationStatus('Location ready', 'success');
                },
                (error) => {
                    locationError = true;
                    let message = 'Location access denied';
                    if (error.code === error.PERMISSION_DENIED) {
                        message = 'Please enable location access to clock in/out';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        message = 'Location unavailable';
                    } else if (error.code === error.TIMEOUT) {
                        message = 'Location request timeout';
                    }
                    updateLocationStatus(message, 'error');
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }
        
        function updateLocationStatus(message, type) {
            const statusEl = document.getElementById('locationStatus');
            statusEl.textContent = message;
            statusEl.className = `location-status ${type}`;
        }
        
        async function loadNotices() {
            try {
                const data = await apiCall('/timesheet/notices');
                const notices = data.notices || [];
                const noticesList = document.getElementById('noticesList');
                
                if (notices.length === 0) {
                    noticesList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No notices at this time</p>';
                    return;
                }
                
                noticesList.innerHTML = notices.map(notice => {
                    const priorityClass = notice.priority || 'normal';
                    const expiresText = notice.expires_at ? `Expires: ${formatDate(notice.expires_at)}` : '';
                    return `
                        <div class="notice-item ${priorityClass}">
                            <div class="notice-title">${escapeHtml(notice.title)}</div>
                            <div class="notice-message">${escapeHtml(notice.message)}</div>
                            <div class="notice-meta">${expiresText}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                document.getElementById('noticesList').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading notices</p>';
            }
        }
        
        async function loadJobs() {
            try {
                const data = await apiCall('/timesheet/jobs');
                jobs = data.jobs || [];
                const jobSelect = document.getElementById('jobSelect');
                
                jobSelect.innerHTML = '<option value="">Select job/site</option>';
                jobs.forEach(job => {
                    jobSelect.innerHTML += `<option value="${job.id}">${job.name}${job.description ? ' - ' + job.description : ''}</option>`;
                });
            } catch (error) {
                showAlert('Error loading jobs', 'error');
            }
        }
        
        async function loadClockStatus() {
            try {
                const data = await apiCall('/clock/status');
                currentStatus = data.status;
                updateUI();
            } catch (error) {
                showAlert('Error loading clock status', 'error');
            }
        }
        
        function updateUI() {
            const clockStatus = document.getElementById('clockStatus');
            const clockDetails = document.getElementById('clockDetails');
            const jobSelectGroup = document.getElementById('jobSelectGroup');
            const clockInBtn = document.getElementById('clockInBtn');
            const clockOutBtn = document.getElementById('clockOutBtn');
            
            if (currentStatus) {
                // Clocked in
                clockStatus.className = 'clock-status clocked-in';
                clockStatus.querySelector('.clock-status-text').textContent = 'You are clocked in';
                const clockInTime = new Date(currentStatus.clock_in_time);
                clockDetails.innerHTML = `
                    <div>Job: ${escapeHtml(currentStatus.job_name || 'Unknown')}</div>
                    <div>Clocked in: ${formatDate(clockInTime)}</div>
                `;
                
                jobSelectGroup.style.display = 'none';
                clockInBtn.style.display = 'none';
                clockOutBtn.style.display = 'block';
            } else {
                // Not clocked in
                clockStatus.className = 'clock-status';
                clockStatus.querySelector('.clock-status-text').textContent = 'You are not clocked in';
                clockDetails.textContent = 'Select a job/site and clock in to start';
                
                jobSelectGroup.style.display = 'block';
                clockInBtn.style.display = 'block';
                clockOutBtn.style.display = 'none';
            }
        }
        
        async function handleClockIn() {
            const jobId = document.getElementById('jobSelect').value;
            if (!jobId) {
                showAlert('Please select a job/site', 'error');
                return;
            }
            
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            const clockInBtn = document.getElementById('clockInBtn');
            clockInBtn.disabled = true;
            clockInBtn.textContent = 'Clocking in...';
            
            try {
                await apiCall('/clock/clock-in', {
                    method: 'POST',
                    body: JSON.stringify({
                        job_id: jobId,
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked in successfully');
                await loadClockStatus();
            } catch (error) {
                showAlert(error.message || 'Failed to clock in', 'error');
            } finally {
                clockInBtn.disabled = false;
                clockInBtn.textContent = 'Clock In';
            }
        }
        
        async function handleClockOut() {
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            const clockOutBtn = document.getElementById('clockOutBtn');
            clockOutBtn.disabled = true;
            clockOutBtn.textContent = 'Clocking out...';
            
            try {
                await apiCall('/clock/clock-out', {
                    method: 'POST',
                    body: JSON.stringify({
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked out successfully');
                await loadClockStatus();
                await loadWeeklyTimesheet(currentWeekStart || getCurrentWeekStart());
            } catch (error) {
                showAlert(error.message || 'Failed to clock out', 'error');
            } finally {
                clockOutBtn.disabled = false;
                clockOutBtn.textContent = 'Clock Out';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Weekly timesheet functions
        let currentWeekStart = null;
        
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            monday.setHours(0, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }
        
        function getWeekDates(weekStart) {
            const start = new Date(weekStart);
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function getDayName(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }
        
        async function loadWeeklyTimesheet(weekStart = null) {
            if (!weekStart) {
                weekStart = getCurrentWeekStart();
            }
            currentWeekStart = weekStart;
            
            try {
                const data = await apiCall(`/clock/weekly/${weekStart}`);
                const weeklyTimesheet = data.weeklyTimesheet;
                const dailyEntries = data.dailyEntries || [];
                
                // Create a map of daily entries by date
                const entriesMap = {};
                dailyEntries.forEach(entry => {
                    entriesMap[entry.entry_date] = entry;
                });
                
                // Display week range
                const weekDates = getWeekDates(weekStart);
                const startDate = new Date(weekDates[0]);
                const endDate = new Date(weekDates[6]);
                document.getElementById('weekRange').textContent = 
                    `${formatDate(startDate)} - ${formatDate(endDate)}`;
                
                // Display daily entries
                const content = document.getElementById('weeklyTimesheetContent');
                let html = '';
                let totalRegular = 0, totalOvertime = 0, totalWeekend = 0, totalOvernight = 0, totalHours = 0;
                
                weekDates.forEach(dateStr => {
                    const entry = entriesMap[dateStr] || null;
                    const dayName = getDayName(dateStr);
                    const date = new Date(dateStr);
                    const isCurrentWeek = weekStart === getCurrentWeekStart();
                    
                    let clockInTime = '';
                    let clockOutTime = '';
                    let regularHours = 0, overtimeHours = 0, weekendHours = 0, overnightHours = 0, dayTotal = 0;
                    let amendmentStatus = '';
                    
                    if (entry) {
                        if (entry.clock_in_time) {
                            clockInTime = formatDate(new Date(entry.clock_in_time));
                        }
                        if (entry.clock_out_time) {
                            clockOutTime = formatDate(new Date(entry.clock_out_time));
                        }
                        regularHours = entry.regular_hours || 0;
                        overtimeHours = entry.overtime_hours || 0;
                        weekendHours = entry.weekend_hours || 0;
                        overnightHours = entry.overnight_hours || 0;
                        dayTotal = entry.total_hours || 0;
                        
                        totalRegular += regularHours;
                        totalOvertime += overtimeHours;
                        totalWeekend += weekendHours;
                        totalOvernight += overnightHours;
                        totalHours += dayTotal;
                    }
                    
                    const hasHours = dayTotal > 0;
                    const hasEntry = entry !== null;
                    
                    html += `
                        <div class="day-entry ${hasHours ? 'has-hours' : ''}">
                            <div class="day-header">
                                <div>
                                    <span class="day-name">${dayName}</span>
                                    <span class="day-date">${formatDate(date)}</span>
                                </div>
                                ${hasEntry && entry.timesheet_entry_id ? `
                                    <button class="edit-times-btn" onclick="showAmendmentModal(${entry.timesheet_entry_id}, '${entry.clock_in_time || ''}', '${entry.clock_out_time || ''}')">
                                        Edit Times
                                    </button>
                                ` : ''}
                            </div>
                            ${hasHours ? `
                                <div class="day-hours">
                                    ${regularHours > 0 ? `
                                        <div class="hour-item regular">
                                            <div class="hour-label">Regular</div>
                                            <div class="hour-value">${regularHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${overtimeHours > 0 ? `
                                        <div class="hour-item overtime">
                                            <div class="hour-label">Overtime (1.25x)</div>
                                            <div class="hour-value">${overtimeHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${weekendHours > 0 ? `
                                        <div class="hour-item weekend">
                                            <div class="hour-label">Weekend (1.5x)</div>
                                            <div class="hour-value">${weekendHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                    ${overnightHours > 0 ? `
                                        <div class="hour-item overnight">
                                            <div class="hour-label">Overnight (1.25x)</div>
                                            <div class="hour-value">${overnightHours.toFixed(2)}h</div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${clockInTime ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">In: ${clockInTime}${clockOutTime ? ` | Out: ${clockOutTime}` : ''}</div>` : ''}
                            ` : ''}
                            ${isCurrentWeek ? `
                                <div class="day-notes">
                                    <textarea 
                                        id="notes-${dateStr}" 
                                        placeholder="What did you do today?"
                                        onblur="saveDailyNotes('${dateStr}', this.value)"
                                    >${entry ? (entry.daily_notes || '') : ''}</textarea>
                                </div>
                                <div class="overnight-checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="overnight-${dateStr}" 
                                        ${entry && entry.overnight_away ? 'checked' : ''}
                                        onchange="saveOvernightAway('${dateStr}', this.checked)"
                                    >
                                    <label for="overnight-${dateStr}">Overnight away from home</label>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Add weekly summary
                html += `
                    <div class="weekly-summary">
                        <div class="summary-row">
                            <span>Regular Hours:</span>
                            <span>${totalRegular.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Overtime Hours (1.25x):</span>
                            <span>${totalOvertime.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Weekend Hours (1.5x):</span>
                            <span>${totalWeekend.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row">
                            <span>Overnight Hours (1.25x):</span>
                            <span>${totalOvernight.toFixed(2)}h</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Total Hours:</span>
                            <span>${totalHours.toFixed(2)}h</span>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
            } catch (error) {
                document.getElementById('weeklyTimesheetContent').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Error loading weekly timesheet</p>';
            }
        }
        
        function previousWeek() {
            if (!currentWeekStart) return;
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() - 7);
            loadWeeklyTimesheet(date.toISOString().split('T')[0]);
        }
        
        function nextWeek() {
            if (!currentWeekStart) return;
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + 7);
            loadWeeklyTimesheet(date.toISOString().split('T')[0]);
        }
        
        async function saveDailyNotes(date, notes) {
            if (!currentWeekStart) return;
            try {
                await apiCall(`/clock/weekly/${currentWeekStart}/day/${date}`, {
                    method: 'PUT',
                    body: JSON.stringify({ daily_notes: notes })
                });
            } catch (error) {
                showAlert('Failed to save notes', 'error');
            }
        }
        
        async function saveOvernightAway(date, overnightAway) {
            if (!currentWeekStart) return;
            try {
                await apiCall(`/clock/weekly/${currentWeekStart}/day/${date}`, {
                    method: 'PUT',
                    body: JSON.stringify({ overnight_away: overnightAway })
                });
                // Reload to update hours
                await loadWeeklyTimesheet(currentWeekStart);
            } catch (error) {
                showAlert('Failed to save overnight away status', 'error');
            }
        }
        
        // Time amendment functions
        function showAmendmentModal(entryId, clockInTime, clockOutTime) {
            document.getElementById('amendmentEntryId').value = entryId;
            document.getElementById('originalClockIn').textContent = clockInTime ? formatDate(new Date(clockInTime)) : 'Not set';
            document.getElementById('originalClockOut').textContent = clockOutTime ? formatDate(new Date(clockOutTime)) : 'Not set';
            
            // Set default values to current times
            if (clockInTime) {
                const clockIn = new Date(clockInTime);
                const localDateTime = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('amendedClockIn').value = localDateTime;
            }
            if (clockOutTime) {
                const clockOut = new Date(clockOutTime);
                const localDateTime = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('amendedClockOut').value = localDateTime;
            }
            
            document.getElementById('amendmentModal').style.display = 'block';
        }
        
        function closeAmendmentModal() {
            document.getElementById('amendmentModal').style.display = 'none';
            document.getElementById('amendmentForm').reset();
        }
        
        document.getElementById('amendmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const entryId = parseInt(document.getElementById('amendmentEntryId').value);
            const amendedClockIn = document.getElementById('amendedClockIn').value;
            const amendedClockOut = document.getElementById('amendedClockOut').value;
            const reason = document.getElementById('amendmentReason').value;
            
            // Convert local datetime to ISO string
            const clockInISO = new Date(amendedClockIn).toISOString();
            const clockOutISO = new Date(amendedClockOut).toISOString();
            
            try {
                await apiCall('/clock/amendments', {
                    method: 'POST',
                    body: JSON.stringify({
                        entry_id: entryId,
                        amended_clock_in_time: clockInISO,
                        amended_clock_out_time: clockOutISO,
                        reason: reason
                    })
                });
                showAlert('Amendment request submitted. Waiting for approval.');
                closeAmendmentModal();
                await loadWeeklyTimesheet(currentWeekStart);
            } catch (error) {
                showAlert(error.message || 'Failed to submit amendment request', 'error');
            }
        });
        
    </script>
</body>
</html>

