<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Materials Management - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            <h1>Raw Materials Management</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Raw Materials</h2>
                <button onclick="showAddStockModal()" class="btn btn-primary admin-only">Add Raw Material</button>
            </div>
            <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label for="categoryFilter" style="font-weight: 600; color: #2c3e50;">Filter by Category:</label>
                    <select id="categoryFilter" class="form-select" style="width: auto; min-width: 200px;" onchange="loadStock()">
                        <option value="">All Categories</option>
                    </select>
                    <span id="filterStatus" style="color: #666; font-size: 14px;"></span>
                </div>
            </div>
            <div id="stockList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Stock Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="stockModalTitle">Add Raw Material</h3>
                <button class="modal-close" onclick="hideModal('stockModal')">&times;</button>
            </div>
            <form id="stockForm">
                <input type="hidden" id="stockId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="stockName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <input type="text" id="stockCategory" class="form-input" placeholder="e.g., Timber, Hardware, Fasteners, Insulation">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="stockDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Unit (Metric) *</label>
                    <input type="text" id="stockUnit" class="form-input" required placeholder="e.g., m, mÂ², kg, litres, pieces">
                </div>
                <div class="form-group">
                    <label class="form-label">Current Quantity</label>
                    <input type="number" step="0.01" id="stockCurrentQty" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Minimum Quantity</label>
                    <input type="number" step="0.01" id="stockMinQty" class="form-input" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" id="stockLocation" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Cost per Unit (GBP)</label>
                    <input type="number" step="0.0001" min="0" id="stockCost" class="form-input" value="0">
                    <small style="color: #6c757d;">Enter 0.0000 for free materials</small>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('stockModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Stock Movement Modal -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Stock Movement</h3>
                <button class="modal-close" onclick="hideModal('movementModal')">&times;</button>
            </div>
            <form id="movementForm">
                <input type="hidden" id="movementStockId">
                <div class="form-group">
                    <label class="form-label">Movement Type *</label>
                    <select id="movementType" class="form-select" required>
                        <option value="in">Stock In</option>
                        <option value="out">Stock Out</option>
                        <option value="adjustment">Adjustment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" step="0.01" id="movementQty" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reference</label>
                    <input type="text" id="movementRef" class="form-input" placeholder="e.g., PO123, Invoice #456">
                </div>
                <div class="form-group">
                    <label class="form-label">Cost (GBP)</label>
                    <input type="number" step="0.01" id="movementCost" class="form-input" value="0">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('movementModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        
        async function init() {
            // Redirect staff users
            if (await restrictStaffAccess()) return;
            
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            loadStock();
        }
        
        async function loadStock() {
            try {
                const data = await apiCall('/stock');
                const stockList = document.getElementById('stockList');
                const categoryFilter = document.getElementById('categoryFilter');
                const filterStatus = document.getElementById('filterStatus');
                
                // Get all unique categories from items
                const categories = [...new Set(data.items.map(item => item.category).filter(c => c && c.trim()))].sort();
                
                // Populate category filter dropdown if not already populated
                if (categoryFilter && (categoryFilter.options.length === 1 || categoryFilter.options[0].value === '')) {
                    const currentFilter = categoryFilter.value;
                    categoryFilter.innerHTML = '<option value="">All Categories</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        categoryFilter.appendChild(option);
                    });
                    // Restore filter if it was set
                    if (currentFilter) {
                        categoryFilter.value = currentFilter;
                    }
                }
                
                // Filter items by selected category
                const selectedCategory = categoryFilter?.value || '';
                let filteredItems = data.items;
                if (selectedCategory) {
                    filteredItems = data.items.filter(item => item.category === selectedCategory);
                }
                
                // Update filter status
                if (filterStatus) {
                    if (selectedCategory) {
                        filterStatus.textContent = `Showing ${filteredItems.length} item(s) in category "${selectedCategory}"`;
                    } else {
                        filterStatus.textContent = `Showing ${filteredItems.length} item(s)${categories.length > 0 ? ` across ${categories.length} categor${categories.length === 1 ? 'y' : 'ies'}` : ''}`;
                    }
                }
                
                if (filteredItems.length === 0) {
                    stockList.innerHTML = `<p>No raw materials found${selectedCategory ? ` in category "${selectedCategory}"` : ''}</p>`;
                    return;
                }
                
                stockList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Current Qty</th>
                                <th>Min Qty</th>
                                <th>Unit</th>
                                <th>Location</th>
                                <th>Cost/Unit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredItems.map(item => {
                                const currentQty = parseFloat(item.current_quantity) || 0;
                                const minQty = parseFloat(item.min_quantity) || 0;
                                const isLow = currentQty <= minQty;
                                return `
                                    <tr>
                                        <td><strong>${escapeHtml(item.name)}</strong></td>
                                        <td>${item.category ? `<span class="badge badge-info">${escapeHtml(item.category)}</span>` : '<span style="color: #999;">-</span>'}</td>
                                        <td>${currentQty.toFixed(2)}</td>
                                        <td>${minQty.toFixed(2)}</td>
                                        <td>${escapeHtml(item.unit)}</td>
                                        <td>${escapeHtml(item.location || '-')}</td>
                                        <td>${formatCurrency(item.cost_per_unit_gbp)}</td>
                                        <td>${isLow ? '<span class="badge badge-danger">Low Stock</span>' : '<span class="badge badge-success">OK</span>'}</td>
                                        <td>
                                            <button onclick="showMovementModal(${item.id})" class="btn btn-primary btn-sm">Movement</button>
                                            ${currentUser.role === 'admin' ? `<button onclick="editStock(${item.id})" class="btn btn-secondary btn-sm">Edit</button>` : ''}
                                            ${currentUser.role === 'admin' ? `<button onclick="deleteStock(${item.id}, event)" data-stock-id="${item.id}" data-stock-name="${(item.name || '').replace(/"/g, '&quot;')}" class="btn btn-danger btn-sm">Delete</button>` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('stockList').innerHTML = '<p>Error loading stock</p>';
            }
        }
        
        function showAddStockModal() {
                document.getElementById('stockModalTitle').textContent = 'Add Raw Material';
            document.getElementById('stockForm').reset();
            document.getElementById('stockId').value = '';
            showModal('stockModal');
        }
        
        async function editStock(id) {
            try {
                const data = await apiCall(`/stock`);
                const item = data.items.find(i => i.id === id);
                if (!item) return;
                
                document.getElementById('stockModalTitle').textContent = 'Edit Raw Material';
                document.getElementById('stockId').value = item.id;
                document.getElementById('stockName').value = item.name;
                document.getElementById('stockCategory').value = item.category || '';
                document.getElementById('stockDescription').value = item.description || '';
                document.getElementById('stockUnit').value = item.unit;
                document.getElementById('stockCurrentQty').value = item.current_quantity;
                document.getElementById('stockMinQty').value = item.min_quantity;
                document.getElementById('stockLocation').value = item.location || '';
                document.getElementById('stockCost').value = item.cost_per_unit_gbp;
                showModal('stockModal');
            } catch (error) {
                showAlert('Error loading stock item', 'error');
            }
        }
        
        document.getElementById('stockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('stockId').value;
            const costValue = document.getElementById('stockCost').value;
            const data = {
                name: document.getElementById('stockName').value,
                category: document.getElementById('stockCategory').value.trim() || null,
                description: document.getElementById('stockDescription').value,
                unit: document.getElementById('stockUnit').value,
                min_quantity: document.getElementById('stockMinQty').value,
                location: document.getElementById('stockLocation').value,
                cost_per_unit_gbp: costValue === '' ? 0 : parseFloat(costValue) || 0
            };
            
            try {
                if (id) {
                    await apiCall(`/stock/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    showAlert('Raw material updated');
                } else {
                    data.current_quantity = document.getElementById('stockCurrentQty').value;
                    await apiCall('/stock', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    showAlert('Raw material created');
                }
                hideModal('stockModal');
                loadStock();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        function showMovementModal(stockId) {
            document.getElementById('movementStockId').value = stockId;
            document.getElementById('movementForm').reset();
            showModal('movementModal');
        }
        
        document.getElementById('movementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const stockId = document.getElementById('movementStockId').value;
            const data = {
                movement_type: document.getElementById('movementType').value,
                quantity: document.getElementById('movementQty').value,
                reference: document.getElementById('movementRef').value,
                cost_gbp: document.getElementById('movementCost').value
            };
            
            try {
                await apiCall(`/stock/${stockId}/movement`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showAlert('Raw material movement recorded');
                hideModal('movementModal');
                loadStock();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        });
        
        async function deleteStock(id, event) {
            const button = event?.target || document.querySelector(`button[data-stock-id="${id}"]`);
            const name = button?.getAttribute('data-stock-name') || 'this raw material';
            if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) return;
            try {
                await apiCall(`/stock/${id}`, { method: 'DELETE' });
                showAlert('Raw material deleted');
                loadStock();
            } catch (error) {
                showAlert(error.message || 'Failed to delete raw material', 'error');
            }
        }
        
        init();
    </script>
</body>
</html>

