<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Admin timesheet management page -->
    <title>Clock ON/OFF Admin - Production System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Clock ON/OFF Admin</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Admin Clock In/Out -->
        <div class="card">
            <div class="card-header">
                <h2>My Clock Status</h2>
            </div>
            <div id="adminClockStatus" style="padding: 20px;">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Active Staff Clock Ins -->
        <div class="card">
            <div class="card-header">
                <h2>Staff Currently On Clock</h2>
                <button onclick="loadActiveClockIns()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="activeClockIns">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Staff Currently Off Clock -->
        <div class="card">
            <div class="card-header">
                <h2>Staff Currently Off Clock</h2>
                <button onclick="loadOffClockStaff()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="offClockStaff">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Jobs/Sites Management -->
        <div class="card">
            <div class="card-header">
                <h2>Jobs/Sites Management</h2>
                <button onclick="showAddJobModal()" class="btn btn-primary">Add Job</button>
            </div>
            <div id="jobsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Notices Management -->
        <div class="card">
            <div class="card-header">
                <h2>Notice Board Management</h2>
                <button onclick="showAddNoticeModal()" class="btn btn-primary">Add Notice</button>
            </div>
            <div id="noticesList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Time Amendment Review -->
        <div class="card">
            <div class="card-header">
                <h2>Time Amendment Requests</h2>
                <button onclick="loadPendingAmendments()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="amendmentsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Payroll Processing -->
        <div class="card">
            <div class="card-header">
                <h2>Payroll Processing</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="payrollWeekSelect" class="form-input" style="width: auto;">
                    <select id="payrollStaffSelect" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="">All Staff</option>
                    </select>
                    <button onclick="loadPayrollSummary()" class="btn btn-primary">Load Week</button>
                    <button onclick="refreshPayrollSummary()" class="btn btn-secondary" id="refreshPayrollBtn" title="Refresh to show latest amendments and day type changes">
                        üîÑ Refresh
                    </button>
                    <button onclick="exportPayroll()" class="btn btn-success" id="exportBtn" style="display: none;">Export CSV</button>
                </div>
            </div>
            <div id="payrollSummary">
                <div class="loading">Select a week to view payroll summary</div>
            </div>
        </div>
        
        <!-- Hours Calculation Logic -->
        <div class="card">
            <div class="card-header">
                <h2>Hours Calculation Logic</h2>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px; color: #666;">
                    This section explains how hours are calculated for payroll processing.
                </p>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #333;">Break Deduction</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li><strong>1 hour</strong> is automatically deducted for <strong>Monday-Thursday</strong> entries</li>
                        <li><strong>45 minutes</strong> is automatically deducted for <strong>Friday</strong> entries</li>
                        <li><strong>30 minutes</strong> is deducted for <strong>weekend</strong> entries (after 4 hours worked)</li>
                        <li><strong>1 hour</strong> is deducted when <strong>working away overnight</strong> (normal break deduction)</li>
                    </ul>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #333;">Hour Types</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li><strong>Regular Hours:</strong> Net hours (after 1hr break) up to 8 hours per day (Monday-Thursday)</li>
                        <li><strong>Regular Hours:</strong> Net hours (after 45min break) up to 6 hours (Friday only)</li>
                        <li><strong>Overtime Hours:</strong> Net hours exceeding 8 hours (Mon-Thu) or 6 hours (Friday)</li>
                        <li><strong>Weekend Hours:</strong> All hours on Saturday/Sunday (30min break deduction after 4hrs)</li>
                        <li><strong>Overnight Hours:</strong> All hours when working away overnight (normal 1hr break deduction)</li>
                    </ul>
                </div>
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #0066cc;">
                    <h3 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #333;">Examples</h3>
                    <div style="color: #555; line-height: 1.8;">
                        <p style="margin: 5px 0;"><strong>Monday 8:00-17:00:</strong> 9 hours - 1 hour break = 8 regular hours</p>
                        <p style="margin: 5px 0;"><strong>Tuesday 8:00-18:00:</strong> 10 hours - 1 hour break = 8 regular + 1 overtime hour</p>
                        <p style="margin: 5px 0;"><strong>Friday 8:00-15:00:</strong> 7 hours - 45min break = 6.25 hours (6 regular + 0.25 overtime)</p>
                        <p style="margin: 5px 0;"><strong>Saturday 8:00-13:00:</strong> 5 hours - 30min break (after 4hrs) = 4.5 weekend hours</p>
                        <p style="margin: 5px 0;"><strong>Working Away 8:00-20:00:</strong> 12 hours - 1 hour break = 11 overnight hours</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Maintenance -->
        <div class="card">
            <div class="card-header">
                <h2>System Maintenance</h2>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px; color: #666;">
                    Cleanup old timesheet entries that were never clocked out. This fixes entries created before the auto-clock-out feature was added.
                </p>
                <button onclick="cleanupOldEntries()" class="btn btn-warning" id="cleanupBtn">
                    Cleanup Old Unclosed Entries
                </button>
                <div id="cleanupResult" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Job Modal -->
    <div id="jobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="jobModalTitle">Add Job</h3>
                <button class="modal-close" onclick="hideModal('jobModal')">&times;</button>
            </div>
            <form id="jobForm">
                <input type="hidden" id="jobId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="jobName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="jobDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group" id="jobStatusGroup" style="display: none;">
                    <label class="form-label">Status</label>
                    <select id="jobStatus" class="form-select">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('jobModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="noticeModalTitle">Add Notice</h3>
                <button class="modal-close" onclick="hideModal('noticeModal')">&times;</button>
            </div>
            <form id="noticeForm">
                <input type="hidden" id="noticeId">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noticeTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <textarea id="noticeMessage" class="form-input" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="noticePriority" class="form-select">
                        <option value="low">Low</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="noticeStatus" class="form-select">
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At (optional)</label>
                    <input type="datetime-local" id="noticeExpiresAt" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('noticeModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Amendment Review Modal -->
    <div id="amendmentReviewModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Review Time Amendment</h3>
                <button class="modal-close" onclick="hideModal('amendmentReviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="amendmentReviewForm">
                    <input type="hidden" id="reviewAmendmentId">
                    <input type="hidden" id="reviewAmendmentStatus">
                    
                    <div class="form-group">
                        <label><strong>Staff:</strong></label>
                        <div id="reviewStaffName" style="padding: 8px; background: #f5f5f5; border-radius: 4px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Reason:</strong></label>
                        <div id="reviewReason" style="padding: 8px; background: #f5f5f5; border-radius: 4px; min-height: 40px;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <h4 style="margin-bottom: 10px; color: #666;">Original Times</h4>
                            <div class="form-group">
                                <label>Clock In:</label>
                                <div id="reviewOriginalIn" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Clock Out:</label>
                                <div id="reviewOriginalOut" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 10px; color: #666;">Requested Times</h4>
                            <div class="form-group">
                                <label>Clock In:</label>
                                <div id="reviewRequestedIn" style="padding: 8px; background: #fff8e1; border-radius: 4px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Clock Out:</label>
                                <div id="reviewRequestedOut" style="padding: 8px; background: #fff8e1; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #4CBB17; padding-top: 15px; margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: #4CBB17;">Final Approved Times</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">You can modify the times if needed before approving:</p>
                        
                        <div class="form-group">
                            <label for="reviewApprovedIn">Clock In Time *</label>
                            <input type="datetime-local" id="reviewApprovedIn" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reviewApprovedOut">Clock Out Time *</label>
                            <input type="datetime-local" id="reviewApprovedOut" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewNotes">Review Notes</label>
                        <textarea id="reviewNotes" class="form-input" rows="3" placeholder="Optional notes about this amendment..."></textarea>
                    </div>
                    
                    <div class="text-right" style="margin-top: 20px;">
                        <button type="button" onclick="hideModal('amendmentReviewModal')" class="btn btn-secondary">Cancel</button>
                        <button type="button" onclick="submitAmendmentReview('rejected')" class="btn btn-danger">Reject</button>
                        <button type="button" onclick="submitAmendmentReview('approved')" class="btn btn-success">Approve</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Edit Timesheet Entry Modal -->
    <div id="adminEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Timesheet Entry (Admin)</h2>
                <button class="modal-close" onclick="hideAdminEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adminEditForm">
                    <input type="hidden" id="adminEditEntryId">
                    
                    <div class="form-group">
                        <label>Original Clock In:</label>
                        <div id="adminOriginalClockIn" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Original Clock Out:</label>
                        <div id="adminOriginalClockOut" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminAmendedClockIn">New Clock In Time *</label>
                        <input type="datetime-local" id="adminAmendedClockIn" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminAmendedClockOut">New Clock Out Time *</label>
                        <input type="datetime-local" id="adminAmendedClockOut" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminEditReason">Reason for Edit *</label>
                        <textarea id="adminEditReason" class="form-control" rows="3" required placeholder="Enter reason for editing this timesheet entry"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="adminEditOvernight" style="width: auto; margin: 0;">
                            <span>Overnight away from home</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 4px;">When checked, all hours for this day will be calculated as overnight hours (1.25x rate)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminEditDayType">Day Type</label>
                        <select id="adminEditDayType" class="form-control">
                            <option value="">Normal Day</option>
                            <option value="holiday_paid">Paid Holiday</option>
                            <option value="holiday_unpaid">Unpaid Holiday</option>
                            <option value="sick_paid">Paid Sick Day</option>
                            <option value="sick_unpaid">Unpaid Sick Day</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 4px;">For holidays and sick days, clock times are optional</small>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                        <strong>‚ö†Ô∏è Admin Edit:</strong> This change will be applied immediately and will be marked as "Edited by Admin" on the timesheet.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideAdminEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="submitAdminEdit()" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Add Missing Day Modal -->
    <div id="addMissingDayModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Missing Day</h2>
                <button class="modal-close" onclick="hideAddMissingDayModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addMissingDayForm">
                    <input type="hidden" id="addMissingDayUserId">
                    <input type="hidden" id="addMissingDayWeekStart">
                    
                    <div class="form-group">
                        <label for="addMissingDayUser">User *</label>
                        <select id="addMissingDayUser" class="form-control" required>
                            <option value="">Select a user</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayDate">Date *</label>
                        <input type="date" id="addMissingDayDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayJob">Job/Site *</label>
                        <select id="addMissingDayJob" class="form-control" required>
                            <option value="">Select a job/site</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayClockIn">Clock In Time *</label>
                        <input type="datetime-local" id="addMissingDayClockIn" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayClockOut">Clock Out Time *</label>
                        <input type="datetime-local" id="addMissingDayClockOut" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayReason">Reason *</label>
                        <textarea id="addMissingDayReason" class="form-control" rows="3" required placeholder="Enter reason for adding this missing day"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="addMissingDayOvernight" style="width: auto; margin: 0;">
                            <span>Overnight away from home</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 4px;">When checked, all hours for this day will be calculated as overnight hours (1.25x rate)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="addMissingDayType">Day Type</label>
                        <select id="addMissingDayType" class="form-control">
                            <option value="">Normal Day</option>
                            <option value="holiday_paid">Paid Holiday</option>
                            <option value="holiday_unpaid">Unpaid Holiday</option>
                            <option value="sick_paid">Paid Sick Day</option>
                            <option value="sick_unpaid">Unpaid Sick Day</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 4px;">For holidays and sick days, clock times are optional</small>
                    </div>
                    
                    <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid #28a745;">
                        <strong>‚úÖ Admin Create:</strong> This entry will be created immediately and will be marked as "Created by Admin" on the timesheet.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideAddMissingDayModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="submitAddMissingDay()" class="btn btn-primary">Create Entry</button>
            </div>
        </div>
    </div>
    
    <style>
        /* Error state styling for form controls */
        .form-control.error {
            border: 2px solid #dc3545 !important;
            background-color: #fff5f5 !important;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        
        .form-control.error:focus {
            border-color: #dc3545 !important;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let refreshInterval = null;
        
        let currentLocation = null;
        let locationError = false;
        
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            
            // Check if user is admin or office
            if (currentUser.role !== 'admin' && currentUser.role !== 'office') {
                showAlert('Access denied. Admin or Office privileges required.', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }
            
            // Request location permission for clock in/out
            requestLocation();
            
            await Promise.all([
                loadAdminClockStatus(),
                loadActiveClockIns(),
                loadOffClockStaff(),
                loadJobs(),
                loadNotices(),
                loadPendingAmendments()
            ]);
            
            // Initialize payroll week selector to current week
            const weekSelect = document.getElementById('payrollWeekSelect');
            if (weekSelect) {
                // Check if there's a selected week from dashboard reminder
                const selectedWeek = localStorage.getItem('selectedWeek');
                if (selectedWeek) {
                    weekSelect.value = selectedWeek;
                    localStorage.removeItem('selectedWeek'); // Clear after use
                } else {
                    weekSelect.value = getCurrentWeekStart();
                }
                // Load payroll summary for selected week
                await loadPayrollSummary();
            }
            
            // Add event listener for staff dropdown change
            const staffSelect = document.getElementById('payrollStaffSelect');
            if (staffSelect) {
                staffSelect.addEventListener('change', () => {
                    loadPayrollSummary();
                });
            }
            
            // Auto-refresh active clock ins every 30 seconds
            refreshInterval = setInterval(loadActiveClockIns, 30000);
            
            // Check for weekly approval reminder (on Saturdays)
            await checkWeeklyApprovalReminder();
        }
        
        function requestLocation() {
            if (!navigator.geolocation) {
                locationError = true;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                },
                (error) => {
                    locationError = true;
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }
        
        async function loadAdminClockStatus() {
            try {
                const data = await apiCall('/timesheet/status');
                const status = data.status;
                const jobsData = await apiCall('/timesheet/jobs');
                const jobs = jobsData.jobs || [];
                const adminClockStatus = document.getElementById('adminClockStatus');
                
                if (status) {
                    // Clocked in
                    const clockInTime = new Date(status.clock_in_time);
                    adminClockStatus.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #667eea;">
                                You are clocked in
                            </div>
                            <div style="color: #666; margin-bottom: 20px;">
                                <div>Job: <strong>${status.job_name || 'Unknown'}</strong></div>
                                <div>Clocked in: ${formatDate(clockInTime)}</div>
                            </div>
                            <button onclick="handleAdminClockOut()" class="btn btn-danger" style="width: 100%; padding: 15px; font-size: 16px;">
                                Clock Out
                            </button>
                        </div>
                    `;
                } else {
                    // Not clocked in
                    adminClockStatus.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #666;">
                                You are not clocked in
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label">Select Job/Site *</label>
                                <select id="adminJobSelect" class="form-select" required>
                                    <option value="">Select job/site</option>
                                    ${jobs.map(job => `<option value="${job.id}">${job.name}${job.description ? ' - ' + job.description : ''}</option>`).join('')}
                                </select>
                            </div>
                            <button onclick="handleAdminClockIn()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                                Clock In
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('adminClockStatus').innerHTML = '<p style="color: #e74c3c;">Error loading clock status</p>';
            }
        }
        
        async function handleAdminClockIn() {
            const jobId = document.getElementById('adminJobSelect').value;
            if (!jobId) {
                showAlert('Please select a job/site', 'error');
                return;
            }
            
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            try {
                await apiCall('/timesheet/clock-in', {
                    method: 'POST',
                    body: JSON.stringify({
                        job_id: jobId,
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked in successfully');
                await Promise.all([loadAdminClockStatus(), loadActiveClockIns()]);
            } catch (error) {
                showAlert(error.message || 'Failed to clock in', 'error');
            }
        }
        
        async function handleAdminClockOut() {
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            try {
                await apiCall('/timesheet/clock-out', {
                    method: 'POST',
                    body: JSON.stringify({
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked out successfully');
                await Promise.all([loadAdminClockStatus(), loadActiveClockIns()]);
            } catch (error) {
                showAlert(error.message || 'Failed to clock out', 'error');
            }
        }
        
        async function loadActiveClockIns() {
            try {
                const data = await apiCall('/timesheet/active');
                const clockIns = data.clockIns || [];
                const activeClockIns = document.getElementById('activeClockIns');
                
                if (clockIns.length === 0) {
                    activeClockIns.innerHTML = '<p>No staff currently clocked in</p>';
                    return;
                }
                
                activeClockIns.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Job/Site</th>
                                <th>Clock In Time</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clockIns.map(entry => {
                                const clockInTime = new Date(entry.clock_in_time);
                                const hasLocation = entry.clock_in_latitude && entry.clock_in_longitude;
                                const location = hasLocation
                                    ? `${parseFloat(entry.clock_in_latitude).toFixed(6)}, ${parseFloat(entry.clock_in_longitude).toFixed(6)}`
                                    : 'Not available';
                                return `
                                    <tr>
                                        <td><strong>${entry.username || 'Unknown'}</strong></td>
                                        <td>${entry.job_name || 'Unknown'}</td>
                                        <td>${formatDateTime(clockInTime)}</td>
                                        <td>
                                            <small>${location}</small>
                                            ${hasLocation ? `
                                                <button onclick="openMap(${entry.clock_in_latitude}, ${entry.clock_in_longitude})" 
                                                        class="btn btn-sm" 
                                                        style="margin-left: 8px; padding: 2px 8px; font-size: 11px; background: #4CBB17; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                                        title="View on map">
                                                    üó∫Ô∏è Map
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading active clock ins:', error);
                let errorMsg = 'Unknown error';
                if (error.message) {
                    errorMsg = error.message;
                } else if (error.details) {
                    errorMsg = error.details;
                } else if (typeof error === 'string') {
                    errorMsg = error;
                }
                document.getElementById('activeClockIns').innerHTML = `
                    <div style="padding: 20px; background: #fee; border: 1px solid #e74c3c; border-radius: 8px;">
                        <p style="color: #e74c3c; font-weight: 600; margin-bottom: 10px;">Error loading active clock ins</p>
                        <p style="color: #c33; font-size: 14px;">${escapeHtml(errorMsg)}</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">Check the server console for more details.</p>
                    </div>
                `;
            }
        }
        
        async function loadOffClockStaff() {
            try {
                // Fetch all users and active clock ins in parallel
                const [usersData, activeClockInsData] = await Promise.all([
                    apiCall('/users'),
                    apiCall('/timesheet/active')
                ]);
                
                const allUsers = usersData.users || [];
                const activeClockIns = activeClockInsData.clockIns || [];
                
                // Get IDs of users who are currently clocked in
                const clockedInUserIds = new Set(activeClockIns.map(entry => parseInt(entry.user_id)));
                
                // Filter users who are NOT clocked in (only show staff role users)
                const offClockStaff = allUsers.filter(user => 
                    !clockedInUserIds.has(parseInt(user.id)) && user.role === 'staff'
                );
                
                const offClockStaffContainer = document.getElementById('offClockStaff');
                
                if (offClockStaff.length === 0) {
                    offClockStaffContainer.innerHTML = '<p>All staff members are currently clocked in</p>';
                    return;
                }
                
                offClockStaffContainer.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${offClockStaff.map(user => {
                                return `
                                    <tr>
                                        <td><strong>${escapeHtml(user.username || 'Unknown')}</strong></td>
                                        <td><span style="color: #6c757d;">Off Clock</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading off-clock staff:', error);
                let errorMsg = 'Unknown error';
                if (error.message) {
                    errorMsg = error.message;
                } else if (error.details) {
                    errorMsg = error.details;
                } else if (typeof error === 'string') {
                    errorMsg = error;
                }
                document.getElementById('offClockStaff').innerHTML = `
                    <div style="padding: 20px; background: #fee; border: 1px solid #e74c3c; border-radius: 8px;">
                        <p style="color: #e74c3c; font-weight: 600; margin-bottom: 10px;">Error loading off-clock staff</p>
                        <p style="color: #c33; font-size: 14px;">${escapeHtml(errorMsg)}</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">Check the server console for more details.</p>
                    </div>
                `;
            }
        }
        
        async function loadJobs() {
            try {
                const data = await apiCall('/timesheet/jobs?all=true');
                const jobs = data.jobs || [];
                const jobsList = document.getElementById('jobsList');
                
                if (jobs.length === 0) {
                    jobsList.innerHTML = '<p>No jobs found. Add your first job/site.</p>';
                    return;
                }
                
                jobsList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${jobs.map(job => `
                                <tr>
                                    <td><strong>${job.name}</strong></td>
                                    <td>${job.description || '-'}</td>
                                    <td><span class="badge ${job.status === 'active' ? 'badge-success' : 'badge-secondary'}">${job.status}</span></td>
                                    <td>
                                        <button onclick="showEditJobModal(${job.id})" class="btn btn-info btn-sm">Edit</button>
                                        <button onclick="deleteJob(${job.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('jobsList').innerHTML = '<p>Error loading jobs</p>';
            }
        }
        
        async function loadNotices() {
            try {
                const data = await apiCall('/timesheet/notices/all');
                const notices = data.notices || [];
                const noticesList = document.getElementById('noticesList');
                
                if (notices.length === 0) {
                    noticesList.innerHTML = '<p>No notices found. Add your first notice.</p>';
                    return;
                }
                
                noticesList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notices.map(notice => {
                                const priorityClass = notice.priority === 'urgent' ? 'badge-danger' :
                                                    notice.priority === 'high' ? 'badge-warning' :
                                                    notice.priority === 'normal' ? 'badge-info' : 'badge-secondary';
                                const expiresText = notice.expires_at ? formatDate(notice.expires_at) : 'Never';
                                return `
                                    <tr>
                                        <td><strong>${notice.title}</strong></td>
                                        <td><span class="badge ${priorityClass}">${notice.priority}</span></td>
                                        <td><span class="badge ${notice.status === 'active' ? 'badge-success' : 'badge-secondary'}">${notice.status}</span></td>
                                        <td><small>${expiresText}</small></td>
                                        <td>${notice.created_by_name || '-'}</td>
                                        <td>
                                            <button onclick="showEditNoticeModal(${notice.id})" class="btn btn-info btn-sm">Edit</button>
                                            <button onclick="deleteNotice(${notice.id})" class="btn btn-danger btn-sm">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('noticesList').innerHTML = '<p>Error loading notices</p>';
            }
        }
        
        function showAddJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            document.getElementById('jobModalTitle').textContent = 'Add Job';
            document.getElementById('jobStatusGroup').style.display = 'none';
            showModal('jobModal');
        }
        
        async function showEditJobModal(jobId) {
            try {
                const data = await apiCall('/timesheet/jobs?all=true');
                const jobs = data.jobs || [];
                const job = jobs.find(j => j.id === jobId);
                
                if (!job) {
                    showAlert('Job not found', 'error');
                    return;
                }
                
                document.getElementById('jobId').value = job.id;
                document.getElementById('jobName').value = job.name;
                document.getElementById('jobDescription').value = job.description || '';
                document.getElementById('jobStatus').value = job.status || 'active';
                document.getElementById('jobModalTitle').textContent = 'Edit Job';
                document.getElementById('jobStatusGroup').style.display = 'block';
                showModal('jobModal');
            } catch (error) {
                showAlert('Error loading job', 'error');
            }
        }
        
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/timesheet/jobs/${jobId}`, { method: 'DELETE' });
                showAlert('Job deleted successfully');
                loadJobs();
            } catch (error) {
                showAlert('Error deleting job: ' + error.message, 'error');
            }
        }
        
        function showAddNoticeModal() {
            document.getElementById('noticeForm').reset();
            document.getElementById('noticeId').value = '';
            document.getElementById('noticeModalTitle').textContent = 'Add Notice';
            showModal('noticeModal');
        }
        
        async function showEditNoticeModal(noticeId) {
            try {
                const data = await apiCall('/timesheet/notices/all');
                const notices = data.notices || [];
                const notice = notices.find(n => n.id === noticeId);
                
                if (!notice) {
                    showAlert('Notice not found', 'error');
                    return;
                }
                
                document.getElementById('noticeId').value = notice.id;
                document.getElementById('noticeTitle').value = notice.title;
                document.getElementById('noticeMessage').value = notice.message;
                document.getElementById('noticePriority').value = notice.priority || 'normal';
                document.getElementById('noticeStatus').value = notice.status || 'active';
                if (notice.expires_at) {
                    const expiresDate = new Date(notice.expires_at);
                    document.getElementById('noticeExpiresAt').value = expiresDate.toISOString().slice(0, 16);
                } else {
                    document.getElementById('noticeExpiresAt').value = '';
                }
                document.getElementById('noticeModalTitle').textContent = 'Edit Notice';
                showModal('noticeModal');
            } catch (error) {
                showAlert('Error loading notice', 'error');
            }
        }
        
        async function deleteNotice(noticeId) {
            if (!confirm('Are you sure you want to delete this notice?')) {
                return;
            }
            
            try {
                await apiCall(`/timesheet/notices/${noticeId}`, { method: 'DELETE' });
                showAlert('Notice deleted successfully');
                loadNotices();
            } catch (error) {
                showAlert('Error deleting notice: ' + error.message, 'error');
            }
        }
        
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const jobId = document.getElementById('jobId').value;
                const name = document.getElementById('jobName').value;
                const description = document.getElementById('jobDescription').value;
                const status = document.getElementById('jobStatus').value || 'active';
                
                if (jobId) {
                    await apiCall(`/timesheet/jobs/${jobId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, description, status })
                    });
                    showAlert('Job updated successfully');
                } else {
                    await apiCall('/timesheet/jobs', {
                        method: 'POST',
                        body: JSON.stringify({ name, description })
                    });
                    showAlert('Job created successfully');
                }
                hideModal('jobModal');
                loadJobs();
            } catch (error) {
                showAlert('Error saving job: ' + error.message, 'error');
            }
        });
        
        document.getElementById('noticeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const noticeId = document.getElementById('noticeId').value;
                const title = document.getElementById('noticeTitle').value;
                const message = document.getElementById('noticeMessage').value;
                const priority = document.getElementById('noticePriority').value;
                const status = document.getElementById('noticeStatus').value;
                const expiresAt = document.getElementById('noticeExpiresAt').value;
                
                if (noticeId) {
                    await apiCall(`/timesheet/notices/${noticeId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ title, message, priority, status, expires_at: expiresAt || null })
                    });
                    showAlert('Notice updated successfully');
                } else {
                    await apiCall('/timesheet/notices', {
                        method: 'POST',
                        body: JSON.stringify({ title, message, priority, expires_at: expiresAt || null })
                    });
                    showAlert('Notice created successfully');
                }
                hideModal('noticeModal');
                loadNotices();
            } catch (error) {
                showAlert('Error saving notice: ' + error.message, 'error');
            }
        });
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Time amendment functions
        async function loadPendingAmendments() {
            try {
                const data = await apiCall('/clock/amendments/pending');
                const amendments = data.amendments || [];
                const listEl = document.getElementById('amendmentsList');
                
                if (amendments.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No pending amendments</p>';
                    return;
                }
                
                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Date</th>
                                <th>Original Times</th>
                                <th>Amended Times</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${amendments.map(amendment => {
                                const originalIn = amendment.original_clock_in_time ? formatDateTime(new Date(amendment.original_clock_in_time)) : '-';
                                const originalOut = amendment.original_clock_out_time ? formatDateTime(new Date(amendment.original_clock_out_time)) : '-';
                                const amendedIn = amendment.amended_clock_in_time ? formatDateTime(new Date(amendment.amended_clock_in_time)) : '-';
                                const amendedOut = amendment.amended_clock_out_time ? formatDateTime(new Date(amendment.amended_clock_out_time)) : '-';
                                const dateStr = amendment.original_clock_in_time ? new Date(amendment.original_clock_in_time).toISOString().split('T')[0] : '-';
                                return `
                                    <tr>
                                        <td>${escapeHtml(amendment.username || 'Unknown')}</td>
                                        <td>${dateStr}</td>
                                        <td><small>In: ${originalIn}<br>Out: ${originalOut}</small></td>
                                        <td><small>In: ${amendedIn}<br>Out: ${amendedOut}</small></td>
                                        <td>${escapeHtml(amendment.reason || '')}</td>
                                        <td>
                                            <button onclick="showAmendmentReviewModal(${amendment.id})" class="btn btn-primary btn-sm">Review</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('amendmentsList').innerHTML = 
                    '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading amendments</p>';
            }
        }
        
        let currentAmendmentData = null;
        
        async function showAmendmentReviewModal(amendmentId) {
            try {
                // Get amendment details
                const amendments = await apiCall('/clock/amendments/pending');
                const amendment = amendments.amendments.find(a => a.id === amendmentId);
                
                if (!amendment) {
                    showAlert('Amendment not found', 'error');
                    return;
                }
                
                currentAmendmentData = amendment;
                
                // Populate modal
                document.getElementById('reviewAmendmentId').value = amendmentId;
                document.getElementById('reviewStaffName').textContent = amendment.username || 'Unknown';
                document.getElementById('reviewReason').textContent = amendment.reason || 'No reason provided';
                
                // Original times
                if (amendment.original_clock_in_time) {
                    document.getElementById('reviewOriginalIn').textContent = formatDateTime(amendment.original_clock_in_time);
                } else {
                    document.getElementById('reviewOriginalIn').textContent = 'Not set';
                }
                
                if (amendment.original_clock_out_time) {
                    document.getElementById('reviewOriginalOut').textContent = formatDateTime(amendment.original_clock_out_time);
                } else {
                    document.getElementById('reviewOriginalOut').textContent = 'Not set';
                }
                
                // Requested times
                if (amendment.amended_clock_in_time) {
                    document.getElementById('reviewRequestedIn').textContent = formatDateTime(amendment.amended_clock_in_time);
                    const clockIn = new Date(amendment.amended_clock_in_time);
                    const localDateTime = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('reviewApprovedIn').value = localDateTime;
                } else {
                    document.getElementById('reviewRequestedIn').textContent = 'Not set';
                }
                
                if (amendment.amended_clock_out_time) {
                    document.getElementById('reviewRequestedOut').textContent = formatDateTime(amendment.amended_clock_out_time);
                    const clockOut = new Date(amendment.amended_clock_out_time);
                    const localDateTime = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('reviewApprovedOut').value = localDateTime;
                } else {
                    document.getElementById('reviewRequestedOut').textContent = 'Not set';
                }
                
                // Clear review notes
                document.getElementById('reviewNotes').value = '';
                
                // Show modal
                showModal('amendmentReviewModal');
            } catch (error) {
                showAlert('Error loading amendment: ' + error.message, 'error');
            }
        }
        
        async function submitAmendmentReview(status) {
            if (!currentAmendmentData) {
                showAlert('No amendment data loaded', 'error');
                return;
            }
            
            const amendmentId = parseInt(document.getElementById('reviewAmendmentId').value);
            const approvedClockIn = document.getElementById('reviewApprovedIn').value;
            const approvedClockOut = document.getElementById('reviewApprovedOut').value;
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (!approvedClockIn || !approvedClockOut) {
                showAlert('Please enter both clock in and clock out times', 'error');
                return;
            }
            
            // Convert to ISO strings
            const clockInISO = new Date(approvedClockIn).toISOString();
            const clockOutISO = new Date(approvedClockOut).toISOString();
            
            try {
                await apiCall(`/clock/amendments/${amendmentId}/review`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: status,
                        review_notes: reviewNotes || '',
                        approved_clock_in_time: status === 'approved' ? clockInISO : null,
                        approved_clock_out_time: status === 'approved' ? clockOutISO : null
                    })
                });
                showAlert(`Amendment ${status} successfully`);
                hideModal('amendmentReviewModal');
                await loadPendingAmendments();
            } catch (error) {
                showAlert('Error reviewing amendment: ' + error.message, 'error');
            }
        }
        
        // Admin edit timesheet entry functions
        async function showAdminEditModal(entryId, clockInTime, clockOutTime, jobName, overnightAway, dayType, date, userId, weekStart) {
            document.getElementById('adminEditEntryId').value = entryId;
            document.getElementById('adminOriginalClockIn').textContent = clockInTime ? formatDateTime(new Date(clockInTime)) : 'Not set';
            document.getElementById('adminOriginalClockOut').textContent = clockOutTime ? formatDateTime(new Date(clockOutTime)) : 'Not set';
            
            // Set default values - use existing times if available, otherwise use day-based defaults
            let defaultClockIn = null;
            let defaultClockOut = null;
            
            if (clockInTime && clockOutTime) {
                // Use existing times
                const clockIn = new Date(clockInTime);
                defaultClockIn = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                
                const clockOut = new Date(clockOutTime);
                defaultClockOut = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            } else if (date) {
                // Set defaults based on day of week
                const entryDate = new Date(date);
                const dayOfWeek = entryDate.getDay(); // 0 = Sunday, 5 = Friday, 6 = Saturday
                
                // Default clock in: 8:00 AM
                const defaultIn = new Date(entryDate);
                defaultIn.setHours(8, 0, 0, 0);
                defaultClockIn = new Date(defaultIn.getTime() - defaultIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                
                // Default clock out based on day
                const defaultOut = new Date(entryDate);
                if (dayOfWeek === 5) {
                    // Friday: 3:00 PM
                    defaultOut.setHours(15, 0, 0, 0);
                } else {
                    // Monday-Thursday and Weekends: 5:00 PM
                    defaultOut.setHours(17, 0, 0, 0);
                }
                defaultClockOut = new Date(defaultOut.getTime() - defaultOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            }
            
            if (defaultClockIn) {
                document.getElementById('adminAmendedClockIn').value = defaultClockIn;
            }
            
            if (defaultClockOut) {
                document.getElementById('adminAmendedClockOut').value = defaultClockOut;
            }
            
            // Set overnight away checkbox
            const overnightCheckbox = document.getElementById('adminEditOvernight');
            if (overnightCheckbox) {
                overnightCheckbox.checked = overnightAway === true || overnightAway === 1 || overnightAway === '1' || overnightAway === 'true';
            }
            
            // Set day type - use provided value or try to fetch from daily entry
            const dayTypeSelect = document.getElementById('adminEditDayType');
            if (dayType) {
                dayTypeSelect.value = dayType;
            } else if (date && userId && weekStart) {
                // Try to fetch current day_type
                try {
                    const dailyData = await apiCall(`/clock/payroll/${weekStart}/user/${userId}/daily`);
                    const dailyBreakdown = dailyData.dailyBreakdown || [];
                    const entryForDate = dailyBreakdown.find(e => e.entry_date === date);
                    if (entryForDate && entryForDate.day_type) {
                        dayTypeSelect.value = entryForDate.day_type;
                    }
                } catch (error) {
                    console.log('Could not load existing day_type:', error);
                }
            }
            
            // Store date, userId, and weekStart for later use
            dayTypeSelect.dataset.date = date || '';
            dayTypeSelect.dataset.userId = userId || '';
            dayTypeSelect.dataset.weekStart = weekStart || '';
            
            // Add event listener for day type change to make clock times conditionally required
            const clockInField = document.getElementById('adminAmendedClockIn');
            const clockOutField = document.getElementById('adminAmendedClockOut');
            
            // Remove existing listeners by cloning and replacing
            const newDayTypeSelect = dayTypeSelect.cloneNode(true);
            newDayTypeSelect.dataset.date = dayTypeSelect.dataset.date;
            newDayTypeSelect.dataset.userId = dayTypeSelect.dataset.userId;
            newDayTypeSelect.dataset.weekStart = dayTypeSelect.dataset.weekStart;
            dayTypeSelect.parentNode.replaceChild(newDayTypeSelect, dayTypeSelect);
            
            newDayTypeSelect.addEventListener('change', function() {
                const dayType = this.value;
                const isHolidayOrSick = dayType === 'holiday_paid' || dayType === 'holiday_unpaid' || 
                                      dayType === 'sick_paid' || dayType === 'sick_unpaid';
                
                if (isHolidayOrSick) {
                    clockInField.removeAttribute('required');
                    clockOutField.removeAttribute('required');
                    clockInField.style.opacity = '0.6';
                    clockOutField.style.opacity = '0.6';
                } else {
                    clockInField.setAttribute('required', 'required');
                    clockOutField.setAttribute('required', 'required');
                    clockInField.style.opacity = '1';
                    clockOutField.style.opacity = '1';
                }
            });
            
            // Trigger change event to set initial state
            newDayTypeSelect.dispatchEvent(new Event('change'));
            
            // Clear reason and any error styling
            const reasonField = document.getElementById('adminEditReason');
            if (reasonField) {
                reasonField.value = '';
                reasonField.classList.remove('error');
            }
            
            const modal = document.getElementById('adminEditModal');
            if (modal) {
                modal.classList.add('show');
            }
        }
        
        // Hide admin edit modal (use class-based approach)
        function hideAdminEditModal() {
            const modal = document.getElementById('adminEditModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // Prevent form submission on Enter key
        document.getElementById('adminEditForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            submitAdminEdit();
        });
        
        // Clear error styling when user types in reason field
        const adminEditReasonField = document.getElementById('adminEditReason');
        if (adminEditReasonField) {
            adminEditReasonField.addEventListener('input', function() {
                // Remove error styling when user starts typing
                this.classList.remove('error');
            });
        }
        
        async function submitAdminEdit() {
            const entryId = parseInt(document.getElementById('adminEditEntryId').value);
            const amendedClockIn = document.getElementById('adminAmendedClockIn').value;
            const amendedClockOut = document.getElementById('adminAmendedClockOut').value;
            const reasonField = document.getElementById('adminEditReason');
            const reason = reasonField.value.trim();
            const overnightAway = document.getElementById('adminEditOvernight').checked;
            const dayType = document.getElementById('adminEditDayType').value || null;
            const dayTypeSelect = document.getElementById('adminEditDayType');
            const date = dayTypeSelect.dataset.date;
            const userId = dayTypeSelect.dataset.userId;
            const weekStart = dayTypeSelect.dataset.weekStart;
            
            const isHolidayOrSick = dayType === 'holiday_paid' || dayType === 'holiday_unpaid' || 
                                   dayType === 'sick_paid' || dayType === 'sick_unpaid';
            
            // Enhanced validation for reason field with prominent error
            if (!reason) {
                // Add error styling
                reasonField.classList.add('error');
                // Focus the field
                reasonField.focus();
                // Show prominent error message
                showAlert('Reason for edit is required. Please provide a reason before saving.', 'error');
                return;
            }
            
            // Remove any error styling if reason is provided
            reasonField.classList.remove('error');
            
            // Clock times only required if not holiday/sick
            if (!isHolidayOrSick) {
                if (!amendedClockIn || !amendedClockOut) {
                    showAlert('Please fill in clock in and clock out times', 'error');
                    return;
                }
                
                // Validate clock out is after clock in
                if (new Date(amendedClockOut) <= new Date(amendedClockIn)) {
                    showAlert('Clock out time must be after clock in time', 'error');
                    return;
                }
            }
            
            // Convert local datetime to ISO string (only if times provided)
            const clockInISO = amendedClockIn ? new Date(amendedClockIn).toISOString() : null;
            const clockOutISO = amendedClockOut ? new Date(amendedClockOut).toISOString() : null;
            
            try {
                const result = await apiCall('/clock/amendments/admin', {
                    method: 'POST',
                    body: JSON.stringify({
                        entry_id: entryId,
                        amended_clock_in_time: clockInISO,
                        amended_clock_out_time: clockOutISO,
                        reason: reason,
                        overnight_away: overnightAway,
                        day_type: dayType,
                        date: date,
                        user_id: userId,
                        week_start: weekStart
                    })
                });
                
                if (result && result.success) {
                    console.log('Admin edit successful:', result);
                    const updatedEntry = result.entry;
                    showAlert('Timesheet entry updated successfully', 'success');
                    hideAdminEditModal();
                    
                    // Get user ID from the updated entry to refresh the correct daily breakdown
                    const editedUserId = updatedEntry?.user_id || userId;
                    
                    // Collect currently expanded user IDs and ensure edited user is included
                    const expandedUserIds = getExpandedUserIds();
                    if (editedUserId && !expandedUserIds.includes(parseInt(editedUserId))) {
                        expandedUserIds.push(parseInt(editedUserId));
                    }
                    
                    // Reload the timesheet data - try both possible element IDs
                    const weekSelect = document.getElementById('payrollWeekSelect');
                    const weekStartEl = document.getElementById('payrollWeekStart');
                    const weekValue = weekSelect?.value || weekStartEl?.value || (weekStart || '');
                    
                    if (weekValue) {
                        // Update the select if it exists
                        if (weekSelect) {
                            weekSelect.value = weekValue;
                        }
                        // Reload payroll summary which will refresh all data and restore expanded states
                        await loadPayrollSummary(expandedUserIds);
                    } else {
                        // If no week selected, try to reload active clock-ins
                        try {
                            await loadActiveClockIns();
                        } catch (e) {
                            console.log('Could not reload active clock-ins:', e);
                        }
                        // Force a page refresh to show updated data
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    console.error('Admin edit failed:', result);
                    showAlert('Error updating timesheet entry: ' + (result?.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Admin edit error:', error);
                showAlert('Error updating timesheet entry: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        // Payroll functions
        async function cleanupOldEntries() {
            const btn = document.getElementById('cleanupBtn');
            const resultDiv = document.getElementById('cleanupResult');
            
            if (!confirm('This will automatically clock out all old entries that were never clocked out. This is a one-time cleanup. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Cleaning up...';
            resultDiv.innerHTML = '<p style="color: #666;">Processing cleanup...</p>';
            
            try {
                const data = await apiCall('/clock/cleanup-old-entries', {
                    method: 'GET'
                });
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                            <strong>Cleanup Complete!</strong><br>
                            ${data.count} entries were updated<br>
                            ${data.errors > 0 ? `<span style="color: #856404;">${data.errors} errors occurred</span>` : 'No errors'}
                        </div>
                    `;
                    showAlert(data.message || 'Cleanup completed successfully', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                            <strong>Error:</strong> ${data.error || 'Unknown error'}
                        </div>
                    `;
                    showAlert(data.error || 'Cleanup failed', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                        <strong>Error:</strong> ${error.message || 'Failed to cleanup old entries'}
                    </div>
                `;
                showAlert('Failed to cleanup old entries: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cleanup Old Unclosed Entries';
            }
        }
        
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            monday.setHours(0, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }
        
        function isWeekComplete(weekStartDate) {
            // A week is complete if its start date is before the current week's start date
            const currentWeekStart = getCurrentWeekStart();
            return weekStartDate < currentWeekStart;
        }
        
        // Round hours down to 15-minute intervals (0.25 hour increments)
        function roundToQuarterHour(hours) {
            if (!hours || isNaN(hours)) return 0;
            // Always round down to nearest 0.25 (15 minutes)
            return Math.floor(parseFloat(hours) * 4) / 4;
        }
        
        // Format hours as hours and minutes (e.g., "5hrs 30mins")
        function formatHours(hours) {
            if (!hours || isNaN(hours) || hours === 0) {
                return '0hrs 0mins';
            }
            const rounded = roundToQuarterHour(hours);
            const wholeHours = Math.floor(rounded);
            const minutes = Math.round((rounded - wholeHours) * 60);
            
            return `${wholeHours}hrs ${minutes}mins`;
        }
        
        // Helper function to get currently expanded user IDs
        function getExpandedUserIds() {
            const expandedIds = [];
            document.querySelectorAll('[id^="daily-"]').forEach(row => {
                if (row.style.display !== 'none' && row.style.display !== '') {
                    const userId = row.id.replace('daily-', '');
                    expandedIds.push(parseInt(userId));
                }
            });
            return expandedIds;
        }
        
        // Refresh payroll summary - preserves expanded states and filters
        async function refreshPayrollSummary() {
            const refreshBtn = document.getElementById('refreshPayrollBtn');
            const originalText = refreshBtn.textContent;
            
            // Show loading state
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Refreshing...';
            
            try {
                // Get currently expanded user IDs to preserve them
                const expandedUserIds = getExpandedUserIds();
                
                // Reload payroll summary with preserved states
                await loadPayrollSummary(expandedUserIds);
                
                showAlert('Payroll data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing payroll summary:', error);
                showAlert('Error refreshing payroll data: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                // Restore button state
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
            }
        }
        
        async function loadPayrollSummary(expandedUserIds = []) {
            const weekStart = document.getElementById('payrollWeekSelect').value || getCurrentWeekStart();
            const selectedStaffId = document.getElementById('payrollStaffSelect')?.value || '';
            
            if (!weekStart) {
                showAlert('Please select a week', 'error');
                return;
            }
            
            try {
                const data = await apiCall(`/clock/payroll/${weekStart}`);
                let summary = data.summary || [];
                const summaryEl = document.getElementById('payrollSummary');
                const exportBtn = document.getElementById('exportBtn');
                const staffSelect = document.getElementById('payrollStaffSelect');
                
                // Populate staff dropdown if not already populated
                if (staffSelect && (staffSelect.options.length === 1 || !staffSelect.options[0].value)) {
                    staffSelect.innerHTML = '<option value="">All Staff</option>';
                    summary.forEach(row => {
                        if (row.user_id && row.username) {
                            const option = document.createElement('option');
                            option.value = row.user_id;
                            option.textContent = row.username;
                            staffSelect.appendChild(option);
                        }
                    });
                    // Restore selected value if it was set
                    if (selectedStaffId) {
                        staffSelect.value = selectedStaffId;
                    }
                }
                
                // Filter by selected staff if a staff member is selected
                if (selectedStaffId) {
                    summary = summary.filter(row => row.user_id == selectedStaffId);
                }
                
                if (summary.length === 0) {
                    summaryEl.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No timesheet data for this week' + (selectedStaffId ? ' for selected staff member' : '') + '</p>';
                    exportBtn.style.display = 'none';
                    return;
                }
                
                exportBtn.style.display = 'inline-block';
                exportBtn.onclick = () => exportPayroll(weekStart);
                
                // Check if this is Saturday and show reminder for previous week if needed
                const today = new Date();
                if (today.getDay() === 6) { // Saturday
                    await checkWeeklyApprovalReminder();
                }
                
                // Calculate totals (with rounding to 15-minute intervals)
                let totalRegular = 0, totalOvertime = 0, totalWeekend = 0, totalOvernight = 0, totalHours = 0;
                summary.forEach(row => {
                    totalRegular += roundToQuarterHour(parseFloat(row.total_regular_hours || 0));
                    totalOvertime += roundToQuarterHour(parseFloat(row.total_overtime_hours || 0));
                    totalWeekend += roundToQuarterHour(parseFloat(row.total_weekend_hours || 0));
                    totalOvernight += roundToQuarterHour(parseFloat(row.total_overnight_hours || 0));
                    totalHours += roundToQuarterHour(parseFloat(row.total_hours || 0));
                });
                
                summaryEl.innerHTML = `
                    <table class="table" style="font-size: 14px;">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>Staff Name</th>
                                <th>Regular Hours</th>
                                <th>Overtime (1.25x)</th>
                                <th>Weekend (1.5x)</th>
                                <th>Overnight (1.25x)</th>
                                <th>Total Hours</th>
                                <th>Days Worked</th>
                                <th style="text-align: center;">Manager Approved</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summary.map(row => {
                                const regular = roundToQuarterHour(parseFloat(row.total_regular_hours || 0));
                                const overtime = roundToQuarterHour(parseFloat(row.total_overtime_hours || 0));
                                const weekend = roundToQuarterHour(parseFloat(row.total_weekend_hours || 0));
                                const overnight = roundToQuarterHour(parseFloat(row.total_overnight_hours || 0));
                                const total = roundToQuarterHour(parseFloat(row.total_hours || 0));
                                const isApproved = row.manager_approved === true || row.manager_approved === 1;
                                const approvedBy = row.approved_by_username || '';
                                const approvedAt = row.approved_at ? new Date(row.approved_at).toLocaleDateString('en-GB') : '';
                                const rowStyle = isApproved ? 'background-color: #e8f5e9;' : '';
                                const weekComplete = isWeekComplete(weekStart);
                                const canApprove = weekComplete;
                                return `
                                <tr class="payroll-row" data-user-id="${row.user_id}" style="cursor: pointer; ${rowStyle}" onclick="toggleDailyBreakdown(${row.user_id}, '${weekStart}')">
                                    <td style="text-align: center;" onclick="event.stopPropagation();">
                                        <span class="expand-icon" id="icon-${row.user_id}">‚ñ∂</span>
                                    </td>
                                    <td><strong>${escapeHtml(row.username || 'Unknown')}</strong></td>
                                    <td>${formatHours(regular)}</td>
                                    <td>${formatHours(overtime)}</td>
                                    <td>${formatHours(weekend)}</td>
                                    <td>${formatHours(overnight)}</td>
                                    <td><strong>${formatHours(total)}</strong></td>
                                    <td>${row.days_worked || 0}</td>
                                    <td style="text-align: center;" onclick="event.stopPropagation();">
                                        ${canApprove ? `
                                        <label style="cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                            <input type="checkbox" 
                                                   ${isApproved ? 'checked' : ''} 
                                                   onchange="toggleManagerApproval(${row.user_id}, '${weekStart}')"
                                                   style="width: 18px; height: 18px; cursor: pointer;">
                                            ${isApproved ? '<span style="color: #28a745; font-weight: bold;">‚úì</span>' : ''}
                                        </label>
                                        ${isApproved && approvedBy ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(approvedBy)}<br>${approvedAt}</div>` : ''}
                                        ` : `
                                        <div style="color: #999; font-size: 11px; padding: 5px;" title="Week in progress - approval available after week ends">
                                            <span style="opacity: 0.6;">Week in progress</span>
                                        </div>
                                        `}
                                    </td>
                                </tr>
                                <tr id="daily-${row.user_id}" style="display: none;">
                                    <td colspan="9" style="padding: 0; background: #f8f9fa;">
                                        <div id="daily-content-${row.user_id}" style="padding: 15px;">
                                            <div class="loading">Loading daily breakdown...</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                            ${summary.length > 1 || !selectedStaffId ? `
                            <tr style="background: #f8f9fa; font-weight: 700;">
                                <td></td>
                                <td><strong>TOTALS${selectedStaffId ? ' (Selected Staff)' : ''}</strong></td>
                                <td>${formatHours(totalRegular)}</td>
                                <td>${formatHours(totalOvertime)}</td>
                                <td>${formatHours(totalWeekend)}</td>
                                <td>${formatHours(totalOvernight)}</td>
                                <td><strong>${formatHours(totalHours)}</strong></td>
                                <td>-</td>
                                <td style="text-align: center;">
                                    ${summary.filter(r => r.manager_approved === true || r.manager_approved === 1).length} / ${summary.length}
                                </td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    <style>
                        .payroll-row:hover {
                            background-color: #f0f0f0 !important;
                        }
                        .expand-icon {
                            display: inline-block;
                            transition: transform 0.2s;
                            font-size: 10px;
                            color: #666;
                        }
                        .expand-icon.expanded {
                            transform: rotate(90deg);
                        }
                        .daily-breakdown {
                            margin-top: 10px;
                        }
                        .daily-breakdown table {
                            width: 100%;
                            font-size: 13px;
                            background: white;
                            border-radius: 4px;
                        }
                        .daily-breakdown th {
                            background: #4CBB17;
                            color: white;
                            padding: 8px;
                            text-align: left;
                            font-weight: 600;
                        }
                        .daily-breakdown td {
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                        }
                        .daily-breakdown tr:last-child td {
                            border-bottom: none;
                        }
                    </style>
                `;
                
                // Restore expanded states for tracked users
                if (expandedUserIds.length > 0) {
                    // Use setTimeout to ensure DOM is ready
                    setTimeout(() => {
                        expandedUserIds.forEach(userId => {
                            const row = document.getElementById(`daily-${userId}`);
                            if (row) {
                                toggleDailyBreakdown(userId, weekStart);
                            }
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading payroll summary:', error);
                document.getElementById('payrollSummary').innerHTML = 
                    `<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading payroll summary: ${error.message || 'Unknown error'}</p>`;
                showAlert('Error loading payroll summary: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function toggleManagerApproval(userId, weekStart) {
            try {
                await apiCall(`/clock/weekly/${weekStart}/approve/${userId}`, {
                    method: 'PUT'
                });
                // Reload payroll summary to refresh approval status
                await loadPayrollSummary();
            } catch (error) {
                console.error('Error toggling manager approval:', error);
                showAlert('Error updating approval: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function checkWeeklyApprovalReminder() {
            try {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
                
                // Only show reminder on Saturday
                if (dayOfWeek !== 6) {
                    return;
                }
                
                // Get previous week's start date (last Monday)
                // On Saturday, the previous week ended on Friday, so go back to last Monday
                const lastMonday = new Date(today);
                lastMonday.setDate(lastMonday.getDate() - 5); // Go back 5 days from Saturday to get last Monday
                lastMonday.setHours(0, 0, 0, 0);
                const weekStartStr = lastMonday.toISOString().split('T')[0];
                
                // Get payroll summary for previous week
                const data = await apiCall(`/clock/payroll/${weekStartStr}`);
                const summary = data.summary || [];
                
                if (summary.length === 0) {
                    return; // No timesheets for that week
                }
                
                // Count approved vs total
                const approvedCount = summary.filter(row => row.manager_approved === true || row.manager_approved === 1).length;
                const totalCount = summary.length;
                
                if (approvedCount < totalCount) {
                    const unapprovedCount = totalCount - approvedCount;
                    const weekStartFormatted = lastMonday.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    
                    // Show prominent reminder
                    const reminderHtml = `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                                <div style="flex: 1;">
                                    <strong style="color: #856404;">Weekly Timesheet Approval Reminder</strong>
                                    <p style="margin: 5px 0 0 0; color: #856404;">
                                        ${unapprovedCount} of ${totalCount} staff member${totalCount > 1 ? 's' : ''} still need${unapprovedCount === 1 ? 's' : ''} manager approval for the week starting ${weekStartFormatted}.
                                        <br>
                                        <button onclick="document.getElementById('payrollWeekSelect').value='${weekStartStr}'; loadPayrollSummary();" 
                                                class="btn btn-warning" 
                                                style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">
                                            Review Timesheets
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Insert reminder at the top of payroll summary section
                    const payrollCard = document.querySelector('.card:has(#payrollSummary)');
                    if (payrollCard) {
                        const existingReminder = payrollCard.querySelector('.approval-reminder');
                        if (existingReminder) {
                            existingReminder.remove();
                        }
                        const reminderDiv = document.createElement('div');
                        reminderDiv.className = 'approval-reminder';
                        reminderDiv.innerHTML = reminderHtml;
                        const summaryEl = document.getElementById('payrollSummary');
                        if (summaryEl && summaryEl.parentNode) {
                            summaryEl.parentNode.insertBefore(reminderDiv, summaryEl);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking approval reminder:', error);
                // Don't show error to user, just log it
            }
        }
        
        async function toggleDailyBreakdown(userId, weekStart) {
            const row = document.getElementById(`daily-${userId}`);
            const icon = document.getElementById(`icon-${userId}`);
            const content = document.getElementById(`daily-content-${userId}`);
            
            if (!row || !content) return;
            
            if (row.style.display === 'none') {
                // Expand
                row.style.display = 'table-row';
                if (icon) icon.classList.add('expanded');
                
                // Load daily breakdown if not already loaded
                if (content.innerHTML.includes('Loading daily breakdown')) {
                    try {
                        const data = await apiCall(`/clock/payroll/${weekStart}/user/${userId}/daily`);
                        const dailyBreakdown = data.dailyBreakdown || [];
                        
                        if (dailyBreakdown.length === 0) {
                            content.innerHTML = '<p style="text-align: center; padding: 10px; color: #666;">No daily entries found</p>';
                            return;
                        }
                        
                        // Generate all dates for the week
                        const weekStartDate = new Date(weekStart);
                        const weekDates = [];
                        for (let i = 0; i < 7; i++) {
                            const date = new Date(weekStartDate);
                            date.setDate(weekStartDate.getDate() + i);
                            weekDates.push(date.toISOString().split('T')[0]);
                        }
                        
                        // Group entries by date to show daily totals
                        const entriesByDate = {};
                        dailyBreakdown.forEach(day => {
                            const date = day.entry_date;
                            if (!entriesByDate[date]) {
                            entriesByDate[date] = {
                                entries: [],
                                daily_notes: day.daily_notes || null,
                                day_type: day.day_type || null,
                                overnight_away: day.overnight_away === true || day.overnight_away === 1 || day.overnight_away === '1' || day.overnight_away === 'true'
                            };
                            }
                            entriesByDate[date].entries.push(day);
                            // Use the first entry's daily_notes, day_type, and overnight_away (they should all be the same for the same date)
                            if (!entriesByDate[date].daily_notes && day.daily_notes) {
                                entriesByDate[date].daily_notes = day.daily_notes;
                            }
                            if (!entriesByDate[date].day_type && day.day_type) {
                                entriesByDate[date].day_type = day.day_type;
                            }
                            if (entriesByDate[date].overnight_away === undefined && day.overnight_away !== undefined) {
                                entriesByDate[date].overnight_away = day.overnight_away === true || day.overnight_away === 1 || day.overnight_away === '1' || day.overnight_away === 'true';
                            }
                        });
                        
                        let dailyHtml = '<div class="daily-breakdown"><table><thead><tr><th>Date</th><th>Job</th><th>Clock In</th><th>Clock Out</th><th>Location</th><th>Day Type</th><th>Regular</th><th>Overtime</th><th>Weekend</th><th>Overnight</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
                        
                        // Iterate through all week dates (not just dates with entries)
                        const sortedDates = weekDates;
                        
                        sortedDates.forEach(date => {
                            const dayData = entriesByDate[date];
                            const dayEntries = dayData ? dayData.entries : [];
                            const dateObj = new Date(date);
                            const dateStr = dateObj.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                            
                            // If no entries for this date, check if there's a day_type
                            if (dayEntries.length === 0) {
                                // Check if dayData exists with a day_type (from daily entries without clock entries)
                                if (dayData && dayData.day_type) {
                                    // Display day with day_type but no clock entries
                                    const dayTypeLabel = {
                                        'holiday_paid': 'Paid Holiday',
                                        'holiday_unpaid': 'Unpaid Holiday',
                                        'sick_paid': 'Paid Sick',
                                        'sick_unpaid': 'Unpaid Sick'
                                    }[dayData.day_type] || dayData.day_type;
                                    
                                    const dayTypeBadge = {
                                        'holiday_paid': '<span style="background: #28a745; color: white; padding: 2px 4px; border-radius: 3px;">‚úì Paid Holiday</span>',
                                        'holiday_unpaid': '<span style="background: #ffc107; color: #333; padding: 2px 4px; border-radius: 3px;">‚ö† Unpaid Holiday</span>',
                                        'sick_paid': '<span style="background: #007bff; color: white; padding: 2px 4px; border-radius: 3px;">‚úì Paid Sick</span>',
                                        'sick_unpaid': '<span style="background: #fd7e14; color: white; padding: 2px 4px; border-radius: 3px;">‚ö† Unpaid Sick</span>'
                                    }[dayData.day_type] || '';
                                    
                                    // Calculate hours based on day_type
                                    let regularHours = 0;
                                    let totalHours = 0;
                                    
                                    if (dayData.day_type === 'holiday_unpaid' || dayData.day_type === 'sick_unpaid') {
                                        regularHours = 0;
                                        totalHours = 0;
                                    } else if (dayData.day_type === 'sick_paid') {
                                        // Paid sick: 8 hours Mon-Thu, 6 hours Friday
                                        const dateObj = new Date(date);
                                        const dayOfWeek = dateObj.getDay(); // 0 = Sunday, 5 = Friday
                                        if (dayOfWeek === 5) {
                                            // Friday
                                            regularHours = 6;
                                            totalHours = 6;
                                        } else {
                                            // Monday to Thursday
                                            regularHours = 8;
                                            totalHours = 8;
                                        }
                                    } else if (dayData.day_type === 'holiday_paid') {
                                        // Paid holiday: hours from holiday request (half day = 4, full day = 8) or default 8
                                        // Note: We can't easily get holiday request here, so default to 8
                                        regularHours = 8;
                                        totalHours = 8;
                                    }
                                    
                                    dailyHtml += `
                                        <tr style="border-top: 2px solid #4CBB17; background: #f8f9fa;">
                                            <td style="font-weight: 600; padding: 15px; vertical-align: top;">${dateStr}</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td>-</td>
                                            <td style="vertical-align: top; padding: 15px;">
                                                <select 
                                                    id="admin-day-type-${userId}-${date}" 
                                                    class="form-select" 
                                                    style="width: 100%; padding: 4px; font-size: 11px; min-width: 120px;"
                                                    onchange="saveAdminDayType('${userId}', '${weekStart}', '${date}', this.value)"
                                                >
                                                    <option value="">Normal Day</option>
                                                    <option value="holiday_paid" ${dayData.day_type === 'holiday_paid' ? 'selected' : ''}>Paid Holiday</option>
                                                    <option value="holiday_unpaid" ${dayData.day_type === 'holiday_unpaid' ? 'selected' : ''}>Unpaid Holiday</option>
                                                    <option value="sick_paid" ${dayData.day_type === 'sick_paid' ? 'selected' : ''}>Paid Sick</option>
                                                    <option value="sick_unpaid" ${dayData.day_type === 'sick_unpaid' ? 'selected' : ''}>Unpaid Sick</option>
                                                </select>
                                                ${dayData.day_type ? `
                                                    <div style="margin-top: 4px; font-size: 10px;">
                                                        ${dayTypeBadge}
                                                    </div>
                                                ` : ''}
                                            </td>
                                            <td>${formatHours(regularHours)}</td>
                                            <td>${formatHours(0)}</td>
                                            <td>${formatHours(0)}</td>
                                            <td>${formatHours(0)}</td>
                                            <td>${formatHours(totalHours)}</td>
                                            <td style="text-align: center; padding: 15px;">
                                                <button onclick="showAddMissingDayModal(${userId}, '${weekStart}', '${date}')" 
                                                        class="btn btn-primary btn-sm" 
                                                        style="padding: 6px 12px; font-size: 12px;"
                                                        title="Add missing day entry">
                                                    ‚ûï Add Missing Day
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                } else {
                                    // No entries and no day_type - show "Add Missing Day" button
                                    dailyHtml += `
                                        <tr style="border-top: 2px solid #ddd; background: #f8f9fa;">
                                            <td style="font-weight: 600; padding: 15px;">${dateStr}</td>
                                            <td colspan="10" style="text-align: center; padding: 15px; color: #666;">
                                                No timesheet entry for this day
                                            </td>
                                            <td style="text-align: center; padding: 15px;">
                                                <button onclick="showAddMissingDayModal(${userId}, '${weekStart}', '${date}')" 
                                                        class="btn btn-primary btn-sm" 
                                                        style="padding: 6px 12px; font-size: 12px;"
                                                        title="Add missing day entry">
                                                    ‚ûï Add Missing Day
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }
                                return; // Skip to next date
                            }
                            
                            // Calculate daily totals
                            let dayRegular = 0, dayOvertime = 0, dayWeekend = 0, dayOvernight = 0, dayTotal = 0;
                            
                            dayEntries.forEach(day => {
                                dayRegular += roundToQuarterHour(parseFloat(day.regular_hours || 0));
                                dayOvertime += roundToQuarterHour(parseFloat(day.overtime_hours || 0));
                                dayWeekend += roundToQuarterHour(parseFloat(day.weekend_hours || 0));
                                dayOvernight += roundToQuarterHour(parseFloat(day.overnight_hours || 0));
                                dayTotal += roundToQuarterHour(parseFloat(day.total_hours || 0));
                            });
                            
                            // Show each entry
                            dayEntries.forEach((day, idx) => {
                                const clockIn = day.clock_in_time ? formatDateTime(new Date(day.clock_in_time)) : '-';
                                const clockOut = day.clock_out_time ? formatDateTime(new Date(day.clock_out_time)) : '-';
                                const hasInLocation = day.clock_in_latitude && day.clock_in_longitude;
                                const hasOutLocation = day.clock_out_latitude && day.clock_out_longitude;
                                const regular = roundToQuarterHour(parseFloat(day.regular_hours || 0));
                                const overtime = roundToQuarterHour(parseFloat(day.overtime_hours || 0));
                                const weekend = roundToQuarterHour(parseFloat(day.weekend_hours || 0));
                                const overnight = roundToQuarterHour(parseFloat(day.overnight_hours || 0));
                                const total = roundToQuarterHour(parseFloat(day.total_hours || 0));
                                // Check if edited by admin (more robust check)
                                const isEditedByAdmin = day.edited_by_admin_id != null && day.edited_by_admin_id !== undefined && 
                                                       day.edited_by_admin_at != null && day.edited_by_admin_at !== undefined;
                                
                                // Debug logging (only log if it should be edited by admin but isn't detected)
                                if (day.id && (day.edited_by_admin_id || day.edited_by_admin_at) && !isEditedByAdmin) {
                                    console.log('Admin edit fields present but not detected:', {
                                        id: day.id,
                                        edited_by_admin_id: day.edited_by_admin_id,
                                        edited_by_admin_at: day.edited_by_admin_at,
                                        type_id: typeof day.edited_by_admin_id,
                                        type_at: typeof day.edited_by_admin_at
                                    });
                                }
                                
                                let locationHtml = '<small style="color: #666;">';
                                if (hasInLocation || hasOutLocation) {
                                    locationHtml += '<div style="margin-bottom: 4px;">';
                                    if (hasInLocation) {
                                        locationHtml += `<button onclick="openMap(${day.clock_in_latitude}, ${day.clock_in_longitude})" class="btn btn-sm" style="padding: 2px 6px; font-size: 10px; background: #4CBB17; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 4px;" title="View clock-in location">In üó∫Ô∏è</button>`;
                                    }
                                    if (hasOutLocation) {
                                        locationHtml += `<button onclick="openMap(${day.clock_out_latitude}, ${day.clock_out_longitude})" class="btn btn-sm" style="padding: 2px 6px; font-size: 10px; background: #808080; color: white; border: none; border-radius: 3px; cursor: pointer;" title="View clock-out location">Out üó∫Ô∏è</button>`;
                                    }
                                    locationHtml += '</div>';
                                } else {
                                    locationHtml += 'N/A';
                                }
                                locationHtml += '</small>';
                                
                                const editedByAdminStamp = isEditedByAdmin 
                                    ? `<br><small style="color: #856404; font-weight: 600;">‚ö†Ô∏è Edited by Admin ${day.edited_by_admin_at ? `on ${formatDateTime(new Date(day.edited_by_admin_at))}` : ''}</small>`
                                    : '';
                                
                                dailyHtml += `
                                    <tr ${idx === 0 ? `style="border-top: 2px solid #4CBB17;"` : ''}>
                                        <td ${idx === 0 ? `rowspan="${dayEntries.length}" style="vertical-align: top; font-weight: 600;"` : ''}>${idx === 0 ? dateStr : ''}</td>
                                        <td>${escapeHtml(day.job_name || '-')}</td>
                                        <td><small>${clockIn}${editedByAdminStamp}</small></td>
                                        <td><small>${clockOut}</small></td>
                                        <td>${locationHtml}</td>
                                        <td ${idx === 0 ? `rowspan="${dayEntries.length}" style="vertical-align: top;"` : ''}>
                                            ${idx === 0 ? `
                                                <select 
                                                    id="admin-day-type-${userId}-${date}" 
                                                    class="form-select" 
                                                    style="width: 100%; padding: 4px; font-size: 11px; min-width: 120px;"
                                                    onchange="saveAdminDayType('${userId}', '${weekStart}', '${date}', this.value)"
                                                >
                                                    <option value="">Normal Day</option>
                                                    <option value="holiday_paid" ${dayData.day_type === 'holiday_paid' ? 'selected' : ''}>Paid Holiday</option>
                                                    <option value="holiday_unpaid" ${dayData.day_type === 'holiday_unpaid' ? 'selected' : ''}>Unpaid Holiday</option>
                                                    <option value="sick_paid" ${dayData.day_type === 'sick_paid' ? 'selected' : ''}>Paid Sick</option>
                                                    <option value="sick_unpaid" ${dayData.day_type === 'sick_unpaid' ? 'selected' : ''}>Unpaid Sick</option>
                                                </select>
                                                ${dayData.day_type ? `
                                                    <div style="margin-top: 4px; font-size: 10px;">
                                                        ${dayData.day_type === 'holiday_paid' ? '<span style="background: #28a745; color: white; padding: 2px 4px; border-radius: 3px;">‚úì Paid Holiday</span>' : ''}
                                                        ${dayData.day_type === 'holiday_unpaid' ? '<span style="background: #ffc107; color: #333; padding: 2px 4px; border-radius: 3px;">‚ö† Unpaid Holiday</span>' : ''}
                                                        ${dayData.day_type === 'sick_paid' ? '<span style="background: #007bff; color: white; padding: 2px 4px; border-radius: 3px;">‚úì Paid Sick</span>' : ''}
                                                        ${dayData.day_type === 'sick_unpaid' ? '<span style="background: #fd7e14; color: white; padding: 2px 4px; border-radius: 3px;">‚ö† Unpaid Sick</span>' : ''}
                                                    </div>
                                                ` : ''}
                                            ` : ''}
                                        </td>
                                        <td>${formatHours(regular)}</td>
                                        <td>${formatHours(overtime)}</td>
                                        <td>${formatHours(weekend)}</td>
                                        <td>${formatHours(overnight)}</td>
                                        <td>${formatHours(total)}</td>
                                        <td>
                                            ${day.id ? `
                                                <button onclick="showAdminEditModal(${day.id}, '${day.clock_in_time || ''}', '${day.clock_out_time || ''}', '${escapeHtml(day.job_name || '')}', ${dayData.overnight_away === true || dayData.overnight_away === 1 || dayData.overnight_away === '1' ? 'true' : 'false'}, '${dayData.day_type || ''}', '${date}', ${userId}, '${weekStart}')" 
                                                        class="btn btn-primary btn-sm" 
                                                        style="padding: 4px 8px; font-size: 11px; margin-right: 4px;"
                                                        title="Edit this entry">
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button onclick="deleteTimesheetEntry(${day.id}, ${userId}, '${weekStart}')" 
                                                        class="btn btn-danger btn-sm" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        title="Delete this entry">
                                                    üóëÔ∏è Delete
                                                </button>
                                            ` : `
                                                <button onclick="showAddMissingDayModal(${userId}, '${weekStart}', '${date}')" 
                                                        class="btn btn-primary btn-sm" 
                                                        style="padding: 4px 8px; font-size: 11px;"
                                                        title="Add clock entry for this day">
                                                    ‚ûï Add Entry
                                                </button>
                                            `}
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Add daily total row if multiple entries
                            if (dayEntries.length > 1) {
                                dailyHtml += `
                                    <tr style="background: #f0f0f0; font-weight: 600;">
                                        <td colspan="6" style="text-align: right;">Daily Total:</td>
                                        <td>${formatHours(dayRegular)}</td>
                                        <td>${formatHours(dayOvertime)}</td>
                                        <td>${formatHours(dayWeekend)}</td>
                                        <td>${formatHours(dayOvernight)}</td>
                                        <td><strong>${formatHours(dayTotal)}</strong></td>
                                        <td></td>
                                    </tr>
                                `;
                            }
                            
                            // Add activities section for this day
                            if (dayData.daily_notes) {
                                let activities = [];
                                try {
                                    const parsed = JSON.parse(dayData.daily_notes);
                                    if (Array.isArray(parsed)) {
                                        activities = parsed;
                                    } else if (typeof parsed === 'string' && parsed.trim()) {
                                        activities = [{ timestamp: new Date().toISOString(), note: parsed }];
                                    }
                                } catch (e) {
                                    if (dayData.daily_notes.trim()) {
                                        activities = [{ timestamp: new Date().toISOString(), note: dayData.daily_notes }];
                                    }
                                }
                                
                                if (activities.length > 0) {
                                    const activitiesHtml = activities.map(activity => {
                                        const time = new Date(activity.timestamp);
                                        const timeStr = time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                                        return `
                                            <div style="background: #f8f9fa; padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 3px solid #4CBB17; font-size: 12px;">
                                                <div style="color: #666; margin-bottom: 2px;">${timeStr}</div>
                                                <div style="color: #2c3e50;">${escapeHtml(activity.note || '')}</div>
                                            </div>
                                        `;
                                    }).join('');
                                    
                                    dailyHtml += `
                                        <tr>
                                            <td colspan="12" style="padding: 10px; background: #f8f9fa; border-top: 2px solid #ddd;">
                                                <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">Daily Activities (${activities.length}):</div>
                                                <div style="max-height: 200px; overflow-y: auto;">
                                                    ${activitiesHtml}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }
                            }
                        });
                        
                        dailyHtml += '</tbody></table></div>';
                        content.innerHTML = dailyHtml;
                    } catch (error) {
                        console.error('Error loading daily breakdown:', error);
                        content.innerHTML = `<p style="text-align: center; padding: 10px; color: #e74c3c;">Error loading daily breakdown: ${error.message || 'Unknown error'}</p>`;
                    }
                }
            } else {
                // Collapse
                row.style.display = 'none';
                if (icon) icon.classList.remove('expanded');
            }
        }
        
        // Open map with coordinates
        function openMap(latitude, longitude) {
            if (!latitude || !longitude) {
                showAlert('Location coordinates not available', 'error');
                return;
            }
            // Open in Google Maps (can be changed to OpenStreetMap or other providers)
            const url = `https://www.google.com/maps?q=${latitude},${longitude}`;
            window.open(url, '_blank');
        }
        
        // Delete timesheet entry
        async function saveAdminDayType(userId, weekStart, date, dayType) {
            try {
                const response = await apiCall(`/clock/weekly/${weekStart}/day/${date}/user/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ day_type: dayType || null })
                });
                
                if (response && response.success) {
                    showAlert('Day type updated successfully', 'success');
                    
                    // Collect currently expanded user IDs and ensure edited user is included
                    const expandedUserIds = getExpandedUserIds();
                    if (userId && !expandedUserIds.includes(parseInt(userId))) {
                        expandedUserIds.push(parseInt(userId));
                    }
                    
                    // Reload payroll summary which will refresh all data and restore expanded states
                    await loadPayrollSummary(expandedUserIds);
                } else {
                    throw new Error(response?.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving day type:', error);
                showAlert('Failed to save day type: ' + (error.message || 'Unknown error'), 'error');
                
                // Collect currently expanded user IDs and ensure edited user is included
                const expandedUserIds = getExpandedUserIds();
                if (userId && !expandedUserIds.includes(parseInt(userId))) {
                    expandedUserIds.push(parseInt(userId));
                }
                
                // Reload to restore previous state
                await loadPayrollSummary(expandedUserIds);
            }
        }
        
        async function deleteTimesheetEntry(entryId, userId, weekStart) {
            if (!confirm('Are you sure you want to delete this timesheet entry? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await apiCall(`/clock/entries/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Timesheet entry deleted successfully', 'success');
                    
                    // Collect currently expanded user IDs and ensure the user is included
                    const expandedUserIds = getExpandedUserIds();
                    if (userId && !expandedUserIds.includes(parseInt(userId))) {
                        expandedUserIds.push(parseInt(userId));
                    }
                    
                    // Reload payroll summary which will refresh all data and restore expanded states
                    await loadPayrollSummary(expandedUserIds);
                } else {
                    throw new Error(response?.error || 'Failed to delete entry');
                }
            } catch (error) {
                console.error('Error deleting timesheet entry:', error);
                showAlert('Failed to delete timesheet entry: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        // Add Missing Day Modal Functions
        async function showAddMissingDayModal(userId, weekStart, date) {
            // Set user ID and week start
            document.getElementById('addMissingDayUserId').value = userId;
            document.getElementById('addMissingDayWeekStart').value = weekStart;
            document.getElementById('addMissingDayDate').value = date;
            
            // Load users for dropdown
            try {
                const usersData = await apiCall('/users');
                const users = usersData.users || [];
                const userSelect = document.getElementById('addMissingDayUser');
                userSelect.innerHTML = '<option value="">Select a user</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    option.selected = user.id == userId;
                    userSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Error loading users', 'error');
            }
            
            // Load jobs for dropdown
            try {
                const jobsData = await apiCall('/timesheet/jobs?all=true');
                const jobs = jobsData.jobs || [];
                const jobSelect = document.getElementById('addMissingDayJob');
                jobSelect.innerHTML = '<option value="">Select a job/site</option>';
                jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.id;
                    option.textContent = job.name + (job.description ? ' - ' + job.description : '');
                    jobSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading jobs:', error);
                showAlert('Error loading jobs', 'error');
            }
            
            // Set default times for the date (9 AM to 5 PM)
            const dateObj = new Date(date);
            dateObj.setHours(9, 0, 0, 0);
            const localDateTimeIn = new Date(dateObj.getTime() - dateObj.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('addMissingDayClockIn').value = localDateTimeIn;
            
            dateObj.setHours(17, 0, 0, 0);
            const localDateTimeOut = new Date(dateObj.getTime() - dateObj.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('addMissingDayClockOut').value = localDateTimeOut;
            
            // Clear reason and day type
            document.getElementById('addMissingDayReason').value = '';
            document.getElementById('addMissingDayOvernight').checked = false;
            document.getElementById('addMissingDayType').value = '';
            
            // Try to load current day_type for this date
            try {
                const weekStartDate = weekStart;
                const dailyData = await apiCall(`/clock/payroll/${weekStartDate}/user/${userId}/daily`);
                const dailyBreakdown = dailyData.dailyBreakdown || [];
                const entryForDate = dailyBreakdown.find(e => e.entry_date === date);
                if (entryForDate && entryForDate.day_type) {
                    document.getElementById('addMissingDayType').value = entryForDate.day_type;
                }
            } catch (error) {
                console.log('Could not load existing day_type:', error);
            }
            
            // Add event listener for day type change to make clock times conditionally required
            const dayTypeSelect = document.getElementById('addMissingDayType');
            const clockInField = document.getElementById('addMissingDayClockIn');
            const clockOutField = document.getElementById('addMissingDayClockOut');
            
            // Remove existing listeners by cloning and replacing
            const newDayTypeSelect = dayTypeSelect.cloneNode(true);
            dayTypeSelect.parentNode.replaceChild(newDayTypeSelect, dayTypeSelect);
            
            newDayTypeSelect.addEventListener('change', function() {
                const dayType = this.value;
                const isHolidayOrSick = dayType === 'holiday_paid' || dayType === 'holiday_unpaid' || 
                                      dayType === 'sick_paid' || dayType === 'sick_unpaid';
                
                if (isHolidayOrSick) {
                    clockInField.removeAttribute('required');
                    clockOutField.removeAttribute('required');
                    clockInField.style.opacity = '0.6';
                    clockOutField.style.opacity = '0.6';
                } else {
                    clockInField.setAttribute('required', 'required');
                    clockOutField.setAttribute('required', 'required');
                    clockInField.style.opacity = '1';
                    clockOutField.style.opacity = '1';
                }
            });
            
            // Trigger change event to set initial state
            newDayTypeSelect.dispatchEvent(new Event('change'));
            
            // Show modal
            showModal('addMissingDayModal');
        }
        
        function hideAddMissingDayModal() {
            hideModal('addMissingDayModal');
            document.getElementById('addMissingDayForm').reset();
        }
        
        async function submitAddMissingDay() {
            const userId = parseInt(document.getElementById('addMissingDayUser').value);
            const date = document.getElementById('addMissingDayDate').value;
            const jobId = parseInt(document.getElementById('addMissingDayJob').value);
            const clockIn = document.getElementById('addMissingDayClockIn').value;
            const clockOut = document.getElementById('addMissingDayClockOut').value;
            const reason = document.getElementById('addMissingDayReason').value.trim();
            const overnightAway = document.getElementById('addMissingDayOvernight').checked;
            const dayType = document.getElementById('addMissingDayType').value || null;
            const weekStart = document.getElementById('addMissingDayWeekStart').value;
            
            const isHolidayOrSick = dayType === 'holiday_paid' || dayType === 'holiday_unpaid' || 
                                   dayType === 'sick_paid' || dayType === 'sick_unpaid';
            
            // Validation - clock times only required if not holiday/sick
            if (!userId || !date || !reason) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            // Job is only required if not holiday/sick (or if times are provided)
            if (!isHolidayOrSick && !jobId) {
                showAlert('Please select a job/site', 'error');
                return;
            }
            
            // Clock times only required if not holiday/sick
            if (!isHolidayOrSick) {
                if (!clockIn || !clockOut) {
                    showAlert('Please fill in clock in and clock out times', 'error');
                    return;
                }
                
                // Validate clock out is after clock in
                if (new Date(clockOut) <= new Date(clockIn)) {
                    showAlert('Clock out time must be after clock in time', 'error');
                    return;
                }
            }
            
            // Convert local datetime to ISO string (only if times provided)
            const clockInISO = clockIn ? new Date(clockIn).toISOString() : null;
            const clockOutISO = clockOut ? new Date(clockOut).toISOString() : null;
            
            try {
                const response = await apiCall('/clock/entries/admin/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: userId,
                        job_id: jobId || null,
                        clock_in_time: clockInISO,
                        clock_out_time: clockOutISO,
                        reason: reason,
                        overnight_away: overnightAway,
                        day_type: dayType
                    })
                });
                
                if (response && response.success) {
                    showAlert('Timesheet entry created successfully', 'success');
                    hideAddMissingDayModal();
                    
                    // Collect currently expanded user IDs and ensure the user is included
                    const expandedUserIds = getExpandedUserIds();
                    if (userId && !expandedUserIds.includes(parseInt(userId))) {
                        expandedUserIds.push(parseInt(userId));
                    }
                    
                    // Reload payroll summary which will refresh all data and restore expanded states
                    await loadPayrollSummary(expandedUserIds);
                } else {
                    throw new Error(response?.error || 'Failed to create entry');
                }
            } catch (error) {
                console.error('Error creating timesheet entry:', error);
                showAlert('Failed to create timesheet entry: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function exportPayroll(weekStart = null) {
            if (!weekStart) {
                weekStart = document.getElementById('payrollWeekSelect').value || getCurrentWeekStart();
            }
            
            if (!weekStart) {
                showAlert('Please select a week', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/clock/payroll/${weekStart}/export`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payroll-${weekStart}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Payroll exported successfully');
            } catch (error) {
                showAlert('Error exporting payroll: ' + error.message, 'error');
            }
        }
        
        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        init();
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            </div>
            <div class="footer-info">
                <p>&copy; <script>document.write(new Date().getFullYear())</script> Production System. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>

