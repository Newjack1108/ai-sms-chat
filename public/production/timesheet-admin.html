<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock ON/OFF Admin - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Clock ON/OFF Admin</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Admin Clock In/Out -->
        <div class="card">
            <div class="card-header">
                <h2>My Clock Status</h2>
            </div>
            <div id="adminClockStatus" style="padding: 20px;">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Active Staff Clock Ins -->
        <div class="card">
            <div class="card-header">
                <h2>Staff Currently On Clock</h2>
                <button onclick="loadActiveClockIns()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="activeClockIns">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Jobs/Sites Management -->
        <div class="card">
            <div class="card-header">
                <h2>Jobs/Sites Management</h2>
                <button onclick="showAddJobModal()" class="btn btn-primary">Add Job</button>
            </div>
            <div id="jobsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Notices Management -->
        <div class="card">
            <div class="card-header">
                <h2>Notice Board Management</h2>
                <button onclick="showAddNoticeModal()" class="btn btn-primary">Add Notice</button>
            </div>
            <div id="noticesList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Time Amendment Review -->
        <div class="card">
            <div class="card-header">
                <h2>Time Amendment Requests</h2>
                <button onclick="loadPendingAmendments()" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
            <div id="amendmentsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- Payroll Processing -->
        <div class="card">
            <div class="card-header">
                <h2>Payroll Processing</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="date" id="payrollWeekSelect" class="form-input" style="width: auto;">
                    <select id="payrollStaffSelect" class="form-select" style="width: auto; min-width: 200px;">
                        <option value="">All Staff</option>
                    </select>
                    <button onclick="loadPayrollSummary()" class="btn btn-primary">Load Week</button>
                    <button onclick="exportPayroll()" class="btn btn-success" id="exportBtn" style="display: none;">Export CSV</button>
                </div>
            </div>
            <div id="payrollSummary">
                <div class="loading">Select a week to view payroll summary</div>
            </div>
        </div>
        
        <!-- System Maintenance -->
        <div class="card">
            <div class="card-header">
                <h2>System Maintenance</h2>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px; color: #666;">
                    Cleanup old timesheet entries that were never clocked out. This fixes entries created before the auto-clock-out feature was added.
                </p>
                <button onclick="cleanupOldEntries()" class="btn btn-warning" id="cleanupBtn">
                    Cleanup Old Unclosed Entries
                </button>
                <div id="cleanupResult" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Job Modal -->
    <div id="jobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="jobModalTitle">Add Job</h3>
                <button class="modal-close" onclick="hideModal('jobModal')">&times;</button>
            </div>
            <form id="jobForm">
                <input type="hidden" id="jobId">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="jobName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="jobDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group" id="jobStatusGroup" style="display: none;">
                    <label class="form-label">Status</label>
                    <select id="jobStatus" class="form-select">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('jobModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Notice Modal -->
    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="noticeModalTitle">Add Notice</h3>
                <button class="modal-close" onclick="hideModal('noticeModal')">&times;</button>
            </div>
            <form id="noticeForm">
                <input type="hidden" id="noticeId">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noticeTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <textarea id="noticeMessage" class="form-input" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="noticePriority" class="form-select">
                        <option value="low">Low</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select id="noticeStatus" class="form-select">
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At (optional)</label>
                    <input type="datetime-local" id="noticeExpiresAt" class="form-input">
                </div>
                <div class="text-right">
                    <button type="button" onclick="hideModal('noticeModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Amendment Review Modal -->
    <div id="amendmentReviewModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Review Time Amendment</h3>
                <button class="modal-close" onclick="hideModal('amendmentReviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="amendmentReviewForm">
                    <input type="hidden" id="reviewAmendmentId">
                    <input type="hidden" id="reviewAmendmentStatus">
                    
                    <div class="form-group">
                        <label><strong>Staff:</strong></label>
                        <div id="reviewStaffName" style="padding: 8px; background: #f5f5f5; border-radius: 4px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Reason:</strong></label>
                        <div id="reviewReason" style="padding: 8px; background: #f5f5f5; border-radius: 4px; min-height: 40px;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <h4 style="margin-bottom: 10px; color: #666;">Original Times</h4>
                            <div class="form-group">
                                <label>Clock In:</label>
                                <div id="reviewOriginalIn" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Clock Out:</label>
                                <div id="reviewOriginalOut" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 10px; color: #666;">Requested Times</h4>
                            <div class="form-group">
                                <label>Clock In:</label>
                                <div id="reviewRequestedIn" style="padding: 8px; background: #fff8e1; border-radius: 4px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Clock Out:</label>
                                <div id="reviewRequestedOut" style="padding: 8px; background: #fff8e1; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="border-top: 2px solid #4CBB17; padding-top: 15px; margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: #4CBB17;">Final Approved Times</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">You can modify the times if needed before approving:</p>
                        
                        <div class="form-group">
                            <label for="reviewApprovedIn">Clock In Time *</label>
                            <input type="datetime-local" id="reviewApprovedIn" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reviewApprovedOut">Clock Out Time *</label>
                            <input type="datetime-local" id="reviewApprovedOut" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewNotes">Review Notes</label>
                        <textarea id="reviewNotes" class="form-input" rows="3" placeholder="Optional notes about this amendment..."></textarea>
                    </div>
                    
                    <div class="text-right" style="margin-top: 20px;">
                        <button type="button" onclick="hideModal('amendmentReviewModal')" class="btn btn-secondary">Cancel</button>
                        <button type="button" onclick="submitAmendmentReview('rejected')" class="btn btn-danger">Reject</button>
                        <button type="button" onclick="submitAmendmentReview('approved')" class="btn btn-success">Approve</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Edit Timesheet Entry Modal -->
    <div id="adminEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Edit Timesheet Entry (Admin)</h2>
                <button class="modal-close" onclick="hideAdminEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adminEditForm">
                    <input type="hidden" id="adminEditEntryId">
                    
                    <div class="form-group">
                        <label>Original Clock In:</label>
                        <div id="adminOriginalClockIn" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Original Clock Out:</label>
                        <div id="adminOriginalClockOut" style="padding: 8px; background: #fee; border-radius: 4px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminAmendedClockIn">New Clock In Time *</label>
                        <input type="datetime-local" id="adminAmendedClockIn" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminAmendedClockOut">New Clock Out Time *</label>
                        <input type="datetime-local" id="adminAmendedClockOut" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminEditReason">Reason for Edit *</label>
                        <textarea id="adminEditReason" class="form-control" rows="3" required placeholder="Enter reason for editing this timesheet entry"></textarea>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                        <strong>‚ö†Ô∏è Admin Edit:</strong> This change will be applied immediately and will be marked as "Edited by Admin" on the timesheet.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="hideAdminEditModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="submitAdminEdit()" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentUser = null;
        let refreshInterval = null;
        
        let currentLocation = null;
        let locationError = false;
        
        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) return;
            initNavbar();
            
            // Check if user is manager/admin
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                showAlert('Access denied. Manager or Admin privileges required.', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }
            
            // Request location permission for clock in/out
            requestLocation();
            
            await Promise.all([
                loadAdminClockStatus(),
                loadActiveClockIns(),
                loadJobs(),
                loadNotices(),
                loadPendingAmendments()
            ]);
            
            // Initialize payroll week selector to current week
            const weekSelect = document.getElementById('payrollWeekSelect');
            if (weekSelect) {
                weekSelect.value = getCurrentWeekStart();
                // Load payroll summary for current week
                await loadPayrollSummary();
            }
            
            // Add event listener for staff dropdown change
            const staffSelect = document.getElementById('payrollStaffSelect');
            if (staffSelect) {
                staffSelect.addEventListener('change', () => {
                    loadPayrollSummary();
                });
            }
            
            // Auto-refresh active clock ins every 30 seconds
            refreshInterval = setInterval(loadActiveClockIns, 30000);
        }
        
        function requestLocation() {
            if (!navigator.geolocation) {
                locationError = true;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                },
                (error) => {
                    locationError = true;
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }
        
        async function loadAdminClockStatus() {
            try {
                const data = await apiCall('/timesheet/status');
                const status = data.status;
                const jobsData = await apiCall('/timesheet/jobs');
                const jobs = jobsData.jobs || [];
                const adminClockStatus = document.getElementById('adminClockStatus');
                
                if (status) {
                    // Clocked in
                    const clockInTime = new Date(status.clock_in_time);
                    adminClockStatus.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #667eea;">
                                You are clocked in
                            </div>
                            <div style="color: #666; margin-bottom: 20px;">
                                <div>Job: <strong>${status.job_name || 'Unknown'}</strong></div>
                                <div>Clocked in: ${formatDate(clockInTime)}</div>
                            </div>
                            <button onclick="handleAdminClockOut()" class="btn btn-danger" style="width: 100%; padding: 15px; font-size: 16px;">
                                Clock Out
                            </button>
                        </div>
                    `;
                } else {
                    // Not clocked in
                    adminClockStatus.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #666;">
                                You are not clocked in
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label class="form-label">Select Job/Site *</label>
                                <select id="adminJobSelect" class="form-select" required>
                                    <option value="">Select job/site</option>
                                    ${jobs.map(job => `<option value="${job.id}">${job.name}${job.description ? ' - ' + job.description : ''}</option>`).join('')}
                                </select>
                            </div>
                            <button onclick="handleAdminClockIn()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                                Clock In
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('adminClockStatus').innerHTML = '<p style="color: #e74c3c;">Error loading clock status</p>';
            }
        }
        
        async function handleAdminClockIn() {
            const jobId = document.getElementById('adminJobSelect').value;
            if (!jobId) {
                showAlert('Please select a job/site', 'error');
                return;
            }
            
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            try {
                await apiCall('/timesheet/clock-in', {
                    method: 'POST',
                    body: JSON.stringify({
                        job_id: jobId,
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked in successfully');
                await Promise.all([loadAdminClockStatus(), loadActiveClockIns()]);
            } catch (error) {
                showAlert(error.message || 'Failed to clock in', 'error');
            }
        }
        
        async function handleAdminClockOut() {
            if (!currentLocation && !locationError) {
                showAlert('Getting your location...', 'error');
                requestLocation();
                return;
            }
            
            if (locationError) {
                if (!confirm('Location unavailable. Continue without GPS coordinates?')) {
                    return;
                }
            }
            
            try {
                await apiCall('/timesheet/clock-out', {
                    method: 'POST',
                    body: JSON.stringify({
                        latitude: currentLocation ? currentLocation.latitude : null,
                        longitude: currentLocation ? currentLocation.longitude : null
                    })
                });
                showAlert('Clocked out successfully');
                await Promise.all([loadAdminClockStatus(), loadActiveClockIns()]);
            } catch (error) {
                showAlert(error.message || 'Failed to clock out', 'error');
            }
        }
        
        async function loadActiveClockIns() {
            try {
                const data = await apiCall('/timesheet/active');
                const clockIns = data.clockIns || [];
                const activeClockIns = document.getElementById('activeClockIns');
                
                if (clockIns.length === 0) {
                    activeClockIns.innerHTML = '<p>No staff currently clocked in</p>';
                    return;
                }
                
                activeClockIns.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Job/Site</th>
                                <th>Clock In Time</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clockIns.map(entry => {
                                const clockInTime = new Date(entry.clock_in_time);
                                const hasLocation = entry.clock_in_latitude && entry.clock_in_longitude;
                                const location = hasLocation
                                    ? `${parseFloat(entry.clock_in_latitude).toFixed(6)}, ${parseFloat(entry.clock_in_longitude).toFixed(6)}`
                                    : 'Not available';
                                return `
                                    <tr>
                                        <td><strong>${entry.username || 'Unknown'}</strong></td>
                                        <td>${entry.job_name || 'Unknown'}</td>
                                        <td>${formatDate(clockInTime)}</td>
                                        <td>
                                            <small>${location}</small>
                                            ${hasLocation ? `
                                                <button onclick="openMap(${entry.clock_in_latitude}, ${entry.clock_in_longitude})" 
                                                        class="btn btn-sm" 
                                                        style="margin-left: 8px; padding: 2px 8px; font-size: 11px; background: #4CBB17; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                                        title="View on map">
                                                    üó∫Ô∏è Map
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading active clock ins:', error);
                let errorMsg = 'Unknown error';
                if (error.message) {
                    errorMsg = error.message;
                } else if (error.details) {
                    errorMsg = error.details;
                } else if (typeof error === 'string') {
                    errorMsg = error;
                }
                document.getElementById('activeClockIns').innerHTML = `
                    <div style="padding: 20px; background: #fee; border: 1px solid #e74c3c; border-radius: 8px;">
                        <p style="color: #e74c3c; font-weight: 600; margin-bottom: 10px;">Error loading active clock ins</p>
                        <p style="color: #c33; font-size: 14px;">${escapeHtml(errorMsg)}</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">Check the server console for more details.</p>
                    </div>
                `;
            }
        }
        
        async function loadJobs() {
            try {
                const data = await apiCall('/timesheet/jobs?all=true');
                const jobs = data.jobs || [];
                const jobsList = document.getElementById('jobsList');
                
                if (jobs.length === 0) {
                    jobsList.innerHTML = '<p>No jobs found. Add your first job/site.</p>';
                    return;
                }
                
                jobsList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${jobs.map(job => `
                                <tr>
                                    <td><strong>${job.name}</strong></td>
                                    <td>${job.description || '-'}</td>
                                    <td><span class="badge ${job.status === 'active' ? 'badge-success' : 'badge-secondary'}">${job.status}</span></td>
                                    <td>
                                        <button onclick="showEditJobModal(${job.id})" class="btn btn-info btn-sm">Edit</button>
                                        <button onclick="deleteJob(${job.id})" class="btn btn-danger btn-sm">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('jobsList').innerHTML = '<p>Error loading jobs</p>';
            }
        }
        
        async function loadNotices() {
            try {
                const data = await apiCall('/timesheet/notices/all');
                const notices = data.notices || [];
                const noticesList = document.getElementById('noticesList');
                
                if (notices.length === 0) {
                    noticesList.innerHTML = '<p>No notices found. Add your first notice.</p>';
                    return;
                }
                
                noticesList.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Expires</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notices.map(notice => {
                                const priorityClass = notice.priority === 'urgent' ? 'badge-danger' :
                                                    notice.priority === 'high' ? 'badge-warning' :
                                                    notice.priority === 'normal' ? 'badge-info' : 'badge-secondary';
                                const expiresText = notice.expires_at ? formatDate(notice.expires_at) : 'Never';
                                return `
                                    <tr>
                                        <td><strong>${notice.title}</strong></td>
                                        <td><span class="badge ${priorityClass}">${notice.priority}</span></td>
                                        <td><span class="badge ${notice.status === 'active' ? 'badge-success' : 'badge-secondary'}">${notice.status}</span></td>
                                        <td><small>${expiresText}</small></td>
                                        <td>${notice.created_by_name || '-'}</td>
                                        <td>
                                            <button onclick="showEditNoticeModal(${notice.id})" class="btn btn-info btn-sm">Edit</button>
                                            <button onclick="deleteNotice(${notice.id})" class="btn btn-danger btn-sm">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('noticesList').innerHTML = '<p>Error loading notices</p>';
            }
        }
        
        function showAddJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('jobId').value = '';
            document.getElementById('jobModalTitle').textContent = 'Add Job';
            document.getElementById('jobStatusGroup').style.display = 'none';
            showModal('jobModal');
        }
        
        async function showEditJobModal(jobId) {
            try {
                const data = await apiCall('/timesheet/jobs?all=true');
                const jobs = data.jobs || [];
                const job = jobs.find(j => j.id === jobId);
                
                if (!job) {
                    showAlert('Job not found', 'error');
                    return;
                }
                
                document.getElementById('jobId').value = job.id;
                document.getElementById('jobName').value = job.name;
                document.getElementById('jobDescription').value = job.description || '';
                document.getElementById('jobStatus').value = job.status || 'active';
                document.getElementById('jobModalTitle').textContent = 'Edit Job';
                document.getElementById('jobStatusGroup').style.display = 'block';
                showModal('jobModal');
            } catch (error) {
                showAlert('Error loading job', 'error');
            }
        }
        
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }
            
            try {
                await apiCall(`/timesheet/jobs/${jobId}`, { method: 'DELETE' });
                showAlert('Job deleted successfully');
                loadJobs();
            } catch (error) {
                showAlert('Error deleting job: ' + error.message, 'error');
            }
        }
        
        function showAddNoticeModal() {
            document.getElementById('noticeForm').reset();
            document.getElementById('noticeId').value = '';
            document.getElementById('noticeModalTitle').textContent = 'Add Notice';
            showModal('noticeModal');
        }
        
        async function showEditNoticeModal(noticeId) {
            try {
                const data = await apiCall('/timesheet/notices/all');
                const notices = data.notices || [];
                const notice = notices.find(n => n.id === noticeId);
                
                if (!notice) {
                    showAlert('Notice not found', 'error');
                    return;
                }
                
                document.getElementById('noticeId').value = notice.id;
                document.getElementById('noticeTitle').value = notice.title;
                document.getElementById('noticeMessage').value = notice.message;
                document.getElementById('noticePriority').value = notice.priority || 'normal';
                document.getElementById('noticeStatus').value = notice.status || 'active';
                if (notice.expires_at) {
                    const expiresDate = new Date(notice.expires_at);
                    document.getElementById('noticeExpiresAt').value = expiresDate.toISOString().slice(0, 16);
                } else {
                    document.getElementById('noticeExpiresAt').value = '';
                }
                document.getElementById('noticeModalTitle').textContent = 'Edit Notice';
                showModal('noticeModal');
            } catch (error) {
                showAlert('Error loading notice', 'error');
            }
        }
        
        async function deleteNotice(noticeId) {
            if (!confirm('Are you sure you want to delete this notice?')) {
                return;
            }
            
            try {
                await apiCall(`/timesheet/notices/${noticeId}`, { method: 'DELETE' });
                showAlert('Notice deleted successfully');
                loadNotices();
            } catch (error) {
                showAlert('Error deleting notice: ' + error.message, 'error');
            }
        }
        
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const jobId = document.getElementById('jobId').value;
                const name = document.getElementById('jobName').value;
                const description = document.getElementById('jobDescription').value;
                const status = document.getElementById('jobStatus').value || 'active';
                
                if (jobId) {
                    await apiCall(`/timesheet/jobs/${jobId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, description, status })
                    });
                    showAlert('Job updated successfully');
                } else {
                    await apiCall('/timesheet/jobs', {
                        method: 'POST',
                        body: JSON.stringify({ name, description })
                    });
                    showAlert('Job created successfully');
                }
                hideModal('jobModal');
                loadJobs();
            } catch (error) {
                showAlert('Error saving job: ' + error.message, 'error');
            }
        });
        
        document.getElementById('noticeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const noticeId = document.getElementById('noticeId').value;
                const title = document.getElementById('noticeTitle').value;
                const message = document.getElementById('noticeMessage').value;
                const priority = document.getElementById('noticePriority').value;
                const status = document.getElementById('noticeStatus').value;
                const expiresAt = document.getElementById('noticeExpiresAt').value;
                
                if (noticeId) {
                    await apiCall(`/timesheet/notices/${noticeId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ title, message, priority, status, expires_at: expiresAt || null })
                    });
                    showAlert('Notice updated successfully');
                } else {
                    await apiCall('/timesheet/notices', {
                        method: 'POST',
                        body: JSON.stringify({ title, message, priority, expires_at: expiresAt || null })
                    });
                    showAlert('Notice created successfully');
                }
                hideModal('noticeModal');
                loadNotices();
            } catch (error) {
                showAlert('Error saving notice: ' + error.message, 'error');
            }
        });
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Time amendment functions
        async function loadPendingAmendments() {
            try {
                const data = await apiCall('/clock/amendments/pending');
                const amendments = data.amendments || [];
                const listEl = document.getElementById('amendmentsList');
                
                if (amendments.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No pending amendments</p>';
                    return;
                }
                
                listEl.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Date</th>
                                <th>Original Times</th>
                                <th>Amended Times</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${amendments.map(amendment => {
                                const originalIn = amendment.original_clock_in_time ? formatDateTime(new Date(amendment.original_clock_in_time)) : '-';
                                const originalOut = amendment.original_clock_out_time ? formatDateTime(new Date(amendment.original_clock_out_time)) : '-';
                                const amendedIn = amendment.amended_clock_in_time ? formatDateTime(new Date(amendment.amended_clock_in_time)) : '-';
                                const amendedOut = amendment.amended_clock_out_time ? formatDateTime(new Date(amendment.amended_clock_out_time)) : '-';
                                const dateStr = amendment.original_clock_in_time ? new Date(amendment.original_clock_in_time).toISOString().split('T')[0] : '-';
                                return `
                                    <tr>
                                        <td>${escapeHtml(amendment.username || 'Unknown')}</td>
                                        <td>${dateStr}</td>
                                        <td><small>In: ${originalIn}<br>Out: ${originalOut}</small></td>
                                        <td><small>In: ${amendedIn}<br>Out: ${amendedOut}</small></td>
                                        <td>${escapeHtml(amendment.reason || '')}</td>
                                        <td>
                                            <button onclick="showAmendmentReviewModal(${amendment.id})" class="btn btn-primary btn-sm">Review</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                document.getElementById('amendmentsList').innerHTML = 
                    '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading amendments</p>';
            }
        }
        
        let currentAmendmentData = null;
        
        async function showAmendmentReviewModal(amendmentId) {
            try {
                // Get amendment details
                const amendments = await apiCall('/clock/amendments/pending');
                const amendment = amendments.amendments.find(a => a.id === amendmentId);
                
                if (!amendment) {
                    showAlert('Amendment not found', 'error');
                    return;
                }
                
                currentAmendmentData = amendment;
                
                // Populate modal
                document.getElementById('reviewAmendmentId').value = amendmentId;
                document.getElementById('reviewStaffName').textContent = amendment.username || 'Unknown';
                document.getElementById('reviewReason').textContent = amendment.reason || 'No reason provided';
                
                // Original times
                if (amendment.original_clock_in_time) {
                    document.getElementById('reviewOriginalIn').textContent = formatDateTime(amendment.original_clock_in_time);
                } else {
                    document.getElementById('reviewOriginalIn').textContent = 'Not set';
                }
                
                if (amendment.original_clock_out_time) {
                    document.getElementById('reviewOriginalOut').textContent = formatDateTime(amendment.original_clock_out_time);
                } else {
                    document.getElementById('reviewOriginalOut').textContent = 'Not set';
                }
                
                // Requested times
                if (amendment.amended_clock_in_time) {
                    document.getElementById('reviewRequestedIn').textContent = formatDateTime(amendment.amended_clock_in_time);
                    const clockIn = new Date(amendment.amended_clock_in_time);
                    const localDateTime = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('reviewApprovedIn').value = localDateTime;
                } else {
                    document.getElementById('reviewRequestedIn').textContent = 'Not set';
                }
                
                if (amendment.amended_clock_out_time) {
                    document.getElementById('reviewRequestedOut').textContent = formatDateTime(amendment.amended_clock_out_time);
                    const clockOut = new Date(amendment.amended_clock_out_time);
                    const localDateTime = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('reviewApprovedOut').value = localDateTime;
                } else {
                    document.getElementById('reviewRequestedOut').textContent = 'Not set';
                }
                
                // Clear review notes
                document.getElementById('reviewNotes').value = '';
                
                // Show modal
                showModal('amendmentReviewModal');
            } catch (error) {
                showAlert('Error loading amendment: ' + error.message, 'error');
            }
        }
        
        async function submitAmendmentReview(status) {
            if (!currentAmendmentData) {
                showAlert('No amendment data loaded', 'error');
                return;
            }
            
            const amendmentId = parseInt(document.getElementById('reviewAmendmentId').value);
            const approvedClockIn = document.getElementById('reviewApprovedIn').value;
            const approvedClockOut = document.getElementById('reviewApprovedOut').value;
            const reviewNotes = document.getElementById('reviewNotes').value;
            
            if (!approvedClockIn || !approvedClockOut) {
                showAlert('Please enter both clock in and clock out times', 'error');
                return;
            }
            
            // Convert to ISO strings
            const clockInISO = new Date(approvedClockIn).toISOString();
            const clockOutISO = new Date(approvedClockOut).toISOString();
            
            try {
                await apiCall(`/clock/amendments/${amendmentId}/review`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: status,
                        review_notes: reviewNotes || '',
                        approved_clock_in_time: status === 'approved' ? clockInISO : null,
                        approved_clock_out_time: status === 'approved' ? clockOutISO : null
                    })
                });
                showAlert(`Amendment ${status} successfully`);
                hideModal('amendmentReviewModal');
                await loadPendingAmendments();
            } catch (error) {
                showAlert('Error reviewing amendment: ' + error.message, 'error');
            }
        }
        
        // Admin edit timesheet entry functions
        function showAdminEditModal(entryId, clockInTime, clockOutTime, jobName) {
            document.getElementById('adminEditEntryId').value = entryId;
            document.getElementById('adminOriginalClockIn').textContent = clockInTime ? formatDateTime(new Date(clockInTime)) : 'Not set';
            document.getElementById('adminOriginalClockOut').textContent = clockOutTime ? formatDateTime(new Date(clockOutTime)) : 'Not set';
            
            // Set default values to current times
            if (clockInTime) {
                const clockIn = new Date(clockInTime);
                const localDateTime = new Date(clockIn.getTime() - clockIn.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('adminAmendedClockIn').value = localDateTime;
            }
            
            if (clockOutTime) {
                const clockOut = new Date(clockOutTime);
                const localDateTime = new Date(clockOut.getTime() - clockOut.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('adminAmendedClockOut').value = localDateTime;
            }
            
            // Clear reason
            document.getElementById('adminEditReason').value = '';
            
            const modal = document.getElementById('adminEditModal');
            if (modal) {
                modal.classList.add('show');
            }
        }
        
        // Hide admin edit modal (use class-based approach)
        function hideAdminEditModal() {
            const modal = document.getElementById('adminEditModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // Prevent form submission on Enter key
        document.getElementById('adminEditForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            submitAdminEdit();
        });
        
        async function submitAdminEdit() {
            const entryId = parseInt(document.getElementById('adminEditEntryId').value);
            const amendedClockIn = document.getElementById('adminAmendedClockIn').value;
            const amendedClockOut = document.getElementById('adminAmendedClockOut').value;
            const reason = document.getElementById('adminEditReason').value;
            
            if (!amendedClockIn || !amendedClockOut || !reason) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            // Convert local datetime to ISO string
            const clockInISO = new Date(amendedClockIn).toISOString();
            const clockOutISO = new Date(amendedClockOut).toISOString();
            
            try {
                const result = await apiCall('/clock/amendments/admin', {
                    method: 'POST',
                    body: JSON.stringify({
                        entry_id: entryId,
                        amended_clock_in_time: clockInISO,
                        amended_clock_out_time: clockOutISO,
                        reason: reason
                    })
                });
                
                if (result && result.success) {
                    console.log('Admin edit successful:', result);
                    const updatedEntry = result.entry;
                    showAlert('Timesheet entry updated successfully', 'success');
                    hideAdminEditModal();
                    
                    // Get user ID from the updated entry to refresh the correct daily breakdown
                    const editedUserId = updatedEntry?.user_id;
                    
                    // Close any expanded daily breakdowns to force refresh
                    document.querySelectorAll('[id^="daily-"]').forEach(row => {
                        if (row.style.display !== 'none' && row.style.display !== '') {
                            row.style.display = 'none';
                            const userId = row.id.replace('daily-', '');
                            const icon = document.getElementById(`icon-${userId}`);
                            if (icon) icon.classList.remove('expanded');
                            const content = document.getElementById(`daily-content-${userId}`);
                            if (content) {
                                content.innerHTML = '<div class="loading">Loading daily breakdown...</div>';
                            }
                        }
                    });
                    
                    // Reload the timesheet data - try both possible element IDs
                    const weekSelect = document.getElementById('payrollWeekSelect');
                    const weekStart = document.getElementById('payrollWeekStart');
                    const weekValue = weekSelect?.value || weekStart?.value;
                    
                    if (weekValue) {
                        // Update the select if it exists
                        if (weekSelect) {
                            weekSelect.value = weekValue;
                        }
                        // Reload payroll summary which will refresh all data
                        await loadPayrollSummary();
                        
                        // If the edited user's breakdown was open, refresh it
                        if (editedUserId) {
                            const dailyRow = document.getElementById(`daily-${editedUserId}`);
                            if (dailyRow && dailyRow.style.display !== 'none') {
                                // Force refresh by closing and reopening
                                dailyRow.style.display = 'none';
                                const icon = document.getElementById(`icon-${editedUserId}`);
                                if (icon) icon.classList.remove('expanded');
                                // Reopen after a short delay
                                setTimeout(() => {
                                    toggleDailyBreakdown(editedUserId, weekValue);
                                }, 500);
                            }
                        }
                    } else {
                        // If no week selected, try to reload active clock-ins
                        try {
                            await loadActiveClockIns();
                        } catch (e) {
                            console.log('Could not reload active clock-ins:', e);
                        }
                        // Force a page refresh to show updated data
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    console.error('Admin edit failed:', result);
                    showAlert('Error updating timesheet entry: ' + (result?.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Admin edit error:', error);
                showAlert('Error updating timesheet entry: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        // Payroll functions
        async function cleanupOldEntries() {
            const btn = document.getElementById('cleanupBtn');
            const resultDiv = document.getElementById('cleanupResult');
            
            if (!confirm('This will automatically clock out all old entries that were never clocked out. This is a one-time cleanup. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Cleaning up...';
            resultDiv.innerHTML = '<p style="color: #666;">Processing cleanup...</p>';
            
            try {
                const data = await apiCall('/clock/cleanup-old-entries', {
                    method: 'GET'
                });
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
                            <strong>Cleanup Complete!</strong><br>
                            ${data.count} entries were updated<br>
                            ${data.errors > 0 ? `<span style="color: #856404;">${data.errors} errors occurred</span>` : 'No errors'}
                        </div>
                    `;
                    showAlert(data.message || 'Cleanup completed successfully', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                            <strong>Error:</strong> ${data.error || 'Unknown error'}
                        </div>
                    `;
                    showAlert(data.error || 'Cleanup failed', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                        <strong>Error:</strong> ${error.message || 'Failed to cleanup old entries'}
                    </div>
                `;
                showAlert('Failed to cleanup old entries: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cleanup Old Unclosed Entries';
            }
        }
        
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            monday.setHours(0, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }
        
        // Round hours down to 15-minute intervals (0.25 hour increments)
        function roundToQuarterHour(hours) {
            if (!hours || isNaN(hours)) return 0;
            // Always round down to nearest 0.25 (15 minutes)
            return Math.floor(parseFloat(hours) * 4) / 4;
        }
        
        // Format hours as hours and minutes (e.g., "5hrs 30mins")
        function formatHours(hours) {
            if (!hours || isNaN(hours) || hours === 0) {
                return '0hrs 0mins';
            }
            const rounded = roundToQuarterHour(hours);
            const wholeHours = Math.floor(rounded);
            const minutes = Math.round((rounded - wholeHours) * 60);
            
            return `${wholeHours}hrs ${minutes}mins`;
        }
        
        async function loadPayrollSummary() {
            const weekStart = document.getElementById('payrollWeekSelect').value || getCurrentWeekStart();
            const selectedStaffId = document.getElementById('payrollStaffSelect')?.value || '';
            
            if (!weekStart) {
                showAlert('Please select a week', 'error');
                return;
            }
            
            try {
                const data = await apiCall(`/clock/payroll/${weekStart}`);
                let summary = data.summary || [];
                const summaryEl = document.getElementById('payrollSummary');
                const exportBtn = document.getElementById('exportBtn');
                const staffSelect = document.getElementById('payrollStaffSelect');
                
                // Populate staff dropdown if not already populated
                if (staffSelect && (staffSelect.options.length === 1 || !staffSelect.options[0].value)) {
                    staffSelect.innerHTML = '<option value="">All Staff</option>';
                    summary.forEach(row => {
                        if (row.user_id && row.username) {
                            const option = document.createElement('option');
                            option.value = row.user_id;
                            option.textContent = row.username;
                            staffSelect.appendChild(option);
                        }
                    });
                    // Restore selected value if it was set
                    if (selectedStaffId) {
                        staffSelect.value = selectedStaffId;
                    }
                }
                
                // Filter by selected staff if a staff member is selected
                if (selectedStaffId) {
                    summary = summary.filter(row => row.user_id == selectedStaffId);
                }
                
                if (summary.length === 0) {
                    summaryEl.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No timesheet data for this week' + (selectedStaffId ? ' for selected staff member' : '') + '</p>';
                    exportBtn.style.display = 'none';
                    return;
                }
                
                exportBtn.style.display = 'inline-block';
                exportBtn.onclick = () => exportPayroll(weekStart);
                
                // Calculate totals (with rounding to 15-minute intervals)
                let totalRegular = 0, totalOvertime = 0, totalWeekend = 0, totalOvernight = 0, totalHours = 0;
                summary.forEach(row => {
                    totalRegular += roundToQuarterHour(parseFloat(row.total_regular_hours || 0));
                    totalOvertime += roundToQuarterHour(parseFloat(row.total_overtime_hours || 0));
                    totalWeekend += roundToQuarterHour(parseFloat(row.total_weekend_hours || 0));
                    totalOvernight += roundToQuarterHour(parseFloat(row.total_overnight_hours || 0));
                    totalHours += roundToQuarterHour(parseFloat(row.total_hours || 0));
                });
                
                summaryEl.innerHTML = `
                    <table class="table" style="font-size: 14px;">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>Staff Name</th>
                                <th>Regular Hours</th>
                                <th>Overtime (1.25x)</th>
                                <th>Weekend (1.5x)</th>
                                <th>Overnight (1.25x)</th>
                                <th>Total Hours</th>
                                <th>Days Worked</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summary.map(row => {
                                const regular = roundToQuarterHour(parseFloat(row.total_regular_hours || 0));
                                const overtime = roundToQuarterHour(parseFloat(row.total_overtime_hours || 0));
                                const weekend = roundToQuarterHour(parseFloat(row.total_weekend_hours || 0));
                                const overnight = roundToQuarterHour(parseFloat(row.total_overnight_hours || 0));
                                const total = roundToQuarterHour(parseFloat(row.total_hours || 0));
                                return `
                                <tr class="payroll-row" data-user-id="${row.user_id}" style="cursor: pointer;" onclick="toggleDailyBreakdown(${row.user_id}, '${weekStart}')">
                                    <td style="text-align: center;">
                                        <span class="expand-icon" id="icon-${row.user_id}">‚ñ∂</span>
                                    </td>
                                    <td><strong>${escapeHtml(row.username || 'Unknown')}</strong></td>
                                    <td>${formatHours(regular)}</td>
                                    <td>${formatHours(overtime)}</td>
                                    <td>${formatHours(weekend)}</td>
                                    <td>${formatHours(overnight)}</td>
                                    <td><strong>${formatHours(total)}</strong></td>
                                    <td>${row.days_worked || 0}</td>
                                </tr>
                                <tr id="daily-${row.user_id}" style="display: none;">
                                    <td colspan="8" style="padding: 0; background: #f8f9fa;">
                                        <div id="daily-content-${row.user_id}" style="padding: 15px;">
                                            <div class="loading">Loading daily breakdown...</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                            ${summary.length > 1 || !selectedStaffId ? `
                            <tr style="background: #f8f9fa; font-weight: 700;">
                                <td></td>
                                <td><strong>TOTALS${selectedStaffId ? ' (Selected Staff)' : ''}</strong></td>
                                <td>${formatHours(totalRegular)}</td>
                                <td>${formatHours(totalOvertime)}</td>
                                <td>${formatHours(totalWeekend)}</td>
                                <td>${formatHours(totalOvernight)}</td>
                                <td><strong>${formatHours(totalHours)}</strong></td>
                                <td>-</td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    <style>
                        .payroll-row:hover {
                            background-color: #f0f0f0 !important;
                        }
                        .expand-icon {
                            display: inline-block;
                            transition: transform 0.2s;
                            font-size: 10px;
                            color: #666;
                        }
                        .expand-icon.expanded {
                            transform: rotate(90deg);
                        }
                        .daily-breakdown {
                            margin-top: 10px;
                        }
                        .daily-breakdown table {
                            width: 100%;
                            font-size: 13px;
                            background: white;
                            border-radius: 4px;
                        }
                        .daily-breakdown th {
                            background: #4CBB17;
                            color: white;
                            padding: 8px;
                            text-align: left;
                            font-weight: 600;
                        }
                        .daily-breakdown td {
                            padding: 8px;
                            border-bottom: 1px solid #eee;
                        }
                        .daily-breakdown tr:last-child td {
                            border-bottom: none;
                        }
                    </style>
                `;
            } catch (error) {
                console.error('Error loading payroll summary:', error);
                document.getElementById('payrollSummary').innerHTML = 
                    `<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading payroll summary: ${error.message || 'Unknown error'}</p>`;
                showAlert('Error loading payroll summary: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function toggleDailyBreakdown(userId, weekStart) {
            const row = document.getElementById(`daily-${userId}`);
            const icon = document.getElementById(`icon-${userId}`);
            const content = document.getElementById(`daily-content-${userId}`);
            
            if (!row || !content) return;
            
            if (row.style.display === 'none') {
                // Expand
                row.style.display = 'table-row';
                if (icon) icon.classList.add('expanded');
                
                // Load daily breakdown if not already loaded
                if (content.innerHTML.includes('Loading daily breakdown')) {
                    try {
                        const data = await apiCall(`/clock/payroll/${weekStart}/user/${userId}/daily`);
                        const dailyBreakdown = data.dailyBreakdown || [];
                        
                        if (dailyBreakdown.length === 0) {
                            content.innerHTML = '<p style="text-align: center; padding: 10px; color: #666;">No daily entries found</p>';
                            return;
                        }
                        
                        // Group entries by date to show daily totals
                        const entriesByDate = {};
                        dailyBreakdown.forEach(day => {
                            const date = day.entry_date;
                            if (!entriesByDate[date]) {
                                entriesByDate[date] = {
                                    entries: [],
                                    daily_notes: day.daily_notes || null
                                };
                            }
                            entriesByDate[date].entries.push(day);
                            // Use the first entry's daily_notes (they should all be the same for the same date)
                            if (!entriesByDate[date].daily_notes && day.daily_notes) {
                                entriesByDate[date].daily_notes = day.daily_notes;
                            }
                        });
                        
                        let dailyHtml = '<div class="daily-breakdown"><table><thead><tr><th>Date</th><th>Job</th><th>Clock In</th><th>Clock Out</th><th>Location</th><th>Regular</th><th>Overtime</th><th>Weekend</th><th>Overnight</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
                        
                        // Sort dates
                        const sortedDates = Object.keys(entriesByDate).sort();
                        
                        sortedDates.forEach(date => {
                            const dayData = entriesByDate[date];
                            const dayEntries = dayData.entries;
                            const dateObj = new Date(date);
                            const dateStr = dateObj.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
                            
                            // Calculate daily totals
                            let dayRegular = 0, dayOvertime = 0, dayWeekend = 0, dayOvernight = 0, dayTotal = 0;
                            
                            dayEntries.forEach(day => {
                                dayRegular += roundToQuarterHour(parseFloat(day.regular_hours || 0));
                                dayOvertime += roundToQuarterHour(parseFloat(day.overtime_hours || 0));
                                dayWeekend += roundToQuarterHour(parseFloat(day.weekend_hours || 0));
                                dayOvernight += roundToQuarterHour(parseFloat(day.overnight_hours || 0));
                                dayTotal += roundToQuarterHour(parseFloat(day.total_hours || 0));
                            });
                            
                            // Show each entry
                            dayEntries.forEach((day, idx) => {
                                const clockIn = day.clock_in_time ? formatDateTime(new Date(day.clock_in_time)) : '-';
                                const clockOut = day.clock_out_time ? formatDateTime(new Date(day.clock_out_time)) : '-';
                                const hasInLocation = day.clock_in_latitude && day.clock_in_longitude;
                                const hasOutLocation = day.clock_out_latitude && day.clock_out_longitude;
                                const regular = roundToQuarterHour(parseFloat(day.regular_hours || 0));
                                const overtime = roundToQuarterHour(parseFloat(day.overtime_hours || 0));
                                const weekend = roundToQuarterHour(parseFloat(day.weekend_hours || 0));
                                const overnight = roundToQuarterHour(parseFloat(day.overnight_hours || 0));
                                const total = roundToQuarterHour(parseFloat(day.total_hours || 0));
                                // Check if edited by admin (more robust check)
                                const isEditedByAdmin = day.edited_by_admin_id != null && day.edited_by_admin_id !== undefined && 
                                                       day.edited_by_admin_at != null && day.edited_by_admin_at !== undefined;
                                
                                // Debug logging (only log if it should be edited by admin but isn't detected)
                                if (day.id && (day.edited_by_admin_id || day.edited_by_admin_at) && !isEditedByAdmin) {
                                    console.log('Admin edit fields present but not detected:', {
                                        id: day.id,
                                        edited_by_admin_id: day.edited_by_admin_id,
                                        edited_by_admin_at: day.edited_by_admin_at,
                                        type_id: typeof day.edited_by_admin_id,
                                        type_at: typeof day.edited_by_admin_at
                                    });
                                }
                                
                                let locationHtml = '<small style="color: #666;">';
                                if (hasInLocation || hasOutLocation) {
                                    locationHtml += '<div style="margin-bottom: 4px;">';
                                    if (hasInLocation) {
                                        locationHtml += `<button onclick="openMap(${day.clock_in_latitude}, ${day.clock_in_longitude})" class="btn btn-sm" style="padding: 2px 6px; font-size: 10px; background: #4CBB17; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 4px;" title="View clock-in location">In üó∫Ô∏è</button>`;
                                    }
                                    if (hasOutLocation) {
                                        locationHtml += `<button onclick="openMap(${day.clock_out_latitude}, ${day.clock_out_longitude})" class="btn btn-sm" style="padding: 2px 6px; font-size: 10px; background: #808080; color: white; border: none; border-radius: 3px; cursor: pointer;" title="View clock-out location">Out üó∫Ô∏è</button>`;
                                    }
                                    locationHtml += '</div>';
                                } else {
                                    locationHtml += 'N/A';
                                }
                                locationHtml += '</small>';
                                
                                const editedByAdminStamp = isEditedByAdmin 
                                    ? `<br><small style="color: #856404; font-weight: 600;">‚ö†Ô∏è Edited by Admin ${day.edited_by_admin_at ? `on ${formatDateTime(new Date(day.edited_by_admin_at))}` : ''}</small>`
                                    : '';
                                
                                dailyHtml += `
                                    <tr ${idx === 0 ? `style="border-top: 2px solid #4CBB17;"` : ''}>
                                        <td ${idx === 0 ? `rowspan="${dayEntries.length}" style="vertical-align: top; font-weight: 600;"` : ''}>${idx === 0 ? dateStr : ''}</td>
                                        <td>${escapeHtml(day.job_name || '-')}</td>
                                        <td><small>${clockIn}${editedByAdminStamp}</small></td>
                                        <td><small>${clockOut}</small></td>
                                        <td>${locationHtml}</td>
                                        <td>${formatHours(regular)}</td>
                                        <td>${formatHours(overtime)}</td>
                                        <td>${formatHours(weekend)}</td>
                                        <td>${formatHours(overnight)}</td>
                                        <td>${formatHours(total)}</td>
                                        <td>
                                            <button onclick="showAdminEditModal(${day.id}, '${day.clock_in_time || ''}', '${day.clock_out_time || ''}', '${escapeHtml(day.job_name || '')}')" 
                                                    class="btn btn-primary btn-sm" 
                                                    style="padding: 4px 8px; font-size: 11px; margin-right: 4px;"
                                                    title="Edit this entry">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button onclick="deleteTimesheetEntry(${day.id}, ${userId}, '${weekStart}')" 
                                                    class="btn btn-danger btn-sm" 
                                                    style="padding: 4px 8px; font-size: 11px;"
                                                    title="Delete this entry">
                                                üóëÔ∏è Delete
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Add daily total row if multiple entries
                            if (dayEntries.length > 1) {
                                dailyHtml += `
                                    <tr style="background: #f0f0f0; font-weight: 600;">
                                        <td colspan="5" style="text-align: right;">Daily Total:</td>
                                        <td>${formatHours(dayRegular)}</td>
                                        <td>${formatHours(dayOvertime)}</td>
                                        <td>${formatHours(dayWeekend)}</td>
                                        <td>${formatHours(dayOvernight)}</td>
                                        <td><strong>${formatHours(dayTotal)}</strong></td>
                                        <td></td>
                                    </tr>
                                `;
                            }
                            
                            // Add activities section for this day
                            if (dayData.daily_notes) {
                                let activities = [];
                                try {
                                    const parsed = JSON.parse(dayData.daily_notes);
                                    if (Array.isArray(parsed)) {
                                        activities = parsed;
                                    } else if (typeof parsed === 'string' && parsed.trim()) {
                                        activities = [{ timestamp: new Date().toISOString(), note: parsed }];
                                    }
                                } catch (e) {
                                    if (dayData.daily_notes.trim()) {
                                        activities = [{ timestamp: new Date().toISOString(), note: dayData.daily_notes }];
                                    }
                                }
                                
                                if (activities.length > 0) {
                                    const activitiesHtml = activities.map(activity => {
                                        const time = new Date(activity.timestamp);
                                        const timeStr = time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                                        return `
                                            <div style="background: #f8f9fa; padding: 8px; margin: 4px 0; border-radius: 4px; border-left: 3px solid #4CBB17; font-size: 12px;">
                                                <div style="color: #666; margin-bottom: 2px;">${timeStr}</div>
                                                <div style="color: #2c3e50;">${escapeHtml(activity.note || '')}</div>
                                            </div>
                                        `;
                                    }).join('');
                                    
                                    dailyHtml += `
                                        <tr>
                                            <td colspan="11" style="padding: 10px; background: #f8f9fa; border-top: 2px solid #ddd;">
                                                <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">Daily Activities (${activities.length}):</div>
                                                <div style="max-height: 200px; overflow-y: auto;">
                                                    ${activitiesHtml}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }
                            }
                        });
                        
                        dailyHtml += '</tbody></table></div>';
                        content.innerHTML = dailyHtml;
                    } catch (error) {
                        console.error('Error loading daily breakdown:', error);
                        content.innerHTML = `<p style="text-align: center; padding: 10px; color: #e74c3c;">Error loading daily breakdown: ${error.message || 'Unknown error'}</p>`;
                    }
                }
            } else {
                // Collapse
                row.style.display = 'none';
                if (icon) icon.classList.remove('expanded');
            }
        }
        
        // Open map with coordinates
        function openMap(latitude, longitude) {
            if (!latitude || !longitude) {
                showAlert('Location coordinates not available', 'error');
                return;
            }
            // Open in Google Maps (can be changed to OpenStreetMap or other providers)
            const url = `https://www.google.com/maps?q=${latitude},${longitude}`;
            window.open(url, '_blank');
        }
        
        // Delete timesheet entry
        async function deleteTimesheetEntry(entryId, userId, weekStart) {
            if (!confirm('Are you sure you want to delete this timesheet entry? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await apiCall(`/clock/entries/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    showAlert('Timesheet entry deleted successfully', 'success');
                    // Reload the daily breakdown
                    const row = document.getElementById(`daily-${userId}`);
                    if (row && row.style.display !== 'none') {
                        // Clear content and reload
                        const content = document.getElementById(`daily-content-${userId}`);
                        if (content) {
                            content.innerHTML = '<div class="loading">Loading daily breakdown...</div>';
                        }
                        await toggleDailyBreakdown(userId, weekStart);
                    }
                    // Reload payroll summary
                    await loadPayrollSummary();
                } else {
                    throw new Error(response?.error || 'Failed to delete entry');
                }
            } catch (error) {
                console.error('Error deleting timesheet entry:', error);
                showAlert('Failed to delete timesheet entry: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        async function exportPayroll(weekStart = null) {
            if (!weekStart) {
                weekStart = document.getElementById('payrollWeekSelect').value || getCurrentWeekStart();
            }
            
            if (!weekStart) {
                showAlert('Please select a week', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/clock/payroll/${weekStart}/export`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `payroll-${weekStart}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Payroll exported successfully');
            } catch (error) {
                showAlert('Error exporting payroll: ' + error.message, 'error');
            }
        }
        
        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
        
        init();
    </script>
</body>
</html>

