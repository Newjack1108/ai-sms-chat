<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Management - Production System</title>
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Holiday Management</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('entitlements')">Entitlements</button>
            <button class="tab-btn" onclick="showTab('requests')">Pending Requests</button>
            <button class="tab-btn" onclick="showTab('shutdown')">Shutdown Periods</button>
        </div>
        
        <!-- Entitlements Tab -->
        <div id="entitlements-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>Holiday Entitlements</h2>
                    <button onclick="showAddEntitlementModal()" class="btn btn-primary">Add/Update Entitlement</button>
                </div>
                <div id="entitlementsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Requests Tab -->
        <div id="requests-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Pending Holiday Requests</h2>
                    <button onclick="loadPendingRequests()" class="btn btn-secondary btn-sm">Refresh</button>
                </div>
                <div id="pendingRequestsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Shutdown Periods Tab -->
        <div id="shutdown-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Company Shutdown Periods</h2>
                    <button onclick="showAddShutdownModal()" class="btn btn-primary">Add Shutdown Period</button>
                </div>
                <div id="shutdownPeriodsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Update Entitlement Modal -->
    <div id="entitlementModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('entitlementModal')">&times;</span>
            <h2 id="entitlementModalTitle">Add Holiday Entitlement</h2>
            <form id="entitlementForm" onsubmit="saveEntitlement(event)">
                <div class="form-group">
                    <label>User:</label>
                    <select id="entitlementUserId" class="form-select" required>
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year:</label>
                    <input type="number" id="entitlementYear" class="form-input" min="2020" max="2100" required>
                </div>
                <div class="form-group">
                    <label>Total Days:</label>
                    <input type="number" id="entitlementTotalDays" class="form-input" min="0" step="0.5" required>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('entitlementModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Shutdown Period Modal -->
    <div id="shutdownModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shutdownModal')">&times;</span>
            <h2>Add Company Shutdown Period</h2>
            <form id="shutdownForm" onsubmit="saveShutdownPeriod(event)">
                <div class="form-group">
                    <label>Year:</label>
                    <input type="number" id="shutdownYear" class="form-input" min="2020" max="2100" required>
                </div>
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="shutdownStartDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" id="shutdownEndDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="shutdownDescription" class="form-input" placeholder="e.g., Christmas Shutdown 2024">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('shutdownModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <script>
        let currentYear = new Date().getFullYear();
        let users = [];
        
        async function init() {
            await checkAuth();
            await loadUsers();
            await loadEntitlements();
            await loadPendingRequests();
            await loadShutdownPeriods();
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            event.target.classList.add('active');
        }
        
        async function loadUsers() {
            try {
                const response = await apiCall('/production/api/users');
                if (response.success) {
                    users = response.users;
                    const select = document.getElementById('entitlementUserId');
                    select.innerHTML = '<option value="">Select User</option>';
                    response.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadEntitlements() {
            try {
                const response = await apiCall('/production/api/holidays/entitlements');
                if (response.success) {
                    displayEntitlements(response.entitlements);
                }
            } catch (error) {
                document.getElementById('entitlementsList').innerHTML = '<div class="error">Error loading entitlements</div>';
            }
        }
        
        function displayEntitlements(entitlements) {
            const container = document.getElementById('entitlementsList');
            
            // Group by year
            const byYear = {};
            entitlements.forEach(e => {
                if (!byYear[e.year]) byYear[e.year] = [];
                byYear[e.year].push(e);
            });
            
            let html = '<table class="data-table"><thead><tr><th>Year</th><th>User</th><th>Total Days</th><th>Days Used</th><th>Days Remaining</th><th>Actions</th></tr></thead><tbody>';
            
            Object.keys(byYear).sort((a, b) => b - a).forEach(year => {
                byYear[year].forEach(ent => {
                    html += `<tr>
                        <td>${year}</td>
                        <td>${ent.username || 'Unknown'}</td>
                        <td>${ent.total_days}</td>
                        <td>${parseFloat(ent.days_used || 0).toFixed(1)}</td>
                        <td><strong>${parseFloat(ent.days_remaining || (ent.total_days - ent.days_used)).toFixed(1)}</strong></td>
                        <td><button onclick="editEntitlement(${ent.user_id}, ${ent.year}, ${ent.total_days})" class="btn btn-sm btn-secondary">Edit</button></td>
                    </tr>`;
                });
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function showAddEntitlementModal() {
            document.getElementById('entitlementModalTitle').textContent = 'Add Holiday Entitlement';
            document.getElementById('entitlementForm').reset();
            document.getElementById('entitlementYear').value = currentYear;
            document.getElementById('entitlementModal').style.display = 'block';
        }
        
        function editEntitlement(userId, year, totalDays) {
            document.getElementById('entitlementModalTitle').textContent = 'Update Holiday Entitlement';
            document.getElementById('entitlementUserId').value = userId;
            document.getElementById('entitlementYear').value = year;
            document.getElementById('entitlementTotalDays').value = totalDays;
            document.getElementById('entitlementUserId').disabled = true;
            document.getElementById('entitlementYear').disabled = true;
            document.getElementById('entitlementModal').style.display = 'block';
        }
        
        async function saveEntitlement(event) {
            event.preventDefault();
            const userId = parseInt(document.getElementById('entitlementUserId').value);
            const year = parseInt(document.getElementById('entitlementYear').value);
            const totalDays = parseFloat(document.getElementById('entitlementTotalDays').value);
            
            try {
                const response = await apiCall('/production/api/holidays/entitlements', 'POST', {
                    user_id: userId,
                    year: year,
                    total_days: totalDays
                });
                
                if (response.success) {
                    closeModal('entitlementModal');
                    await loadEntitlements();
                    alert('Entitlement saved successfully');
                }
            } catch (error) {
                alert('Error saving entitlement: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function loadPendingRequests() {
            try {
                const response = await apiCall('/production/api/holidays/requests/pending');
                if (response.success) {
                    displayPendingRequests(response.requests);
                }
            } catch (error) {
                document.getElementById('pendingRequestsList').innerHTML = '<div class="error">Error loading requests</div>';
            }
        }
        
        function displayPendingRequests(requests) {
            const container = document.getElementById('pendingRequestsList');
            
            if (requests.length === 0) {
                container.innerHTML = '<div class="info">No pending requests</div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>User</th><th>Start Date</th><th>End Date</th><th>Days Requested</th><th>Requested</th><th>Actions</th></tr></thead><tbody>';
            
            requests.forEach(req => {
                const startDate = new Date(req.start_date).toLocaleDateString();
                const endDate = new Date(req.end_date).toLocaleDateString();
                const requestedAt = new Date(req.requested_at).toLocaleDateString();
                
                html += `<tr>
                    <td>${req.user_name || 'Unknown'}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${parseFloat(req.days_requested).toFixed(1)}</strong> weekdays</td>
                    <td>${requestedAt}</td>
                    <td>
                        <button onclick="approveRequest(${req.id})" class="btn btn-sm btn-success">Approve</button>
                        <button onclick="rejectRequest(${req.id})" class="btn btn-sm btn-danger">Reject</button>
                        <button onclick="viewRequestDetails(${req.id})" class="btn btn-sm btn-secondary">Details</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function approveRequest(requestId) {
            if (!confirm('Approve this holiday request?')) return;
            
            try {
                const response = await apiCall(`/production/api/holidays/requests/${requestId}/approve`, 'PUT', {});
                if (response.success) {
                    await loadPendingRequests();
                    alert('Request approved successfully');
                }
            } catch (error) {
                alert('Error approving request: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function rejectRequest(requestId) {
            const reviewNotes = prompt('Enter rejection reason (optional):');
            if (reviewNotes === null) return;
            
            try {
                const response = await apiCall(`/production/api/holidays/requests/${requestId}/reject`, 'PUT', {
                    review_notes: reviewNotes || null
                });
                if (response.success) {
                    await loadPendingRequests();
                    alert('Request rejected');
                }
            } catch (error) {
                alert('Error rejecting request: ' + (error.message || 'Unknown error'));
            }
        }
        
        function viewRequestDetails(requestId) {
            // Could open a modal with more details
            alert('Request details view coming soon');
        }
        
        async function loadShutdownPeriods() {
            try {
                const response = await apiCall('/production/api/holidays/shutdown-periods');
                if (response.success) {
                    displayShutdownPeriods(response.periods);
                }
            } catch (error) {
                document.getElementById('shutdownPeriodsList').innerHTML = '<div class="error">Error loading shutdown periods</div>';
            }
        }
        
        function displayShutdownPeriods(periods) {
            const container = document.getElementById('shutdownPeriodsList');
            
            if (periods.length === 0) {
                container.innerHTML = '<div class="info">No shutdown periods configured</div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Year</th><th>Start Date</th><th>End Date</th><th>Weekdays</th><th>Description</th><th>Created By</th><th>Actions</th></tr></thead><tbody>';
            
            periods.forEach(period => {
                const startDate = new Date(period.start_date).toLocaleDateString();
                const endDate = new Date(period.end_date).toLocaleDateString();
                const weekdays = ProductionDatabase ? ProductionDatabase.calculateWorkingDays(period.start_date, period.end_date) : 'N/A';
                
                html += `<tr>
                    <td>${period.year}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${weekdays}</strong> days</td>
                    <td>${period.description || '-'}</td>
                    <td>${period.created_by_name || 'Unknown'}</td>
                    <td>
                        <button onclick="applyShutdown(${period.id})" class="btn btn-sm btn-primary">Apply to All Users</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function showAddShutdownModal() {
            document.getElementById('shutdownForm').reset();
            document.getElementById('shutdownYear').value = currentYear;
            document.getElementById('shutdownModal').style.display = 'block';
        }
        
        async function saveShutdownPeriod(event) {
            event.preventDefault();
            const year = parseInt(document.getElementById('shutdownYear').value);
            const startDate = document.getElementById('shutdownStartDate').value;
            const endDate = document.getElementById('shutdownEndDate').value;
            const description = document.getElementById('shutdownDescription').value;
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }
            
            try {
                const response = await apiCall('/production/api/holidays/shutdown-periods', 'POST', {
                    year: year,
                    start_date: startDate,
                    end_date: endDate,
                    description: description || null
                });
                
                if (response.success) {
                    closeModal('shutdownModal');
                    await loadShutdownPeriods();
                    alert('Shutdown period created successfully');
                }
            } catch (error) {
                alert('Error creating shutdown period: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function applyShutdown(periodId) {
            if (!confirm('Apply this shutdown period to all user entitlements? This will deduct weekdays from everyone\'s entitlement for this year.')) return;
            
            try {
                const response = await apiCall(`/production/api/holidays/shutdown-periods/${periodId}/apply`, 'POST', {});
                if (response.success) {
                    alert(response.message || 'Shutdown applied successfully');
                    await loadEntitlements();
                }
            } catch (error) {
                alert('Error applying shutdown: ' + (error.message || 'Unknown error'));
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset form and re-enable fields
            const form = document.getElementById(modalId.replace('Modal', 'Form'));
            if (form) {
                form.reset();
                form.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false;
                });
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }
        
        init();
    </script>
    <script>
        // Helper function to calculate weekdays (client-side version)
        function calculateWorkingDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let count = 0;
            const current = new Date(start);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }
        
        // Use this for shutdown periods display
        const ProductionDatabase = { calculateWorkingDays };
    </script>
</body>
</html>
