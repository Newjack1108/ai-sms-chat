<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Management - Production System</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="logo.png" alt="Company Logo" onerror="this.style.display='none'">
            <h1>Holiday Management</h1>
        </div>
        <div class="navbar-right">
            <span class="navbar-user" id="userInfo"></span>
            <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
            <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
        </div>
    </nav>
    
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('entitlements')">Entitlements</button>
            <button class="tab-btn" onclick="showTab('requests')">Pending Requests</button>
            <button class="tab-btn" onclick="showTab('all-requests')">All Requests</button>
            <button class="tab-btn" onclick="showTab('calendar')">Calendar</button>
            <button class="tab-btn" onclick="showTab('shutdown')">Shutdown Periods</button>
        </div>
        
        <!-- Entitlements Tab -->
        <div id="entitlements-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2>Holiday Entitlements</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="yearFilter" onchange="filterByYear(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">All Years</option>
                        </select>
                        <button onclick="recalculateEntitlements()" class="btn btn-secondary">Recalculate Entitlements</button>
                        <button onclick="showAddHolidayModal()" class="btn btn-primary">Add Holiday for User</button>
                        <button onclick="showAddEntitlementModal()" class="btn btn-primary">Add/Update Entitlement</button>
                    </div>
                </div>
                <div id="entitlementsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Requests Tab -->
        <div id="requests-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Pending Holiday Requests</h2>
                    <button onclick="loadPendingRequests()" class="btn btn-secondary btn-sm">Refresh</button>
                </div>
                <div id="pendingRequestsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- All Requests Tab -->
        <div id="all-requests-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>All Holiday Requests</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="allRequestsYearFilter" onchange="filterAllRequestsByYear(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">All Years</option>
                        </select>
                        <select id="allRequestsStatusFilter" onchange="filterAllRequestsByStatus(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button onclick="loadAllRequests()" class="btn btn-secondary btn-sm">Refresh</button>
                    </div>
                </div>
                <div id="allRequestsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- Calendar Tab -->
        <div id="calendar-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Holiday Calendar</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="previousMonth()" class="btn btn-secondary btn-sm">← Previous</button>
                        <h3 id="calendarMonthYear" style="margin: 0; min-width: 200px; text-align: center;"></h3>
                        <button onclick="nextMonth()" class="btn btn-secondary btn-sm">Next →</button>
                        <button onclick="goToToday()" class="btn btn-primary btn-sm">Today</button>
                    </div>
                </div>
                <div id="calendarContainer">
                    <div class="loading">Loading calendar...</div>
                </div>
            </div>
        </div>
        
        <!-- Shutdown Periods Tab -->
        <div id="shutdown-tab" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Company Shutdown Periods</h2>
                    <button onclick="showAddShutdownModal()" class="btn btn-primary">Add Shutdown Period</button>
                </div>
                <div id="shutdownPeriodsList">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Update Entitlement Modal -->
    <div id="entitlementModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('entitlementModal')">&times;</span>
            <h2 id="entitlementModalTitle">Add Holiday Entitlement</h2>
            <form id="entitlementForm" onsubmit="saveEntitlement(event)">
                <div class="form-group">
                    <label>User:</label>
                    <select id="entitlementUserId" class="form-select" required>
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year:</label>
                    <input type="number" id="entitlementYear" class="form-input" min="2020" max="2100" required>
                </div>
                <div class="form-group">
                    <label>Total Days:</label>
                    <input type="number" id="entitlementTotalDays" class="form-input" min="0" step="0.5" required>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('entitlementModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Holiday for User Modal -->
    <div id="addHolidayModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addHolidayModal')">&times;</span>
            <h2>Add Holiday for User</h2>
            <form id="addHolidayForm" onsubmit="saveHoliday(event)">
                <div class="form-group">
                    <label>User: *</label>
                    <select id="addHolidayUserId" class="form-select" required>
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date: *</label>
                    <input type="date" id="addHolidayStartDate" class="form-input" required onchange="updateAddHolidayDaysPreview()" oninput="updateAddHolidayDaysPreview()">
                </div>
                <div class="form-group">
                    <label>End Date: *</label>
                    <input type="date" id="addHolidayEndDate" class="form-input" required onchange="updateAddHolidayDaysPreview()" oninput="updateAddHolidayDaysPreview()">
                </div>
                <div class="form-group">
                    <label>Day Type: *</label>
                    <select id="addHolidayDayType" class="form-select" required onchange="updateAddHolidayDaysPreview()">
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (optional):</label>
                    <textarea id="addHolidayNotes" class="form-input" rows="3" placeholder="Optional notes about this holiday"></textarea>
                </div>
                <div class="form-group">
                    <div id="addHolidayDaysPreview" style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-top: 10px;">
                        <strong>Days: </strong><span id="addHolidayDaysCount">-</span> weekdays
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('addHolidayModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Holiday</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Shutdown Period Modal -->
    <div id="shutdownModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shutdownModal')">&times;</span>
            <h2 id="shutdownModalTitle">Add Company Shutdown Period</h2>
            <form id="shutdownForm" onsubmit="saveShutdownPeriod(event)">
                <input type="hidden" id="shutdownPeriodId" value="">
                <div class="form-group">
                    <label>Year:</label>
                    <input type="number" id="shutdownYear" class="form-input" min="2020" max="2100" required>
                </div>
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="shutdownStartDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" id="shutdownEndDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="shutdownDescription" class="form-input" placeholder="e.g., Christmas Shutdown 2024">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('shutdownModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="common.js"></script>
    <style>
        .holiday-calendar {
            width: 100%;
            margin-top: 20px;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }
        
        .calendar-header-cell {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border: 1px solid #dee2e6;
        }
        
        .calendar-day {
            min-height: 100px;
            background: white;
            padding: 5px;
            border: 1px solid #dee2e6;
            position: relative;
        }
        
        .calendar-day.other-month {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .calendar-day.today {
            background: #e7f3ff;
            border: 2px solid #007bff;
        }
        
        .calendar-day.weekend {
            background: #f8f9fa;
        }
        
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .holiday-item {
            font-size: 11px;
            padding: 2px 4px;
            margin: 2px 0;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .holiday-approved {
            background: #28a745;
            color: white;
        }
        
        .holiday-pending {
            background: #ffc107;
            color: #000;
        }
        
        .shutdown-period {
            background: #17a2b8;
            color: white;
            font-weight: bold;
            margin-top: 5px;
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .holiday-multiple {
            font-size: 10px;
            color: #666;
        }
    </style>
    <script>
        let currentYear = new Date().getFullYear();
        let users = [];
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let selectedYearFilter = null;
        let allEntitlements = [];
        
        async function init() {
            await checkAuth();
            await loadUsers();
            await loadEntitlements();
            await loadPendingRequests();
            await loadAllRequests();
            await loadShutdownPeriods();
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the button for this tab
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if ((tabName === 'entitlements' && btn.textContent.includes('Entitlements')) ||
                        (tabName === 'requests' && btn.textContent.includes('Pending')) ||
                        (tabName === 'all-requests' && btn.textContent.includes('All Requests')) ||
                        (tabName === 'calendar' && btn.textContent.includes('Calendar')) ||
                        (tabName === 'shutdown' && btn.textContent.includes('Shutdown'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Load calendar if calendar tab is selected
            if (tabName === 'calendar') {
                loadCalendar();
            }
            
            // Load all requests if all-requests tab is selected
            if (tabName === 'all-requests') {
                loadAllRequests();
            }
        }
        
        async function loadUsers() {
            try {
                const response = await apiCall('/users');
                if (response.success) {
                    users = response.users;
                    const select = document.getElementById('entitlementUserId');
                    select.innerHTML = '<option value="">Select User</option>';
                    response.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadEntitlements() {
            try {
                console.log('Loading entitlements...');
                const response = await apiCall('/holidays/entitlements');
                console.log('Entitlements response:', response);
                
                if (response && response.success) {
                    allEntitlements = response.entitlements || [];
                    console.log('Entitlements data:', allEntitlements);
                    
                    // Populate year filter dropdown
                    populateYearFilter(allEntitlements);
                    
                    // Apply current filter (or show all if no filter)
                    const filterSelect = document.getElementById('yearFilter');
                    filterByYear(filterSelect.value || '');
                } else {
                    console.error('Failed to load entitlements:', response);
                    document.getElementById('entitlementsList').innerHTML = '<div class="error">Error loading entitlements: ' + (response?.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error loading entitlements:', error);
                document.getElementById('entitlementsList').innerHTML = '<div class="error">Error loading entitlements: ' + (error.message || 'Unknown error') + '</div>';
            }
        }
        
        function populateYearFilter(entitlements) {
            const filterSelect = document.getElementById('yearFilter');
            const currentValue = filterSelect.value; // Preserve current selection
            
            // Extract unique years
            const years = [...new Set(entitlements.map(e => parseInt(e.year)))];
            years.sort((a, b) => b - a); // Sort descending (newest first)
            
            // Clear existing options except "All Years"
            filterSelect.innerHTML = '<option value="">All Years</option>';
            
            // Add year options
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                filterSelect.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (currentValue) {
                filterSelect.value = currentValue;
            }
        }
        
        function filterByYear(year) {
            selectedYearFilter = year === '' ? null : parseInt(year);
            
            let filteredEntitlements = allEntitlements;
            
            // Filter by year if a specific year is selected
            if (selectedYearFilter !== null) {
                filteredEntitlements = allEntitlements.filter(e => parseInt(e.year) === selectedYearFilter);
            }
            
            displayEntitlements(filteredEntitlements);
        }
        
        function displayEntitlements(entitlements) {
            const container = document.getElementById('entitlementsList');
            
            if (!entitlements || entitlements.length === 0) {
                const message = selectedYearFilter !== null 
                    ? `No entitlements found for year ${selectedYearFilter}.` 
                    : 'No entitlements found. Add an entitlement to get started.';
                container.innerHTML = `<div class="info">${message}</div>`;
                return;
            }
            
            // Group by year
            const byYear = {};
            entitlements.forEach(e => {
                if (!byYear[e.year]) byYear[e.year] = [];
                byYear[e.year].push(e);
            });
            
            let html = '<div class="table-wrapper"><table class="data-table"><thead><tr><th style="width: 80px;">Year</th><th style="min-width: 150px;">User</th><th style="width: 100px;">Total Days</th><th style="width: 100px;">Days Used</th><th style="width: 120px;">Days Remaining</th><th style="width: 100px;">Actions</th></tr></thead><tbody>';
            
            Object.keys(byYear).sort((a, b) => b - a).forEach(year => {
                byYear[year].forEach(ent => {
                    html += `<tr>
                        <td>${year}</td>
                        <td>${ent.username || 'Unknown'}</td>
                        <td>${ent.total_days}</td>
                        <td>${parseFloat(ent.days_used || 0).toFixed(1)}</td>
                        <td><strong>${parseFloat(ent.days_remaining !== undefined ? ent.days_remaining : (parseFloat(ent.total_days || 0) - parseFloat(ent.days_used || 0))).toFixed(1)}</strong></td>
                        <td><button onclick="editEntitlement(${ent.user_id}, ${ent.year}, ${ent.total_days})" class="btn btn-sm btn-secondary">Edit</button></td>
                    </tr>`;
                });
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function showAddHolidayModal() {
            document.getElementById('addHolidayForm').reset();
            document.getElementById('addHolidayDayType').value = 'full'; // Reset to full day
            document.getElementById('addHolidayDaysCount').textContent = '-';
            // Populate user dropdown if not already populated
            const select = document.getElementById('addHolidayUserId');
            if (select.options.length <= 1 && users.length > 0) {
                select.innerHTML = '<option value="">Select User</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    select.appendChild(option);
                });
            }
            document.getElementById('addHolidayModal').style.display = 'block';
        }
        
        function updateAddHolidayDaysPreview() {
            const startDate = document.getElementById('addHolidayStartDate').value;
            const endDate = document.getElementById('addHolidayEndDate').value;
            const dayType = document.getElementById('addHolidayDayType').value;
            const daysCountSpan = document.getElementById('addHolidayDaysCount');
            
            if (startDate && endDate) {
                if (new Date(startDate) > new Date(endDate)) {
                    daysCountSpan.textContent = 'Invalid (end date must be after start date)';
                    daysCountSpan.style.color = 'red';
                } else {
                    if (dayType === 'half' && startDate !== endDate) {
                        daysCountSpan.textContent = 'Invalid (half day requires same start and end date)';
                        daysCountSpan.style.color = 'red';
                        return;
                    }
                    const weekdays = calculateHolidayDaysRequested(startDate, endDate, dayType);
                    if (weekdays === 0 && dayType === 'half') {
                        daysCountSpan.textContent = 'Invalid (half day must be on a weekday)';
                        daysCountSpan.style.color = 'red';
                        return;
                    }
                    daysCountSpan.textContent = weekdays.toFixed(2);
                    daysCountSpan.style.color = '';
                }
            } else {
                daysCountSpan.textContent = '-';
                daysCountSpan.style.color = '';
            }
        }
        
        async function saveHoliday(event) {
            event.preventDefault();
            const userId = parseInt(document.getElementById('addHolidayUserId').value);
            const startDate = document.getElementById('addHolidayStartDate').value;
            const endDate = document.getElementById('addHolidayEndDate').value;
            const dayType = document.getElementById('addHolidayDayType').value;
            const notes = document.getElementById('addHolidayNotes').value;
            
            if (!userId || !startDate || !endDate || !dayType) {
                alert('Please fill in all required fields');
                return;
            }
            
            // For half day, start and end dates must be the same
            if (dayType === 'half' && startDate !== endDate) {
                alert('For half day, start date and end date must be the same');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const weekdays = calculateHolidayDaysRequested(startDate, endDate, dayType);
            if (weekdays <= 0) {
                alert('Date range must include at least one weekday (or a weekday for half day)');
                return;
            }
            
            try {
                const response = await apiCall('/holidays/add', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: userId,
                        start_date: startDate,
                        end_date: endDate,
                        day_type: dayType,
                        review_notes: notes || null
                    })
                });
                
                if (response && response.success) {
                    closeModal('addHolidayModal');
                    alert('Holiday added successfully');
                    // Refresh entitlements and pending requests
                    setTimeout(async () => {
                        await loadEntitlements();
                        await loadPendingRequests();
                    }, 200);
                } else {
                    alert('Error adding holiday: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding holiday:', error);
                alert('Error adding holiday: ' + (error.message || 'Unknown error'));
            }
        }
        
        function showAddEntitlementModal() {
            document.getElementById('entitlementModalTitle').textContent = 'Add Holiday Entitlement';
            document.getElementById('entitlementForm').reset();
            document.getElementById('entitlementYear').value = currentYear;
            document.getElementById('entitlementModal').style.display = 'block';
        }
        
        function editEntitlement(userId, year, totalDays) {
            document.getElementById('entitlementModalTitle').textContent = 'Update Holiday Entitlement';
            document.getElementById('entitlementUserId').value = userId;
            document.getElementById('entitlementYear').value = year;
            document.getElementById('entitlementTotalDays').value = totalDays;
            document.getElementById('entitlementUserId').disabled = true;
            document.getElementById('entitlementYear').disabled = false;
            document.getElementById('entitlementModal').style.display = 'block';
        }
        
        async function recalculateEntitlements() {
            if (!confirm('Recalculate all holiday entitlements? This will recalculate days_used for all users based on approved holiday requests and active shutdown periods. This action may take a moment.')) {
                return;
            }
            
            try {
                console.log('Recalculating entitlements...');
                const response = await apiCall('/holidays/entitlements/recalculate', {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                
                console.log('Recalculate response:', response);
                
                if (response && response.success) {
                    alert(response.message || 'Entitlements recalculated successfully');
                    // Refresh the entitlements list
                    setTimeout(async () => {
                        await loadEntitlements();
                    }, 200);
                } else {
                    alert('Error recalculating entitlements: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error recalculating entitlements:', error);
                alert('Error recalculating entitlements: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function saveEntitlement(event) {
            event.preventDefault();
            const userId = parseInt(document.getElementById('entitlementUserId').value);
            const year = parseInt(document.getElementById('entitlementYear').value);
            const totalDays = parseFloat(document.getElementById('entitlementTotalDays').value);
            
            try {
                console.log('Saving entitlement:', { userId, year, totalDays });
                const response = await apiCall('/holidays/entitlements', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: userId,
                        year: year,
                        total_days: totalDays
                    })
                });
                
                console.log('Save entitlement response:', response);
                
                if (response && response.success) {
                    closeModal('entitlementModal');
                    alert('Entitlement saved successfully');
                    // Small delay to ensure database update is complete
                    setTimeout(async () => {
                        await loadEntitlements();
                    }, 200);
                } else {
                    alert('Error saving entitlement: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving entitlement: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function loadPendingRequests() {
            try {
                console.log('Loading pending requests...');
                const response = await apiCall('/holidays/requests/pending');
                console.log('Pending requests response:', response);
                
                if (response && response.success) {
                    const requests = response.requests || [];
                    console.log('Pending requests data:', requests);
                    displayPendingRequests(requests);
                } else {
                    console.error('Failed to load pending requests:', response);
                    document.getElementById('pendingRequestsList').innerHTML = '<div class="error">Error loading requests: ' + (response?.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
                document.getElementById('pendingRequestsList').innerHTML = '<div class="error">Error loading requests: ' + (error.message || 'Unknown error') + '</div>';
            }
        }
        
        function displayPendingRequests(requests) {
            const container = document.getElementById('pendingRequestsList');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="info">No pending requests</div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>User</th><th>Start Date</th><th>End Date</th><th>Days Requested</th><th>Requested</th><th>Actions</th></tr></thead><tbody>';
            
            requests.forEach(req => {
                const startDate = new Date(req.start_date).toLocaleDateString();
                const endDate = new Date(req.end_date).toLocaleDateString();
                const requestedAt = new Date(req.requested_at).toLocaleDateString();
                
                html += `<tr>
                    <td>${req.user_name || 'Unknown'}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${parseFloat(req.days_requested).toFixed(1)}</strong> weekdays</td>
                    <td>${requestedAt}</td>
                    <td>
                        <button onclick="approveRequest(${req.id})" class="btn btn-sm btn-success">Approve</button>
                        <button onclick="rejectRequest(${req.id})" class="btn btn-sm btn-danger">Reject</button>
                        <button onclick="viewRequestDetails(${req.id})" class="btn btn-sm btn-secondary">Details</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function approveRequest(requestId) {
            if (!confirm('Approve this holiday request?')) return;
            
            try {
                console.log('Approving request:', requestId);
                const response = await apiCall(`/holidays/requests/${requestId}/approve`, {
                    method: 'PUT',
                    body: JSON.stringify({})
                });
                console.log('Approve response:', response);
                
                if (response && response.success) {
                    alert('Request approved successfully');
                    setTimeout(async () => {
                        await loadPendingRequests();
                    }, 200);
                } else {
                    alert('Error approving request: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Error approving request: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function rejectRequest(requestId) {
            const reviewNotes = prompt('Enter rejection reason (optional):');
            if (reviewNotes === null) return;
            
            try {
                console.log('Rejecting request:', requestId);
                const response = await apiCall(`/holidays/requests/${requestId}/reject`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        review_notes: reviewNotes || null
                    })
                });
                console.log('Reject response:', response);
                
                if (response && response.success) {
                    alert('Request rejected');
                    setTimeout(async () => {
                        await loadPendingRequests();
                    }, 200);
                } else {
                    alert('Error rejecting request: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Error rejecting request: ' + (error.message || 'Unknown error'));
            }
        }
        
        function viewRequestDetails(requestId) {
            // Could open a modal with more details
            alert('Request details view coming soon');
        }
        
        let allRequestsData = [];
        let allRequestsYearFilter = null;
        let allRequestsStatusFilter = null;
        
        async function loadAllRequests() {
            try {
                console.log('Loading all requests...');
                const response = await apiCall('/holidays/requests');
                console.log('All requests response:', response);
                
                if (response && response.success) {
                    allRequestsData = response.requests || [];
                    console.log('All requests data:', allRequestsData);
                    
                    // Populate year filter
                    populateAllRequestsYearFilter(allRequestsData);
                    
                    // Apply current filters
                    filterAllRequests();
                } else {
                    console.error('Failed to load all requests:', response);
                    document.getElementById('allRequestsList').innerHTML = '<div class="error">Error loading requests: ' + (response?.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error loading all requests:', error);
                document.getElementById('allRequestsList').innerHTML = '<div class="error">Error loading requests: ' + (error.message || 'Unknown error') + '</div>';
            }
        }
        
        function populateAllRequestsYearFilter(requests) {
            const filterSelect = document.getElementById('allRequestsYearFilter');
            const currentValue = filterSelect.value;
            
            // Extract unique years
            const years = [...new Set(requests.map(r => new Date(r.start_date).getFullYear()))];
            years.sort((a, b) => b - a);
            
            filterSelect.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                filterSelect.appendChild(option);
            });
            
            if (currentValue) {
                filterSelect.value = currentValue;
            }
        }
        
        function filterAllRequestsByYear(year) {
            allRequestsYearFilter = year === '' ? null : parseInt(year);
            filterAllRequests();
        }
        
        function filterAllRequestsByStatus(status) {
            allRequestsStatusFilter = status === '' ? null : status;
            filterAllRequests();
        }
        
        function filterAllRequests() {
            let filtered = allRequestsData;
            
            if (allRequestsYearFilter !== null) {
                filtered = filtered.filter(r => new Date(r.start_date).getFullYear() === allRequestsYearFilter);
            }
            
            if (allRequestsStatusFilter !== null) {
                filtered = filtered.filter(r => r.status === allRequestsStatusFilter);
            }
            
            displayAllRequests(filtered);
        }
        
        function displayAllRequests(requests) {
            const container = document.getElementById('allRequestsList');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="info">No holiday requests found</div>';
                return;
            }
            
            // Sort by start date (most recent first)
            requests.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
            
            let html = '<div class="table-wrapper"><table class="data-table"><thead><tr><th>User</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Status</th><th>Requested</th><th>Reviewed</th><th>Actions</th></tr></thead><tbody>';
            
            requests.forEach(req => {
                const startDate = new Date(req.start_date).toLocaleDateString();
                const endDate = new Date(req.end_date).toLocaleDateString();
                const requestedAt = req.requested_at ? new Date(req.requested_at).toLocaleDateString() : '-';
                const reviewedAt = req.reviewed_at ? new Date(req.reviewed_at).toLocaleDateString() : '-';
                
                let statusClass = 'info';
                if (req.status === 'approved') statusClass = 'success';
                else if (req.status === 'rejected') statusClass = 'danger';
                else if (req.status === 'pending') statusClass = 'warning';
                else if (req.status === 'cancelled') statusClass = 'secondary';
                
                html += `<tr>
                    <td>${req.user_name || 'Unknown'}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${parseFloat(req.days_requested).toFixed(1)}</strong> days</td>
                    <td><span class="badge badge-${statusClass}">${req.status.toUpperCase()}</span></td>
                    <td>${requestedAt}</td>
                    <td>${reviewedAt}</td>
                    <td>
                        <button onclick="deleteHolidayRequest(${req.id})" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function deleteHolidayRequest(requestId) {
            if (!confirm('Are you sure you want to delete this holiday request? This action cannot be undone and will return the entitlement if the request was approved.')) {
                return;
            }
            
            try {
                console.log('Deleting holiday request:', requestId);
                const response = await apiCall(`/holidays/requests/${requestId}`, {
                    method: 'DELETE'
                });
                console.log('Delete response:', response);
                
                if (response && response.success) {
                    alert('Holiday request deleted successfully');
                    // Refresh all lists
                    setTimeout(async () => {
                        await loadAllRequests();
                        await loadPendingRequests();
                        await loadEntitlements();
                    }, 200);
                } else {
                    alert('Error deleting holiday request: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting holiday request:', error);
                alert('Error deleting holiday request: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function loadShutdownPeriods() {
            try {
                console.log('Loading shutdown periods...');
                const response = await apiCall('/holidays/shutdown-periods');
                console.log('Shutdown periods response:', response);
                
                if (response && response.success) {
                    const periods = response.periods || [];
                    console.log('Shutdown periods data:', periods);
                    displayShutdownPeriods(periods);
                } else {
                    console.error('Failed to load shutdown periods:', response);
                    document.getElementById('shutdownPeriodsList').innerHTML = '<div class="error">Error loading shutdown periods: ' + (response?.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('Error loading shutdown periods:', error);
                document.getElementById('shutdownPeriodsList').innerHTML = '<div class="error">Error loading shutdown periods: ' + (error.message || 'Unknown error') + '</div>';
            }
        }
        
        function displayShutdownPeriods(periods) {
            const container = document.getElementById('shutdownPeriodsList');
            
            if (periods.length === 0) {
                container.innerHTML = '<div class="info">No shutdown periods configured</div>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table class="data-table"><thead><tr><th style="width: 80px;">Year</th><th style="width: 110px;">Start Date</th><th style="width: 110px;">End Date</th><th style="width: 100px;">Weekdays</th><th style="min-width: 200px;">Description</th><th style="min-width: 120px;">Created By</th><th style="min-width: 150px;">Actions</th></tr></thead><tbody>';
            
            periods.forEach(period => {
                const startDate = new Date(period.start_date).toLocaleDateString();
                const endDate = new Date(period.end_date).toLocaleDateString();
                const weekdays = calculateWorkingDays(period.start_date, period.end_date);
                
                html += `<tr>
                    <td>${period.year}</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td><strong>${weekdays}</strong> days</td>
                    <td>${period.description || '-'}</td>
                    <td>${period.created_by_name || 'Unknown'}</td>
                    <td>
                        <button onclick="editShutdownPeriod(${period.id})" class="btn btn-sm btn-secondary">Edit</button>
                        <button onclick="deleteShutdownPeriod(${period.id})" class="btn btn-sm btn-danger">Delete</button>
                        <button onclick="applyShutdown(${period.id})" class="btn btn-sm btn-primary">Apply to All Users</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function showAddShutdownModal() {
            document.getElementById('shutdownModalTitle').textContent = 'Add Company Shutdown Period';
            document.getElementById('shutdownForm').reset();
            document.getElementById('shutdownPeriodId').value = '';
            document.getElementById('shutdownYear').value = currentYear;
            document.getElementById('shutdownModal').style.display = 'block';
        }
        
        async function editShutdownPeriod(periodId) {
            try {
                // Fetch all shutdown periods to find the one we want to edit
                const response = await apiCall('/holidays/shutdown-periods');
                if (!response || !response.success) {
                    alert('Error loading shutdown periods');
                    return;
                }
                
                const period = response.periods.find(p => p.id === periodId);
                if (!period) {
                    alert('Shutdown period not found');
                    return;
                }
                
                populateEditModal(period);
            } catch (error) {
                console.error('Error loading shutdown period:', error);
                alert('Error loading shutdown period: ' + (error.message || 'Unknown error'));
            }
        }
        
        function populateEditModal(period) {
            document.getElementById('shutdownModalTitle').textContent = 'Edit Company Shutdown Period';
            document.getElementById('shutdownPeriodId').value = period.id;
            document.getElementById('shutdownYear').value = period.year;
            document.getElementById('shutdownStartDate').value = period.start_date.split('T')[0];
            document.getElementById('shutdownEndDate').value = period.end_date.split('T')[0];
            document.getElementById('shutdownDescription').value = period.description || '';
            document.getElementById('shutdownModal').style.display = 'block';
        }
        
        async function deleteShutdownPeriod(periodId) {
            if (!confirm('Are you sure you want to delete this shutdown period? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await apiCall(`/holidays/shutdown-periods/${periodId}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    alert('Shutdown period deleted successfully');
                    await loadShutdownPeriods();
                    await loadEntitlements();
                } else {
                    alert('Error deleting shutdown period: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting shutdown period:', error);
                alert('Error deleting shutdown period: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function saveShutdownPeriod(event) {
            event.preventDefault();
            const periodId = document.getElementById('shutdownPeriodId').value;
            const year = parseInt(document.getElementById('shutdownYear').value);
            const startDate = document.getElementById('shutdownStartDate').value;
            const endDate = document.getElementById('shutdownEndDate').value;
            const description = document.getElementById('shutdownDescription').value;
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const isEdit = periodId && periodId !== '';
            const url = isEdit ? `/holidays/shutdown-periods/${periodId}` : '/holidays/shutdown-periods';
            const method = isEdit ? 'PUT' : 'POST';
            
            try {
                console.log(isEdit ? 'Updating' : 'Creating', 'shutdown period:', { periodId, year, startDate, endDate, description });
                const response = await apiCall(url, {
                    method: method,
                    body: JSON.stringify({
                        year: year,
                        start_date: startDate,
                        end_date: endDate,
                        description: description || null
                    })
                });
                
                console.log('Shutdown period save response:', response);
                
                if (response && response.success) {
                    closeModal('shutdownModal');
                    alert(isEdit ? 'Shutdown period updated successfully' : 'Shutdown period created successfully');
                    // Small delay to ensure database update is complete
                    setTimeout(async () => {
                        await loadShutdownPeriods();
                        await loadEntitlements();
                    }, 200);
                } else {
                    alert(`Error ${isEdit ? 'updating' : 'creating'} shutdown period: ` + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error(`Error ${isEdit ? 'updating' : 'creating'} shutdown period:`, error);
                alert(`Error ${isEdit ? 'updating' : 'creating'} shutdown period: ` + (error.message || 'Unknown error'));
            }
        }
        
        async function applyShutdown(periodId) {
            if (!confirm('Apply this shutdown period to all user entitlements? This will deduct weekdays from everyone\'s entitlement for this year.')) return;
            
            try {
                const response = await apiCall(`/holidays/shutdown-periods/${periodId}/apply`, {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                if (response.success) {
                    alert(response.message || 'Shutdown applied successfully');
                    await loadEntitlements();
                }
            } catch (error) {
                alert('Error applying shutdown: ' + (error.message || 'Unknown error'));
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset form and re-enable fields
            const form = document.getElementById(modalId.replace('Modal', 'Form'));
            if (form) {
                form.reset();
                form.querySelectorAll('input, select').forEach(field => {
                    field.disabled = false;
                });
            }
            // Reset edit state for shutdown modal
            if (modalId === 'shutdownModal') {
                document.getElementById('shutdownPeriodId').value = '';
                document.getElementById('shutdownModalTitle').textContent = 'Add Company Shutdown Period';
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }
        
        init();
    </script>
    <script>
        // Helper function to calculate weekdays (client-side version)
        function calculateWorkingDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let count = 0;
            const current = new Date(start);
            while (current <= end) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            return count;
        }
        
        // Holiday days for entitlement: Mon-Thu = 1, Friday = 0.75, half = 0.5 or 0.375 (Friday)
        function calculateHolidayDaysRequested(startDate, endDate, dayType) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start > end) return 0;
            if (dayType === 'half') {
                if (startDate !== endDate) return 0;
                const dayOfWeek = start.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) return 0;
                return dayOfWeek === 5 ? 0.375 : 0.5;
            }
            let total = 0;
            const current = new Date(start);
            while (current <= end) {
                const d = current.getDay();
                if (d >= 1 && d <= 5) {
                    total += d === 5 ? 0.75 : 1;
                }
                current.setDate(current.getDate() + 1);
            }
            return Math.round(total * 100) / 100;
        }
        
        // Use this for shutdown periods display
        const ProductionDatabase = { calculateWorkingDays };
        
        // Helper function to parse date string (YYYY-MM-DD) as local date, not UTC
        function parseLocalDate(dateString) {
            // dateString is in format "YYYY-MM-DD"
            const parts = dateString.split('-');
            if (parts.length !== 3) {
                // Fallback to standard Date parsing if format is unexpected
                return new Date(dateString);
            }
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            const day = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
        
        // Helper function to format date as YYYY-MM-DD without timezone conversion
        function formatDateString(year, month, day) {
            // month is 0-indexed in JavaScript Date, but we pass it as-is (0-11)
            const monthStr = String(month + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            return `${year}-${monthStr}-${dayStr}`;
        }
        
        // Calendar functions
        async function loadCalendar() {
            const container = document.getElementById('calendarContainer');
            try {
                container.innerHTML = '<div class="loading">Loading calendar...</div>';
                
                const year = calendarYear;
                const month = calendarMonth;
                
                console.log('Loading calendar for:', month, year);
                
                // Fetch all holiday requests for the year
                const requestsResponse = await apiCall(`/holidays/requests?year=${year}`);
                console.log('Holiday requests response:', requestsResponse);
                
                if (!requestsResponse) {
                    throw new Error('No response from server. Please check your connection.');
                }
                
                if (!requestsResponse.success) {
                    throw new Error('Failed to load holiday requests: ' + (requestsResponse.error || 'Unknown error'));
                }
                
                // Filter for approved and pending only, and check if they overlap with current month
                const allRequests = Array.isArray(requestsResponse.requests) ? requestsResponse.requests : [];
                const monthRequests = allRequests.filter(req => {
                    if (req.status !== 'approved' && req.status !== 'pending') {
                        return false;
                    }
                    const reqStart = new Date(req.start_date);
                    const reqEnd = new Date(req.end_date);
                    const monthStart = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0);
                    // Check if request overlaps with the month
                    return reqStart <= monthEnd && reqEnd >= monthStart;
                });
                
                // Fetch shutdown periods for the year
                let allShutdowns = [];
                try {
                    const shutdownsResponse = await apiCall(`/holidays/shutdown-periods?year=${year}`);
                    console.log('Shutdown periods response:', shutdownsResponse);
                    if (shutdownsResponse && shutdownsResponse.success) {
                        allShutdowns = Array.isArray(shutdownsResponse.periods) ? shutdownsResponse.periods : 
                                      (Array.isArray(shutdownsResponse.shutdowns) ? shutdownsResponse.shutdowns : []);
                    }
                } catch (shutdownError) {
                    console.warn('Error loading shutdown periods (continuing without them):', shutdownError);
                    // Continue without shutdown periods
                }
                const monthShutdowns = allShutdowns.filter(shutdown => {
                    const shutdownStart = new Date(shutdown.start_date);
                    const shutdownEnd = new Date(shutdown.end_date);
                    const monthStart = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0);
                    // Check if shutdown overlaps with the month
                    return shutdownStart <= monthEnd && shutdownEnd >= monthStart;
                });
                
                console.log('Rendering calendar with', monthRequests.length, 'requests and', monthShutdowns.length, 'shutdowns');
                renderCalendar(month, year, monthRequests, monthShutdowns);
            } catch (error) {
                console.error('Error loading calendar:', error);
                const container = document.getElementById('calendarContainer');
                container.innerHTML = 
                    '<div class="error" style="padding: 20px; color: #dc3545;">' +
                    'Error loading calendar: ' + (error.message || 'Unknown error') + 
                    '<br><small>Check browser console for details</small>' +
                    '</div>';
            }
        }
        
        function renderCalendar(month, year, requests, shutdowns) {
            const container = document.getElementById('calendarContainer');
            if (!container) {
                console.error('Calendar container not found');
                return;
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update month/year display
            const monthYearElement = document.getElementById('calendarMonthYear');
            if (monthYearElement) {
                monthYearElement.textContent = `${monthNames[month]} ${year}`;
            }
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Create a map of dates to holidays
            const holidaysByDate = {};
            requests.forEach(req => {
                // Parse dates as local dates to avoid timezone conversion issues
                const start = parseLocalDate(req.start_date);
                const end = parseLocalDate(req.end_date);
                const current = new Date(start);
                
                while (current <= end) {
                    // Use formatDateString to avoid timezone conversion
                    const dateKey = formatDateString(current.getFullYear(), current.getMonth(), current.getDate());
                    if (!holidaysByDate[dateKey]) {
                        holidaysByDate[dateKey] = [];
                    }
                    // Only add if it's a weekday and within the current month
                    const dayOfWeek = current.getDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5 && 
                        current.getMonth() === month && 
                        current.getFullYear() === year) {
                        holidaysByDate[dateKey].push({
                            user_name: req.user_name || 'Unknown',
                            status: req.status
                        });
                    }
                    current.setDate(current.getDate() + 1);
                }
            });
            
            // Create shutdown map
            const shutdownsByDate = {};
            shutdowns.forEach(shutdown => {
                // Parse dates as local dates to avoid timezone conversion issues
                const start = parseLocalDate(shutdown.start_date);
                const end = parseLocalDate(shutdown.end_date);
                const current = new Date(start);
                
                while (current <= end) {
                    // Use formatDateString to avoid timezone conversion
                    const dateKey = formatDateString(current.getFullYear(), current.getMonth(), current.getDate());
                    if (current.getMonth() === month && current.getFullYear() === year) {
                        shutdownsByDate[dateKey] = shutdown.description || 'Company Shutdown';
                    }
                    current.setDate(current.getDate() + 1);
                }
            });
            
            // Build calendar HTML
            let html = '<div class="holiday-calendar">';
            
            // Header with day names
            html += '<div class="calendar-header">';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-header-cell">${day}</div>`;
            });
            html += '</div>';
            
            // Calendar grid
            html += '<div class="calendar-grid">';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            // Add cells for each day of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                // Use formatDateString to avoid timezone conversion
                const dateKey = formatDateString(year, month, day);
                const dayOfWeek = date.getDay();
                const isToday = date.toDateString() === today.toDateString();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (isWeekend) dayClass += ' weekend';
                
                html += `<div class="${dayClass}">`;
                html += `<div class="calendar-day-number">${day}</div>`;
                
                // Add shutdown period if exists
                if (shutdownsByDate[dateKey]) {
                    html += `<div class="shutdown-period">${shutdownsByDate[dateKey]}</div>`;
                }
                
                // Add holidays for this day
                if (holidaysByDate[dateKey] && holidaysByDate[dateKey].length > 0) {
                    const holidays = holidaysByDate[dateKey];
                    holidays.forEach(holiday => {
                        const statusClass = holiday.status === 'approved' ? 'holiday-approved' : 'holiday-pending';
                        html += `<div class="holiday-item ${statusClass}" title="${holiday.user_name} - ${holiday.status}">`;
                        html += `${holiday.user_name} (${holiday.status === 'approved' ? 'Approved' : 'Pending'})`;
                        html += `</div>`;
                    });
                }
                
                html += '</div>';
            }
            
            // Add empty cells for days after month ends
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; // 6 weeks * 7 days
            for (let i = 0; i < remainingCells && i < 7; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            html += '</div></div>';
            
            try {
                container.innerHTML = html;
                console.log('Calendar rendered successfully');
            } catch (error) {
                console.error('Error rendering calendar HTML:', error);
                container.innerHTML = '<div class="error">Error rendering calendar. Please check console for details.</div>';
            }
        }
        
        function previousMonth() {
            calendarMonth--;
            if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            }
            loadCalendar();
        }
        
        function nextMonth() {
            calendarMonth++;
            if (calendarMonth > 11) {
                calendarMonth = 0;
                calendarYear++;
            }
            loadCalendar();
        }
        
        function goToToday() {
            const today = new Date();
            calendarMonth = today.getMonth();
            calendarYear = today.getFullYear();
            loadCalendar();
        }
    </script>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="logo.png" alt="Company Logo" onerror="this.style.display='none';">
            </div>
            <div class="footer-info">
                <p>&copy; <script>document.write(new Date().getFullYear())</script> Production System. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
