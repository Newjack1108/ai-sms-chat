<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered SMS Chat Interface</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2c3e50;
        }

        .app-container {
            width: 98%;
            max-width: 1600px;
            height: 95vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.08), 0 0 0 1px rgba(76, 175, 80, 0.1);
            overflow: hidden;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        /* Login System */
        .login-container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f8fffe 0%, #e8f5e8 100%);
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            border: 1px solid rgba(76, 175, 80, 0.1);
            width: 400px;
            max-width: 90%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #5a6c7d;
            font-size: 1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 14px 16px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .login-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .role-option {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
        }

        .role-option.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            color: #2E7D32;
        }

        .role-option:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-role {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .demo-credentials {
            margin-top: 20px;
            padding: 15px;
            background: rgba(76, 175, 80, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .demo-credentials h4 {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        .credential-item {
            font-size: 0.8rem;
            color: #5a6c7d;
            margin-bottom: 5px;
            padding: 5px;
            background: white;
            border-radius: 6px;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .credential-item strong {
            color: #2E7D32;
        }

        /* Integration Settings Styles */
        .integration-box {
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .integration-box h4 {
            color: #2E7D32;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }

        .webhook-url {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .webhook-url input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            background: white;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #2E7D32;
        }

        .copy-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
        }

        .integration-steps {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .integration-steps h5 {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .integration-steps ol {
            margin: 0;
            padding-left: 20px;
            color: #5a6c7d;
        }

        .integration-steps li {
            margin-bottom: 5px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .integration-status {
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(76, 175, 80, 0.1);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.connected {
            background: rgba(76, 175, 80, 0.15);
            color: #2E7D32;
        }

        .status-badge.not-connected {
            background: rgba(244, 67, 54, 0.15);
            color: #C62828;
        }

        .integration-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .test-integration-btn, .refresh-status-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .test-integration-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .test-integration-btn:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            transform: translateY(-1px);
        }

        .refresh-status-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .refresh-status-btn:hover {
            background: linear-gradient(135deg, #F57C00, #EF6C00);
            transform: translateY(-1px);
        }

        /* Test Mode Styles */
        .test-chat-box {
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .test-input-group {
            margin-bottom: 15px;
        }

        .test-input-group label {
            display: block;
            color: #2E7D32;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .test-input-group input,
        .test-input-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .test-input-group input:focus,
        .test-input-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .test-sms-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
        }

        .test-sms-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
        }

        .test-results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(76, 175, 80, 0.1);
            min-height: 100px;
            font-size: 0.85rem;
            color: #5a6c7d;
        }

        .test-status {
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-info {
            background: rgba(33, 150, 243, 0.05);
            border: 1px solid rgba(33, 150, 243, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        .test-info h4 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .test-info ul {
            margin: 0;
            padding-left: 20px;
            color: #5a6c7d;
        }

        .test-info li {
            margin-bottom: 5px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .chat-container {
            width: 100%;
            height: calc(100% - 60px);
            display: flex;
            overflow: hidden;
        }

        .settings-container {
            width: 100%;
            height: calc(100% - 60px);
            display: none;
            overflow: hidden;
        }

        .settings-container.active {
            display: block;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            padding: 0;
            display: flex;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .tab-button {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 16px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.15);
            border-bottom-color: white;
        }

        .tab-button:first-child {
            border-top-left-radius: 16px;
        }

        .tab-button:last-child {
            border-top-right-radius: 16px;
        }

        /* Settings Dashboard */
        .settings-dashboard {
            height: calc(100% - 60px);
            overflow-y: auto;
            background: linear-gradient(180deg, #fafafa 0%, #f8fffe 100%);
            padding: 24px;
        }

        .settings-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .settings-section h2 {
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .settings-group {
            background: rgba(248, 255, 254, 0.5);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .settings-group h3 {
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-input-group {
            margin-bottom: 16px;
        }

        .settings-input-group label {
            display: block;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .settings-input-group input,
        .settings-input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.2s ease;
        }

        .settings-input-group input:focus,
        .settings-input-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .help-text {
            display: block;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #5a6c7d;
        }

        .help-text a {
            text-decoration: none;
            font-weight: 500;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        .save-settings-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 15px;
        }

        .save-settings-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .save-ai-settings-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 15px;
        }

        .save-ai-settings-btn:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: rgba(76, 175, 80, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(76, 175, 80, 0.15);
        }

        .settings-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4CAF50;
        }

        .settings-toggle label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .settings-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .settings-status.enabled {
            background: rgba(76, 175, 80, 0.15);
            color: #2E7D32;
        }

        .settings-status.disabled {
            background: rgba(244, 67, 54, 0.15);
            color: #C62828;
        }

        /* Security Warning Styles */
        .security-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.2);
        }

        .warning-content h4 {
            color: #d68910;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .warning-content p {
            color: #8b4513;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .warning-content ul {
            color: #8b4513;
            margin-bottom: 16px;
            padding-left: 20px;
        }

        .warning-content li {
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .clear-tokens-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .clear-tokens-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fffe 100%);
            border-right: 1px solid rgba(76, 175, 80, 0.15);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .setup-section {
            padding: 16px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.1);
            background: rgba(248, 255, 254, 0.5);
        }

        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.8rem;
        }

        .input-group input, .input-group select {
            padding: 10px 12px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
            transition: all 0.2s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .ai-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(76, 175, 80, 0.08);
            border-radius: 10px;
            font-size: 0.8rem;
            border: 1px solid rgba(76, 175, 80, 0.15);
        }

        .ai-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
        }

        .ai-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .ai-status.enabled {
            background: rgba(76, 175, 80, 0.15);
            color: #2E7D32;
        }

        .ai-status.disabled {
            background: rgba(244, 67, 54, 0.15);
            color: #C62828;
        }

        .templates-section {
            padding: 16px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.1);
            flex: 1;
            overflow-y: auto;
            background: rgba(248, 255, 254, 0.3);
        }

        .templates-section h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .template-item {
            background: white;
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .template-item:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.15);
        }

        .template-item.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        }

        .template-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .template-preview {
            color: #5a6c7d;
            font-size: 0.75rem;
            line-height: 1.3;
        }


        .ai-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .new-chat-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 14px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
            position: relative;
        }

        .chat-header h2 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .status {
            font-size: 0.95rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .ai-mode-indicator {
            position: absolute;
            top: 18px;
            right: 24px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(180deg, #fafafa 0%, #f8fffe 100%);
        }

        .message {
            margin-bottom: 18px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.ai-response {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }

        .message.received .message-bubble {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.ai-response .message-bubble {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border-bottom-left-radius: 6px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .message.ai-response .message-bubble::before {
            content: "🤖";
            position: absolute;
            top: -10px;
            left: 8px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 2px solid rgba(76, 175, 80, 0.2);
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 6px;
        }

        .message-form {
            padding: 20px;
            background: white;
            border-top: 1px solid rgba(76, 175, 80, 0.1);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .template-selector {
            width: 100%;
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .template-dropdown {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
            font-size: 0.9rem;
            outline: none;
            background: white;
            transition: all 0.2s ease;
        }

        .template-dropdown:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .use-template-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .use-template-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
        }

        .message-row {
            width: 100%;
            display: flex;
            gap: 12px;
        }

        .recipient-input {
            width: 140px;
            padding: 14px 18px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            background: white;
            transition: all 0.2s ease;
        }

        .recipient-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 25px;
            font-size: 0.95rem;
            outline: none;
            min-height: 50px;
            resize: vertical;
            background: white;
            transition: all 0.2s ease;
        }

        .message-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .send-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .send-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error {
            color: #C62828;
            background: rgba(244, 67, 54, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin: 12px 16px;
            font-size: 0.85rem;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        .success {
            color: #2E7D32;
            background: rgba(76, 175, 80, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin: 12px 16px;
            font-size: 0.85rem;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #5a6c7d;
            text-align: center;
        }

        .empty-state h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-weight: 600;
        }

        .unread-badge {
            background: #C62828;
            color: white;
            border-radius: 12px;
            padding: 3px 8px;
            font-size: 0.7rem;
            float: right;
            margin-top: 2px;
            font-weight: 600;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #5a6c7d;
            font-style: italic;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }

        .typing-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #4CAF50;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Customer Management Styles */
        .tab-content {
            display: none;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .customer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        .stat-box h4 {
            font-size: 0.85rem;
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
        }

        .stat-box span {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .customer-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .customer-item {
            background: rgba(248, 255, 254, 0.8);
            border: 1px solid rgba(76, 175, 80, 0.15);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .customer-item:hover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.08);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.15);
        }

        .customer-phone {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .customer-info {
            font-size: 0.8rem;
            color: #5a6c7d;
            line-height: 1.3;
        }

        /* Question Configuration Styles */
        .question-config {
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(76, 175, 80, 0.1);
        }

        .question-config h4 {
            color: #2c3e50;
            margin-bottom: 18px;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .question-item {
            margin-bottom: 16px;
        }

        .question-item label {
            display: block;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .question-item input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
            outline: none;
            background: white;
            transition: all 0.2s ease;
        }

        .question-item input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .question-config button {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .question-config button:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        @media (max-width: 768px) {
            .app-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 280px;
            }

            .customer-stats {
                grid-template-columns: 1fr;
            }


            .settings-grid {
                grid-template-columns: 1fr;
            }

            .settings-dashboard {
                padding: 16px;
            }

            .settings-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 0.85rem;
            }

            .message-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            .new-chat-btn {
                min-width: 80px;
                padding: 12px 14px;
                font-size: 0.8rem;
            }

            .recipient-input {
                width: 120px;
            }
        }

        /* Conversations List Styles */
        .conversations-section {
            margin-bottom: 20px;
        }

        .conversations-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .conversation-item:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .conversation-item.active {
            background: #007bff;
            color: white;
        }

        .conversation-item.active:hover {
            background: #0056b3;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-phone {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .conversation-item.active .unread-badge {
            background: #fff;
            color: #007bff;
        }

        .conversation-preview {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .conversation-item.active .conversation-preview {
            color: rgba(255, 255, 255, 0.8);
        }

        .conversation-time {
            font-size: 0.7rem;
            color: #999;
        }

        .conversation-item.active .conversation-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-conversations {
            text-align: center;
            color: #999;
            font-size: 0.8rem;
            padding: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <h1>🤖 AI SMS Chat</h1>
                <p>Secure Access Portal</p>
            </div>

            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                
                <div class="form-group">
                    <label>Role</label>
                    <div class="role-selector">
                        <div class="role-option selected" data-role="admin">
                            👑 Admin
                        </div>
                        <div class="role-option" data-role="sales">
                            💼 Sales
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Sign In
                </button>
            </form>
            
            <!-- Demo Credentials -->
            <div class="demo-credentials">
                <h4>🔑 Demo Credentials</h4>
                <div class="credential-item">
                    <strong>Admin:</strong> admin / admin123
                </div>
                <div class="credential-item">
                    <strong>Sales:</strong> sales / sales123
                </div>
                <div class="credential-item">
                    <strong>Manager:</strong> manager / manager123
                </div>
            </div>
        </div>
                </div>
                
    <!-- Main Application -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- User Info -->
        <div class="user-info" id="userInfo">
            <span id="userName">User</span>
            <span class="user-role" id="userRole">Role</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
                </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" id="tabNavigation">
            <button class="tab-button active" onclick="switchTab('chat')">
                💬 Chat Interface
            </button>
            <button class="tab-button" id="settingsTabBtn" onclick="switchTab('settings')" style="display: none;">
                ⚙️ Settings & Configuration
            </button>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container" id="chatTab">
            <div class="sidebar">
            <div class="sidebar-header">
                <h1>🤖 AI SMS Chat</h1>
                <div class="status">Intelligent Messaging</div>
            </div>

            <div class="conversations-section">
                <h3>💬 Conversations</h3>
                <div class="conversation-controls" style="margin-bottom: 10px;">
                    <button class="button" onclick="clearCurrentChat()" style="background: #f44336; color: white; padding: 5px 10px; font-size: 0.8rem; margin-right: 5px;">🗑️ Clear Current</button>
                    <button class="button" onclick="clearAllChats()" style="background: #ff9800; color: white; padding: 5px 10px; font-size: 0.8rem;">🧹 Clear All</button>
                </div>
                <div id="conversationsList">
                    <!-- Conversations will be populated here -->
                </div>
            </div>

            <div class="templates-section">
                <h3>📝 Message Templates</h3>
                <div id="templatesList">
                    <!-- Templates will be populated here -->
                </div>
            </div>

        </div>

        <div class="chat-main">
            <div class="chat-header">
                <h2 id="chatTitle">Select a conversation</h2>
                <div class="status" id="chatStatus">Choose a contact to start messaging</div>
                <div class="ai-mode-indicator" id="aiModeIndicator">
                    🤖 AI Mode: <span id="aiModeStatus">ON</span>
                </div>
            </div>

            <div class="messages" id="messages">
                <div class="empty-state">
                    <h3>🤖 Welcome to AI-Powered SMS Chat</h3>
                    <p>Select a conversation or start a new one with a template!</p>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #999;">
                        Configure your Twilio and OpenAI settings in the sidebar.
                    </p>
                </div>
            </div>

            <form class="message-form" id="messageForm">
                <div class="template-selector">
                    <select class="template-dropdown" id="templateDropdown">
                        <option value="">Select a message template...</option>
                    </select>
                    <button type="button" class="use-template-btn" id="useTemplateBtn">Use Template</button>
                </div>
                
                <div class="message-row">
                    <button type="button" class="new-chat-btn" id="newConversation">
                        + New Chat
                    </button>
                    <input 
                        type="text" 
                        class="recipient-input" 
                        id="recipientInput" 
                        placeholder="Phone number"
                        required
                    >
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type your message or select a template..."
                        required
                        rows="1"
                    ></textarea>
                    <button type="submit" class="send-btn" id="sendBtn">Send</button>
                </div>
            </form>
        </div>
        </div>

        <!-- Settings Dashboard -->
        <div class="settings-container" id="settingsTab">
            <div class="settings-dashboard">
                <!-- Twilio Settings Section -->
                <div class="settings-section">
                    <h2>🔧 Twilio Configuration</h2>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
                        <strong>✅ Credentials Loaded from Railway</strong><br>
                        Your Twilio and OpenAI credentials are automatically loaded from Railway's secure environment variables. 
                        No need to enter them manually - they're already configured and working!
                    </div>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📱 Account Details</h3>
                            <div class="settings-input-group">
                                <label>Account SID:</label>
                                <input type="text" id="settingsAccountSid" placeholder="ACxxx..." readonly>
                                <small style="color: #666; font-size: 0.8em;">✅ Loaded from Railway environment variables</small>
                            </div>
                            <div class="settings-input-group">
                                <label>Auth Token:</label>
                                <input type="password" id="settingsAuthToken" placeholder="Token..." readonly>
                                <small style="color: #666; font-size: 0.8em;">✅ Loaded from Railway environment variables</small>
                            </div>
                            <div class="settings-input-group">
                                <label>From Number:</label>
                                <input type="text" id="settingsFromNumber" placeholder="+1234567890" readonly>
                                <small style="color: #666; font-size: 0.8em;">✅ Loaded from Railway environment variables</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings Section -->
                <div class="settings-section">
                    <h2>🤖 AI Configuration</h2>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>🧠 OpenAI Settings</h3>
                            <div class="settings-input-group">
                                <label>OpenAI API Key:</label>
                                <input type="password" id="settingsOpenaiKey" placeholder="sk-..." readonly>
                                <small style="color: #666; font-size: 0.8em;">✅ Loaded from Railway environment variables</small>
                            </div>
                            <div class="settings-input-group">
                                <label>OpenAI Assistant ID:</label>
                                <input type="text" id="settingsAssistantId" placeholder="asst_..." readonly>
                                <small style="color: #666; font-size: 0.8em;">✅ Loaded from Railway environment variables</small>
                            </div>
                            <div class="settings-input-group">
                                <label>AI Model:</label>
                                <select id="settingsAiModel">
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-4o">GPT-4o</option>
                                </select>
                            </div>
                            <div class="settings-toggle">
                                <input type="checkbox" id="settingsAiEnabled" checked>
                                <label for="settingsAiEnabled">Enable Auto AI Responses</label>
                                <span class="settings-status enabled" id="settingsAiStatus">ENABLED</span>
                            </div>
                            <div class="settings-toggle">
                                <input type="checkbox" id="settingsTestMode">
                                <label for="settingsTestMode">Test Mode (No SMS Sending)</label>
                                <span class="settings-status disabled" id="settingsTestModeStatus">DISABLED</span>
                            </div>
                            <button onclick="saveAISettings()" class="save-ai-settings-btn">
                                🤖 Save AI Settings
                            </button>
                            <button onclick="saveSettingsToStorage()" class="save-settings-btn">
                                💾 Save All Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Question Configuration Section -->
                <div class="settings-section">
                    <h2>❓ Question Configuration</h2>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📝 Custom Questions</h3>
                            <div class="settings-input-group">
                                <label>Question 1:</label>
                                <input type="text" id="settingsQ1" value="How many horses do you currently have?">
                            </div>
                            <div class="settings-input-group">
                                <label>Question 2:</label>
                                <input type="text" id="settingsQ2" value="What type of stable configuration interests you most?">
                            </div>
                            <div class="settings-input-group">
                                <label>Question 3:</label>
                                <input type="text" id="settingsQ3" value="What's your budget range for this project?">
                            </div>
                            <div class="settings-input-group">
                                <label>Question 4:</label>
                                <input type="text" id="settingsQ4" value="What's your ideal timeline for completion?">
                            </div>
                            <button class="question-config button" onclick="saveSettingsQuestions()">Save Questions</button>
                        </div>
                    </div>
                </div>

                <!-- Test Mode Section -->
                <div class="settings-section" id="testModeSection" style="display: none;">
                    <h2>🧪 Test Mode</h2>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📱 Simulate Incoming SMS</h3>
                            <div class="test-chat-box">
                                <div class="test-input-group">
                                    <label>Phone Number:</label>
                                    <input type="text" id="testPhoneNumber" placeholder="+1234567890" value="+1234567890">
                                </div>
                                <div class="test-input-group">
                                    <label>Message:</label>
                                    <textarea id="testMessage" placeholder="Type a test message here..." rows="3"></textarea>
                                </div>
                                <button onclick="simulateIncomingSMS()" class="test-sms-btn">
                                    📤 Simulate SMS
                                </button>
                                <div class="test-results" id="testResults">
                                    <!-- Test results will appear here -->
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <h3>📊 Test Status</h3>
                            <div class="test-status">
                                <div class="status-item">
                                    <span class="status-label">Test Mode:</span>
                                    <span class="status-badge" id="testModeBadge">Disabled</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">AI Responses:</span>
                                    <span class="status-badge" id="aiTestBadge">Disabled</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">SMS Sending:</span>
                                    <span class="status-badge" id="smsTestBadge">Disabled</span>
                                </div>
                            </div>
                            <div class="test-info">
                                <h4>ℹ️ Test Mode Info</h4>
                                <ul>
                                    <li>AI responses are generated but not sent via SMS</li>
                                    <li>Messages appear in chat interface only</li>
                                    <li>Perfect for testing while waiting for Twilio verification</li>
                                    <li>Customer database is still updated</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integration Settings Section -->
                <div class="settings-section">
                    <h2>🔗 Lead Integration</h2>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📱 Facebook Lead Ads</h3>
                            <div class="integration-box">
                                <h4>Webhook URL</h4>
                                <div class="webhook-url">
                                    <input type="text" id="facebookWebhookUrl" readonly value="https://your-domain.com/api/import-lead">
                                    <button onclick="copyToClipboard('facebookWebhookUrl')" class="copy-btn">📋 Copy</button>
                                </div>
                                <div class="integration-steps">
                                    <h5>Setup Steps:</h5>
                                    <ol>
                                        <li>Go to Facebook Business Manager</li>
                                        <li>Navigate to Lead Ads → Webhooks</li>
                                        <li>Add new webhook with the URL above</li>
                                        <li>Map fields: name, phone, email, postcode</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <h3>📝 Gravity Forms</h3>
                            <div class="integration-box">
                                <h4>Webhook URL</h4>
                                <div class="webhook-url">
                                    <input type="text" id="gravityWebhookUrl" readonly value="https://your-domain.com/api/import-lead">
                                    <button onclick="copyToClipboard('gravityWebhookUrl')" class="copy-btn">📋 Copy</button>
                                </div>
                                <div class="integration-steps">
                                    <h5>Setup Steps:</h5>
                                    <ol>
                                        <li>Go to Gravity Forms → Settings → Webhooks</li>
                                        <li>Add new webhook with the URL above</li>
                                        <li>Set method to POST</li>
                                        <li>Map form fields to API fields</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📊 Integration Status</h3>
                            <div class="integration-status">
                                <div class="status-item">
                                    <span class="status-label">Facebook Integration:</span>
                                    <span class="status-badge" id="facebookStatus">Not Connected</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Gravity Forms:</span>
                                    <span class="status-badge" id="gravityStatus">Not Connected</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">SMS Webhook:</span>
                                    <span class="status-badge" id="smsWebhookStatus">Not Connected</span>
                                </div>
                            </div>
                            <div class="integration-actions">
                                <button onclick="testIntegration()" class="test-integration-btn">
                                    🧪 Test Integration
                                </button>
                                <button onclick="refreshStatus()" class="refresh-status-btn">
                                    🔄 Refresh Status
                                </button>
                            </div>
                        </div>
                        <div class="settings-group">
                            <h3>📱 SMS Webhook (Twilio)</h3>
                            <div class="integration-box">
                                <h4>Webhook URL</h4>
                                <div class="webhook-url">
                                    <input type="text" id="smsWebhookUrl" readonly value="https://your-domain.com/webhook/sms">
                                    <button onclick="copyToClipboard('smsWebhookUrl')" class="copy-btn">📋 Copy</button>
                                </div>
                                <div class="integration-steps">
                                    <h5>Twilio Setup:</h5>
                                    <ol>
                                        <li>Go to Twilio Console → Phone Numbers</li>
                                        <li>Click on your SMS-enabled number</li>
                                        <li>Set webhook URL to the URL above</li>
                                        <li>Set HTTP method to POST</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Management Section -->
                <div class="settings-section">
                    <h2>📊 Customer Database</h2>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <h3>📈 Statistics</h3>
                            <div class="customer-stats">
                                <div class="stat-box">
                                    <h4>Total Customers</h4>
                                    <span id="settingsTotalCustomers">0</span>
                                </div>
                                <div class="stat-box">
                                    <h4>Active Conversations</h4>
                                    <span id="settingsActiveConversations">0</span>
                                </div>
                                <div class="stat-box">
                                    <h4>Complete Profiles</h4>
                                    <span id="settingsCompleteProfiles">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <h3>👥 Customer List</h3>
                            <div class="customer-list" id="settingsCustomerList">
                                <!-- Customer records will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AISmsChatManager {
            constructor() {
                this.conversations = new Map();
                this.activeConversation = null;
                this.templates = this.getDefaultTemplates();
                this.typingTimeouts = new Map();
                this.setupEventListeners();
                this.loadFromStorage();
                this.renderTemplates();
                this.renderConversations();
                this.setupAutoRefresh();
                this.setupAIToggle();
            }

            getDefaultTemplates() {
                return [
                    {
                        id: 'welcome',
                        name: 'Welcome Message',
                        message: 'Hi there! 👋 Welcome to our service. How can I help you today?'
                    },
                    {
                        id: 'followup',
                        name: 'Follow Up',
                        message: 'Hi! Just following up on our previous conversation. Is there anything else I can help you with?'
                    },
                    {
                        id: 'appointment',
                        name: 'Appointment Reminder',
                        message: 'This is a friendly reminder about your upcoming appointment. Please reply to confirm.'
                    },
                    {
                        id: 'support',
                        name: 'Support Inquiry',
                        message: 'Thank you for contacting support! I\'m here to help. What issue are you experiencing?'
                    },
                    {
                        id: 'feedback',
                        name: 'Feedback Request',
                        message: 'We\'d love to hear your feedback! How was your experience with our service?'
                    },
                    {
                        id: 'promotion',
                        name: 'Special Offer',
                        message: '🎉 Special offer just for you! We have an exclusive deal that might interest you.'
                    },
                    {
                        id: 'survey',
                        name: 'Quick Survey',
                        message: 'Quick question: On a scale of 1-10, how likely are you to recommend us to a friend?'
                    },
                    {
                        id: 'thankyou',
                        name: 'Thank You',
                        message: 'Thank you for choosing our service! We appreciate your business. 🙏'
                    }
                ];
            }

            setupEventListeners() {
                document.getElementById('messageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                document.getElementById('newConversation').addEventListener('click', () => {
                    this.startNewConversation();
                });

                document.getElementById('useTemplateBtn').addEventListener('click', () => {
                    this.useSelectedTemplate();
                });

                // Only add event listeners if elements exist (they're now in settings dashboard)
                const aiEnabledElement = document.getElementById('aiEnabled');
                if (aiEnabledElement) {
                    aiEnabledElement.addEventListener('change', (e) => {
                    this.updateAIStatus(e.target.checked);
                });
                }

                // Save settings when they change (only if elements exist)
                ['accountSid', 'authToken', 'fromNumber', 'openaiKey', 'aiModel'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => {
                        this.saveSettings();
                    });
                    }
                });

                // Auto-resize textarea
                document.getElementById('messageInput').addEventListener('input', (e) => {
                    e.target.style.height = 'auto';
                    e.target.style.height = e.target.scrollHeight + 'px';
                });

                // Handle recipient input changes
                document.getElementById('recipientInput').addEventListener('input', (e) => {
                    const recipient = e.target.value.trim();
                    if (recipient && this.conversations.has(recipient)) {
                        this.selectConversation(recipient);
                    }
                });
            }

            setupAIToggle() {
                const aiEnabledElement = document.getElementById('aiEnabled');
                if (aiEnabledElement) {
                    this.updateAIStatus(aiEnabledElement.checked);
                } else {
                    // Fallback to localStorage
                    const aiEnabled = localStorage.getItem('aiEnabled') === 'true';
                    this.updateAIStatus(aiEnabled);
                }
            }

            updateAIStatus(enabled) {
                const statusElement = document.getElementById('aiStatus');
                const modeElement = document.getElementById('aiModeStatus');
                
                if (statusElement) {
                if (enabled) {
                    statusElement.textContent = 'ENABLED';
                    statusElement.className = 'ai-status enabled';
                } else {
                    statusElement.textContent = 'DISABLED';
                    statusElement.className = 'ai-status disabled';
                    }
                }
                
                if (modeElement) {
                    modeElement.textContent = enabled ? 'ON' : 'OFF';
                }
                
                this.saveSettings();
            }

            renderTemplates() {
                const templatesList = document.getElementById('templatesList');
                const dropdown = document.getElementById('templateDropdown');
                
                // Clear existing
                templatesList.innerHTML = '';
                dropdown.innerHTML = '<option value="">Select a message template...</option>';

                this.templates.forEach(template => {
                    // Render in sidebar
                    const templateDiv = document.createElement('div');
                    templateDiv.className = 'template-item';
                    templateDiv.innerHTML = `
                        <div class="template-name">${template.name}</div>
                        <div class="template-preview">${this.truncateText(template.message, 50)}</div>
                    `;
                    
                    templateDiv.addEventListener('click', () => {
                        document.getElementById('messageInput').value = template.message;
                        document.querySelectorAll('.template-item').forEach(item => 
                            item.classList.remove('selected'));
                        templateDiv.classList.add('selected');
                    });

                    templatesList.appendChild(templateDiv);

                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    dropdown.appendChild(option);
                });
            }

            renderConversations() {
                const conversationsList = document.getElementById('conversationsList');
                if (!conversationsList) return;

                conversationsList.innerHTML = '';

                if (this.conversations.size === 0) {
                    conversationsList.innerHTML = '<div class="empty-conversations">No conversations yet</div>';
                    return;
                }

                // Sort conversations by last activity (most recent first)
                const sortedConversations = Array.from(this.conversations.entries())
                    .sort((a, b) => new Date(b[1].lastActivity) - new Date(a[1].lastActivity));

                sortedConversations.forEach(([recipient, conversation]) => {
                    const conversationDiv = document.createElement('div');
                    conversationDiv.className = `conversation-item ${recipient === this.activeConversation ? 'active' : ''}`;
                    
                    const unreadBadge = conversation.unreadCount > 0 ? `<span class="unread-badge">${conversation.unreadCount}</span>` : '';
                    const lastMessage = conversation.messages.length > 0 ? 
                        conversation.messages[conversation.messages.length - 1].text.substring(0, 30) + '...' : 
                        'No messages yet';
                    
                    conversationDiv.innerHTML = `
                        <div class="conversation-header">
                            <span class="conversation-phone">${recipient}</span>
                            ${unreadBadge}
                        </div>
                        <div class="conversation-preview">${lastMessage}</div>
                        <div class="conversation-time">${this.formatTime(conversation.lastActivity)}</div>
                    `;
                    
                    conversationDiv.onclick = () => this.selectConversation(recipient);
                    conversationsList.appendChild(conversationDiv);
                });
            }

            useSelectedTemplate() {
                const dropdown = document.getElementById('templateDropdown');
                const selectedId = dropdown.value;
                
                if (selectedId) {
                    const template = this.templates.find(t => t.id === selectedId);
                    if (template) {
                        document.getElementById('messageInput').value = template.message;
                        document.getElementById('messageInput').focus();
                    }
                }
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const recipientInput = document.getElementById('recipientInput');
                const message = messageInput.value.trim();
                const recipient = recipientInput.value.trim();
                
                if (!message || !recipient) return;

                const settings = this.getSettings();
                if (!this.validateTwilioSettings(settings)) {
                    this.showError('Please fill in all Twilio settings first!');
                    return;
                }

                // Normalize phone number
                const normalizedRecipient = this.normalizePhoneNumber(recipient);
                
                // Create or get conversation
                if (!this.conversations.has(normalizedRecipient)) {
                    this.conversations.set(normalizedRecipient, {
                        recipient: normalizedRecipient,
                        messages: [],
                        lastActivity: new Date().toISOString(),
                        unreadCount: 0,
                        aiEnabled: settings.aiEnabled
                    });
                }

                // Add message to conversation immediately
                this.addMessageToConversation(normalizedRecipient, {
                    text: message,
                    isSent: true,
                    timestamp: new Date().toISOString(),
                    status: 'sending'
                });

                // Update UI
                recipientInput.value = normalizedRecipient;
                messageInput.value = '';
                messageInput.style.height = 'auto';
                this.selectConversation(normalizedRecipient);

                try {
                    // Check if test mode is enabled
                    const testMode = localStorage.getItem('testMode') === 'true';
                    
                    if (testMode) {
                        // In test mode, just add the message to conversation without sending
                        this.addMessageToConversation(normalizedRecipient, {
                            text: message,
                            isSent: true,
                            timestamp: new Date().toISOString(),
                            status: 'sent'
                        });
                        
                        this.showSuccess('Message added to conversation (Test Mode)');
                        return;
                    }
                    
                    // Send via API
                    const response = await fetch('/api/send-sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: normalizedRecipient,
                            message: message,
                            accountSid: settings.accountSid,
                            authToken: settings.authToken,
                            from: settings.fromNumber,
                            enableAI: settings.aiEnabled,
                            openaiKey: settings.openaiKey,
                            aiModel: settings.aiModel
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update message status
                        const conversation = this.conversations.get(normalizedRecipient);
                        const lastMessage = conversation.messages[conversation.messages.length - 1];
                        lastMessage.status = 'sent';
                        lastMessage.id = result.data.id;
                        
                        this.showSuccess('Message sent successfully!');
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    this.showError('Failed to send message: ' + error.message);
                    
                    // Update message status to failed
                    const conversation = this.conversations.get(normalizedRecipient);
                    const lastMessage = conversation.messages[conversation.messages.length - 1];
                    lastMessage.status = 'failed';
                }

                this.saveConversations();
                this.renderMessages();
            }

            async handleIncomingMessage(body, from, messageId) {
                const normalizedFrom = this.normalizePhoneNumber(from);
                
                // Add the incoming message
                this.addMessageToConversation(normalizedFrom, {
                    id: messageId,
                    text: body,
                    isSent: false,
                    timestamp: new Date().toISOString(),
                    status: 'received'
                });

                // Update UI
                if (normalizedFrom === this.activeConversation) {
                    this.renderMessages();
                }
                this.saveConversations();

                // Check if AI should respond
                const conversation = this.conversations.get(normalizedFrom);
                const settings = this.getSettings();
                
                if (settings.aiEnabled && this.validateAISettings(settings)) {
                    this.showTypingIndicator(normalizedFrom);
                    
                    try {
                        const aiResponse = await this.generateAIResponse(normalizedFrom, body);
                        
                        if (aiResponse) {
                            // Send AI response after a brief delay
                            setTimeout(() => {
                                this.sendAIResponse(normalizedFrom, aiResponse);
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('AI response error:', error);
                        this.hideTypingIndicator(normalizedFrom);
                    }
                }
            }

            async generateAIResponse(recipient, incomingMessage) {
                const settings = this.getSettings();
                console.log('Generating AI response with settings:', {
                    openaiKey: settings.openaiKey ? 'Set' : 'Not set',
                    assistantId: settings.assistantId ? 'Set' : 'Not set',
                    aiModel: settings.aiModel
                });

                // Debug API key format
                if (settings.openaiKey) {
                    console.log('API Key format check:', {
                        length: settings.openaiKey.length,
                        startsWithSk: settings.openaiKey.startsWith('sk-'),
                        first10Chars: settings.openaiKey.substring(0, 10),
                        last4Chars: settings.openaiKey.substring(settings.openaiKey.length - 4)
                    });
                } else {
                    console.error('❌ OpenAI API key is not set!');
                    return null;
                }

                try {
                    // Use OpenAI API directly from the frontend
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${settings.openaiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: settings.aiModel,
                            messages: [
                                {
                                    role: 'system',
                                    content: `You are a helpful AI assistant for an equine stable construction company. You respond to SMS messages from potential customers. Keep responses concise (under 160 characters when possible), friendly, and professional. Ask qualifying questions about their stable needs, number of horses, budget, and timeline.`
                                },
                                {
                                    role: 'user',
                                    content: incomingMessage
                                }
                            ],
                            max_tokens: 150,
                            temperature: 0.7
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const aiResponse = data.choices[0].message.content;
                        console.log('AI response generated:', aiResponse);
                        return aiResponse;
                    } else {
                        const errorData = await response.json();
                        console.error('OpenAI API error:', errorData);
                        console.error('Response status:', response.status);
                        console.error('Response statusText:', response.statusText);
                        
                        // Show user-friendly error message
                        if (response.status === 401) {
                            console.error('❌ OpenAI API Key is invalid or expired. Please check your API key in settings.');
                        } else if (response.status === 429) {
                            console.error('❌ OpenAI API rate limit exceeded. Please try again later.');
                        } else if (response.status === 402) {
                            console.error('❌ OpenAI account billing issue. Please check your account.');
                        }
                        
                        return null;
                    }
                } catch (error) {
                    console.error('AI response error:', error);
                    return null;
                }
            }

            async sendAIResponse(recipient, aiResponse) {
                const settings = this.getSettings();
                
                // Add AI message to conversation
                this.addMessageToConversation(recipient, {
                    text: aiResponse,
                    isSent: true,
                    isAI: true,
                    timestamp: new Date().toISOString(),
                    status: 'sending'
                });

                this.hideTypingIndicator(recipient);
                
                if (recipient === this.activeConversation) {
                    this.renderMessages();
                }

                try {
                    // Check if test mode is enabled
                    const testMode = localStorage.getItem('testMode') === 'true';
                    
                    if (testMode) {
                        // In test mode, just add the AI response to conversation without sending
                        this.addMessageToConversation(recipient, {
                            text: aiResponse,
                            isSent: true,
                            isAI: true,
                            timestamp: new Date().toISOString(),
                            status: 'sent'
                        });
                        
                        console.log('AI response added to conversation (Test Mode)');
                        return;
                    }
                    
                    // Send via Twilio
                    const response = await fetch('/api/send-sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: recipient,
                            message: aiResponse,
                            accountSid: settings.accountSid,
                            authToken: settings.authToken,
                            from: settings.fromNumber,
                            isAIResponse: true
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update message status
                        const conversation = this.conversations.get(recipient);
                        const lastMessage = conversation.messages[conversation.messages.length - 1];
                        lastMessage.status = 'sent';
                        lastMessage.id = result.data.id;
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('Failed to send AI response:', error);
                    
                    // Update message status to failed
                    const conversation = this.conversations.get(recipient);
                    const lastMessage = conversation.messages[conversation.messages.length - 1];
                    lastMessage.status = 'failed';
                }

                this.saveConversations();
                this.renderMessages();
            }

            showTypingIndicator(recipient) {
                if (recipient === this.activeConversation) {
                    const messagesContainer = document.getElementById('messages');
                    
                    // Remove existing typing indicator
                    const existingIndicator = document.querySelector('.typing-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }

                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.innerHTML = `
                        🤖 AI is typing
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(typingDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            hideTypingIndicator(recipient) {
                const existingIndicator = document.querySelector('.typing-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
            }

            addMessageToConversation(recipient, messageData) {
                if (!this.conversations.has(recipient)) {
                    this.conversations.set(recipient, {
                        recipient: recipient,
                        messages: [],
                        lastActivity: new Date().toISOString(),
                        unreadCount: 0,
                        aiEnabled: true
                    });
                }

                const conversation = this.conversations.get(recipient);
                conversation.messages.push(messageData);
                conversation.lastActivity = messageData.timestamp;

                // Increment unread count for received messages
                if (!messageData.isSent && recipient !== this.activeConversation) {
                    conversation.unreadCount++;
                }
            }

            selectConversation(recipient) {
                this.activeConversation = recipient;
                const conversation = this.conversations.get(recipient);
                
                if (conversation) {
                    // Mark as read
                    conversation.unreadCount = 0;
                    
                    // Update UI
                    document.getElementById('recipientInput').value = recipient;
                    document.getElementById('chatTitle').textContent = recipient;
                    document.getElementById('chatStatus').textContent = 
                        `${conversation.messages.length} messages • AI: ${conversation.aiEnabled ? 'ON' : 'OFF'}`;
                    
                    this.renderMessages();
                    this.renderConversations(); // Update conversations list to show active state
                    this.saveConversations();
                }
            }

            startNewConversation() {
                this.activeConversation = null;
                document.getElementById('recipientInput').value = '';
                document.getElementById('messageInput').value = '';
                document.getElementById('messageInput').focus();
                document.getElementById('chatTitle').textContent = 'New Conversation';
                document.getElementById('chatStatus').textContent = 'Enter a phone number and select a template';
                
                // Clear messages
                document.getElementById('messages').innerHTML = `
                    <div class="empty-state">
                        <h3>🤖 New AI Conversation</h3>
                        <p>Select a template to start or type a custom message!</p>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #999;">
                            AI responses are ${document.getElementById('aiEnabled').checked ? 'enabled' : 'disabled'}.
                        </p>
                    </div>
                `;
            }


            renderMessages() {
                const container = document.getElementById('messages');
                
                if (!this.activeConversation || !this.conversations.has(this.activeConversation)) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>🤖 Select a conversation</h3>
                            <p>Choose a contact to view message history</p>
                        </div>
                    `;
                    return;
                }

                const conversation = this.conversations.get(this.activeConversation);
                container.innerHTML = '';

                conversation.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    let messageClass = 'message ';
                    
                    if (msg.isSent) {
                        messageClass += msg.isAI ? 'ai-response' : 'sent';
                    } else {
                        messageClass += 'received';
                    }
                    
                    messageDiv.className = messageClass;
                    
                    const statusIndicator = msg.isSent ? this.getStatusIndicator(msg.status) : '';
                    const timeString = this.formatTime(msg.timestamp);

                    messageDiv.innerHTML = `
                        <div class="message-bubble">
                            <div>${this.escapeHtml(msg.text)}</div>
                            <div class="message-time">${timeString} ${statusIndicator}</div>
                        </div>
                    `;

                    container.appendChild(messageDiv);
                });

                container.scrollTop = container.scrollHeight;
            }

            getStatusIndicator(status) {
                switch(status) {
                    case 'sending': return '⏳';
                    case 'sent': return '✓';
                    case 'delivered': return '✓✓';
                    case 'failed': return '❌';
                    default: return '';
                }
            }

            async setupAutoRefresh() {
                // Check for new messages every 5 seconds
                setInterval(async () => {
                    await this.checkForNewMessages();
                }, 5000);
            }

            async checkForNewMessages() {
                try {
                    const settings = this.getSettings();
                    // Message check logging removed for production
                    
                    if (!this.validateTwilioSettings(settings)) {
                        console.log('Twilio settings not configured, skipping message check');
                        return;
                    }
                    
                    const queryParams = new URLSearchParams({
                        accountSid: settings.accountSid,
                        authToken: settings.authToken
                    });
                    
                    const response = await fetch(`/api/messages?${queryParams}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Process new messages
                        result.messages.forEach(msg => {
                            if (msg.direction === 'inbound') {
                                const recipient = msg.from;
                                const normalizedRecipient = this.normalizePhoneNumber(recipient);
                                
                                // Check if we already have this message
                                const conversation = this.conversations.get(normalizedRecipient);
                                const messageExists = conversation && 
                                    conversation.messages.some(m => m.id === msg.id);
                                
                                if (!messageExists) {
                                    this.handleIncomingMessage(msg.body, recipient, msg.id);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking for new messages:', error);
                }
            }

            saveSettings() {
                const settings = {
                    accountSid: document.getElementById('accountSid')?.value || '',
                    authToken: document.getElementById('authToken')?.value || '',
                    fromNumber: document.getElementById('fromNumber')?.value || '',
                    openaiKey: document.getElementById('openaiKey')?.value || '',
                    aiModel: document.getElementById('aiModel')?.value || 'gpt-3.5-turbo',
                    aiEnabled: document.getElementById('aiEnabled')?.checked ?? false
                };
                
                Object.keys(settings).forEach(key => {
                    if (settings[key] !== undefined) {
                        localStorage.setItem(key, settings[key]);
                    }
                });
            }

            loadFromStorage() {
                // Load settings (only if elements exist)
                ['accountSid', 'authToken', 'fromNumber', 'openaiKey', 'aiModel'].forEach(id => {
                    const element = document.getElementById(id);
                    const value = localStorage.getItem(id);
                    if (element && value) {
                        element.value = value;
                    }
                });

                // Load AI enabled state
                const aiEnabled = localStorage.getItem('aiEnabled');
                const aiEnabledElement = document.getElementById('aiEnabled');
                if (aiEnabled !== null && aiEnabledElement) {
                    aiEnabledElement.checked = aiEnabled === 'true';
                    this.updateAIStatus(aiEnabled === 'true');
                } else if (aiEnabled !== null) {
                    this.updateAIStatus(aiEnabled === 'true');
                }

                // Load conversations
                const savedConversations = localStorage.getItem('smsConversations');
                if (savedConversations) {
                    const conversationsData = JSON.parse(savedConversations);
                    conversationsData.forEach(conv => {
                        this.conversations.set(conv.recipient, {
                            recipient: conv.recipient,
                            messages: conv.messages || [],
                            lastActivity: conv.lastActivity,
                            unreadCount: conv.unreadCount || 0,
                            aiEnabled: conv.aiEnabled !== undefined ? conv.aiEnabled : true
                        });
                    });
                }
            }

            saveConversations() {
                const conversationsArray = Array.from(this.conversations.values());
                localStorage.setItem('smsConversations', JSON.stringify(conversationsArray));
            }

            getSettings() {
                const settings = {
                    accountSid: document.getElementById('settingsAccountSid')?.value || document.getElementById('accountSid')?.value || localStorage.getItem('accountSid') || window.env?.TWILIO_ACCOUNT_SID || '',
                    authToken: document.getElementById('settingsAuthToken')?.value || document.getElementById('authToken')?.value || localStorage.getItem('authToken') || window.env?.TWILIO_AUTH_TOKEN || '',
                    fromNumber: document.getElementById('settingsFromNumber')?.value || document.getElementById('fromNumber')?.value || localStorage.getItem('fromNumber') || window.env?.TWILIO_FROM_NUMBER || '',
                    openaiKey: document.getElementById('settingsOpenaiKey')?.value || document.getElementById('openaiKey')?.value || localStorage.getItem('openaiKey') || window.env?.OPENAI_API_KEY || '',
                    assistantId: document.getElementById('settingsAssistantId')?.value || document.getElementById('assistantId')?.value || localStorage.getItem('assistantId') || window.env?.OPENAI_ASSISTANT_ID || '',
                    aiModel: document.getElementById('settingsAiModel')?.value || document.getElementById('aiModel')?.value || localStorage.getItem('aiModel') || 'gpt-3.5-turbo',
                    aiEnabled: document.getElementById('settingsAiEnabled')?.checked ?? document.getElementById('aiEnabled')?.checked ?? (localStorage.getItem('aiEnabled') === 'true')
                };
                
                // Debug logging removed for production
                
                return settings;
            }

            validateTwilioSettings(settings) {
                const hasAccountSid = settings.accountSid && settings.accountSid.trim() !== '';
                const hasAuthToken = settings.authToken && settings.authToken.trim() !== '';
                const hasFromNumber = settings.fromNumber && settings.fromNumber.trim() !== '';
                
                // Validation logging removed for production
                
                return hasAccountSid && hasAuthToken && hasFromNumber;
            }

            validateAISettings(settings) {
                return settings.openaiKey && 
                       settings.assistantId &&
                       settings.aiModel &&
                       settings.aiEnabled;
            }

            normalizePhoneNumber(phone) {
                // Basic phone number normalization
                let normalized = phone.replace(/[^\d+]/g, '');
                if (!normalized.startsWith('+') && normalized.length === 10) {
                    normalized = '+1' + normalized;
                }
                if (!normalized.startsWith('+')) {
                    normalized = '+' + normalized;
                }
                return normalized;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 24 * 60 * 60 * 1000) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                    return date.toLocaleDateString([], { weekday: 'short' });
                } else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                }
            }

            truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = type;
                notification.textContent = message;

                const sidebar = document.querySelector('.sidebar');
                sidebar.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Authentication System
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.setupLoginForm();
                this.checkExistingSession();
            }

            setupLoginForm() {
                const loginForm = document.getElementById('loginForm');
                const roleOptions = document.querySelectorAll('.role-option');

                // Role selection
                roleOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        roleOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    });
                });

                // Login form submission
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
            }

            handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const selectedRole = document.querySelector('.role-option.selected').dataset.role;

                // Simple authentication (in production, this would be server-side)
                if (this.authenticateUser(username, password, selectedRole)) {
                    this.loginUser(username, selectedRole);
                } else {
                    this.showLoginError('Invalid credentials');
                }
            }

            authenticateUser(username, password, role) {
                // Simple hardcoded credentials for demo
                // In production, this would be server-side authentication
                const validUsers = {
                    'admin': { password: 'admin123', role: 'admin' },
                    'sales': { password: 'sales123', role: 'sales' },
                    'manager': { password: 'manager123', role: 'admin' }
                };

                const user = validUsers[username.toLowerCase()];
                return user && user.password === password && user.role === role;
            }

            loginUser(username, role) {
                this.currentUser = { username, role };
                
                // Store session
                sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                
                // Update UI
                document.getElementById('userName').textContent = username;
                document.getElementById('userRole').textContent = role.toUpperCase();
                
                // Show/hide elements based on role
                this.updateUIForRole(role);
                
                // Show main app
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Initialize chat manager after login
                if (!window.aiChatManager) {
                    window.aiChatManager = new AISmsChatManager();
                }
            }

            updateUIForRole(role) {
                const settingsTabBtn = document.getElementById('settingsTabBtn');
                
                if (role === 'admin') {
                    settingsTabBtn.style.display = 'block';
                } else {
                    settingsTabBtn.style.display = 'none';
                    // Hide settings tab if it's currently active
                    if (document.getElementById('settingsTab').style.display === 'block') {
                        switchTab('chat');
                    }
                }
            }

            checkExistingSession() {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    this.currentUser = JSON.parse(storedUser);
                    this.loginUser(this.currentUser.username, this.currentUser.role);
                }
            }

            logout() {
                this.currentUser = null;
                sessionStorage.removeItem('currentUser');
                
                // Clear form
                document.getElementById('loginForm').reset();
                document.querySelector('.role-option[data-role="admin"]').classList.add('selected');
                document.querySelector('.role-option[data-role="sales"]').classList.remove('selected');
                
                // Show login screen
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }

            showLoginError(message) {
                const loginBtn = document.getElementById('loginBtn');
                const originalText = loginBtn.textContent;
                
                loginBtn.textContent = message;
                loginBtn.style.background = '#e74c3c';
                
                setTimeout(() => {
                    loginBtn.textContent = originalText;
                    loginBtn.style.background = '';
                }, 3000);
            }

            isAdmin() {
                return this.currentUser && this.currentUser.role === 'admin';
            }

            isSales() {
                return this.currentUser && this.currentUser.role === 'sales';
            }
        }

        // Initialize authentication
        const authManager = new AuthManager();

        // Logout function
        window.logout = () => {
            authManager.logout();
        };

        // Initialize the AI chat manager (will be initialized after login)
        let aiChatManager = null;


        // Tab switching functionality
        window.switchTab = (tabName) => {
            // Check permissions
            if (tabName === 'settings' && !authManager.isAdmin()) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide containers
            if (tabName === 'chat') {
                document.getElementById('chatTab').style.display = 'flex';
                document.getElementById('settingsTab').style.display = 'none';
            } else if (tabName === 'settings') {
                document.getElementById('chatTab').style.display = 'none';
                document.getElementById('settingsTab').style.display = 'block';
                // Ensure settings are loaded and auto-save is enabled
                setTimeout(() => {
                    syncSettings();
                }, 100);
            }
        };

        // Sync settings between chat and settings dashboard
        function syncSettings() {
            console.log('Syncing settings...');
            
            // Show security warning
            showSecurityWarning();
            
            // Update webhook URLs with current domain
            updateWebhookUrls();
            
            // Check integration status
            checkIntegrationStatus();
            
            // Load settings from localStorage and environment variables
            const settings = {
                accountSid: localStorage.getItem('accountSid') || window.env?.TWILIO_ACCOUNT_SID || '',
                authToken: localStorage.getItem('authToken') || window.env?.TWILIO_AUTH_TOKEN || '',
                fromNumber: localStorage.getItem('fromNumber') || window.env?.TWILIO_FROM_NUMBER || '',
                openaiKey: localStorage.getItem('openaiKey') || window.env?.OPENAI_API_KEY || '',
                assistantId: localStorage.getItem('assistantId') || window.env?.OPENAI_ASSISTANT_ID || '',
                aiModel: localStorage.getItem('aiModel') || 'gpt-3.5-turbo',
                aiEnabled: localStorage.getItem('aiEnabled') === 'true',
                testMode: localStorage.getItem('testMode') === 'true'
            };

            console.log('Loaded settings:', settings);

            // Populate settings dashboard with delay to ensure elements exist
            setTimeout(() => {
                const elements = {
                    settingsAccountSid: document.getElementById('settingsAccountSid'),
                    settingsAuthToken: document.getElementById('settingsAuthToken'),
                    settingsFromNumber: document.getElementById('settingsFromNumber'),
                    settingsOpenaiKey: document.getElementById('settingsOpenaiKey'),
                    settingsAssistantId: document.getElementById('settingsAssistantId'),
                    settingsAiModel: document.getElementById('settingsAiModel'),
                    settingsAiEnabled: document.getElementById('settingsAiEnabled'),
                    settingsTestMode: document.getElementById('settingsTestMode')
                };

                // Temporarily disable auto-save while populating fields
                const originalAutoSaveHandler = window.autoSaveHandler;
                window.autoSaveHandler = () => {}; // Disable auto-save temporarily
                
                if (elements.settingsAccountSid) elements.settingsAccountSid.value = settings.accountSid;
                if (elements.settingsAuthToken) elements.settingsAuthToken.value = settings.authToken;
                if (elements.settingsFromNumber) elements.settingsFromNumber.value = settings.fromNumber;
                if (elements.settingsOpenaiKey) elements.settingsOpenaiKey.value = settings.openaiKey;
                if (elements.settingsAssistantId) elements.settingsAssistantId.value = settings.assistantId;
                if (elements.settingsAiModel) elements.settingsAiModel.value = settings.aiModel;
                if (elements.settingsAiEnabled) elements.settingsAiEnabled.checked = settings.aiEnabled;
                if (elements.settingsTestMode) elements.settingsTestMode.checked = settings.testMode;
                
                console.log('Settings populated in dashboard');
                
                // Re-enable auto-save after a short delay
                setTimeout(() => {
                    window.autoSaveHandler = originalAutoSaveHandler;
                }, 1000);
                
                // Add auto-save listeners for all settings fields
                addAutoSaveListeners();
                
                // Update AI status
                updateSettingsAIStatus(settings.aiEnabled);
                
                // Update test mode status
                updateTestModeStatus(settings.testMode);
            }, 50);

            // Load questions
            const savedQuestions = localStorage.getItem('customQuestions');
            if (savedQuestions) {
                const questions = JSON.parse(savedQuestions);
                document.getElementById('settingsQ1').value = questions.q1 || '';
                document.getElementById('settingsQ2').value = questions.q2 || '';
                document.getElementById('settingsQ3').value = questions.q3 || '';
                document.getElementById('settingsQ4').value = questions.q4 || '';
            }
            
            // Add event listeners for test mode toggle
            const testModeToggle = document.getElementById('settingsTestMode');
            if (testModeToggle) {
                testModeToggle.addEventListener('change', (e) => {
                    localStorage.setItem('testMode', e.target.checked);
                    updateTestModeStatus(e.target.checked);
                });
            }

            // Add event listeners for settings changes (with delay to ensure elements exist)
            setTimeout(() => {
                setupAIConfigurationListeners();
                setupGeneralSettingsListeners();
            }, 100);
        }

        function setupAIConfigurationListeners() {
            console.log('Setting up AI Configuration listeners...');
            
            // AI Configuration specific elements
            const aiElements = [
                'settingsOpenaiKey',
                'settingsAssistantId', 
                'settingsAiModel',
                'settingsAiEnabled'
            ];
            
            aiElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        console.log(`AI setting changed: ${id}`);
                        console.log(`New value: "${element.value}"`);
                        
                        // Auto-save AI settings when changed (but don't show alert for checkboxes)
                        if (id !== 'settingsAiEnabled') {
                            console.log(`Calling saveAISettings for ${id}`);
                            saveAISettings();
                        } else {
                            // For checkbox, just save silently
                            console.log(`Calling saveAISettingsSilent for ${id}`);
                            saveAISettingsSilent();
                        }
                    });
                    
                    // Add input event listener for real-time debugging
                    element.addEventListener('input', () => {
                        console.log(`AI setting input: ${id} = "${element.value}"`);
                    });
                    
                    console.log(`Added listeners for: ${id}`);
                } else {
                    console.log(`AI element not found: ${id}`);
                }
            });
        }

        function setupGeneralSettingsListeners() {
            console.log('Setting up General Settings listeners...');
            
            // General settings elements
            const generalElements = [
                'settingsAccountSid',
                'settingsAuthToken',
                'settingsFromNumber'
            ];
            
            generalElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        console.log(`General setting changed: ${id}`);
                        saveSettingsToStorage();
                    });
                    console.log(`Added listener for: ${id}`);
                } else {
                    console.log(`General element not found: ${id}`);
                }
            });
        }

        function updateSettingsAIStatus(enabled) {
            const statusElement = document.getElementById('settingsAiStatus');
            if (statusElement) {
                if (enabled) {
                    statusElement.textContent = 'ENABLED';
                    statusElement.className = 'settings-status enabled';
                } else {
                    statusElement.textContent = 'DISABLED';
                    statusElement.className = 'settings-status disabled';
                }
            }
        }

        // Add auto-save listeners for all settings fields
        function addAutoSaveListeners() {
            const settingsFields = [
                'settingsAccountSid',
                'settingsAuthToken', 
                'settingsFromNumber',
                'settingsOpenaiKey',
                'settingsAssistantId',
                'settingsAiModel'
            ];
            
            settingsFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    // Remove existing listeners to avoid duplicates
                    element.removeEventListener('input', autoSaveHandler);
                    element.removeEventListener('change', autoSaveHandler);
                    
                    // Add new listeners
                    element.addEventListener('input', autoSaveHandler);
                    element.addEventListener('change', autoSaveHandler);
                    
                    console.log(`Added auto-save listener for: ${fieldId}`);
                }
            });
            
            // Special handling for checkboxes
            const checkboxFields = ['settingsAiEnabled', 'settingsTestMode'];
            checkboxFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.removeEventListener('change', autoSaveHandler);
                    element.addEventListener('change', autoSaveHandler);
                    console.log(`Added auto-save listener for checkbox: ${fieldId}`);
                }
            });
        }
        
        // Auto-save handler with debounce
        let saveTimeout;
        function autoSaveHandler(event) {
            console.log(`Auto-saving due to change in: ${event.target.id}`);
            
            // Clear existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Debounce the save operation
            saveTimeout = setTimeout(() => {
                saveSettingsToStorage();
            }, 500); // Wait 500ms after last change
        }

        // Flag to prevent multiple save notifications
        let isSaving = false;
        
        function saveSettingsToStorage() {
            if (isSaving) {
                console.log('Save already in progress, skipping...');
                return;
            }
            
            isSaving = true;
            console.log('Saving settings...');
            
            const settings = {
                accountSid: document.getElementById('settingsAccountSid')?.value || '',
                authToken: document.getElementById('settingsAuthToken')?.value || '',
                fromNumber: document.getElementById('settingsFromNumber')?.value || '',
                openaiKey: document.getElementById('settingsOpenaiKey')?.value || '',
                assistantId: document.getElementById('settingsAssistantId')?.value || '',
                aiModel: document.getElementById('settingsAiModel')?.value || 'gpt-3.5-turbo',
                aiEnabled: document.getElementById('settingsAiEnabled')?.checked || false,
                testMode: document.getElementById('settingsTestMode')?.checked || false
            };
            
            console.log('Settings to save:', settings);
            
            // Save to localStorage
            Object.keys(settings).forEach(key => {
                localStorage.setItem(key, settings[key]);
                console.log(`Saved ${key}:`, settings[key]);
            });
            
            // Update test mode status
            updateTestModeStatus(settings.testMode);
            
            // Update AI status
            updateSettingsAIStatus(settings.aiEnabled);
            
            // Reset saving flag after a short delay
            setTimeout(() => {
                isSaving = false;
            }, 1000);

            // Also update the chat interface settings (only if elements exist)
            const accountSidElement = document.getElementById('accountSid');
            const authTokenElement = document.getElementById('authToken');
            const fromNumberElement = document.getElementById('fromNumber');
            const openaiKeyElement = document.getElementById('openaiKey');
            const aiModelElement = document.getElementById('aiModel');
            const aiEnabledElement = document.getElementById('aiEnabled');

            if (accountSidElement) accountSidElement.value = settings.accountSid;
            if (authTokenElement) authTokenElement.value = settings.authToken;
            if (fromNumberElement) fromNumberElement.value = settings.fromNumber;
            if (openaiKeyElement) openaiKeyElement.value = settings.openaiKey;
            if (aiModelElement) aiModelElement.value = settings.aiModel;
            if (aiEnabledElement) aiEnabledElement.checked = settings.aiEnabled;
            
            // Update AI status in chat interface
            if (window.aiChatManager && window.aiChatManager.updateAIStatus) {
                window.aiChatManager.updateAIStatus(settings.aiEnabled);
            }
            
            // Show success message
            alert('Settings saved successfully!');
        }

        // Save AI settings specifically
        window.saveAISettings = () => {
            console.log('Saving AI settings...');
            
            const openaiKeyElement = document.getElementById('settingsOpenaiKey');
            const assistantIdElement = document.getElementById('settingsAssistantId');
            
            console.log('OpenAI Key element:', openaiKeyElement);
            console.log('OpenAI Key element value:', openaiKeyElement?.value);
            console.log('Assistant ID element:', assistantIdElement);
            console.log('Assistant ID element value:', assistantIdElement?.value);
            
            const aiSettings = {
                openaiKey: openaiKeyElement?.value || '',
                assistantId: assistantIdElement?.value || '',
                aiModel: document.getElementById('settingsAiModel')?.value || 'gpt-3.5-turbo',
                aiEnabled: document.getElementById('settingsAiEnabled')?.checked || false
            };
            
            console.log('AI settings to save:', aiSettings);
            
            // Save to localStorage
            Object.keys(aiSettings).forEach(key => {
                localStorage.setItem(key, aiSettings[key]);
                console.log(`Saved ${key}:`, aiSettings[key]);
            });
            
            // Verify what was actually saved
            console.log('Verification - localStorage openaiKey:', localStorage.getItem('openaiKey'));
            console.log('Verification - localStorage assistantId:', localStorage.getItem('assistantId'));
            
            // Update AI status
            updateSettingsAIStatus(aiSettings.aiEnabled);
            
            // Show success message
            alert('AI Settings saved successfully!');
        };

        // Save AI settings silently (no alert)
        window.saveAISettingsSilent = () => {
            console.log('Saving AI settings silently...');
            
            const openaiKeyElement = document.getElementById('settingsOpenaiKey');
            const assistantIdElement = document.getElementById('settingsAssistantId');
            
            console.log('Silent save - OpenAI Key element:', openaiKeyElement);
            console.log('Silent save - OpenAI Key value:', openaiKeyElement?.value);
            console.log('Silent save - Assistant ID element:', assistantIdElement);
            console.log('Silent save - Assistant ID value:', assistantIdElement?.value);
            
            const aiSettings = {
                openaiKey: openaiKeyElement?.value || '',
                assistantId: assistantIdElement?.value || '',
                aiModel: document.getElementById('settingsAiModel')?.value || 'gpt-3.5-turbo',
                aiEnabled: document.getElementById('settingsAiEnabled')?.checked || false
            };
            
            console.log('AI settings to save silently:', aiSettings);
            
            // Save to localStorage
            Object.keys(aiSettings).forEach(key => {
                localStorage.setItem(key, aiSettings[key]);
                console.log(`Silently saved ${key}:`, aiSettings[key]);
            });
            
            // Verify what was actually saved
            console.log('Silent verification - localStorage openaiKey:', localStorage.getItem('openaiKey'));
            console.log('Silent verification - localStorage assistantId:', localStorage.getItem('assistantId'));
            
            // Update AI status
            updateSettingsAIStatus(aiSettings.aiEnabled);
        };

        // Debug function to check localStorage
        window.debugSettings = () => {
            console.log('=== DEBUG SETTINGS ===');
            console.log('localStorage openaiKey:', localStorage.getItem('openaiKey'));
            console.log('localStorage assistantId:', localStorage.getItem('assistantId'));
            console.log('localStorage aiEnabled:', localStorage.getItem('aiEnabled'));
            console.log('localStorage testMode:', localStorage.getItem('testMode'));
            
            const settings = window.aiChatManager ? window.aiChatManager.getSettings() : {};
            console.log('getSettings() result:', settings);
            
            const elements = {
                settingsOpenaiKey: document.getElementById('settingsOpenaiKey')?.value,
                settingsAssistantId: document.getElementById('settingsAssistantId')?.value,
                settingsAiEnabled: document.getElementById('settingsAiEnabled')?.checked
            };
            console.log('Dashboard elements:', elements);
        };

        // Debug function specifically for OpenAI key
        window.debugOpenAIKey = () => {
            console.log('=== OPENAI KEY DEBUG ===');
            const element = document.getElementById('settingsOpenaiKey');
            console.log('Element found:', !!element);
            console.log('Element value:', element?.value);
            console.log('Element value length:', element?.value?.length);
            console.log('localStorage value:', localStorage.getItem('openaiKey'));
            console.log('localStorage value length:', localStorage.getItem('openaiKey')?.length);
            
            // Test saving
            if (element && element.value) {
                localStorage.setItem('openaiKey', element.value);
                console.log('Manually saved to localStorage:', localStorage.getItem('openaiKey'));
            }
        };

        // Debug function to test API key saving specifically
        window.testAPIKeySaving = () => {
            console.log('=== TESTING API KEY SAVING ===');
            const element = document.getElementById('settingsOpenaiKey');
            
            if (!element) {
                console.error('❌ settingsOpenaiKey element not found!');
                return;
            }
            
            console.log('Element found:', element);
            console.log('Current value:', element.value);
            console.log('Current localStorage:', localStorage.getItem('openaiKey'));
            
            // Test setting a value
            const testKey = 'sk-test123456789';
            element.value = testKey;
            console.log('Set test value:', element.value);
            
            // Test the save function
            if (window.saveAISettingsSilent) {
                console.log('Calling saveAISettingsSilent...');
                window.saveAISettingsSilent();
                console.log('After save - localStorage:', localStorage.getItem('openaiKey'));
            } else {
                console.error('saveAISettingsSilent function not found!');
            }
            
            // Test getSettings
            if (window.aiChatManager && window.aiChatManager.getSettings) {
                const settings = window.aiChatManager.getSettings();
                console.log('getSettings() result:', settings.openaiKey);
            }
        };

        // Test OpenAI API key directly
        window.testOpenAIKey = async () => {
            const settings = window.aiChatManager ? window.aiChatManager.getSettings() : {};
            const apiKey = settings.openaiKey;
            
            if (!apiKey) {
                console.error('❌ No OpenAI API key found. Please set it in settings.');
                return;
            }
            
            console.log('🧪 Testing OpenAI API key...');
            console.log('Key format:', {
                length: apiKey.length,
                startsWithSk: apiKey.startsWith('sk-'),
                first10Chars: apiKey.substring(0, 10),
                last4Chars: apiKey.substring(apiKey.length - 4)
            });
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'user',
                                content: 'Hello, this is a test message.'
                            }
                        ],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ OpenAI API key is working!');
                    console.log('Test response:', data.choices[0].message.content);
                } else {
                    const errorData = await response.json();
                    console.error('❌ OpenAI API test failed:');
                    console.error('Status:', response.status);
                    console.error('Error:', errorData);
                    
                    if (response.status === 401) {
                        console.error('🔑 API Key is invalid or expired');
                    } else if (response.status === 429) {
                        console.error('⏱️ Rate limit exceeded');
                    } else if (response.status === 402) {
                        console.error('💳 Billing issue - check your OpenAI account');
                    }
                }
            } catch (error) {
                console.error('❌ Network error testing OpenAI API:', error);
            }
        };

        // Switch to chat interface and show the conversation
        window.switchToChatAndShowConversation = (phoneNumber) => {
            // Switch to chat tab
            switchTab('chat');
            
            // Wait a moment for the tab to switch, then select the conversation
            setTimeout(() => {
                if (window.aiChatManager) {
                    window.aiChatManager.selectConversation(phoneNumber);
                }
            }, 100);
        };

        // Global function for webhook integration
        window.handleIncomingMessage = (body, from, messageId) => {
            aiChatManager.handleIncomingMessage(body, from, messageId);
        };

        // Security warning for API tokens
        function showSecurityWarning() {
            const warning = document.createElement('div');
            warning.className = 'security-warning';
            warning.innerHTML = `
                <div class="warning-content">
                    <h4>🔒 Security Notice</h4>
                    <p>Your API tokens are stored locally in your browser. For maximum security:</p>
                    <ul>
                        <li>Don't share your browser or computer</li>
                        <li>Clear tokens when using shared computers</li>
                        <li>Consider using environment variables for production</li>
                    </ul>
                    <button onclick="clearAllTokens()" class="clear-tokens-btn">Clear All Tokens</button>
                </div>
            `;
            
            const settingsDashboard = document.querySelector('.settings-dashboard');
            settingsDashboard.insertBefore(warning, settingsDashboard.firstChild);
        }

        // Clear all stored tokens
        window.clearAllTokens = () => {
            if (confirm('Are you sure you want to clear all stored API tokens? This will require you to re-enter them.')) {
                localStorage.removeItem('accountSid');
                localStorage.removeItem('authToken');
                localStorage.removeItem('openaiKey');
                localStorage.removeItem('assistantId');
                
                // Clear form fields
                document.getElementById('settingsAccountSid').value = '';
                document.getElementById('settingsAuthToken').value = '';
                document.getElementById('settingsOpenaiKey').value = '';
                document.getElementById('settingsAssistantId').value = '';
                
                alert('All API tokens have been cleared from local storage.');
            }
        };

        // Copy webhook URL to clipboard
        window.copyToClipboard = (elementId) => {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                
                // Show success feedback
                const button = element.nextElementSibling;
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.style.background = '#4CAF50';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
                
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(element.value).then(() => {
                    const button = element.nextElementSibling;
                    const originalText = button.textContent;
                    button.textContent = '✅ Copied!';
                    button.style.background = '#4CAF50';
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                    }, 2000);
                });
            }
        };

        // Update webhook URLs with current domain
        function updateWebhookUrls() {
            const currentDomain = window.location.origin;
            
            document.getElementById('facebookWebhookUrl').value = `${currentDomain}/api/import-lead`;
            document.getElementById('gravityWebhookUrl').value = `${currentDomain}/api/import-lead`;
            document.getElementById('smsWebhookUrl').value = `${currentDomain}/webhook/sms`;
        }

        // Check integration status
        async function checkIntegrationStatus() {
            try {
                // Check if server is responding
                const response = await fetch('/health');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update status badges
                    document.getElementById('smsWebhookStatus').textContent = 'Connected';
                    document.getElementById('smsWebhookStatus').className = 'status-badge connected';
                    
                    // Check for recent customer data (indicates integrations working)
                    if (data.customers > 0) {
                        document.getElementById('facebookStatus').textContent = 'Active';
                        document.getElementById('facebookStatus').className = 'status-badge connected';
                        document.getElementById('gravityStatus').textContent = 'Active';
                        document.getElementById('gravityStatus').className = 'status-badge connected';
                    }
                }
            } catch (error) {
                console.log('Integration status check failed:', error);
            }
        }

        // Test integration by sending a test lead
        window.testIntegration = async () => {
            try {
                const testLead = {
                    name: "Test Customer",
                    phone: "+1234567890",
                    email: "test@example.com",
                    postcode: "12345",
                    source: "test_integration",
                    sourceDetails: {
                        test: true,
                        timestamp: new Date().toISOString()
                    }
                };

                const response = await fetch('/api/import-lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testLead)
                });

                if (response.ok) {
                    alert('✅ Integration test successful! Test lead created.');
                    refreshStatus();
                } else {
                    const error = await response.json();
                    alert(`❌ Integration test failed: ${error.error}`);
                }
            } catch (error) {
                alert(`❌ Integration test failed: ${error.message}`);
            }
        };

        // Refresh integration status
        window.refreshStatus = () => {
            // Reset all status badges
            document.getElementById('facebookStatus').textContent = 'Not Connected';
            document.getElementById('facebookStatus').className = 'status-badge not-connected';
            document.getElementById('gravityStatus').textContent = 'Not Connected';
            document.getElementById('gravityStatus').className = 'status-badge not-connected';
            document.getElementById('smsWebhookStatus').textContent = 'Not Connected';
            document.getElementById('smsWebhookStatus').className = 'status-badge not-connected';
            
            // Re-check status
            checkIntegrationStatus();
        };

        // Update test mode status
        function updateTestModeStatus(isEnabled) {
            const statusElement = document.getElementById('settingsTestModeStatus');
            const testModeSection = document.getElementById('testModeSection');
            
            if (isEnabled) {
                statusElement.textContent = 'ENABLED';
                statusElement.className = 'settings-status enabled';
                testModeSection.style.display = 'block';
                updateTestStatusBadges();
            } else {
                statusElement.textContent = 'DISABLED';
                statusElement.className = 'settings-status disabled';
                testModeSection.style.display = 'none';
            }
        }

        // Update test status badges
        function updateTestStatusBadges() {
            const testMode = localStorage.getItem('testMode') === 'true';
            const aiEnabled = localStorage.getItem('aiEnabled') === 'true';
            
            document.getElementById('testModeBadge').textContent = testMode ? 'Enabled' : 'Disabled';
            document.getElementById('testModeBadge').className = testMode ? 'status-badge connected' : 'status-badge not-connected';
            
            document.getElementById('aiTestBadge').textContent = aiEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('aiTestBadge').className = aiEnabled ? 'status-badge connected' : 'status-badge not-connected';
            
            document.getElementById('smsTestBadge').textContent = testMode ? 'Disabled (Test Mode)' : 'Enabled';
            document.getElementById('smsTestBadge').className = testMode ? 'status-badge not-connected' : 'status-badge connected';
        }

        // Simulate incoming SMS for testing
        window.simulateIncomingSMS = async () => {
            const phoneNumber = document.getElementById('testPhoneNumber').value;
            const message = document.getElementById('testMessage').value;
            const resultsDiv = document.getElementById('testResults');
            
            if (!phoneNumber || !message) {
                resultsDiv.innerHTML = '<div style="color: #e74c3c;">❌ Please enter both phone number and message</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div style="color: #2196F3;">🔄 Simulating incoming SMS...</div>';
            
            try {
                // Check settings first
                const settings = window.aiChatManager ? window.aiChatManager.getSettings() : {};
                const debugInfo = `
                    <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 0.8rem;">
                        <strong>Debug Info:</strong><br>
                        AI Enabled: ${settings.aiEnabled || 'false'}<br>
                        OpenAI Key: ${settings.openaiKey ? 'Set (' + settings.openaiKey.substring(0, 10) + '...)' : 'Not set'}<br>
                        Assistant ID: ${settings.assistantId ? 'Set (' + settings.assistantId.substring(0, 10) + '...)' : 'Not set'}<br>
                        AI Model: ${settings.aiModel || 'Not set'}
                    </div>
                `;
                
                // Simulate the incoming message processing
                if (window.aiChatManager) {
                    await window.aiChatManager.handleIncomingMessage(message, phoneNumber, 'test_message_' + Date.now());
                    
                    // Get the conversation to see the AI response
                    const conversation = window.aiChatManager.conversations.get(phoneNumber);
                    if (conversation && conversation.messages.length > 0) {
                        const lastMessage = conversation.messages[conversation.messages.length - 1];
                        if (lastMessage.isAI) {
                            resultsDiv.innerHTML = `
                                <div style="color: #4CAF50;">✅ SMS simulation successful!</div>
                                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <strong>AI Response:</strong><br>
                                    "${lastMessage.text}"
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                                    <button onclick="switchToChatAndShowConversation('${phoneNumber}')" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                        📱 View in Chat Interface
                                    </button>
                                </div>
                                ${debugInfo}
                            `;
                        } else {
                            resultsDiv.innerHTML = `
                                <div style="color: #ff9800;">⚠️ Message received but no AI response generated</div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                                    This usually means AI is disabled or missing API credentials.
                                </div>
                                ${debugInfo}
                            `;
                        }
                    } else {
                        resultsDiv.innerHTML = `
                            <div style="color: #ff9800;">⚠️ Message received but no conversation created</div>
                            ${debugInfo}
                        `;
                    }
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: #e74c3c;">❌ Chat manager not initialized</div>
                        ${debugInfo}
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="color: #e74c3c;">❌ Error: ${error.message}</div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">
                        Check browser console for more details.
                    </div>
                `;
            }
        };

        // Global function for saving questions
        window.saveQuestions = () => {
            const questions = {
                q1: document.getElementById('q1').value,
                q2: document.getElementById('q2').value,
                q3: document.getElementById('q3').value,
                q4: document.getElementById('q4').value
            };
            
            localStorage.setItem('customQuestions', JSON.stringify(questions));
            
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'success';
            notification.textContent = 'Questions saved successfully!';
            
            const sidebar = document.querySelector('.sidebar');
            sidebar.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };

        // Global function for clearing current chat
        window.clearCurrentChat = () => {
            if (!window.aiChatManager) {
                alert('Chat manager not initialized');
                return;
            }
            
            const currentRecipient = window.aiChatManager.selectedRecipient;
            if (!currentRecipient) {
                alert('No conversation selected');
                return;
            }
            
            if (confirm(`Are you sure you want to clear the conversation with ${currentRecipient}?`)) {
                // Clear the conversation
                window.aiChatManager.conversations.delete(currentRecipient);
                window.aiChatManager.saveConversations();
                
                // Clear the chat display
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }
                
                // Update conversations list
                window.aiChatManager.renderConversations();
                
                // Show success message
                showNotification('Conversation cleared successfully!', 'success');
            }
        };
        
        // Global function for clearing all chats
        window.clearAllChats = () => {
            if (!window.aiChatManager) {
                alert('Chat manager not initialized');
                return;
            }
            
            if (confirm('Are you sure you want to clear ALL conversations? This cannot be undone.')) {
                // Clear all conversations
                window.aiChatManager.conversations.clear();
                window.aiChatManager.saveConversations();
                
                // Clear the chat display
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }
                
                // Update conversations list
                window.aiChatManager.renderConversations();
                
                // Reset selected recipient
                window.aiChatManager.selectedRecipient = null;
                
                // Update chat title
                const chatTitle = document.getElementById('chatTitle');
                if (chatTitle) {
                    chatTitle.textContent = 'Select a conversation';
                }
                
                // Show success message
                showNotification('All conversations cleared successfully!', 'success');
            }
        };
        
        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Global function for saving settings questions
        window.saveSettingsQuestions = () => {
            console.log('Saving questions...');
            
            const questions = {
                q1: document.getElementById('settingsQ1').value,
                q2: document.getElementById('settingsQ2').value,
                q3: document.getElementById('settingsQ3').value,
                q4: document.getElementById('settingsQ4').value
            };
            
            console.log('Questions to save:', questions);
            
            // Save to localStorage
            localStorage.setItem('customQuestions', JSON.stringify(questions));
            
            // Also send to server to update the default questions
            fetch('/api/configure-questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ questions: questions })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                
                // Show success message
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-weight: bold;
                `;
                notification.textContent = 'Questions saved successfully!';
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            })
            .catch(error => {
                console.error('Error saving questions:', error);
                
                // Show error message
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f44336;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-weight: bold;
                `;
                notification.textContent = 'Error saving questions!';
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            });
        };


        // Load saved questions on page load
        // Load environment variables from server
        async function loadEnvironmentVariables() {
            try {
                const response = await fetch('/api/env');
                const env = await response.json();
                window.env = env;
                console.log('Environment variables loaded:', env);
            } catch (error) {
                console.log('Could not load environment variables:', error);
                window.env = {};
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Load environment variables first
            await loadEnvironmentVariables();
            
            const savedQuestions = localStorage.getItem('customQuestions');
            if (savedQuestions) {
                const questions = JSON.parse(savedQuestions);
                Object.keys(questions).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = questions[key];
                    }
                });
            }
        });

        console.log('AI-Powered SMS Chat Interface loaded!');
        console.log('Features: Templates, AI Responses, Conversation Threading, Customer Management');
    </script>
</body>
</html>